<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Настройка Mail сервера на Ubuntu &#8211; Sirius Blog</title>
<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130427752-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130427752-1');
</script>

</head>
<meta name="description" content="Postfix and other ....">
<meta name="keywords" content="Postfix, Ubuntu, Mail">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/matrix.jpg">

<meta name="twitter:title" content="Настройка Mail сервера на Ubuntu">
<meta name="twitter:description" content="Postfix and other ....">
<meta name="twitter:creator" content="@2hotab2">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Настройка Mail сервера на Ubuntu">
<meta property="og:description" content="Postfix and other ....">
<meta property="og:url" content="http://localhost:4000/Mail_server/">
<meta property="og:site_name" content="Sirius Blog">





<link rel="canonical" href="http://localhost:4000/Mail_server/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Sirius Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.jpg">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.jpg">
<!-- 114x72 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x72" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.jpg">
<!-- 144x72 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x72" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.jpg">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://localhost:4000/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://localhost:4000/images/avatar.jpg" alt="Sergey Khatsiola photo" class="author-photo">
					<h4>Sergey Khatsiola</h4>
					<p>Кратко обо мне ...</p>
				</li>
				<li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:2hotab2@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/2hotab2"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/sergej.ha1"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				
				<li>
					<a href="https://github.com/Sergey-sirius"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://localhost:4000/posts/">All Posts</a></li>
				<li><a href="http://localhost:4000/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://localhost:4000/handbook/" >HandBook</a></li>
	  
	    
	    <li><a href="https://github.com/Sergey-sirius" target="_blank">Main Link</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="http://localhost:4000/images/matrix.jpg" alt="Настройка Mail сервера на Ubuntu">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://localhost:4000/Mail_server/" rel="bookmark" title="Настройка Mail сервера на Ubuntu">Настройка Mail сервера на Ubuntu</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2019-02-16T00:00:00+02:00">February 16, 2019</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~5 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p><em>**</em>Настройка Почтового сервера сервера</p>

<p>В принципе дальнейшие команды подразумевают использование sudo</p>

<p>Пробежимся по основным настройкам</p>

<p>*1. Хосты hostname and FQDN</p>

<p>resolv.conf “забывает” настройки nameservers
Можно ввести атрибут запрета на изменение установка 
запрета - $ sudo chattr + i имя_файла
снятие запрета - $ sudo chattr - i имя_файла</p>

<p>хост hp</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">hostnamectl</span> <span class="nt">set-hostname</span> <span class="nt">--static</span> <span class="nt">hp</span>

</code></pre></div></div>

<p>/etc/hosts</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">cat</span> <span class="nt">hosts</span>
<span class="nt">127</span><span class="nc">.0.0.1</span>	<span class="nt">localhost</span><span class="nc">.localdomain</span>	<span class="nt">localhost</span>
<span class="nt">127</span><span class="nc">.0.1.1</span>	<span class="nt">hp</span><span class="nc">.e-mag.com.ua</span> <span class="nt">hp</span>
<span class="nd">::1</span>		<span class="nt">localhost6</span><span class="nc">.localdomain6</span>	<span class="nt">localhost6</span>

<span class="err">#</span> <span class="nt">The</span> <span class="nt">following</span> <span class="nt">lines</span> <span class="nt">are</span> <span class="nt">desirable</span> <span class="nt">for</span> <span class="nt">IPv6</span> <span class="nt">capable</span> <span class="nt">hosts</span>
<span class="nd">::1</span>     <span class="nt">localhost</span> <span class="nt">ip6-localhost</span> <span class="nt">ip6-loopback</span>
<span class="nt">fe00</span><span class="nd">::0</span> <span class="nt">ip6-localnet</span>
<span class="nt">ff02</span><span class="nd">::1</span> <span class="nt">ip6-allnodes</span>
<span class="nt">ff02</span><span class="nd">::2</span> <span class="nt">ip6-allrouters</span>
<span class="nt">ff02</span><span class="nd">::3</span> <span class="nt">ip6-allhosts</span>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">hostname</span>
<span class="nt">hp</span>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">hostname</span> <span class="nt">--fqdn</span>
<span class="nt">hp</span><span class="nc">.e-mag.com.ua</span>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">echo</span> <span class="err">$</span><span class="o">(</span><span class="nt">hostname</span> <span class="nt">-f</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">mailname</span>

<span class="err">$</span> <span class="nt">cat</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">mailname</span>
<span class="nt">hp</span><span class="nc">.e-mag.com.ua</span>
</code></pre></div></div>
<p>Имя хоста в вашей командной оболочке будет адаптировано после перезагрузки</p>

<p>2 DNS а зачем ?</p>

<p>Сервисы в вашей системе сильно зависят от DNS-запросов. 
Я настоятельно рекомендую установить Unbound в качестве локального преобразователя 
DNS и -cache! Некоторые провайдеры серверов ограничивают доступ к своим предварительно определенным DNS-распознавателям, что может вызвать проблемы. Особенно Rspamd делает много DNS-запросов в зависимости от загрузки почтовой системы. Кроме того, блочные списки Spamhaus часто можно использовать только с собственными распознавателями DNS (мы собираемся использовать Spamhaus с постэкраном).</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">apt</span> <span class="nt">install</span> <span class="nt">unbound</span>
</code></pre></div></div>
<p>Обновите корневой ключ DNSSEC и перезагрузите Unbound сервис:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">su</span> <span class="nt">-c</span> <span class="s1">"unbound-anchor -a /var/lib/unbound/root.key"</span> <span class="nt">-</span> <span class="nt">unbound</span>
<span class="err">$</span> <span class="nt">systemctl</span> <span class="nt">reload</span> <span class="nt">unbound</span>
</code></pre></div></div>

<p>если установлен пакет «dnsutils»</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">dig</span> <span class="k">@127</span><span class="m">.0.0.1</span> <span class="n">e-mag</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">ua</span> <span class="err">+</span><span class="n">short</span> <span class="err">+</span><span class="n">dnssec</span>
  
  <span class="n">external</span> <span class="n">your</span> <span class="n">ip</span> <span class="m">91.219.83.33</span>
</code></pre></div></div>

<p>Если команда dig сработала, теперь вы можете установить Unbound в качестве основного преобразователя DNS для вашей почтовой системы:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">apt</span> <span class="nt">install</span> <span class="nt">resolvconf</span>
<span class="err">$</span> <span class="nt">echo</span> <span class="s1">"nameserver 127.0.0.1"</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">resolvconf</span><span class="o">/</span><span class="nt">resolv</span><span class="nc">.conf.d</span><span class="o">/</span><span class="nt">head</span>

<span class="err">$</span> <span class="nt">nslookup</span> <span class="nt">e-mag</span><span class="nc">.com.ua</span> <span class="o">|</span> <span class="nt">grep</span> <span class="nt">Server</span>
  <span class="nt">Server</span><span class="o">:</span>	<span class="nt">127</span><span class="nc">.0.0.1</span>
</code></pre></div></div>

<p>**Теперь у вас есть собственный DNS-распознаватель. Давайте продолжим с настройкой DNS …</p>

<p>Проверить записи DNS провайдера</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">A</span>    <span class="nt">91</span><span class="nc">.219.83.33</span>

<span class="nt">imap</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">CNAME</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>
<span class="nt">pop</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">CNAME</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>
<span class="nt">smtp</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">CNAME</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>

<span class="nt">e-mag</span><span class="nc">.com.ua</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">MX</span> <span class="nt">0</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>
</code></pre></div></div>
<p>… И мы также хотим, чтобы он обрабатывал электронные письма для «domain2» и «domain3»:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">domain2</span><span class="nc">.tld</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">MX</span> <span class="nt">0</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>
<span class="nt">domain3</span><span class="nc">.tld</span><span class="o">.</span> <span class="nt">86400</span> <span class="nt">IN</span> <span class="nt">MX</span> <span class="nt">0</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>
</code></pre></div></div>
<p>(последние три записи должны быть созданы в соответствующих им файлах зон)</p>

<p>Обратный DNS</p>

<p>Обратная запись DNS (также называемая «PTR-запись») сопоставляет полное доменное имя с IP-адресом. 
Многие популярные провайдеры электронной почты проверяют записи PTR других почтовых серверов и отказывают в получении электронной почты от них, 
если они не могут найти подходящее доменное имя для их IP-адреса. Вам понадобятся PTR-записи для всех IP-адресов вашего сервера. 
Все они должны указывать на mail.e-mag.com.ua. 
В большинстве случаев обратные записи DNS могут быть установлены через веб-интерфейс вашего хостера или через службу поддержки сервера.</p>

<p>Пример опроса сервера доменных имен google на доменную зону ya.ru:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">dig</span> <span class="k">@google-public-dns-a</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="p">.</span> <span class="n">ya</span><span class="p">.</span><span class="n">ru</span>
</code></pre></div></div>

<p>Узнать какие есть почтовые сервера имеющие MX записи в DNS:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">dig</span> <span class="nt">e-mag</span><span class="nc">.com.ua</span> <span class="nt">mx</span>

</code></pre></div></div>
<p>PTR</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">dig</span> <span class="nt">-x</span> <span class="nt">91</span><span class="nc">.219.83.33</span>
<span class="o">;</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="nt">DiG</span> <span class="nt">9</span><span class="nc">.11.3-1ubuntu1.3-Ubuntu</span> <span class="o">&lt;&lt;&gt;&gt;</span> <span class="nt">-x</span> <span class="nt">91</span><span class="nc">.219.83.33</span>
<span class="o">;;</span> <span class="nt">global</span> <span class="nt">options</span><span class="o">:</span> <span class="o">+</span><span class="nt">cmd</span>
<span class="o">;;</span> <span class="nt">Got</span> <span class="nt">answer</span><span class="o">:</span>
<span class="o">;;</span> <span class="nt">-</span><span class="o">&gt;&gt;</span><span class="nt">HEADER</span><span class="o">&lt;&lt;</span><span class="nt">-</span> <span class="nt">opcode</span><span class="o">:</span> <span class="nt">QUERY</span><span class="o">,</span> <span class="nt">status</span><span class="o">:</span> <span class="nt">NXDOMAIN</span><span class="o">,</span> <span class="nt">id</span><span class="o">:</span> <span class="nt">46021</span>
<span class="o">;;</span> <span class="nt">flags</span><span class="o">:</span> <span class="nt">qr</span> <span class="nt">rd</span> <span class="nt">ra</span> <span class="nt">ad</span><span class="o">;</span> <span class="nt">QUERY</span><span class="o">:</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">ANSWER</span><span class="o">:</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">AUTHORITY</span><span class="o">:</span> <span class="nt">1</span><span class="o">,</span> <span class="nt">ADDITIONAL</span><span class="o">:</span> <span class="nt">1</span>

<span class="o">;;</span> <span class="nt">OPT</span> <span class="nt">PSEUDOSECTION</span><span class="o">:</span>
<span class="o">;</span> <span class="nt">EDNS</span><span class="o">:</span> <span class="nt">version</span><span class="o">:</span> <span class="nt">0</span><span class="o">,</span> <span class="nt">flags</span><span class="o">:;</span> <span class="nt">udp</span><span class="o">:</span> <span class="nt">4096</span>
<span class="o">;;</span> <span class="nt">QUESTION</span> <span class="nt">SECTION</span><span class="o">:</span>
<span class="o">;</span><span class="nt">33</span><span class="nc">.83.219.91.in-addr.arpa</span><span class="o">.</span>	<span class="nt">IN</span>	<span class="nt">PTR</span>

<span class="o">;;</span> <span class="nt">AUTHORITY</span> <span class="nt">SECTION</span><span class="o">:</span>
<span class="nt">91</span><span class="nc">.in-addr.arpa</span><span class="o">.</span>	<span class="nt">3508</span>	<span class="nt">IN</span>	<span class="nt">SOA</span>	<span class="nt">pri</span><span class="nc">.authdns.ripe.net</span><span class="o">.</span> <span class="nt">dns</span><span class="nc">.ripe.net</span><span class="o">.</span> <span class="nt">1550417273</span> <span class="nt">3600</span> <span class="nt">600</span> <span class="nt">864000</span> <span class="nt">3600</span>

<span class="o">;;</span> <span class="nt">Query</span> <span class="nt">time</span><span class="o">:</span> <span class="nt">81</span> <span class="nt">msec</span>
<span class="o">;;</span> <span class="nt">SERVER</span><span class="o">:</span> <span class="nt">127</span><span class="nc">.0.0.1</span><span class="nf">#53</span><span class="o">(</span><span class="nt">127</span><span class="nc">.0.0.1</span><span class="o">)</span>
<span class="o">;;</span> <span class="nt">WHEN</span><span class="o">:</span> <span class="nt">Sun</span> <span class="nt">Feb</span> <span class="nt">17</span> <span class="nt">23</span><span class="nd">:14:23</span> <span class="nt">EET</span> <span class="nt">2019</span>
<span class="o">;;</span> <span class="nt">MSG</span> <span class="nt">SIZE</span>  <span class="nt">rcvd</span><span class="o">:</span> <span class="nt">114</span>

</code></pre></div></div>
<p>SPF records
Записи SPF были изобретены для поддержки борьбы со спам-серверами. 
К сожалению, это оказалось неправильным представлением, и вы больше не можете полагаться на эти записи. 
SPF описывает, каким почтовым серверам разрешено отправлять электронную почту для домена, а какие нет. 
В некоторых случаях (например, списки рассылки) концепция SPF не работает. Тем не менее, некоторые провайдеры ожидают, 
что вы установите рекорд SPF - если вы этого не сделаете, вы получите некоторое количество баллов за ваш «рейтинг вероятности спама».</p>

<p>Итак, давайте сделаем компромисс и обеспечим нейтральную запись SPF:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">e-mag</span><span class="nc">.com.ua</span><span class="o">.</span> <span class="nt">3600</span> <span class="nt">IN</span> <span class="nt">TXT</span> <span class="nt">v</span><span class="o">=</span><span class="nt">spf1</span> <span class="nt">a</span><span class="nd">:mail</span><span class="nc">.e-mag.com.ua</span> <span class="o">?</span><span class="nt">all</span>

<span class="nt">domain2</span><span class="nc">.tld</span><span class="o">.</span> <span class="nt">3600</span> <span class="nt">IN</span> <span class="nt">TXT</span> <span class="nt">v</span><span class="o">=</span><span class="nt">spf1</span> <span class="nt">include</span><span class="nd">:e-mag</span><span class="nc">.com.ua</span> <span class="o">?</span><span class="nt">all</span>
<span class="nt">domain3</span><span class="nc">.tld</span><span class="o">.</span> <span class="nt">3600</span> <span class="nt">IN</span> <span class="nt">TXT</span> <span class="nt">v</span><span class="o">=</span><span class="nt">spf1</span> <span class="nt">include</span><span class="nd">:e-mag</span><span class="nc">.com.ua</span> <span class="o">?</span><span class="nt">all</span>
</code></pre></div></div>

<p>DMARC records</p>

<p>Записи DMARC устанавливают правила для сторонних почтовых серверов, которые сообщают им, как обращаться с не аутентифицированными 
или неправильно аутентифицированными электронными письмами. Если спамер отправляет поддельное электронное письмо и использует 
ваш домен e-mag.com.ua, принимающий сервер свяжется с DNS и запросит запись DMARC. 
Если он обнаруживает, что SPF или DKIM отказывают (что будет иметь место), сервер будет действовать в соответствии с записью DMARC. 
Это хорошая идея, чтобы отклонить такие электронные письма:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">_dmarc</span><span class="nc">.e-mag.com.ua</span><span class="o">.</span>   <span class="nt">3600</span>    <span class="nt">IN</span> <span class="nt">TXT</span>    <span class="nt">v</span><span class="o">=</span><span class="nt">DMARC1</span><span class="o">;</span> <span class="nt">p</span><span class="o">=</span><span class="nt">reject</span><span class="o">;</span>

<span class="nt">_dmarc</span><span class="nc">.domain2.tld</span><span class="o">.</span>   <span class="nt">3600</span>    <span class="nt">IN</span> <span class="nt">TXT</span>    <span class="nt">v</span><span class="o">=</span><span class="nt">DMARC1</span><span class="o">;</span> <span class="nt">p</span><span class="o">=</span><span class="nt">reject</span><span class="o">;</span>
<span class="nt">_dmarc</span><span class="nc">.domain3.tld</span><span class="o">.</span>   <span class="nt">3600</span>    <span class="nt">IN</span> <span class="nt">TXT</span>    <span class="nt">v</span><span class="o">=</span><span class="nt">DMARC1</span><span class="o">;</span> <span class="nt">p</span><span class="o">=</span><span class="nt">reject</span><span class="o">;</span>
</code></pre></div></div>
<p>Вы можете создать свои собственные записи политики DMARC на https://elasticemail.com/dmarc/.</p>

<p>Set up TLS certificates</p>

<p>Современный почтовый сервер не может работать серьезно без сертификатов TLS. 
Для этой цели мы будем использовать сертификаты Let Encrypt, поскольку они бесплатны и принимаются всеми браузерами, 
почтовыми клиентами и операционными системами. 
Если у вас уже есть действительные сертификаты, вы можете использовать их вместо.</p>

<p>Получить новые сертификаты</p>

<p>Используйте официальный клиент командной строки «certbot» для получения новых сертификатов для вашей почтовой системы:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">apt</span> <span class="nt">install</span> <span class="nt">certbot</span>

<span class="err">$</span> <span class="nt">certbot</span> <span class="nt">certonly</span> <span class="nt">--standalone</span> <span class="nt">--rsa-key-size</span> <span class="nt">4096</span> <span class="nt">-d</span> <span class="nt">mail</span><span class="nc">.e-mag.com.ua</span> <span class="nt">-d</span> <span class="nt">imap</span><span class="nc">.e-mag.com.ua</span> <span class="nt">-d</span> <span class="nt">smtp</span><span class="nc">.e-mag.com.ua</span>

</code></pre></div></div>

<p>Согласившись с условиями использования и указав свой адрес электронной почты, вы мгновенно получите действительные сертификаты. 
Они сохраняются по адресу: /etc/letsencrypt/live/mail.e-mag.com.ua и действительны для трех имен доменов вашей почтовой системы:
Ваши дополнительные домены «domain2» и «domain3» не должны быть включены в этот сертификат.</p>

<p>Есть несколько новых файлов, которые вам понадобятся:</p>

<ul>
  <li>cert.pem: 		Ваш почтовый сертификат</li>
  <li>chain.pem:		Сертификат CA</li>
  <li>fullchain.pem:	сертификат почтового сервера + сертификат CA</li>
  <li>privkey.pem:		Закрытый ключ для сертификата почтового сервера</li>
</ul>

<p>Далее будут использоваться только два файла сертификатов.</p>

<p>Auto-Renewal - Автоматическое продление cronjob:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">crontab</span> <span class="nt">-e</span>

<span class="k">@weekly</span> <span class="n">certbot</span> <span class="n">renew</span> <span class="n">--pre-hook</span> <span class="s1">"systemctl stop nginx"</span> <span class="n">--post-hook</span> <span class="s1">"systemctl start nginx"</span> <span class="n">--renew-hook</span> <span class="s1">"systemctl reload nginx; 
systemctl reload dovecot; 
systemctl reload postfix"</span> <span class="n">--quiet</span>

</code></pre></div></div>

<p>MySQL database setup</p>

<p>Создайте новую базу данных с именем «vmail»:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">create</span> <span class="nt">database</span> <span class="nt">vmail</span> <span class="nt">CHARACTER</span> <span class="nt">SET</span> <span class="s2">'utf8'</span><span class="o">;</span>

<span class="nt">grant</span> <span class="nt">select</span> <span class="nt">on</span> <span class="nt">vmail</span><span class="o">.*</span> <span class="nt">to</span> <span class="s2">'vmail'</span><span class="o">@</span><span class="s2">'localhost'</span> <span class="nt">identified</span> <span class="nt">by</span> <span class="s2">'vmaildbpass'</span><span class="o">;</span>

<span class="nt">use</span> <span class="nt">vmail</span><span class="o">;</span>

<span class="nt">CREATE</span> <span class="nt">TABLE</span> <span class="err">`</span><span class="nt">domains</span><span class="err">`</span> <span class="o">(</span>
    <span class="err">`</span><span class="nt">id</span><span class="err">`</span> <span class="nt">int</span> <span class="nt">unsigned</span> <span class="nt">NOT</span> <span class="nt">NULL</span> <span class="nt">AUTO_INCREMENT</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">domain</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="nt">PRIMARY</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">id</span><span class="err">`</span><span class="o">),</span>
    <span class="nt">UNIQUE</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">)</span>
<span class="o">);</span>

<span class="nt">CREATE</span> <span class="nt">TABLE</span> <span class="err">`</span><span class="nt">accounts</span><span class="err">`</span> <span class="o">(</span>
    <span class="err">`</span><span class="nt">id</span><span class="err">`</span> <span class="nt">int</span> <span class="nt">unsigned</span> <span class="nt">NOT</span> <span class="nt">NULL</span> <span class="nt">AUTO_INCREMENT</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">username</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">64</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">domain</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">password</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">quota</span><span class="err">`</span> <span class="nt">int</span> <span class="nt">unsigned</span> <span class="nt">DEFAULT</span> <span class="s2">'0'</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">enabled</span><span class="err">`</span> <span class="nt">boolean</span> <span class="nt">DEFAULT</span> <span class="s2">'0'</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">sendonly</span><span class="err">`</span> <span class="nt">boolean</span> <span class="nt">DEFAULT</span> <span class="s2">'0'</span><span class="o">,</span>
    <span class="nt">PRIMARY</span> <span class="nt">KEY</span> <span class="o">(</span><span class="nt">id</span><span class="o">),</span>
    <span class="nt">UNIQUE</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">username</span><span class="err">`</span><span class="o">,</span> <span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">),</span>
    <span class="nt">FOREIGN</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">)</span> <span class="nt">REFERENCES</span> <span class="err">`</span><span class="nt">domains</span><span class="err">`</span> <span class="o">(</span><span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">)</span>
<span class="o">);</span>

<span class="nt">CREATE</span> <span class="nt">TABLE</span> <span class="err">`</span><span class="nt">aliases</span><span class="err">`</span> <span class="o">(</span>
    <span class="err">`</span><span class="nt">id</span><span class="err">`</span> <span class="nt">int</span> <span class="nt">unsigned</span> <span class="nt">NOT</span> <span class="nt">NULL</span> <span class="nt">AUTO_INCREMENT</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">source_username</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">64</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">source_domain</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">destination_username</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">64</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">destination_domain</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">enabled</span><span class="err">`</span> <span class="nt">boolean</span> <span class="nt">DEFAULT</span> <span class="s2">'0'</span><span class="o">,</span>
    <span class="nt">PRIMARY</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">id</span><span class="err">`</span><span class="o">),</span>
    <span class="nt">UNIQUE</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">source_username</span><span class="err">`</span><span class="o">,</span> <span class="err">`</span><span class="nt">source_domain</span><span class="err">`</span><span class="o">,</span> <span class="err">`</span><span class="nt">destination_username</span><span class="err">`</span><span class="o">,</span> <span class="err">`</span><span class="nt">destination_domain</span><span class="err">`</span><span class="o">),</span>
    <span class="nt">FOREIGN</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">source_domain</span><span class="err">`</span><span class="o">)</span> <span class="nt">REFERENCES</span> <span class="err">`</span><span class="nt">domains</span><span class="err">`</span> <span class="o">(</span><span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">)</span>
<span class="o">);</span>

<span class="nt">CREATE</span> <span class="nt">TABLE</span> <span class="err">`</span><span class="nt">tlspolicies</span><span class="err">`</span> <span class="o">(</span>
    <span class="err">`</span><span class="nt">id</span><span class="err">`</span> <span class="nt">int</span> <span class="nt">unsigned</span> <span class="nt">NOT</span> <span class="nt">NULL</span> <span class="nt">AUTO_INCREMENT</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">domain</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">policy</span><span class="err">`</span> <span class="nt">enum</span><span class="o">(</span><span class="s2">'none'</span><span class="o">,</span> <span class="s2">'may'</span><span class="o">,</span> <span class="s2">'encrypt'</span><span class="o">,</span> <span class="s2">'dane'</span><span class="o">,</span> <span class="s2">'dane-only'</span><span class="o">,</span> <span class="s2">'fingerprint'</span><span class="o">,</span> <span class="s2">'verify'</span><span class="o">,</span> <span class="s2">'secure'</span><span class="o">)</span> <span class="nt">NOT</span> <span class="nt">NULL</span><span class="o">,</span>
    <span class="err">`</span><span class="nt">params</span><span class="err">`</span> <span class="nt">varchar</span><span class="o">(</span><span class="nt">255</span><span class="o">),</span>
    <span class="nt">PRIMARY</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">id</span><span class="err">`</span><span class="o">),</span>
    <span class="nt">UNIQUE</span> <span class="nt">KEY</span> <span class="o">(</span><span class="err">`</span><span class="nt">domain</span><span class="err">`</span><span class="o">)</span>
<span class="o">);</span>

<span class="nt">quit</span><span class="o">;</span>
</code></pre></div></div>

<p>vmail-user and vmail-directory</p>

<p>Все электронные письма и скриптовые файлы сохраняются в специальном каталоге / var / vmail. 
Только связанный пользователь vmail имеет к нему доступ. Dovecot будет использовать эту учетную запись для выполнения 
своих операций в файловой системе. Создать vmail-каталог:</p>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="nt">mkdir</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span>

<span class="err">$</span> <span class="nt">adduser</span> <span class="nt">--disabled-login</span> <span class="nt">--disabled-password</span> <span class="nt">--home</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span> <span class="nt">vmail</span>

<span class="err">$</span> <span class="nt">mkdir</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span><span class="o">/</span><span class="nt">mailboxes</span>
<span class="err">$</span> <span class="nt">mkdir</span> <span class="nt">-p</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span><span class="o">/</span><span class="nt">sieve</span><span class="o">/</span><span class="nt">global</span>

<span class="err">$</span> <span class="nt">chown</span> <span class="nt">-R</span> <span class="nt">vmail</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span>
<span class="err">$</span> <span class="nt">chgrp</span> <span class="nt">-R</span> <span class="nt">vmail</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span>
<span class="err">$</span> <span class="nt">chmod</span> <span class="nt">-R</span> <span class="nt">770</span> <span class="o">/</span><span class="nt">var</span><span class="o">/</span><span class="nt">vmail</span>

</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#Postfix" title="Pages tagged Postfix" class="tag"><span class="term">Postfix</span></a><a href="http://localhost:4000/tags/#Ubuntu" title="Pages tagged Ubuntu" class="tag"><span class="term">Ubuntu</span></a><a href="http://localhost:4000/tags/#Mail" title="Pages tagged Mail" class="tag"><span class="term">Mail</span></a></span>
        <span>Updated on <span class="entry-date date updated"><time datetime="2019-02-16">February 16, 2019</time></span></span>
        <span class="author vcard"><span class="fn">Sergey Khatsiola</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/Mail_server/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://localhost:4000/Mail_server/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://localhost:4000/Mail_server/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://localhost:4000/Mount_new_HardDisk/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://localhost:4000/Git/" title="Просто о GIT">Просто о GIT</a></h3>
      <p>Шпаргалка GIT <a href="http://localhost:4000/Git/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/UML_resources/" title="UML средство проектирования и разработки">UML средство проектирования и разработки</a></h4>
        <span>Published on May 31, 2019</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/Oracle_RESOURCE/" title="Базы данных. Oracle">Базы данных. Oracle</a></h4>
        <span>Published on May 31, 2019</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2019 Sergey Khatsiola. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-130427752-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


	        

</body>
</html>
