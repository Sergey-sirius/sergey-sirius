<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Приложение E. Замечания к выпуску &#8211; Sirius Blog</title>
<meta name="description" content="">
<meta name="keywords" content="PostgreSQL, PostgreSQL_Book_11">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:4000/images/abstract-11.jpg">

<meta name="twitter:title" content="Приложение E. Замечания к выпуску">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@2hotab2">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Приложение E. Замечания к выпуску">
<meta property="og:description" content="">
<meta property="og:url" content="http://localhost:4000/PostgreSQL-V11_Doc-075/">
<meta property="og:site_name" content="Sirius Blog">





<link rel="canonical" href="http://localhost:4000/PostgreSQL-V11_Doc-075/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Sirius Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">
<!-- Webfonts -->
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.jpg">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.jpg">
<!-- 114x72 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x72" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.jpg">
<!-- 144x72 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x72" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.jpg">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
	<button class="dl-trigger">Open Menu</button>
	<ul class="dl-menu">
		<li><a href="http://localhost:4000/">Home</a></li>
		<li>
			<a href="#">About</a>
			<ul class="dl-submenu">
				<li>
					<img src="http://localhost:4000/images/avatar.jpg" alt="Sergey Khatsiola photo" class="author-photo">
					<h4>Sergey Khatsiola</h4>
					<p>Кратко обо мне ...</p>
				</li>
				<li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li>
				<li>
					<a href="mailto:2hotab2@gmail.com"><i class="fa fa-fw fa-envelope"></i> Email</a>
				</li>
				<li>
					<a href="https://twitter.com/2hotab2"><i class="fa fa-fw fa-twitter"></i> Twitter</a>
				</li>
				<li>
					<a href="https://facebook.com/sergej.ha1"><i class="fa fa-fw fa-facebook"></i> Facebook</a>
				</li>
				
				
				<li>
					<a href="https://github.com/Sergey-sirius"><i class="fa fa-fw fa-github"></i> GitHub</a>
				</li>
				
				
				
				
			</ul><!-- /.dl-submenu -->
		</li>
		<li>
			<a href="#">Posts</a>
			<ul class="dl-submenu">
				<li><a href="http://localhost:4000/posts/">All Posts</a></li>
				<li><a href="http://localhost:4000/tags/">All Tags</a></li>
			</ul>
		</li>
		
	    
	    <li><a href="http://localhost:4000/handbook/" >HandBook</a></li>
	  
	    
	    <li><a href="http://localhost:4000/postgres/" >PostgreSQL_11</a></li>
	  
	    
	    <li><a href="http://mademistakes.com" target="_blank">Main Link</a></li>
	  
	</ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="http://localhost:4000/images/abstract-11.jpg" alt="Приложение E. Замечания к выпуску">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="http://localhost:4000/PostgreSQL-V11_Doc-075/" rel="bookmark" title="Приложение E. Замечания к выпуску">Приложение E. Замечания к выпуску</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2018-12-01T00:00:00+02:00">December 01, 2018</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~375 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>Приложение E. Замечания к выпуску</p>

<p>В замечаниях к выпуску отмечаются значительные изменения, имевшие место в каждом выпуске
PostgreSQL, при этом ключевые изменения и вопросы миграции освещаются в самом начале. В
эти замечания не включаются изменения, затрагивающие лишь нескольких пользователей, как
и изменения внутренние и поэтому пользователям не заметные. Например, оптимизатор усовер-
шенствуется почти в каждом выпуске, но для пользователей эти улучшения проявляются обычно
просто в ускорении запросов.
Полный список изменений каждого выпуска можно получить, просмотрев журналы Git для этого
выпуска. Также все изменения в исходном коде отражаются в списке рассылки pgsql-committers.
Кроме того, имеется веб-интерфейс, в котором можно просмотреть изменения в разрезе файлов.
Имя, указанное рядом с каждым пунктом, показывает, кто был основным разработчиком этого из-
менения. Но, конечно, с каждым из изменений связано обсуждение в сообществе и анализ пред-
лагаемой правки, так что на самом деле каждый из этих пунктов — плод работы сообщества.
E.1. Выпуск 11.1
Дата выпуска:
2018-11-08
В этот выпуск вошли различные исправления, внесённые после версии 11.0. За информацией о
нововведениях версии 11 обратитесь к Разделу E.2.
E.1.1. Миграция на версию 11.1
Если используется версия 11.X, выгрузка/восстановление базы не требуется.
Однако если вы используете расширение pg_stat_statements, прочитайте запись о нём в списке
изменений.
E.1.2. Изменения
• Корректное заключение в кавычки имён переходных таблиц в командах CREATE TRIGGER …
REFERENCING, которые выдаёт pg_dump (Том Лейн)
Отсутствием кавычек мог воспользоваться непривилегированный пользователь с целью полу-
чения прав суперпользователя при последующем восстановлении выгруженных данных или
выполнении pg_upgrade. (CVE-2018-16850)
• Размещение создаваемого дочернего индекса в табличном пространстве, выбранном для сек-
ционированного индекса (Альваро Эррера)
Ранее дочерние индексы всегда создавались в табличном пространстве по умолчанию.
• Исправление обработки NULL при выполнении распараллеливаемых многопакетных левых со-
единений по хешу (Эндрю Гирт, Томас Мунро)
Ранее строки внешнего отношения, содержащие значения NULL в ключе хеширования, не по-
падали в результат соединения.
• Исправление некорректной обработки выражения, содержащего приведение типа к масси-
ву, внутри предложения CASE, в котором проверяемое выражение является константой (Том
Лейн)
• Исправление некорректного расширения кортежей, не содержащих недавно добавленных
столбцов (Эндрю Дунстан, Амит Ланготе)
В результате этого дефекта наблюдался крах сервера в коде триггера таблицы, в которую до-
бавлялись столбцы; однако были возможны и другие проявления.
• Исправление ошибок в обработке аргументов с именами или значениями по умолчанию, пере-
даваемых в списке аргументов команде CALL (Том Лейн, Павел Стехуле)
2277Замечания к выпуску
• Исправление проверки строгости для агрегатов со столбцами ORDER BY (Эндрю Гирт, Андрес
Фройнд)
Логика проверки строгости функции ошибочно игнорировала строки, в которых значения
столбцов ORDER BY были равны NULL.
• Отключение оптимизации recheck_on_update (Том Лейн)
Эта появившаяся в 11 версии функциональность оказалась не готовой к публичному выступ-
лению. Поэтому решено было её убрать, пока она не будет исправлена.
• Недопущение создания секции в триггере, присоединённом к родительской таблице (Амит
Ланготе)
В идеале такое создание можно было бы разрешить, но в данный момент оно блокируется во
избежание сбоев.
• Устранение проблем с применением ON COMMIT DELETE ROWS к секционированной временной
таблице (Амит Ланготе)
• Исправление проверок классов символов для корректной поддержки в Windows символов
Unicode выше U+FFFF (Том Лейн, Кэндзи Уно)
Эта ошибка проявлялась в операциях полнотекстового поиска, а также в работе модулей
contrib/ltree и contrib/pg_trgm.
• Обеспечение обработки сервером уже полученных прерываний NOTIFY и SIGTERM до начала
ожидания данных от клиента (Джефф Джейнс, Том Лейн)
• Ликвидация утечки памяти при сканировании индекса SP-GiST (Том Лейн)
Сколько-нибудь значительное проявление этой утечки наблюдалось, только когда для ограни-
чения-исключения, использующего SP-GiST, в индекс поступало много записей.
• Предотвращение запуска сервера со значением wal_level, недостаточно большим для под-
держки существующего слота репликации (Андрес Фройнд)
• Исправление кода psql, а также примеров в документации, чтобы функция PQconsumeInput()
вызывалась перед PQnotifies() (Том Лейн)
Тем самым решена проблема, когда psql не выдавал полученное сообщение NOTIFY до следую-
щей команды.
• Исправление в pg_verify_checksums выбора файлов для проверки контрольных сумм (Микаэль
Пакье)
В некоторых случаях несоответствие контрольной суммы выявлялось в тех файлах, в которых
она не должна проверяться.
• В contrib/pg_stat_statements роли pg_read_all_stats запрещено выполнение
pg_stat_statements_reset() (Харибабу Комми)
Роли pg_read_all_stats должно позволяться только чтение статистики, но не её изменение,
поэтому разрешение на выполнение этой функции ей было дано некорректно.
Чтобы это изменение вступило в силу, выполните ALTER EXTENSION pg_stat_statements
UPDATE в каждой базе данных, где установлено расширение pg_stat_statements. (Для баз дан-
ных, изначально созданных в версии 11.0, это не должно требоваться, но базы, обновлённые
с предыдущей версии, могут содержать старую версию pg_stat_statements. Если модуль был
обновлён ранее, команда UPDATE не сделает ничего.)
• Переход в названиях функций поддержки red-black tree (красно-чёрного дерева) от префикса
rb к rbt (Том Лейн)
Это позволяет избежать конфликта имён с функциями Ruby, нарушающего работу PL/Ruby. Хо-
чется надеяться, что в результате не пострадают другие расширения.
2278Замечания к выпуску
• Устранение проблем при сборке в macOS 10.14 (Mojave) (Том Лейн)
Усовершенствование скрипта configure, чтобы в CPPFLAGS добавлялся ключ -isysroot; без
этого PL/Perl и PL/Tcl нельзя сконфигурировать или собрать в macOS 10.14. Значение sysroot
можно переопределить во время конфигурирования или сборки, установив переменную
PG_SYSROOT в аргументах configure или make.
Теперь рекомендуется, чтобы для связанных с Perl расширений во флагах компилятора указы-
валось $(perl_includespec), а не -I$(perl_archlibexp)/CORE. Второй вариант по-прежнему
будет работать на большинстве платформ, но не в последних macOS.
Также теперь не требуется указывать вручную ключ –with-tclconfig, чтобы собрать PL/Tcl в
последних версиях macOS.
• Исправление скриптов сборки с MSVC и регрессионного тестирования для работы с последни-
ми версиями Perl (Эндрю Дунстан)
Это изменение вызвано тем, что Perl теперь по умолчанию не включает текущий каталог в
свой путь поиска.
• Реализована возможность запускать регрессионные тесты в Windows с учётной записью адми-
нистратора (Эндрю Дунстан)
Чтобы это было безопасно, pg_regress теперь лишает себя расширенных прав при запуске.
• Обновление данных часовых поясов до версии tzdata 2018g, включающее изменений правил
перехода на летнее время в России (Волгограде), Чили, Марокко и на Фиджи, а также коррек-
тировку исторических данных для Китая, Гавайев, Японии, Макао и Северной Кореи.
E.2. Выпуск 11
Дата выпуска:
2018-10-18
E.2.1. Обзор
В число ключевых усовершенствований PostgreSQL 11 входят:
• Усовершенствования, связанные с секционированием:
• Реализована поддержка секционирования по хешу
• Реализована поддержка ключей PRIMARY KEY, FOREIGN KEY, индексов и триггеров в секцио-
нированных таблицах
• Добавлена возможность создания секции по умолчанию, содержащей строки, не попадаю-
щие ни в одну другую секцию
• При изменении операторами UPDATE значений ключа разбиения в строках секционирован-
ной таблицы эти строки теперь будут переноситься в соответствующие секции
• Улучшена производительность SELECT благодаря стратегиям оптимизированного устране-
ния секций при планировании и выполнении запросов
• Усовершенствования, связанные с распараллеливанием:
• Команда CREATE INDEX теперь может строить индекс-B-дерево параллельно
• Стало возможным параллельное выполнение CREATE TABLE .. AS, CREATE MATERIALIZED
VIEW и некоторых запросов с UNION
• Распараллеливаемые соединения по хешу и распараллеливаемые последовательные скани-
рования теперь выполняются эффективнее
• Хранимые процедуры на SQL, поддерживающие внутренние транзакции
• Возможность JIT-компиляции некоторого кода SQL, позволяющая ускорить вычисление выра-
жений
2279Замечания к выпуску
• Оконные функции теперь поддерживают все варианты описания рамки, определённые в стан-
дарте SQL:2011, включая RANGE смещение PRECEDING/FOLLOWING, режим GROUPS и рамки с ис-
ключением
• Возможность создания покрывающих индексов, которые определяются предложением
INCLUDE команды CREATE INDEX
• Много других улучшений, увеличивающих производительность, в частности возможность
избежать перезаписи таблицы при выполнении ALTER TABLE .. ADD COLUMN с отличным от
NULL значением по умолчанию
Предыдущие пункты более подробно описаны в следующих разделах.
E.2.2. Миграция на версию 11
Тем, кто хочет мигрировать данные из любой предыдущей версии, необходимо выполнить выгруз-
ку/загрузку данных с помощью pg_dumpall или воспользоваться pg_upgrade.
В версии 11 реализован ряд изменений, которые могут повлиять на совместимость с предыдущими
выпусками. Рассмотрите следующие несовместимые аспекты:
• pg_dump теперь выгружает и свойства базы данных, а не только её содержимое (Харибабу
Комми)
Ранее такие атрибуты базы данных, как разрешения GRANT/REVOKE уровня базы данных и на-
значения переменных ALTER DATABASE SET, выгружались только утилитой pg_dumpall. Теперь
при выполнении pg_dump –create и pg_restore –create в дополнение к объектам базы бу-
дут восстанавливаться и такие её свойства. При этом pg_dumpall -g будет выводить только
атрибуты, связанные с ролями и табличными пространствами. Содержимое полного вывода
pg_dumpall (без -g) не изменилось.
Команды pg_dump и pg_restore без ключа –create теперь не выгружают/не восстанавливают
комментарии на уровне базы и метки безопасности; эти атрибуты теперь считаются свойства-
ми базы данных.
При восстановлении вывода pg_dumpall теперь базы данных всегда должны восстанавливаться
с исходными локалями и кодировками, и поэтому, если локаль или кодировка окажется неиз-
вестной в целевой системе, произойдёт ошибка. Ранее команда CREATE DATABASE выдавалась
без таких указаний, если локаль и кодировка базы данных не отличались от установленных по
умолчанию в старом кластере.
pg_dumpall –clean теперь позволяет восстановить исходные параметры локали и кодировки
для баз данных postgres и template1, а не только для баз, создаваемых пользователями.
• Неоднозначность между вызовом функции и обращением к столбцу теперь разрешается с учё-
том синтаксической формы (Том Лейн)
В предположении, что x — имя таблицы или составного столбца, PostgreSQL традиционно
считал синтаксические формы f(x) и x.f равнозначными. Это позволяло использовать такие
приёмы, как вызов специально написанной функции в виде обращения к вычисляемому столб-
цу. Однако в случаях, допускающих оба прочтения, ранее всегда выбиралось прочтение столб-
ца, что приводило к неожиданным результатам, когда пользователь намеревался именно вы-
звать функцию. Теперь в случае подобной неоднозначности прочтение выбирается в зависи-
мости от синтаксической формы.
• Строгое требование уникальности для имён ограничений таблиц и доменов (Том Лейн)
PostgreSQL ожидает, что имена ограничений таблицы, как и имена ограничений доменов, бу-
дут уникальными. Однако ранее это не контролировалось явно, и в особых случаях могли по-
являться дублирующиеся имена.
• Обработка в функциях power(numeric, numeric) и power(float8, float8) аргументов NaN в
соответствии со стандартом POSIX (Том Лейн, Дан Мин Хыонг)
2280Замечания к выпуску
Согласно стандарту POSIX, NaN ^ 0 = 1 и 1 ^ NaN = 1, а во всех других случаях с аргумен-
тами NaN должно возвращаться значение NaN. Ранее power(numeric, numeric) просто всегда
возвращала NaN; сейчас она учитывает эти два исключения. power(float8, float8) следовала
стандарту в зависимости от поведения нижележащей библиотеки C; однако на некоторых ста-
рых платформах Unix эта библиотека работала некорректно, и кроме того, возникали расхож-
дения в некоторых версиях Windows.
• Недопущение игнорирования функцией to_number() символов, которые не соответствуют сим-
волам в шаблоне (Оливер Форд)
В частности, SELECT to_number(‘1234’, ‘9,999’) раньше возвращала 134. Теперь она возвра-
щает 1234. Символы в шаблоне L и TH теперь будут поглощать только символы, отличные от
цифр, знаков плюс/минус, десятичной точки и запятой.
• Исправление поведения to_date(), to_number(), и to_timestamp(), чтобы для каждого симво-
ла в шаблоне пропускался один символ в данных (Том Лейн)
Ранее они пропускали один байт для каждого байта, составляющего символ шаблона, что
приводило к неадекватному поведению при наличии многобайтных символов в шаблоне или
вводимой строке.
• В to_char(), to_number() и to_timestamp() исправлена обработка символов обратной косой
черты в двойных кавычках внутри строки шаблона.
Такие символы теперь экранируют следующий за ними символ, а именно символ кавычек или
другую обратную косую черту.
• Корректная обработка выражений с относительными путями в xmltable(), xpath() и других
функциях, работающих с XML (Маркус Винанд)
Согласно стандарту SQL, относительные пути нужно рассматривать от узла документа XML, а
не от корневого узла, как раньше это делали данные функции.
• В протоколе расширенных запросов значение statement_timeout должно применяться к каж-
дому отдельному сообщению Execute, а не ко всем командам до Sync (Тацуо Исии, Андрес
Фройнд)
• Удаление столбца relhaspkey из системного каталога pg_class (Питер Эйзентраут)
Приложения, которым нужно проверить первичный ключ, должны обращаться в pg_index.
• Замена столбцов proisagg и proiswindow в системном каталоге pg_proc на prokind (Питер Эй-
зентраут)
Новый столбец более чётко выделяет функции, процедуры, а также агрегатные и оконные
функции.
• Откорректировано содержимое столбца информационной схемы tables.table_type — значе-
ние FOREIGN TABLE изменено на FOREIGN (Питер Эйзентраут)
Новое содержимое соответствует стандарту SQL.
• Изменены отображаемые в ps имена фоновых рабочих процессов для соответствия меткам
pg_stat_activity.backend_type (Питер Эйзентраут)
• Проверка разрешений для использования больших объектов теперь происходит при открытии
объекта, в функции lo_open(), а не при попытке чтения/записи (Том Лейн, Микаэль Пакье)
Теперь в случае отсутствия прав на запись будет выдаваться ошибка, тогда как раньше её мог-
ло не быть, если собственно запись в большой объект вообще не производилась.
• Разрешение переиндексирования общих каталогов только для суперпользователей (Микаэль
Пакье, Роберт Хаас)
2281Замечания к выпуску
Ранее это также могли делать владельцы баз данных, но теперь эта операция считается выхо-
дящей за рамки их полномочий.
• Удаление устаревших функций adminpack pg_file_read(), pg_file_length() и
pg_logfile_rotate() (Стивен Фрост)
Равнозначная функциональность теперь представлена в ядре сервера. Старые инсталляции
adminpack продолжат использовать эти функции, пока не будут обновлены посредством ALTER
EXTENSION … UPDATE.
• Параметры команд, заключённые в двойные кавычки, стали восприниматься с учётом реги-
стра (Даниэль Густафссон)
Ранее имена параметров в определённых SQL-командах принудительно приводились к нижне-
му регистру, даже когда они задавались в кавычках; так, например, “FillFactor” восприни-
малось как имя параметра хранения индекса, тогда как правильное имя должно записываться
строчными буквами. Теперь в подобных случаях будет выдаваться ошибка.
• Ликвидация серверного параметра replacement_sort_tuples (Питер Геохеган)
Было решено, что сортировка с замещением в настоящее время не имеет практической поль-
зы.
• Удаление предложения WITH в CREATE FUNCTION (Микаэль Пакье)
PostgreSQL уже долгое время поддерживает более стандартный вариант записи для этой воз-
можности.
E.2.3. Изменения
Ниже вы найдёте подробный список изменений, произошедших между предыдущим основным вы-
пуском и выпуском PostgreSQL 11.
E.2.3.1. Сервер
E.2.3.1.1. Секционирование
• Возможность создания секций по хешу ключевого столбца (Амул Сул)
• Поддержка индексов в секционированных таблицах (Альваро Эррера, Амит Ланготе)
«Индекс» в секционированной таблице надо понимать не как физический индекс, построен-
ный по всей этой таблице, а скорее как шаблон автоматического создания подобных индексов
в каждой секции таблицы.
Если ключ секционирования входит в набор столбцов индекса, секционированный индекс мо-
жет иметь характеристику UNIQUE. В этом случае он будет представлять собой полноценное
ограничение уникальности во всей секционированной таблице, несмотря на то, что каждый
физический индекс обеспечивает уникальность только в отдельной секции.
Новая команда ALTER INDEX ATTACH PARTITION позволяет связать существующий в определён-
ной секции индекс с соответствующим шаблоном индекса для содержащей её секционирован-
ной таблицы. Это даёт возможность гибко образовывать новые секционированные индексы
для существующих секционированных таблиц.
• Возможность создавать внешние ключи с секционированными таблицами (Альваро Эррера)
• Поддержка триггеров FOR EACH ROW в секционированных таблицах (Альваро Эррера)
При создании триггера в секционированной таблице автоматически создаются триггеры во
всех её существующих и в добавляемых впоследствии секциях. Это также позволяет реализо-
вать отложенные ограничения уникальности в секционированных таблицах.
• Возможность определить для секционированной таблицы секцию по умолчанию (Дживан Лад-
хе, Бина Эмерсон, Ашутош Бапат, Рахила Сьед, Роберт Хаас)
2282Замечания к выпуску
Секция по умолчанию будет содержать строки, не попадающие ни в одну из других секций,
что соответствующим образом учитывается при поиске.
• При изменении операторами UPDATE значений ключа разбиения в строках секционированной
таблицы эти строки теперь будут переноситься в соответствующие секции (Амит Хандекар)
• При выполнении в секционированных таблицах команд INSERT, UPDATE и COPY строки долж-
ным образом перенаправляются в секции, размещённые в сторонних таблицах (Эцуро Фудзи-
та, Амит Ланготе)
Эта функциональность поддерживается обёрткой сторонних таблиц postgres_fdw.
• Реализована возможность быстрого устранения секций при обработке запросов (Амит Ланго-
те, Дэвид Роули, Дилип Кумар)
Она позволяет ускорить доступ к секционированным таблицам со многими секциями.
• Реализована возможность устранения секций при выполнении запроса (Дэвид Роули, Бина
Эмерсон)
Ранее секции исключались только во время планирования, так что во многих соединениях и
подготовленных запросах осуществить исключение секций было невозможно.
• При соединении секционированных таблиц по равенству строк реализована возможность со-
единения непосредственно соответствующих секций (Ашутош Бапат)
По умолчанию эта возможность отключена, но её можно включить, изменив параметр
enable_partitionwise_join.
• Возможность вычисления агрегатных функций в секционированных таблицах по отдельным
секциям с последующим объединением результатов (Дживан Чок, Ашутош Бапат, Роберт Ха-
ас)
Эта функциональность по умолчанию отключена, но её можно включить, изменив параметр
enable_partitionwise_aggregate.
• В postgres_fdw реализована возможность распределять агрегатные вычисления в секциони-
рованных таблицах по сторонним таблицам-секциям (Дживан Чок)
E.2.3.1.2. Параллельное выполнение запросов
• Возможность параллельного построения индексов btree (Питер Геохеган, Рушаб Латиа, Хейк-
ки Линнакангас)
• Возможность выполнения соединения по хешу в параллельном режиме с использованием об-
щей хеш-таблицы (Томас Мунро)
• При выполнении UNION образующие его запросы SELECT могут выполняться параллельно, если
отдельный SELECT не может быть распараллелен (Амит Хандекар, Роберт Хаас, Амул Сул)
• Сканирование секций может более эффективно использовать параллельные исполнители
(Амит Хандекар, Роберт Хаас, Амул Сул)
• Указание LIMIT может передаваться параллельным исполнителям (Роберт Хаас, Том Лейн)
Благодаря этому рабочие процессы могут возвращать меньший объём результатов и использо-
вать целенаправленное сканирование индекса.
• Возможность распараллеливания запросов, выполняемых разово, например, агрегатных за-
просов в предложении WHERE и функций в выходном списке запроса (Амит Капила, Роберт Ха-
ас)
• Добавление серверного параметра parallel_leader_participation, управляющего участием
ведущего процесса в выполнении подпланов (Томас Мунро)
По умолчанию этот параметр включён, то есть ведущий будет исполнять подпланы.
2283Замечания к выпуску
• Возможность распараллеливания команд CREATE TABLE … AS, SELECT INTO и CREATE
MATERIALIZED VIEW (Харибабу Комми)
• Увеличение скорости последовательного сканирования со множеством параллельных испол-
нителей (Дэвид Роули)
• Добавление в вывод EXPLAIN информации о действиях, выполняемых при сортировке с парал-
лельными исполнителями (Роберт Хаас, Том Лейн)
E.2.3.1.3. Индексы
• Возможность включать в индексы-B-деревья столбцы, которые не входят в ограничение уни-
кальности или ключ поиска, но могут быть прочитаны при сканировании только индекса (Ана-
стасия Лубенникова, Александр Коротков, Фёдор Сигаев)
Для определения таких индексов предназначено новое предложение INCLUDE команды CREATE
INDEX. Таким образом стало возможным создавать «покрывающие индексы», оптимизирую-
щие некоторые типы запросов. В покрывающий индекс могут включаться столбцы даже с та-
кими типами данных, которые не поддерживает B-дерево.
• Ускорение добавления в индекс монотонно увеличивающихся ключей (Паван Деоласи, Питер
Геохеган)
• Улучшение производительности сканирования хеш-индекса (Томаш Вондра, Роберт Хаас)
• Добавление предикатных блокировок для индексов GiST, GIN и хеш-индексов (Шубхам Барай)
Благодаря этому уменьшается вероятность конфликтов сериализации для транзакций в сериа-
лизуемом режиме.
E.2.3.1.3.1. SP-GiST
• Добавление оператора сопоставления префиксов text ^@ text и реализация его поддержки в
SP-GiST (Ильдус Курбангалиев)
Он действует подобно конструкции переменная LIKE ‘слово%’ с индексом btree, но обрабаты-
вается более эффективно.
• Возможность индексирования многоугольников с SP-GiST (Никита Глухов, Александр Корот-
ков)
• Возможность использования в SP-GiST неточного представления ключей на уровне листьев
(Фёдор Сигаев, Хейкки Линнакангас, Александр Коротков, Никита Глухов)
E.2.3.1.4. Оптимизатор
• Улучшение выбора наиболее типичных значений для статистики (Джефф Джейнс, Дин Ра-
шид)
Ранее наиболее типичные значения (Most-Common-Values, MCV) выбирались с учётом их ча-
стоты относительно всех других значений столбца. Теперь MCV выбираются с учётом их ча-
стоты относительно значений, не попадающих в число MCV. Это способствует улучшению ста-
тистики для равномерного и неравномерного распределения.
• Улучшение оценок избирательности для &gt;= и &lt;= (Том Лейн)
Ранее для них применялась та же оценка избирательности, что и для операторов &gt; и &lt;, соот-
ветственно, за исключением сравнения с константами из числа MCV. Это изменение особенно
полезно для условий BETWEEN с маленькими диапазонами.
• Сведение выражения переменная = переменная к выражению переменная IS NOT NULL там, где
они равнозначны (Том Лейн)
Благодаря этому улучшается оценка избирательности.
• Улучшение оценки числа строк оптимизатором для запросов EXISTS и NOT EXISTS (Том Лейн)
2284Замечания к выпуску
• Усовершенствование оптимизатора, чтобы он учитывал стоимость вычислений и избиратель-
ность для предложений HAVING (Том Лейн)
E.2.3.1.5. Общая производительность
• Реализация JIT-компиляции некоторых частей планов для ускорения выполнения запросов
(Андрес Фройнд)
Для этой функциональности требуется наличие LLVM. По умолчанию она отключена, даже в
сборках, обеспечивающих её поддержку.
• Возможность выполнения при определённых условиях сканирования битовой карты подобно
сканированию только индекса (Александр Кузьменков)
• Обновление карты свободного пространства во время VACUUM (Клаудио Фрейре)
Это позволяет задействовать освободившееся пространство более оперативно.
• Исключение ненужных операций сканирований индекса при выполнении VACUUM (Масахико
Савада, Александр Коротков)
• Увеличение производительности при одновременном фиксировании множества транзакций
(Амит Капила)
• Более эффективное использование памяти при выполнении запросов, в списках результатов
которых фигурируют функции, возвращающие множества (Андрес Фройнд)
• Ускорение агрегатных вычислений (Андрес Фройнд)
• Реализация в postgres_fdw возможности передавать на сторонние серверы запросы UPDATE и
DELETE, использующие соединения (Эцуро Фудзита)
Ранее могли передаваться только UPDATE и DELETE без соединений.
• Добавление поддержки больших страниц в Windows (Такаюки Цунакава, Томас Мунро)
Эта поддержка включается параметром конфигурации huge_pages.
E.2.3.1.6. Мониторинг
• Добавление информации об использовании памяти в вывод log_statement_stats,
log_parser_stats, log_planner_stats и log_executor_stats (Джастин Призби, Питер Эйзен-
траут)
• Добавление поля pg_stat_activity.backend_type, в котором показывается тип рабочего про-
цесса (Питер Эйзентраут)
Этот тип также можно увидеть в выводе ps.
• В режиме log_autovacuum_min_duration добавлен вывод сообщений о таблицах, которые были
удалены, пока выполнялась очистка (Натан Боссарт)
E.2.3.1.6.1. Информационная схема
• Добавление столбцов в представления information_schema, связанные с ограничениями таб-
лиц и триггерами (Питер Эйзентраут)
А именно, поля triggers.action_order, triggers.action_reference_old_table и
triggers.action_reference_new_table, ранее всегда содержавшие NULL, теперь заполнены
значениями. Также добавилось поле table_constraints.enforced, но оно пока не содержит
полезного значения.
E.2.3.1.7. Аутентификация
• Возможность задавать на сервере более сложные конструкции LDAP в режиме поиск+связы-
вание (Томас Мунро)
В частности, в ldapsearchfilter можно задавать шаблоны с комбинациями атрибутов LDAP.
2285Замечания к выпуску
• Возможность аутентификации LDAP с использованием шифрованного протокола LDAP (Томас
Мунро)
Ранее мы поддерживали работу LDAP поверх TLS с параметром ldaptls=1. Новый ме-
тод TLS LDAP для зашифрованного LDAP включается параметром ldapscheme=ldaps или
ldapurl=ldaps://.
• Улучшен вывод сообщений об ошибках LDAP (Томас Мунро)
E.2.3.1.8. Разрешения
• Добавление стандартных ролей для управления доступом к файловой системе (Стивен Фрост)
А именно, добавлены роли: pg_read_server_files, pg_write_server_files и
pg_execute_server_program. Эти роли теперь также определяют, кому разрешено выполнять
COPY на стороне сервера и использовать расширение file_fdw. Ранее эти функции были до-
ступны только суперпользователям, и сейчас по умолчанию другим пользователям они недо-
ступны.
• Вместо явных проверок суперпользователей ограничение доступа к функциям, которые рабо-
тают с файловой системой, теперь обеспечивается разрешениями, управляемыми командами
GRANT/REVOKE (Стивен Фрост)
Соответствующим образом были изменены функции: pg_ls_dir(), pg_read_file(),
pg_read_binary_file() и pg_stat_file().
• Переход к использованию GRANT/REVOKE для ограничения доступа к функциям lo_import() и
lo_export() (Микаэль Пакье, Том Лейн)
Ранее к этим функциям имели доступ только суперпользователи.
Удалён параметр времени компиляции ALLOW_DANGEROUS_LO_FUNCTIONS.
• Для ограничения доступа без пароля к таблицам postgres_fdw через представление теперь
проверяется владелец представления, а не пользователь сеанса (Роберт Хаас)
PostgreSQL позволяет только суперпользователям обращаться к таблицам postgres_fdw без
паролей, то есть в режиме peer. Ранее для получения такого доступа суперпользователем
должен был быть владелец сеанса; теперь же проверяется владелец представления.
• Исправление некорректной проверки разрешений для блокировки в SELECT FOR UPDATE с
представлениями (Том Лейн)
E.2.3.1.9. Конфигурация сервера
• Добавление серверного параметра ssl_passphrase_command, позволяющего передать пароль,
требующийся для расшифровывания файлов ключей SSL (Питер Эйзентраут)
Вместе с этим добавлен параметр ssl_passphrase_command_supports_reload, указывающий,
нужно ли перезагружать конфигурацию SSL и вызывать ssl_passphrase_command при переза-
грузке конфигурации сервера.
• Добавление параметра хранилища toast_tuple_target, определяющего минимальный размер
кортежа для рассмотрения возможности применения TOAST (Саймон Риггс)
Подразумеваемое по умолчанию пороговое значение для применения TOAST осталось преж-
ним.
• Возможность задавать значения серверных параметров, связанных с объёмом файлов и памя-
ти, в байтах (Бина Эмерсон)
Новая единица обозначается «B». Она дополняет прежний набор из «kB», «MB», «GB» и «TB».
E.2.3.1.10. Журнал предзаписи (WAL)
• Возможность указания размера файлов WAL при вызове initdb (Бина Эмерсон)
2286Замечания к выпуску
Ранее размер по умолчанию составлял 16 Мбайт, и изменить его можно было только при ком-
пиляции.
• Сохранение данных WAL только для одной контрольной точки (Саймон Риггс)
Ранее записи WAL сохранялись для двух контрольных точек.
• Заполнение нулями неиспользованной части принудительно переключаемых сегментов WAL
для более эффективного их сжатия (Чепмен Флэк)
E.2.3.2. Базовое резервное копирование и потоковая репликация
• Репликация действия TRUNCATE в ходе логической репликации (Саймон Риггс, Марко Ненча-
рини, Питер Эйзентраут)
• Передача информации о подготовленных транзакциях подписчикам логической репликации
(Никхил Сонтакке, Стас Кельвич)
• Исключение нежурналируемых и временных таблиц, а также файлов pg_internal.init из
транслируемых базовых копий (Дэвид Стил)
Копировать такие файлы нет необходимости.
• Возможность проверки контрольных сумм страниц кучи при трансляции базовой резервной
копии (Михаэль Банк)
• Возможность программного сдвига позиции в слотах репликации, без участия подписчиков
(Петр Желинек)
Это позволяет эффективно продвигаться вперёд в слоте репликации, когда считы-
вать его содержимое не требуется. Данная возможность реализована в функции
pg_replication_slot_advance().
• Добавление информации о линии времени в файл backup_label (Микаэль Пакье)
Также добавлена проверка на соответствие линии времени в WAL линии времени в файле
backup_label.
• Добавление адреса узла и порта в системное представление pg_stat_wal_receiver (Харибабу
Комми)
E.2.3.3. Служебные команды
• Возможность избежать перезаписи таблицы при добавлении в ALTER TABLE столбца с отлич-
ным от NULL значением по умолчанию (Эндрю Дунстан, Серж Рило)
Эта оптимизация включается, когда значение по умолчанию задаётся константой.
• Возможность блокирования представлений в результате блокирования нижележащих таблиц
(Юго Нагата)
• Возможность определения в ALTER INDEX ориентиров сбора статистики для индексов по выра-
жению (Александр Коротков, Адриен Найрат)
В psql команда \d+ теперь показывает ориентир статистики для индексов.
• Возможность указания нескольких таблиц в одной команде VACUUM или ANALYZE (Натан Бос-
сарт)
Кроме того, если для какой-либо таблицы, упомянутой в VACUUM, задаётся список столбцов,
необходимо добавить ключевое слово ANALYZE; ранее в таких случаях указание ANALYZE подра-
зумевалось.
• В ANALYZE добавлен синтаксис указания параметров в скобках (Натан Боссарт)
Подобный синтаксис поддерживает команда VACUUM.
2287Замечания к выпуску
• Добавление в CREATE AGGREGATE параметра, отмечающего поведение функции завершения аг-
регата (Том Лейн)
Это позволяет оптимизировать пользовательские агрегатные функции и использовать их как
оконные функции.
E.2.3.4. Типы данных
• Возможность создания массивов доменов (Том Лейн)
Это также позволяет использовать array_agg() с доменами.
• Поддержка доменов поверх составных типов (Том Лейн)
В дополнение к этому языки PL/Perl, PL/Python и PL/Tcl получили возможность принимать ар-
гументы и выдавать результаты с составными доменными типами. Также улучшена поддерж-
ка доменных типов в PL/Python.
• Добавление приведений скаляров JSONB к числовому и логическому типу данных (Анастасия
Лубенникова)
E.2.3.5. Функции
• Реализация всех описанных в SQL:2011 вариантов определения рамки для оконных функций
(Оливер Форд, Том Лейн)
В режиме RANGE теперь допускается указание в PRECEDING и FOLLOWING смещений для выбора
строк с группирующими значениями плюс/минус заданное смещение. Кроме того, был добав-
лен режим GROUPS, в котором в рамку включается плюс/минус заданное число групп родствен-
ных строк. Также добавлен синтаксис для описания рамки с исключением.
• Добавление семейства хеш-функций SHA-2 (Питер Эйзентраут)
А именно, были добавлены функции: sha224(), sha256(), sha384() и sha512().
• Добавление поддержки 64-битных функций хеширования без криптографической стойкости
(Роберт Хаас, Амул Сул)
• Возможность указания в to_char() и to_timestamp() смещения часового пояса от UTC в ча-
сах и минутах (Никита Глухов, Эндрю Дунстан)
Для этого предназначены указания формата TZH и TZM.
• Добавление функции текстового поиска websearch_to_tsquery(), поддерживающей синтаксис
запросов, подобный принятому в поисковых системах в Интернете (Виктор Дробный, Дмитрий
Иванов)
• Добавление функций json(b)_to_tsvector(), создающих запрос текстового поиска для соот-
ветствующих значений JSON/JSONB (Дмитрий Долгов)
E.2.3.6. Языки программирования на стороне сервера
• Реализация процедур на уровне SQL, которые могут начинать и фиксировать собственные
транзакции (Питер Эйзентраут)
Для создания хранимых процедур предназначена новая команда CREATE PROCEDURE, а для вы-
полнения — CALL
Новые команды ALTER/DROP ROUTINE позволяют изменять/удалять все виды объектов-подпро-
грамм, а именно процедуры, функции и агрегаты.
Кроме того, теперь запись FUNCTION в командах CREATE OPERATOR и CREATE TRIGGER предпочти-
тельнее, чем PROCEDURE, так как целевой объект должен быть функцией, а не процедурой. Од-
нако для совместимости старый синтаксис по-прежнему поддерживается.
2288Замечания к выпуску
• Добавление возможностей управления транзакциями в серверные языки PL/pgSQL, PL/Perl,
PL/Python, PL/Tcl и SPI (Питер Эйзентраут)
Управление транзакциями возможно только в процедурах на верхнем уровне транзакций и
вложенных блоках CALL и DO, которые могут содержать только другие блоки CALL и DO.
• Добавление в PL/pgSQL возможности обозначать типы записей составного типа как не прини-
мающие NULL, постоянные, или имеющие начальные значения (Том Лейн)
• В PL/pgSQL добавлена обработка изменений составных типов (например, записи, кортежа),
происходящих между первым и последующими вызовами функции в одном сеансе (Том Лейн)
Ранее в таких обстоятельствах выдавались ошибки.
• Добавление расширения jsonb_plpython для преобразования JSONB в типы PL/Python и в об-
ратном направлении (Антон Быков)
• Добавление расширения jsonb_plperl для преобразования JSONB в типы PL/Perl и в обратном
направлении (Антон Быков)
E.2.3.7. Клиентские интерфейсы
• По умолчанию сжатие теперь отключено в libpq (Питер Эйзентраут)
В современных версиях OpenSSL сжатие отключено, так что соответствующий параметр libpq
в них фактически не действовал.
• Добавление указания DO CONTINUE в команду ecpg WHENEVER (Винаяк Покале)
При этом генерируется команда continue языка C, приводящая к передаче управления в на-
чало цикла, содержащего указанное условие.
• Добавление в ecpg режима обработки символьных массивов в стиле Oracle Pro<em>C.
Этот режим включается ключом -C.
E.2.3.8. Клиентские приложения
• Добавление в psql команды \gdesc, выводящей названия и типы столбцов в результате запро-
са (Павел Стехуле)
• Добавление переменных psql для управление выводом ошибок и действий запросов (Фабьен
Коэльо)
А именно, были добавлены переменные: ERROR, SQLSTATE, ROW_COUNT, LAST_ERROR_MESSAGE и
LAST_ERROR_SQLSTATE.
• Добавление в psql возможности проверить существование переменной (Фабьен Коэльо)
Для проверки существования переменной в операторе \if реализован синтаксис :{?имя_пе-
ременной}.
• Добавление переменной окружения PSQL_PAGER для управления постраничником в psql (Па-
вел Стехуле)
Эта переменная позволяет задать для psql постраничник по умолчанию, отличный от постра-
ничника, который выбран для других программ. Значение PAGER по-прежнему действует, если
переменная PSQL_PAGER не определена.
• Безусловное добавление информации о секционировании в вывод команды psql \d+ (Амит Лан-
готе, Ашутош Бапат)
Ранее эта информация не выводилась для секционированной таблицы, в которой не было сек-
ций. Также теперь обозначается, какие секции сами являются секционированными.
• Вывод в psql правильного имени пользователя при запросе пароля (Том Лейн)
2289Замечания к выпуску
Ранее, когда имя пользователя задавалось в адресе URI и одновременно использовался ключ
-U, в приглашении выдавалось некорректное имя. Теперь также подавляется имя при запросе
пароля, когда указывается ключ –password.
• Выполнение выхода из psql при вводе команд quit и exit, когда в буфере ввода больше ничего
нет (Брюс Момджян)
Добавление подсказки о том, как выйти из программы, когда команды quit и exit вводятся в
отдельной строке при непустом буфере ввода. Эта же информация добавлена в справку (help).
• Добавление в psql подсказки об использовании Control-D, когда \q вводится в отдельной стро-
ке, но при этом игнорируется (Брюс Момджян)
Например, ввод \q не приведёт к выходу, если эти символы введены внутри текстовой строки.
• Улучшение дополнения табуляцией для команды ALTER INDEX RESET/SET (Масахико Савада)
• Добавление в psql инфраструктуры для адаптации запросов, требующихся для дополнения та-
буляцией, к версии сервера (Том Лейн)
Ранее запросы, выполняемые механизмом дополнения табуляцией, могли не работать на ста-
рых серверах.
E.2.3.8.2. pgbench
• Добавление в pgbench поддержки выражений с NULL, логическими значениями, а также
нескольких функций и операторов (Фабьен Коэльо)
• Добавление условий \if в pgbench (Фабьен Коэльо)
• Возможность использовать в именах переменных pgbench не только символы ASCII (Фабьен
Коэльо)
• Добавление в pgbench ключа –init-steps, позволяющего управлять этапами инициализации
(Масахико Савада)
• Добавление в pgbench генератора случайных чисел с распределением, приблизительно соот-
ветствующим закону Ципфа (Алик Хилажев)
• Возможность указания затравки для генератора случайных чисел в pgbench (Фабьен Коэльо)
• Добавление в pgbench функций pow() и power() для возведения в степень (Раул Марин Родри-
гес)
• Добавление в pgbench функций хеширования (Ильдар Мусин)
• Улучшение точности статистики pgbench при использовании параметров –latency-limit и
–rate (Фабьен Коэльо)
E.2.3.9. Серверные приложения
• Добавление в pg_basebackup параметра для создания слота репликации с заданным именем
(Михаэль Банк)
С ключом –create-slot будет создаваться слот репликации (с именем, заданным ключом –
slot), когда используется метод потоковой трансляции WAL (–wal-method=stream).
• Возможность разрешения в initdb доступа группы к каталогу данных (Дэвид Стил)
Для этого предназначен добавленный ключ initdb –allow-group-access. Администраторы
также могут установить разрешения для группы в пустом каталоге данных до запуска initdb.
Узнать, разрешено ли группе чтение в каталоге данных, позволяет серверная переменная
data_directory_mode.
• Добавление утилиты pg_verify_checksums для проверки контрольных сумм базы данных в от-
ключённом состоянии (Магнус Хагандер)
• Возможность изменить в pg_resetwal размер сегмента WAL с помощью ключа –wal-segsize
(Натан Боссарт)
2290Замечания к выпуску
• Добавление длинных параметров в pg_resetwal и pg_controldata (Натан Боссарт, Питер Эйзен-
траут)
• Добавление в pg_receivewal ключа –no-sync, отключающего синхронную запись WAL в целях
тестирования (Микаэль Пакье)
• Добавление в pg_receivewal ключа –endpos, указывающего, когда нужно остановить приём
WAL (Микаэль Пакье)
• Включение в pg_ctl возможности посылать процессам сигналы SIGKILL (Андрес Фройнд)
Ранее эта возможность не поддерживалась из-за опасений потенциальных злоупотреблений
ей.
• Уменьшение числа файлов, копируемых утилитой pg_rewind (Микаэль Пакье)
• Недопущение запуска pg_rewind от имени root (Микаэль Пакье)
E.2.3.9.1. pg_dump, pg_dumpall, pg_restore
• Добавление в pg_dumpall ключа –encoding для управления выводом указаний кодировок (Ми-
каэль Пакье)
В pg_dump этот ключ уже был раньше.
• Добавление в pg_dump ключа –load-via-partition-root, указывающего, что данные долж-
ны загружаться в корневую таблицу секционирования, а не в исходную секцию (Рушаб Латиа)
Это полезно, если в целевой системе окажутся другие правила сортировки или порядок бай-
тов, при которых может потребоваться поместить строки в секции, отличные от прежних.
• Добавление ключа для отключения выгрузки и восстановления комментариев объекта базы
данных (Робинс Таракан)
Новый ключ утилит pg_dump, pg_dumpall и pg_restore называется –no-comments.
E.2.3.10. Исходный код
• Добавление в PGXS возможности устанавливать заголовочные файлы (Эндрю Гирт)
Это позволяет создавать модули расширений, зависящие от других модулей. Ранее для зави-
симого модуля не было простой возможности найти заголовочные файлы нужного ему моду-
ля. Также был скорректирован ряд существующих модулей в contrib, определяющих типы
данных, чтобы при их установке устанавливались и соответствующие заголовки. Кроме того,
реализации PL/Perl и PL/Python теперь устанавливают свои заголовочные файлы для поддерж-
ки создания модулей преобразования для этих языков.
• Установка файла errcodes.txt при инсталляции, что позволяет расширениям получать спи-
сок кодов ошибок, известных в PostgreSQL (Томас Мунро)
• Преобразование документации в формат DocBook XML (Питер Эйзентраут, Александр Лахин,
Юрген Пуртц)
Имена файлов по-прежнему имеют расширение sgml для совместимости с ветвями старых
версий.
• Использование определения типа bool из stdbool.h там, где это возможно, то есть на подав-
ляющем большинстве платформ (Питер Эйзентраут)
Тем самым устранены трудности, связанные с написанием модулей расширений, в исходный
код которых требовалось включить stdbool.h.
• Кардинальное изменение способа описания начальных системных каталогов (Джон Нейлор)
Теперь исходные данные представляются в структурах Perl, что значительно упрощает меха-
ническую работу с ними.
2291Замечания к выпуску
• Недопущение создания расширениями собственных серверных параметров, принимающих
значения в виде списка в кавычках (Том Лейн)
Сейчас нет возможности это поддерживать, так как об этом свойстве параметра необходимо
знать до того, как расширение будет загружено.
• Добавление возможности применять связывание каналов при использовании аутентификации
SCRAM (Микаэль Пакье)
Связывание каналов предназначено для предотвращения атак посредника; SCRAM сам по се-
бе не обеспечивает такую защиту — связывание необходимо включать явно. К сожалению,
libpq не позволяет это сделать. Необходимая поддержка ожидается в будущих версиях libpq и
в интерфейсах, построенных не на базе libpq, например, в JDBC.
• Предоставление фоновым исполнителям возможности подключения к базам данных, которые
обычно не допускают подключения (Магнус Хагандер)
• Поддержка аппаратного вычисления CRC на платформе ARMv8 (Юки Гу, Хейкки Линнакан-
гас, Томас Мунро)
• Ускорение поиска встроенных функций по OID (Андрес Фройнд)
Теперь вместо двоичного поиска используется массив индексов.
• Ускорение форматирования результатов запроса (Андрес Фройнд)
• Увеличение скорости доступа к кешам системы (Андрес Фройнд)
• Добавление механизма управления памятью, построенного на модели поколений, оптимизи-
рованной для последовательного выделения/освобождения блоков (Томаш Вондра)
С новым механизмом уменьшается потребление памяти при логическом декодировании.
• Согласование вычисления pg_class.reltuples при VACUUM с вычислением этого же значения
при выполнении ANALYZE (Томаш Вондра)
• Переход к использованию более новой версии perltidy, 20170521 (Том Лейн, Питер Эйзентра-
ут)
E.2.3.11. Дополнительные модули
• В расширение pg_prewarm добавлена возможность восстанавливать предыдущее содержимое
общего буфера при запуске (Митхун Сай, Роберт Хаас)
Для этого информацию об отношениях и номерах блоков, наблюдаемых в общем буфере,
pg_prewarm периодически сохраняет на диск во время работы и при отключении сервера.
• Добавление в pg_trgm функции strict_word_similarity() для вычисления схожести целых
слов (Александр Коротков)
Для подобной цели уже существовала функция word_similarity(), но она была предназначе-
на для поиска схожих частей слов, тогда как strict_word_similarity() вычисляет схожесть
целых слов.
• Возможность создания индексов, которые можно использовать в сравнениях LIKE со столбца-
ми citext (Алексей Чернышов)
Для этого индексы должны создаваться с использованием класса операторов
citext_pattern_ops.
• Возможность создания индексов btree_gin по значениям типов данных bool, bpchar, name и
uuid (Матеус Оливейра)
• Возможность выполнения расширениями cube и seg сканирования только индекса при ис-
пользовании индексов GiST (Андрей Бородин)
• Реализация извлечения отрицательных координат куба оператором ~&gt; (Александр Коротков)
Это полезно для поиска kNN-GiST, когда нужно выбрать координаты в возрастающем порядке.
2292Замечания к выпуску
• Обработка букв вьетнамского языка в расширении unaccent (Дан Мин Хыонг, Микаэль Пакье)
• Добавление в amcheck проверки наличия для каждого кортежа в куче соответствующей запи-
си в индексе (Питер Геохеган)
• Переход в модуле adminpack к использованию новых стандартных ролей для доступа к файло-
вой системе (Стивен Фрост)
Ранее функции adminpack могли вызывать только администраторы, теперь проверяются разре-
шения ролей.
• Расширение идентификатора запроса в pg_stat_statement до 64 бит (Роберт Хаас)
Это значительно сокращает вероятность совпадений хеша для разных идентификаторов за-
просов. Теперь эти идентификаторы могут отображаться и в виде отрицательных чисел.
• Удаление скриптов contrib/start-scripts/osx, так как использовать их более не рекоменду-
ется (вместо них следует использовать contrib/start-scripts/macos) (Том Лейн)
• Удаление расширения chkpass (Питер Эйзентраут)
Это расширение более не считается полезным средством безопасности и примером написа-
ния расширения.
E.2.4. Благодарственный список
Перечисленные ниже (в алфавитном порядке) лица сделали вклад в этот выпуск, разрабатывая,
совершенствуя и рецензируя код, принимая правки, проводя тестирование или сообщая о пробле-
мах.
Абхиджит Менон-Сен (Abhijit Menon-Sen)
Адам Беланьский (Adam Bielanski)
Адам Брайтвелл (Adam Brightwell)
Адам Брюссельбек (Adam Brusselback)
Адитья Тошнивал (Aditya Toshniwal)
Адриан Эскомс (Adrián Escoms)
Адриен Найрат (Adrien Nayrat)
Акос Вандра (Akos Vandra)
Александр Алексеев (Aleksander Alekseev)
Александр Парфёнов (Aleksandr Parfenov)
Александр Коротков (Alexander Korotkov)
Александр Кукушкин (Alexander Kukushkin)
Александр Кузьменков (Alexander Kuzmenkov)
Александр Лахин (Alexander Lakhin)
Александре Гарсия (Alexandre Garcia)
Алексей Баштанов (Alexey Bashtanov)
Алексей Чернышов (Alexey Chernyshov)
Алексей Крючков (Alexey Kryuchkov)
Алик Хилажев (Alik Khilazhev)
Альваро Эррера (Álvaro Herrera)
Амит Капила (Amit Kapila)
Амит Хандекар (Amit Khandekar)
Амит Ланготе (Amit Langote)
Амул Сул (Amul Sul)
Анастасия Лубенникова (Anastasia Lubennikova)
Андреас Джозеф Крог (Andreas Joseph Krogh)
Андреас Карлссон (Andreas Karlsson)
Андреас Зельтенрейх (Andreas Seltenreich)
Андре Гензель (André Hänsel)
Андрей Горита (Andrei Gorita)
Андрес Фройнд (Andres Freund)
Эндрю Дунстан (Andrew Dunstan)
2293Замечания к выпуску
Эндрю Флетчер (Andrew Fletcher)
Эндрю Гирт (Andrew Gierth)
Эндрю Гроссман (Andrew Grossman)
Андрей Красичков (Andrew Krasichkov)
Андрей Бородин (Andrey Borodin)
Андрей Лизенко (Andrey Lizenko)
Энди Абелисто (Andy Abelisto)
Антон Быков (Anthony Bykov)
Антуан Семама (Antoine Scemama)
Антон Дигнос (Anton Dignös)
Антонин Хоуска (Antonin Houska)
Арсений Шароглазов (Arseniy Sharoglazov)
Арсений Шер (Arseny Sher)
Артур Закиров (Artur Zakirov)
Ашутош Бапат (Ashutosh Bapat)
Ашутош Шарма (Ashutosh Sharma)
Ашвин Агравал (Ashwin Agrawal)
Асим Правин (Asim Praveen)
Атсуши Торикоши (Atsushi Torikoshi)
Бадрул Чоудхури (Badrul Chowdhury)
Балаж Силфаи (Balazs Szilfai)
Бейзил Бурк (Basil Bourque)
Бина Эмерсон (Beena Emerson)
Бен Чобот (Ben Chobot)
Бенджамин Кутю (Benjamin Coutu)
Бернд Хелмле (Bernd Helmle)
Блаз Мерела (Blaz Merela)
Брэд Дейонг (Brad DeJong)
Брент Дерт (Brent Dearth)
Брайан Клотье (Brian Cloutier)
Брюс Момджян (Bruce Momjian)
Каталин Якоб (Catalin Iacob)
Чад Трабант (Chad Trabant)
Чепмен Флэк (Chapman Flack)
Кристиан Дута (Christian Duta)
Кристиан Ульрих (Christian Ullrich)
Кристоф Берг (Christoph Berg)
Кристоф Дрейс (Christoph Dreis)
Кристоф Куртуа (Christophe Courtois)
Кристофер Джонс (Christopher Jones)
Клаудио Фрейре (Claudio Freire)
Клейтон Салем (Clayton Salem)
Крейг Рингер (Craig Ringer)
Дагфинн Ильмари Маннсакер (Dagfinn Ilmari Mannsåker)
Дан Вианелло (Dan Vianello)
Дэн Ватсон (Dan Watson)
Дан Мин Хыонг
Даниэль Густафссон (Daniel Gustafsson)
Даниэль Верите (Daniel Vérité)
Даниель Вестерман (Daniel Westermann)
Даниель Вуд (Daniel Wood)
Дорофей Пролесковский (Darafei Praliaskouski)
Дейв Крамер (Dave Cramer)
Дейв Пейдж (Dave Page)
Дэвид Биндерман (David Binderman)
Дэвид Карлье (David Carlier)
Давид Феттер (David Fetter)
Дэвид Дж. Джонстон (David G. Johnston)
2294Замечания к выпуску
Дэвид Гулд (David Gould)
Дэвид Хинкль (David Hinkle)
Давид Перейро Лагарес (David Pereiro Lagares)
Дэвид Рэйдер (David Rader)
Дэвид Роули (David Rowley)
Дэвид Стил (David Steele)
Дэви Мачадо (Davy Machado)
Дин Рашид (Dean Rasheed)
Диан Фей (Dian Fay)
Дилип Кумар (Dilip Kumar)
Дмитрий Сарафанников (Dmitriy Sarafannikov)
Дмитрий Долгов (Dmitry Dolgov)
Дмитрий Иванов (Dmitry Ivanov)
Дмитрий Шалашов (Dmitry Shalashov)
Дон Зейлер (Don Seiler)
Даг Дул (Doug Doole)
Даг Рэди (Doug Rady)
Эдмунд Хорнер (Edmund Horner)
Эйдзи Сэки (Eiji Seki)
Элвис Пранскевичус (Elvis Pranskevichus)
Эмре Хасегели (Emre Hasegeli)
Эрик Рижкерс (Erik Rijkers)
Эрвин Брандштеттер (Erwin Brandstetter)
Эцуро Фудзита (Etsuro Fujita)
Эйлер Тавейра (Euler Taveira)
Эверальдо Кануто (Everaldo Canuto)
Фабьен Коэльо (Fabien Coelho)
Фабрицио де Ройес Мелло (Fabrízio de Royes Mello)
Фейке Стинберген (Feike Steenbergen)
Фриц Ялвинг (Frits Jalvingh)
Фудзии Масао (Fujii Masao)
Гао Цзэнци (Gao Zengqi)
Джанни Чиолли (Gianni Ciolli)
Грег Старк (Greg Stark)
Гуннлаугур Тор Брием (Gunnlaugur Thor Briem)
Го Сян Тань (Guo Xiang Tan)
Хади Мошаеди (Hadi Moshayedi)
Хайлун Ли (Hailong Li)
Харибабу Комми (Haribabu Kommi)
Хит Лорд (Heath Lord)
Хейкки Линнакангас (Heikki Linnakangas)
Хьюго Мерсье (Hugo Mercier)
Игорь Корот (Igor Korot)
Игорь Нейман (Igor Neyman)
Ильдар Мусин (Ildar Musin)
Ильдус Курбангалиев (Ildus Kurbangaliev)
Йозеф Ким (Ioseph Kim)
Джейкоб Чемпион (Jacob Champion)
Хайме Казанова (Jaime Casanova)
Якоб Еггер (Jakob Egger)
Жан-Пьер Пельтье (Jean-Pierre Pelletier)
Дживан Чок (Jeevan Chalke)
Дживан Ладхе (Jeevan Ladhe)
Джефф Девис (Jeff Davis)
Джефф Джейнс (Jeff Janes)
Джереми Эванс (Jeremy Evans)
Джереми Финцель (Jeremy Finzel)
Джереми Шнайдер (Jeremy Schneider)
2295Замечания к выпуску
Джеспер Педерсен (Jesper Pedersen)
Джим Нэсби (Jim Nasby)
Джимми Йи (Jimmy Yih)
Цзин Ван (Jing Wang)
Жобен Августин (Jobin Augustine)
Джо Конвей (Joe Conway)
Джон Горман (John Gorman)
Джон Нейлор (John Naylor)
Йон Нельсон (Jon Nelson)
Джон Вольский (Jon Wolski)
Джонатан Аллен (Jonathan Allen)
Джонатан С. Кац (Jonathan S. Katz)
Жульен Рухо (Julien Rouhaud)
Юрген Пуртц (Jürgen Purtz)
Джастин Призби (Justin Pryzby)
КайГай Кохэй (KaiGai Kohei)
Кайтин Чен (Kaiting Chen)
Карл Лехенбауэр (Karl Lehenbauer)
Кит Фиске (Keith Fiske)
Кевин Блох (Kevin Bloch)
Ка Нгуен (Kha Nguyen)
Ким Росе Карлсен (Kim Rose Carlsen)
Константин Книжник (Konstantin Knizhnik)
Кунтал Гхош (Kuntal Ghosh)
Кайл Самсон (Kyle Samson)
Кётаро Хоригути (Kyotaro Horiguchi)
Летиция Аврот (Lætitia Avrot)
Ларс Канис (Lars Kanis)
Лауренц Альбе (Laurenz Albe)
Леонардо Чекки (Leonardo Cecchi)
Людмила Мантрова (Liudmila Mantrova)
Лисиань Цзоу (Lixian Zou)
Ллойд Альбин (Lloyd Albin)
Лука Феррари (Luca Ferrari)
Лукас Фэйрчайлд (Lucas Fairchild)
Лукас Эдер (Lukas Eder)
Лукас Фиттл (Lukas Fittl)
Магнус Хагандер (Magnus Hagander)
Май Пэн (Mai Peng)
Максим Милютин (Maksim Milyutin)
Максим Богук (Maksym Boguk)
Мансур Галиев (Mansur Galiev)
Марк Дилгер (Marc Dilger)
Марко Ненчарини (Marco Nenciarini)
Марина Полякова (Marina Polyakova)
Марио де Фрутос Диегес (Mario de Frutos Dieguez)
Марк Кейв-Айланд (Mark Cave-Ayland)
Марк Дилгер (Mark Dilger)
Марк Вуд (Mark Wood)
Марко Тииккая (Marko Tiikkaja)
Маркус Винанд (Markus Winand)
Мартин Маркес (Martín Marqués)
Масахико Савада (Masahiko Sawada)
Матеус Оливейра (Matheus Oliveira)
Мэтью Стикни (Matthew Stickney)
Метин Дослу (Metin Doslu)
Михаэль Банк (Michael Banck)
Михаэль Мескес (Michael Meskes)
2296Замечания к выпуску
Микаэль Пакье (Michael Paquier)
Михаил Николаев (Michail Nikolaev)
Майк Блэквелл (Mike Blackwell)
Мин-Цюань Тран (Minh-Quan Tran)
Митхун Сай (Mithun Cy)
Морган Оуэнс (Morgan Owens)
Натан Боссарт (Nathan Bossart)
Натан Вагнер (Nathan Wagner)
Нейл Конвей (Neil Conway)
Ник Барнс (Nick Barnes)
Николас Товен (Nicolas Thauvin)
Никхил Сонтакке (Nikhil Sontakke)
Никита Глухов (Nikita Glukhov)
Николай Шаплов (Nikolay Shaplov)
Ной Миш (Noah Misch)
Нориёси Синода (Noriyoshi Shinoda)
Олег Бартунов (Oleg Bartunov)
Олег Самойлов (Oleg Samoilov)
Оливер Форд (Oliver Ford)
Пан Бянь (Pan Bian)
Паскаль Легран (Pascal Legrand)
Патрик Хеммер (Patrick Hemmer)
Патрик Крекер (Patrick Krecker)
Поль Боно (Paul Bonaud)
Пол Гуо (Paul Guo)
Пол Рамсей (Paul Ramsey)
Паван Деоласи (Pavan Deolasee)
Паван Маддамсетти (Pavan Maddamsetti)
Павел Голубь (Pavel Golub)
Павел Стехуле (Pavel Stehule)
Питер Эйзентраут (Peter Eisentraut)
Питер Геохеган (Peter Geoghegan)
Петр Желинек (Petr Jelínek)
Петру-Флорин Миханча (Petru-Florin Mihancea)
Фил Флорент (Phil Florent)
Филипп Бодуэн (Philippe Beaudoin)
Пьер Дюкроке (Pierre Ducroquet)
Пётр Стефаняк (Piotr Stefaniak)
Прабхат Саху (Prabhat Sahu)
Пу Квун (Pu Qun)
Куэль Чжо (QL Zhuo)
Рафия Сабих (Rafia Sabih)
Рахила Сьед (Rahila Syed)
Райнер Орт (Rainer Orth)
Раджкумар Рагхуванши (Rajkumar Raghuwanshi)
Рауль Марин Родригес (Raúl Marín Rodríguez)
Регина Обе (Regina Obe)
Ричард Йен (Richard Yen)
Роберт Хаас (Robert Haas)
Робинс Таракан (Robins Tharakan)
Род Тейлор (Rod Taylor)
Рушаб Латиа (Rushabh Lathia)
Райан Мерфи (Ryan Murphy)
Шахап Ашчи (Sahap Asci)
Самуэль Хорвиц (Samuel Horwitz)
Скотт Уре (Scott Ure)
Шон Джонстон (Sean Johnston)
Шао Брет (Shao Bret)
2297Замечания к выпуску
Шэй Роджански (Shay Rojansky)
Шубхам Барай (Shubham Barai)
Саймон Риггс (Simon Riggs)
Симоне Готти (Simone Gotti)
Шивасубраманьян Рамасубраманьян (Sivasubramanian Ramasubramanian)
Стас Кельвич (Stas Kelvich)
Стефан Кальтенбруннер (Stefan Kaltenbrunner)
Стефан Фройлих (Stephen Froehlich)
Стивен Фрост (Stephen Frost)
Стив Сингер (Steve Singer)
Стивен Винфилд (Steven Winfield)
Свен Кунце (Sven Kunze)
Тайки Кондо (Taiki Kondo)
Такаюки Цунакава (Takayuki Tsunakawa)
Такэси Идэриха (Takeshi Ideriha)
Тацуо Исии (Tatsuo Ishii)
Тацуро Ямада (Tatsuro Yamada)
Фёдор Сигаев (Teodor Sigaev)
Том Браун (Thom Brown)
Томас Келлерер (Thomas Kellerer)
Томас Мунро (Thomas Munro)
Томас Рейсс (Thomas Reiss)
Тобиас Бусман (Tobias Bussmann)
Тодд А. Кук (Todd A. Cook)
Том Казимирс (Tom Kazimiers)
Том Лейн (Tom Lane)
Томаш Вондра (Tomas Vondra)
Томонари Кацумата (Tomonari Katsumata)
Торстен Груст (Torsten Grust)
Тушар Ахуджа (Tushar Ahuja)
Вайшнави Прабакаран (Vaishnavi Prabakaran)
Васундар Боддапати (Vasundhar Boddapati)
Виктор Дробный (Victor Drobny)
Виктор Вагнер (Victor Wagner)
Виктор Егоров (Victor Yegorov)
Вик Фиринг (Vik Fearing)
Винаяк Покале (Vinayak Pokale)
Винсент Лаченал (Vincent Lachenal)
Виталий Гарнашевич (Vitaliy Garnashevich)
Виталий Буровой (Vitaly Burovoy)
Владимир Баранов (Vladimir Baranoff)
Синь Чжан (Xin Zhang)
И Вэнь Вон (Yi Wen Wong)
Йорик Петерс (Yorick Peterse)
Юго Нагата (Yugo Nagata)
Юки Гу (Yuqi Gu)
Юрий Соколов (Yura Sokolov)
Ив Герген (Yves Goergen)
Чжоу Дигоал (Zhou Digoal)
E.3. Выпуск 10.6
Дата выпуска:
2018-11-08
В этот выпуск вошли различные исправления, внесённые после версии 10.5. За информацией о
нововведениях версии обратитесь к Разделу E.9.
2298Замечания к выпуску
E.3.1. Миграция на версию 10.6
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Однако если вы используете расширение pg_stat_statements, прочитайте запись о нём в списке
изменений.
Если вы обновляете сервер с более ранней версии, чем 10.4, см. также Раздел E.5.
E.3.2. Изменения
• Корректное заключение в кавычки имён переходных таблиц в командах CREATE TRIGGER …
REFERENCING, которые выдаёт pg_dump (Том Лейн)
Отсутствием кавычек мог воспользоваться непривилегированный пользователь с целью полу-
чения прав суперпользователя при последующем восстановлении выгруженных данных или
выполнении pg_upgrade. (CVE-2018-16850)
• Устранение сбоев, которые могли возникать в особых случаях в семействе функций has_объ-
ект_privilege() (Том Лейн)
Эти функции должны возвращать NULL, а не выдавать ошибку при получении неверного
OID. Некоторые из этих функций делали это и прежде, но не все. Кроме того, в функции
has_column_privilege() на некоторых платформах могли иметь место и другие сбои.
• Исправление функции pg_get_partition_constraintdef(), чтобы при получении неверного
OID отношения не происходил сбой, а выдавался NULL (Том Лейн)
• Недопущение замедления порядка O(N^2) в функциях match/split с регулярными выражения-
ми при обработке длинных строк (Эндрю Гирт)
• Исправление дефекта в обработке стандартных многосимвольных операторов, следующих
непосредственно за комментарием или символами + и - (Эндрю Гирт)
Следствием данного упущения могли быть ошибки при разборе или неправильное определе-
ние приоритета операторов.
• Недопущение замедления порядка O(N^3) при обработке лексическим анализатором длин-
ных строк из символов + или - (Эндрю Гирт)
• Исправление некорректного выполнения подчинённых планов при сканировании внешнего
запроса в обратном направлении (Эндрю Гирт)
• Исправление ошибочного поведения UPDATE/DELETE … WHERE CURRENT OF … после переме-
щения курсора (Том Лейн)
Курсор, сканирующий несколько отношений (в частности, дерево наследования), мог работать
неправильно, возвращаясь к предыдущему отношению.
• Исправление в функции EvalPlanQual обработки узлов InitPlan, которые выполняются по
условию (Эндрю Гирт, Том Лейн)
Вследствие ошибки реализации могли возникать сложновоспроизводимые сбои или выдавать-
ся неправильные результаты при одновременных запросах на изменение, содержащих изоли-
рованные вложенные SELECT в конструкции CASE.
• Недопущение создания секции в триггере, присоединённом к родительской таблице (Амит
Ланготе)
В идеале такое создание можно было бы разрешить, но в данный момент оно блокируется во
избежание сбоев.
• Устранение проблем с применением ON COMMIT DELETE ROWS к секционированной временной
таблице (Амит Ланготе)
• Исправление проверок классов символов для корректной поддержки в Windows символов
Unicode выше U+FFFF (Том Лейн, Кэндзи Уно)
2299Замечания к выпуску
Эта ошибка проявлялась в операциях полнотекстового поиска, а также в работе модулей
contrib/ltree и contrib/pg_trgm.
• Недопущение передачи вложенных SELECT с оконными функциями, а также с указаниями
LIMIT или OFFSET, параллельным исполнителям (Амит Капила)
В таких случаях поведение могло быть несогласованным из-за того, что разные исполнители
получали разные результаты вследствие вариативности в порядке строк.
• Смена владельца последовательности, принадлежащей сторонней таблице, при выполнении
ALTER OWNER для этой таблицы (Питер Эйзентраут)
Операция смены владельца должна распространяться и на такие последовательности, но
раньше сторонние таблицы она не затрагивала.
• Обеспечение обработки сервером уже полученных прерываний NOTIFY и SIGTERM до начала
ожидания данных от клиента (Джефф Джейнс, Том Лейн)
• Устранение ошибки, приводившей к выделению лишней памяти для строки результатов
array_out() (Кэйити Хиробэ)
• Предотвращение утечки памяти на время выполнения запроса при работе с XMLTABLE (Эндрю
Гирт)
• Ликвидация утечки памяти при сканировании индекса SP-GiST (Том Лейн)
Сколько-нибудь значительное проявление этой утечки наблюдалось, только когда для ограни-
чения-исключения, использующего SP-GiST, в индекс поступало много записей.
• Закрытие файла сопоставлений в ApplyLogicalMappingFile() после завершения его использо-
вания (Томаш Вондра)
Ранее дескриптор файла терялся, что могло в итоге приводить к сбоям при логическом деко-
дировании.
• Устранение ошибки логического декодирования в случаях, когда сопоставленная таблица ка-
талога постоянно перезаписывается, например, в результате действия VACUUM FULL (Андрес
Фройнд)
• Предотвращение запуска сервера со значением wal_level, недостаточно большим для под-
держки существующего слота репликации (Андрес Фройнд)
• Предотвращение сбоя в случаях, когда служебная команда создаёт бесконечную рекурсию
(Том Лейн)
• Устранение в процессе инициализации горячего резерва проблемы дублирующихся XID, ко-
торые образуются при выполнении двухфазных транзакций на ведущем сервере (Микаэль Па-
кье, Константин Книжник)
• Исправление поведения событийных триггеров при обработке вложенных команд ALTER TABLE
(Микаэль Пакье, Альваро Эррера)
• Передача параллельным исполнителям времени начала оператора и транзакции от родитель-
ского процесса (Константин Книжник)
Тем самым исправлено поведение таких функций, как transaction_timestamp(), выполняю-
щихся в параллельном исполнителе.
• Обеспечение корректного выравнивания при передаче расширенных значений данных парал-
лельным исполнителям, что позволяет избежать сбоев на платформах, требовательных к вы-
равниванию (Том Лейн, Амит Капила)
• Исправление логики переработки файла WAL для правильного выполнения этой операции на
ведомых серверах (Микаэль Пакье)
В зависимости от значения параметра archive_mode ведомый сервер мог не удалить некото-
рые файлы WAL, подлежащие удалению.
2300Замечания к выпуску
• Исправление обработки времени фиксации транзакций в процессе восстановления (Масахико
Савада, Микаэль Пакье)
Если отслеживание времени фиксации не было включено постоянно, в процессе восстановле-
ния мог произойти сбой при попытке получить время фиксации транзакции, для которой оно
не было записано.
• Использование случайной затравки для random() в initdb, а также в сервере, запускаемом в
режиме начальной загрузки и в монопольном режиме (Ной Миш)
Практическая польза этого изменения состоит прежде всего в разрешении проблемы, когда
программа initdb не могла использовать общую память POSIX, считая её недоступной, из-за
конфликтов имён, вызванных использованием одинаковой затравки.
• Предотвращение повреждения общей памяти в логике DSA (Томас Мунро)
• Возможность прерывания операции выделения памяти в DSM (Крис Трэверс)
• Предупреждение сбоя в параллельном исполнителе при загрузке расширения, пытающегося
обратиться к системным кешам в своей функции инициализации (Томас Мунро)
Мы не считаем это удачным приёмом программирования расширений, но до внедрения парал-
лельных запросов это работало, а значит должно поддерживаться и теперь.
• Исправление поведения при динамическом включении параметра full_page_writes (Кётаро
Хоригути)
• Недопущение возможного сбоя в результате двойного освобождения памяти при повторном
сканировании SP-GiST (Эндрю Гирт)
• Предотвращение некорректной компоновки функций в src/port и src/common на платформах
BSD, использующих формат ELF, а также в HP-UX и Solaris (Эндрю Гирт, Том Лейн)
Разделяемые библиотеки, загружаемые в адресное пространство сервера, могли использовать
серверные версии этих функций, а не собственные реализации, как должно быть. Так как в по-
ведении этих двух наборов функций имеются различия, это приводило к проблемам.
• Предупреждение возможного переполнения буфера при воспроизведении операции распаков-
ки страницы GIN из WAL (Александр Коротков, Шивасубраманьян Рамасубраманьян)
• Предотвращение переполнения метастраницы хеш-индекса в случаях, когда размер BLCKSZ
меньше значения по умолчанию (Дилип Кумар)
• Добавление ранее упущенного пересчёта контрольной суммы страницы в хеш-индексах (Амит
Капила)
• Выполнение операции fsync, ранее упущенной, для каталога слотов репликации (Константин
Книжник, Микаэль Пакье)
• Устранение неожиданных тайм-аутов при использовании wal_sender_timeout на медленном
сервере (Ной Миш)
• Исправление вычисления подходящей точки согласованности WAL в процессах горячего ре-
зерва (Александр Кукушкин, Микаэль Пакье)
Выбор правильной точки позволяет предотвратить некорректное поведение сразу после того,
как ведомый сервер достигает согласованного состояния базы при воспроизведении WAL.
• Корректная остановка фоновых рабочих процессов при получении главным процессом запро-
са на быстрое отключение до завершения запуска базы (Александр Кукушкин)
• Обновление карты свободного пространства при воспроизведении из WAL изменений флагов
замороженных/полностью видимых страниц (Альваро Эррера)
Ранее мы не заботились об этом, считая, что в карте свободного пространства в любом слу-
чае нет важной информации. Однако если она сильно устаревает, это может привести к зна-
чительному снижению производительности после повышения ведомого сервера до основного.
Эта карта в конце концов будет исправлена в результате обновлений, но мы хотим иметь её в
2301Замечания к выпуску
хорошем состоянии раньше, поэтому стоит приложить дополнительные усилия и поддержи-
вать её актуальность при воспроизведении WAL.
• Предотвращение преждевременного освобождения ресурсов параллельных исполнителей по
окончании запроса или при достижении предельного числа кортежей (Амит Капила)
В этот момент завершение исполнителя допустимо, только если вызывающий процесс не мо-
жет запросить обратное сканирование.
• Отказ от вызова обработчиков atexit при обработке SIGQUIT (Хейкки Линнакангас)
• Исключение сопоставлений пользователей для сторонних серверов из состава расширений
(Том Лейн)
При выполнении CREATE USER MAPPING в скрипте расширения для создаваемого сопоставле-
ния добавлялась зависимость, чего не должно быть. Сопоставления пользователей, как и ро-
ли, не могут быть членами расширений.
• Исправление поведения syslogger в случае ошибок при попытке открыть файлы CSV (Том
Лейн)
• При передаче в libpq нескольких имён узлов они должны разрешаться в DNS не все сразу, а
каждое в свою очередь (Том Лейн)
Это предотвращает отказы, которых можно избежать, и замедления подключения после
успешного соединения с одним из предыдущих серверов в списке.
• Исправление поведения libpq, чтобы тайм-ауты при подключении корректно применялись для
отдельного имени или IP-адреса узла (Том Лейн)
Ранее при некоторых условиях таймер при переключении на следующий узел не перезапус-
кался, что могло приводить к преждевременному тайм-ауту.
• Исправление кода psql, а также примеров в документации, чтобы функция PQconsumeInput()
вызывалась перед PQnotifies() (Том Лейн)
Тем самым решена проблема, когда psql не выдавал полученное сообщение NOTIFY до следую-
щей команды.
• Исправление в pg_dump обработки ключа –no-publications, чтобы с ним также игнорирова-
лись таблицы публикации (Жиль Даролд)
• Исключение из выгрузки pg_dump идентификационной последовательности при исключении
её родительской таблицы (Дэвид Роули)
• Устранение возможной несогласованности при сортировке различных имён объектов в
pg_dump (Джейкоб Чемпион)
• Исправление pg_restore, чтобы при выдаче команд DISABLE/ENABLE TRIGGER имя таблицы до-
полнялось схемой (Том Лейн)
Это предотвращает сбои, возможные при новой политике выполнения восстановления с огра-
ниченным путём поиска.
• В pg_upgrade исправлена обработка событийных триггеров в расширениях (Харибабу Комми)
Ранее pg_upgrade не сохранял связь событийных триггеров с расширениями.
• Исправление проверки состояния кластера в pg_upgrade, чтобы она корректно выполнялась
на ведомом сервере (Брюс Момджян)
• Ограничение числа размерностей в значениях cube во всех функциях contrib/cube (Андрей
Бородин)
Ранее в некоторых функциях, связанных с кубами, можно было создать такие значения, кото-
рые затем не принимала функция cube_in(), что вызывало ошибки при восстановлении вы-
груженных данных.
2302Замечания к выпуску
• В contrib/pg_stat_statements роли pg_read_all_stats запрещено выполнение
pg_stat_statements_reset() (Харибабу Комми)
Роли pg_read_all_stats должно позволяться только чтение статистики, но не её изменение,
поэтому разрешение на выполнение этой функции ей было дано некорректно.
Чтобы это изменение вступило в силу, выполните ALTER EXTENSION pg_stat_statements
UPDATE в каждой базе данных, где установлено расширение pg_stat_statements.
• Недопущение передачи расширением contrib/postgres_fdw предложений ORDER BY, не со-
держащих переменных, на удалённый сервер (Эндрю Гирт)
• Исправление функции unaccent() в расширении contrib/unaccent, чтобы она использовала
словарь текстового поиска unaccent, находящийся в той же схеме, где и сама функция (Том
Лейн)
Ранее она пыталась найти словарь по пути поиска, но могла не обнаружить его, если путь по-
иска был ограничен.
• Устранение проблем при сборке в macOS 10.14 (Mojave) (Том Лейн)
Усовершенствование скрипта configure, чтобы в CPPFLAGS добавлялся ключ -isysroot; без
этого PL/Perl и PL/Tcl нельзя сконфигурировать или собрать в macOS 10.14. Значение sysroot
можно переопределить во время конфигурирования или сборки, установив переменную
PG_SYSROOT в аргументах configure или make.
Теперь рекомендуется, чтобы для связанных с Perl расширений во флагах компилятора указы-
валось $(perl_includespec), а не -I$(perl_archlibexp)/CORE. Второй вариант по-прежнему
будет работать на большинстве платформ, но не в последних macOS.
Также теперь не требуется указывать вручную ключ –with-tclconfig, чтобы собрать PL/Tcl в
последних версиях macOS.
• Исправление скриптов сборки с MSVC и регрессионного тестирования для работы с последни-
ми версиями Perl (Эндрю Дунстан)
Это изменение вызвано тем, что Perl теперь по умолчанию не включает текущий каталог в
свой путь поиска.
• Реализована возможность запускать регрессионные тесты в Windows с учётной записью адми-
нистратора (Эндрю Дунстан)
Чтобы это было безопасно, pg_regress теперь лишает себя расширенных прав при запуске.
• Снятие запрета на возврат из функций сравнения btree значений INT_MIN (Том Лейн)
До настоящего времени мы не позволяли типозависимым функциям сравнения возвращать
INT_MIN, благодаря чему вызывающий код мог сменить порядок сортировки, просто изменив
знак результата сравнения. Однако это могло вызывать проблемы с функциями сравнения,
возвращающими непосредственно результат memcmp(), strcmp() и подобных функций, так как
POSIX не накладывает на него никаких ограничений. Как минимум некоторые последние вер-
сии memcmp() могут возвращать INT_MIN, что приводило к нарушению порядка сортировки. В
связи с этим мы убрали это ограничение. Там же, где требуется поменять порядок сортировки
на противоположный, теперь нужно использовать макрос INVERT_COMPARE_RESULT().
• Устранение риска рекурсии при обработке сообщений об аннулировании общего кеша (Том
Лейн)
Эта ошибка могла привести, например, к сбою при обращении к системному каталогу или ин-
дексу, который был только что обработан командой VACUUM FULL.
В результате этого изменения функция LockAcquire теперь может возвращать новый код ре-
зультата, что теоретически может вызвать проблемы при использовании этой функции, хо-
2303Замечания к выпуску
тя для этого схема её использования должна быть весьма необычной. Также был изменён API
функции LockAcquireExtended.
• Сохранение и восстановление глобальных переменных SPI в SPI_connect() и SPI_finish()
(Чепмен Флэк, Том Лейн)
Это предотвращает накладки, возможные при вызове из одной функции, использующей SPI,
другой такой функции.
• Предотвращение использования потенциально невыравненных буферов страниц (Том Лейн)
Добавлены новые типы-объединения PGAlignedBlock и PGAlignedXLogBlock, которые должны
использоваться вместо простых массивов char, чтобы компилятор гарантированно выравни-
вал адрес начала буфера. В результате устраняется риск аварийного сбоя на платформах, чув-
ствительных к выравниванию, и может увеличиться быстродействие даже на тех платформах,
где выравнивание не требуется.
• Приведение в src/port/snprintf.c значения результата snprintf() в соответствие со стан-
дартом C99 (Том Лейн)
На платформах, где этот код используется (в основном в Windows), его несовременное поведе-
ние (не соответствующие C99) могло препятствовать выявлению переполнения буфера, если
вызывающий код рассчитывал на семантику C99.
• Требование обязательного использования -msse2 при сборке компилятором clang для i386
(Андрес Фройнд)
Тем самым решается проблема отсутствия проверок переполнения при операциях с плаваю-
щей точкой.
• Исправление в configure проверки, определяющей, результат какого типа возвращает
strerror_r() (Том Лейн)
Предыдущая реализация давала неправильный ответ при сборке с использованием компиля-
тора icc в Linux (возможно, и в других случаях), в результате чего libpq не выдавала полезные
сообщения при возникновении системных ошибок.
• Обновление данных часовых поясов до версии tzdata 2018g, включающее изменений правил
перехода на летнее время в России (Волгограде), Чили, Марокко и на Фиджи, а также коррек-
тировку исторических данных для Китая, Гавайев, Японии, Макао и Северной Кореи.
E.4. Выпуск 10.5
Дата выпуска:
2018-08-09
В этот выпуск вошли различные исправления, внесённые после версии 10.4. За информацией о
нововведениях версии обратитесь к Разделу E.9.
E.4.1. Миграция на версию 10.5
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Если вы обновляете сервер с более ранней версии, чем 10.4, см. также Раздел E.5.
E.4.2. Изменения
• Осуществление полного сброса состояния libpq между попытками соединения (Том Лейн)
Непривилегированный пользователь dblink или postgres_fdw мог обойти проверки, пред-
назначенные для предотвращения использования учётных данных на стороне сервера, на-
пример, файла ~/.pgpass, принадлежащего пользователю ОС, от имени которого работа-
2304Замечания к выпуску
ет сервер. В частности, уязвимость затрагивает серверы, принимающие локальные подклю-
чения с методом peer. Возможны были и другие атаки, например, SQL-инъекции в сеансе
postgres_fdw. Для атаки на postgres_fdw через эту уязвимость пользователь должен был
иметь возможность создавать объект стороннего сервера с нужными параметрами подключе-
ния, но атаку на dblink мог произвести любой пользователь, имеющий к нему доступ. Вообще
любой пользователь, имеющий возможность менять параметры подключения для приложения
на базе libpq, мог производить непредусмотренные действия, но другие эффективные сцена-
рии эксплуатации этого сложно придумать. Мы благодарим Андрея Красичкова за сообщение
о данном дефекте. (CVE-2018-10915)
• Исправление поведения INSERT … ON CONFLICT UPDATE с более сложным представлением,
чем просто SELECT * FROM … (Дин Рашид, Амит Ланготе)
Ошибочное развёртывание изменяемого представления могло приводить к сбоям или ошиб-
кам «attribute … has the wrong type» (атрибут … имеет неверный тип), если список SELECT
представления не соответствовал в точности списку столбцов нижележащей таблицы. Более
того, развив атаку через эту уязвимость, злоумышленник мог изменять столбцы, не имея для
них права UPDATE, но имея права INSERT и UPDATE для некоторых других столбцов в таблице.
Любой пользователь также мог эксплуатировать её для раскрытия содержимого памяти сер-
вера. (CVE-2018-10925)
• Обеспечение своевременного изменения полей relfrozenxid и relminmxid в «зафиксирован-
ных» системных каталогах (Андрес Фройнд)
Из-за чрезмерно оптимистичного кеширования эти изменения могли оказаться невидимыми
для других сеансов, что приводило к случайным ошибкам и/или разрушению данных. Для об-
щих каталогов, таких как pg_authid, проблема была ещё острее, так как устаревшие кеширо-
ванные данные могли попадать в новые сеансы и оставаться в существующих.
• Исправление поведения в ситуации, когда недавно повышенный сервер аварийно завершает-
ся до окончания обработки первой контрольной точки после восстановления (Микаэль Пакье,
Кётаро Хоригути, Паван Деоласи, Альваро Эррера)
В такой ситуации сервер не считал, что при последующем воспроизведении WAL было достиг-
нуто согласованное состояние базы данных, и это препятствовало его перезапуску.
• Исключение выдачи фантомной записи WAL при переработке полностью нулевой страницы
индекса btree (Амит Капила)
Эта ошибка проявлялась в сбоях проверочных утверждений и могла приводить к неоправдан-
ным отменам запросов на серверах горячего резерва.
• При воспроизведении WAL добавлена защита от некорректной длины записи, превышающей 1
ГБ (Микаэль Пакье)
Подобные данные должны считаться некорректными. Ранее код пытался выделить такой объ-
ём и получал критическую ошибку, что делало восстановление невозможным.
• При завершении восстановления запись в файл истории линии времени должна откладывать-
ся, насколько это возможно (Хейкки Линнакангас)
Это позволяет избежать ситуаций с несогласованностью состояния линии времени на диске,
возникавших при сбое в процессе очистки после восстановления (например, при проблеме с
файлом двухфазного состояния).
• Увеличение скорости воспроизведения WAL для транзакций, удаляющих множество отноше-
ний (Фудзии Масао)
В результате этого изменения уменьшается число сканирований общих буферов, поэтому эф-
фект от данного изменения тем больше, чем больше значение shared_buffers.
• Увеличение скорости освобождения блокировки при воспроизведении WAL ведомым сервером
(Томас Мунро)
2305Замечания к выпуску
• Обеспечение согласованной передачи состояния логической трансляции передатчиками WAL
(Саймон Риггс, Савада Масахико)
Ранее код не мог правильно определить, удалось ли нагнать вышестоящий сервер.
• Обеспечение наличия снимка при выполнении функций ввода типа данных в подписчиках ло-
гической репликации (Мин-Цюань Тран, Альваро Эррера)
Отсутствие снимка в некоторых случаях приводило к сбоям, например, при вводе доменов с
ограничениями, определяемыми функциями на языке SQL.
• Устранение дефектов в процедуре обработки снимков при логическом декодировании, приво-
дивших к ошибкам декодирования в редких случаях (Арсений Шер, Альваро Эррера)
• Добавление обработки подтранзакций в рабочих процессах синхронизации таблиц при логиче-
ской репликации (Амит Хандекар, Роберт Хаас)
Ранее синхронизация таблицы могла выполняться некорректно в случае отката подтранзак-
ций после модификации синхронизируемой таблицы.
• Обеспечение корректного сброса кешированного списка индексов таблицы после сбоя при со-
здания индекса (Питер Геохеган)
Ранее в этом списке могли оставаться OID нерабочих индексов, что могло приводить к про-
блемам в том же сеансе.
• Исправление некорректной обработки пустых несжатых страниц списка идентификаторов в
индексах GIN (Шивасубраманьян Рамасубраманьян, Александр Коротков)
Это могло привести к сбою проверочного утверждения после выполнения pg_upgrade для ин-
дексов GIN версии до 9.4 (в 9.4 и последующих версиях такие страницы не создаются).
• Выравнивание массивов безымянных семафоров POSIX для уменьшения разделения линий ке-
ша (Томас Мунро)
Это снижает конкуренцию в многопроцессорных системах и устраняет падение производи-
тельности (наблюдаемое в сравнении с предыдущими выпусками) в Linux и FreeBSD.
• Обеспечение реакции на сигналы в процессе, производящем параллельное сканирование ин-
декса (Амит Капила)
Ранее параллельные исполнители могли «зависать», ожидая блокировки страницы индекса, и
не замечать сигналы прерывания запроса.
• Обеспечение реакции на сигналы в процессе VACUUM в цикле удаления страниц B-дерева (Ан-
дрес Фройнд)
С испорченными индексами btree цикл мог оказаться бесконечным, и прервать его можно бы-
ло только аварийно отключив сервер.
• Исправление ошибки с оценкой стоимости соединения по хешу при оптимизации inner_unique
(Дэвид Роули)
Это могло приводить к выбору неудачного плана запроса, когда применялась эта оптимиза-
ция.
• Исправление некорректной оптимизации классов эквивалентности со столбцами составного
типа (Том Лейн)
Вследствие данной ошибки сервер не понимал, что индекс по составному столбцу может обес-
печить порядок сортировки, необходимый для соединения слиянием с данным столбцом.
• Исправление планировщика с целью устранения ошибок «ORDER/GROUP BY expression not
found in targetlist» (выражение ORDER/GROUP BY не найдено в целевом списке) при выполне-
нии некоторых запросов с функциями, возвращающими множества (Том Лейн)
2306Замечания к выпуску
• Исправление обработки ключей секционирования с типами данных, которые используют по-
лиморфный класс операторов btree; например, это касается массивов (Амит Ланготе, Альваро
Эррера)
• Исправление синтаксиса конструкции SQL-стандарта FETCH FIRST, чтобы она принимала ($n),
как того требует стандарт (Эндрю Гирт)
• Удаление недокументированного ограничения, не допускающего дублирования столбцов в
ключах разбиения (Юго Нагата)
• Недопущение использования временных таблиц в качестве секций не временных, а обычных
таблиц (Амит Ланготе, Микаэль Пакье)
Ранее такое использование разрешалось, но работало ненадёжно.
• Исправление в EXPLAIN учёта использования ресурсов, в частности, обращений к буферам
(Амит Капила, Томас Мунро)
• Исправление поведения SHOW ALL, чтобы эта команда показывала все параметры членам ро-
ли pg_read_all_settings и позволяла этим пользователям видеть имя файла и номер строки в
представлении pg_settings (Лоренц Альбе, Альваро Эррера)
• Корректное добавление схемы к именам ряда объектов в выводе getObjectDescription и
getObjectIdentity (Кётаро Хоригути, Том Лейн)
Имена правил сортировки, преобразований, объектов текстового поиска, отношений публика-
ций и объектов расширенной статистики не дополнялись схемой, тогда как должны были.
• Исправление проверки типа CREATE AGGREGATE с тем, чтобы к агрегатам с переменными аргу-
ментами можно было присоединять функции поддержки распараллеливания (Алексей Башта-
нов)
• Расширение счётчика строк в команде COPY FROM с 32 до 64 бит (Дэвид Роули)
Тем самым были решены две проблемы с входными данными, содержащими более 4G строк:
COPY FROM WITH HEADER терял одну строку на каждые 4G строк (не только первую), а в сообще-
ниях об ошибках выводилось неверное количество строк.
• Восстановление возможности удаления слотов репликации в однопользовательском режиме
(Альваро Эррера)
Она была непреднамеренно утрачена в выпуске 10.0.
• Исправление некорректных результатов функции variance(int4) и связанных агрегатов при
работе в параллельном режиме агрегирования (Дэвид Роули)
• Внесение корректив в обработку узлов TEXT и CDATA в выражениях столбцов xmltable() (Мар-
кус Винанд)
• Защита от возможной ошибки в функции OpenSSL RAND_bytes() (Дин Рашид, Микаэль Пакье)
При редких обстоятельствах это упущение могло приводить к отказам с сообщением «could
not generate random cancel key» (не удалось сгенерировать случайный ключ отмены), устра-
нить которые можно было, только перезапустив главный процесс.
• Исправление поведения libpq в некоторых случаях, когда задаётся hostaddr (Хари Бабу, Том
Лейн, Роберт Хаас)
Функция PQhost() в некоторых случаях выдавала некорректные или вводящие в заблуждение
результаты. Теперь она единообразно возвращает имя узла (если оно указано), или адрес узла
(если указан только он), или имя узла по умолчанию (обычно /tmp либо localhost, если опу-
щены оба параметра).
Также при проверке сертификата SSL с именем сервера могло сравниваться неправильное
значение.
2307Замечания к выпуску
Кроме того, поле с именем узла в ~/.pgpass могло сравниваться с неправильным значением.
Теперь это поле сравнивается с именем сервера (если оно указано), либо с его адресом (если
указан только он), либо с localhost (если опущены оба параметра).
Помимо этого, когда значение hostaddr нельзя было разобрать, выдавалось неправильное со-
общение об ошибке.
А когда параметры host, hostaddr или port содержат списки через запятую, libpq теперь ак-
куратнее обрабатывает пустые элементы списков (воспринимая их как значения по умолча-
нию).
• Добавление в библиотеку ecpg pgtypes функции освобождения строк для исключения про-
блем с управлением памятью в разных модулях (Такаюки Цунакава)
В Windows могут происходить сбои, если вызов free для некоторого блока памяти произво-
дится не из той DLL, которая выделила память (с помощью malloc). Библиотека pgtypes ино-
гда возвращает строки, которые должен освободить вызывающий код, и сделать это корректно
оказывается невозможно. Добавленная функция PGTYPESchar_free() является просто обёрт-
кой free, позволяющей приложениям произвести освобождение по правилам.
• Исправление поддержки в ecpg переменных long long в Windows, а также на других платфор-
мах, где strtoll/strtoull объявлены нестандартно или не объявлены вовсе (Хыонг Дангминь,
Том Лейн)
• Исправление ошибки с определением типа SQL-оператора в PL/pgSQL, когда изменение пра-
вила приводило к изменению семантики оператора в рамках сеанса (Том Лейн)
Эта ошибка приводила к сбоям проверочных утверждений или, в редких случаях, к тому, что
указание INTO STRICT не работало должным образом.
• Исправление запроса пароля в клиентских программах, чтобы отображение корректно отклю-
чалось в Windows, когда stdin — не терминал (Мэтью Стикни)
• Доработка исправления некорректного заключения в кавычки значений для переменных GUC
со списками при формировании дампа (Том Лейн)
Предыдущее исправление для заключения в кавычки значения search_path и других пере-
менных со списками в выводе pg_dump, как оказалось, привело к ошибкам со списками с пу-
стыми элементами и риску потери части длинных файловых путей.
• В pg_dump устранено упущение, когда свойства REPLICA IDENTITY для индексов ограничений
не выгружались (Том Лейн)
Уникальные индексы, созданные вручную, помечались корректно, а индексы, созданные огра-
ничениями UNIQUE или PRIMARY KEY — нет.
• В pg_upgrade теперь правильно проверяется, что старый сервер был выключен штатно (Брюс
Момджян)
Ранее проверка могла сработать некорректно при выключении сервера в незамедлительном
режиме.
• Исправление в contrib/hstore_plperl просмотра скалярных ссылок Perl и предотвращение
сбоя в случае, если не удаётся найти хеш-ссылку там, где она ожидается (Том Лейн)
• Устранение сбоя в функции модуля contrib/ltree при получении на вход пустого массива
(Пьер Дюкроке)
• Исправление обработки ошибок в ряде мест, где мог выдаваться некорректный код ошибки
(Микаэль Пакье, Том Лейн, Магнус Хагандер)
• Переоформление скриптов Makefile для обеспечения компоновки программ с собранными в
том же дереве библиотеками (например, libpq.so), а не с теми, что могут уже находиться в
системных каталогах библиотек (Том Лейн)
2308Замечания к выпуску
Это позволяет избежать проблем при сборке на платформах, где представлены старые версии
библиотек PostgreSQL.
• Обновление данных часовых поясов до версии tzdata 2018e, включающее изменение правил
перехода на летнее время в Северной Корее, а также корректировку исторических данных
для Чехословакии.
В это обновление вошло переопределение «летнего времени», которое действует в Ирландии,
а также действовало в прошлом в Намибии и в Чехословакии. В этих юрисдикциях стандарт-
ное время действует летом, а время для экономии света — зимой, поэтому при переходе на
это время сдвиг производится на час назад, а не на час вперёд. Это не влияет ни на фактиче-
ское смещение от UTC, ни на используемое сокращение часового пояса; эта особенность про-
является лишь в том, что в таких случаях столбец is_dst в представлении pg_timezone_names
будет содержать true для зимнего периода, и false для летнего.
E.5. Выпуск 10.4
Дата выпуска:
2018-05-10
В этот выпуск вошли различные исправления, внесённые после версии 10.3. За информацией о
нововведениях 10 версии обратитесь к Разделу E.9.
E.5.1. Миграция на версию 10.4
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Однако если вы используете расширение adminpack, его нужно обновить, следуя указаниям в пер-
вой записи в списке изменений.
Кроме того, если вас касаются ошибки с пометкой функций, описанные во второй и третьей записи
ниже, потребуются дополнительные действия для исправления каталогов баз данных.
Если вы обновляете сервер с более ранней версии, чем 10.3, см. также Раздел E.6.
E.5.2. Изменения
• Лишение роли public права на выполнение функции pg_logfile_rotate() из contrib/
adminpack (Стивен Фрост)
Функция pg_logfile_rotate() является устаревшей оболочкой функции ядра
pg_rotate_logfile(). Когда в последней была удалена жёсткая проверка суперпользователя,
чтобы доступ к этой функции ограничивался правами SQL, эти изменения следовало отразить
и в pg_logfile_rotate(), но это было упущено. Таким образом, с установленным расширени-
ем adminpack любой пользователь мог запросить прокрутку файла журнала, что можно счи-
тать некритичным нарушением безопасности.
После установки этого обновления администраторы должны обновить adminpack, выпол-
нив ALTER EXTENSION adminpack UPDATE в каждой базе данных, где установлен adminpack.
(CVE-2018-1115)
• Исправление некорректных пометок изменчивости для нескольких встроенных функций (То-
мас Мунро, Том Лейн)
Функции query_to_xml, cursor_to_xml, cursor_to_xmlschema, query_to_xmlschema и
query_to_xml_and_xmlschema должны были считаться изменчивыми, так как они выполняют
пользовательские запросы, в которых могут быть изменчивые операции. Однако они не бы-
ли помечены должным образом, что было чревато неправильной оптимизацией запросов. Это
было исправлено для новых инсталляций в результате корректировки исходных данных ката-
лога, но в существующих инсталляциях ошибочные пометки сохранятся. При практическом
2309Замечания к выпуску
использовании этих функций риск кажется небольшим, но в случае необходимости их мож-
но исправить, вручную изменив записи этих функций в pg_proc. Например: ALTER FUNCTION
pg_catalog.query_to_xml(text, boolean, boolean, text) VOLATILE. (Заметьте, что это нуж-
но будет проделать в каждой базе данных инсталляции.) Также вы можете обновить базу до
версии с корректными исходными данными, воспользовавшись pg_upgrade.
• Исправление некорректных пометок параллельно-безопасности для нескольких встроенных
функций (Thomas Munro, Tom Lane)
Функции brin_summarize_new_values, brin_summarize_range, brin_desummarize_range,
gin_clean_pending_list, cursor_to_xml, cursor_to_xmlschema, ts_rewrite, ts_stat,
binary_upgrade_create_empty_extension и pg_import_system_collations должны были счи-
таться параллельно-небезопасными, так как одни из них непосредственно модифицируют ба-
зу данных, а другие выполняют пользовательские запросы, которые могут это делать. Они
были некорректно помечены как параллельно-безопасные, что могло приводить к неожи-
данным ошибкам запросов. Это было исправлено для новых инсталляций в результате кор-
ректировки исходных данных каталога, но в существующих инсталляциях ошибочные помет-
ки сохранятся. При практическом использовании этих функций риск кажется небольшим,
если только не включён режим force_parallel_mode, но в случае необходимости их мож-
но исправить, вручную изменив записи этих функций в pg_proc. Например: ALTER FUNCTION
pg_catalog.brin_summarize_new_values(regclass) PARALLEL UNSAFE. (Заметьте, что это нуж-
но будет проделать в каждой базе данных инсталляции.) Также вы можете обновить базу до
версии с корректными исходными данными, воспользовавшись pg_upgrade.
• Предотвращение повторного использования для TOAST идентификаторов OID, соответствую-
щих уже неактуальным, но ещё не очищенным записям TOAST (Паван Деоласи)
После зацикливания счётчика OID имеется возможность использования для значения TOAST
идентификатора OID, соответствующего ранее удалённой записи в той же таблице TOAST.
Если запись не была очищена к тому времени, это приводило к ошибкам «unexpected chunk
number 0 (expected 1) for toast value nnnnn» (неожиданный номер порции 0 (ожидался 1) для
значения TOAST nnnnn), которые сохранялись до удаления неактуальной записи командой
VACUUM. В качестве решения выбор таких OID при создании новых записей TOAST теперь ис-
ключается.
• Корректная проверка всех ограничений CHECK для отдельных секций при выполнении COPY в
секционированную таблицу (Эцуро Фудзита)
Ранее проверялись только ограничения, заданные для секционированной таблицы в целом.
• Допущение значений TRUE и FALSE в качестве границ секции (Амит Ланготе)
Ранее для логического секционирующего столбца принимались только строковые литералы,
но pg_dump выводит эти значения как TRUE/FALSE, что приводило к ошибкам при выгрузке/за-
грузке данных.
• Исправление работы с памятью в функциях сравнения ключей секционирования (Альваро Эр-
рера, Амит Ланготе)
Эта ошибка могла приводить к сбоям при использовании для ключей секционирования клас-
сов операторов, определённых пользователем.
• Устранение возможности сбоя при добавлении запросом кортежей в несколько секций секци-
онированной таблицы, когда эти секции имеют разные типы строк (Эцуро Фудзита, Амит Лан-
готе)
• Изменение алгоритма ANALYZE в части модификации pg_class.reltuples (Дэвид Гулд)
Ранее плотность кортежей могла обновляться только для страниц, прошедших обработку
ANALYZE, для остальных плотность считалась прежней. В большой таблице, где ANALYZE выби-
рает лишь небольшой процент страниц, это означает, что возможно лишь незначительное из-
менение общей оценки плотности кортежей, и поэтому reltuples будет меняться практиче-
2310Замечания к выпуску
ски пропорционально изменениям физического размера таблицы (relpages) вне зависимо-
сти от того, что фактически происходит в таблице. В результате может наблюдаться настоль-
ко большое увеличение reltuples по сравнению с реальностью, что автоматическая очистка
практически отключается. Для исправления этой ошибки принимается, что выборка ANALYZE
является статистически несмещённой (какой она и должна быть), и наблюдаемая в ней плот-
ность просто экстраполируется на всю таблицу.
• Включение объектов расширенной статистики в набор свойств таблицы, копируемых кон-
струкцией CREATE TABLE … LIKE … INCLUDING ALL (Дэвид Роули)
Также добавлено указание INCLUDING STATISTICS для явного управления включением этой
информации.
• Исправление работы CREATE TABLE … LIKE со столбцами идентификации типа bigint (Пи-
тер Эйзентраут)
На платформах, где long имеет размер 32 бита (что включает 64-битные Windows, а также
большинство 32-битных систем), копируемые параметры последовательностей усекались до
32 бит.
• Предупреждение взаимоблокировок в параллельных командах CREATE INDEX CONCURRENTLY,
выполняемых на уровнях изоляции SERIALIZABLE и REPEATABLE READ (Том Лейн)
• Устранение возможности замедленного выполнения REFRESH MATERIALIZED VIEW
CONCURRENTLY (Томас Мунро)
• Устранение ошибки в UPDATE/DELETE … WHERE CURRENT OF в случае, когда задействованный
курсор использует план сканирования только индекса (Юго Нагата, Том Лейн)
• Исправление некорректного планирования, когда предложения соединения передавались в
параметризованные пути (Эндрю Гирт, Том Лейн)
Эта ошибка могла привести к неправильной классификации условия как «фильтра соедине-
ния» для внешнего соединения, тогда как оно должно быть простым «фильтром», и в итоге
мог получиться некорректный результат соединения.
• Устранение возможности некорректного построения плана сканирования только индекса в
случаях, когда один столбец таблицы фигурирует в нескольких индексах, но не во всех этих
индексах используются классы операторов, которые могут выдать значение столбца (Кётаро
Хоригути)
• Исправление некорректной оптимизации ограничений CHECK с гарантированными NULL-под-
выражениями в условиях верхнего уровня AND/OR (Том Лейн, Дин Рашид)
В результате, например, ограничение-исключение могло исключить из запроса дочернюю
таблицу, которая не должна быть исключена.
• Предотвращение сбоя планировщика в случаях, когда запрос содержит несколько наборов
GROUPING SETS, и ни один из них нельзя получить сортировкой (Эндрю Гирт)
• Устранение сбоя исполнителя в результате двойного освобождения памяти с некоторыми ва-
риантами использования GROUPING SET (Питер Геохеган)
• Исправление некорректного выполнения замкнутого соединения переходных таблиц (Томас
Мунро)
• Предотвращение сбоя в случае, когда триггер события перезаписи таблицы добавляется од-
новременно с выполнением команды, которая может вызвать такой триггер (Альваро Эррера,
Эндрю Гирт, Том Лейн)
• Предотвращение ошибки при прерывании запроса или прекращении сеанса в момент фикси-
рования подготовленной транзакции (Стас Кельвич)
• Ликвидация утечки памяти на время выполнения запроса в последовательно выполняемых со-
единениях по хешу (Том Лейн)
2311Замечания к выпуску
• Устранение возможных утечек или двойного освобождения закреплений буферов карты види-
мости (Амит Капила)
• Устранение неоправданной пометки страниц как полностью видимых (Дэн Вуд, Паван Деола-
си, Альваро Эррера)
Это могло происходить при блокировании (но не удалении) некоторых кортежей. Хотя за-
просы будут продолжать выполняться корректно, процедура очистки обычно игнорирует та-
кие страницы, вследствие чего кортежи на них никогда не будут замораживаться. В послед-
них выпусках это в конце концов приведёт к появлению ошибок вида «found multixact nnnnn
from before relminmxid nnnnn» (найдена мультитранзакция nnnnn, предшествующая relminmxid
nnnnn).
• Исправление излишне строгой проверки в heap_prepare_freeze_tuple (Альваро Эррера)
Это могло приводить к необоснованной ошибке «cannot freeze committed xmax» (не удаётся за-
морозить зафиксированный xmax) в базах данных, обновлённых с помощью pg_upgrade с вер-
сии 9.2 или старее.
• Устранение потери указателя в случаях, когда написанный на С триггер, выполняемый до из-
менения строки, возвращает старый кортеж («old») (Рушаб Латиа)
• Понижение уровня блокировки при планировании работы автоочистки (Джефф Джейнс)
Предыдущее поведение создавало значительные препятствия для параллельного выполнения
рабочих процессов в базах, содержащих множество таблиц.
• Обеспечение копирования имени клиентского компьютера при копировании данных
pg_stat_activity в локальную память (Эдмунд Хорнер)
Ранее предположительно локальный экземпляр содержал указатель на разделяемую память,
вследствие чего содержимое поля с именем клиентского компьютера могло неожиданно из-
мениться при отключении какого-либо сеанса.
• Корректная обработка информации pg_stat_activity для вспомогательных процессов (Эд-
мунд Хорнер)
Поля application_name, client_hostname и query для таких процессов могли содержать
неверные данные.
• Исправление некорректной обработки нескольких составных аффиксов в словарях ispell (Ар-
тур Закиров)
• Исправление поиска (то есть сканирования индекса с операторами неравенства), зависимого
от правила сортировки, в индексах SP-GiST, построенных по текстовым столбцам (Том Лейн)
Такой поиск мог возвращать неправильный набор строк для большинства правил сортировки,
отличных от C.
• Предотвращение утечки памяти на время выполнения запроса в классах операторов SP-GiST,
использующих переходящие значения (Антон Дигнос)
• Корректировка вычисления количества кортежей в индексе при изначальном построении ин-
декса SP-GiST (Томаш Вондра)
Ранее количество кортежей в индексе считалось равным количеству кортежей в нижележа-
щей таблице, что неверно в случае частичного индекса.
• Корректировка вычисления количества кортежей в индексе при очистке индекса GiST (Ан-
дрей Бородин)
Ранее оно считалось равным примерному количеству кортежей в куче, что провоцировало
неточность и определённо было ошибочным в случае частичного индекса.
• Исправление поведения в особом случае, когда ведомый реплицирующий сервер «застревал»
на записи продолжения WAL (Кётаро Хоригути)
2312Замечания к выпуску
• При логическом декодировании приняты меры во избежание двойной обработки данных WAL
при перезапуске передатчика WAL (Крейг Рингер)
• Исправление механизма логической репликации, чтобы он не полагался на совпадение OID
типов между локальным и удалённым серверами (Масахико Савада)
• Поддержка использования scalarltsel и scalargtsel с расширенными типами данных (То-
маш Вондра)
• Уменьшение потребления памяти libpq в случаях, когда сервер выдаёт ошибку после получе-
ния большого объёма результата запроса (Том Лейн)
Полученный ранее результат должен быть отброшен до, а не после обработки ошибки. На
некоторых платформах, в частности в Linux это может влиять на то, сколько памяти будет за-
нимать приложение.
• Устранение сбоев в ecpg, вызванных двойным освобождением памяти (Патрик Крекер, Джи-
ван Ладхе)
• Исправление обработки переменных long long int в ecpg, собранном с использованием
MSVC (Михаэль Мескес, Эндрю Гирт)
• Исправление некорректного заключения в кавычки значений для переменных GUC со списка-
ми при формировании дампа (Микаэль Пакье, Том Лейн)
Переменные local_preload_libraries, session_preload_libraries,
shared_preload_libraries и temp_tablespaces не заключались в кавычки корректно в выводе
pg_dump. Это могло приводить к проблемам, если эти переменным присваивались значения в
конструкциях CREATE FUNCTION … SET или ALTER DATABASE/ROLE … SET.
• Предотвращение отказа pg_recvlogical при подключении к серверам PostgreSQL до 10 версии
(Микаэль Пакье)
В результате предыдущего исправления программа pg_recvlogical, не проверяя версию серве-
ра, выдавала команду, которая должна предназначаться только серверам версии 10 и новее.
• Исправление поведения pg_rewind, чтобы на целевом сервере удалялись файлы, которые мог-
ли быть удалены в процессе выполнения на исходном сервере (Такаюки Цунакава)
В противном случае на целевом сервере могла нарушаться согласованность данных, особенно
если это был файл сегмента WAL.
• Исправление в pg_rewind обработки таблиц в дополнительных табличных пространствах (Та-
каюки Цунакава)
• Исправление обработки целочисленного переполнения в циклах FOR на языке PL/pgSQL (Том
Лейн)
Ранее с некоторыми компиляторами, отличными от gcc, переполнение переменной цикла не
проверялось, в результате чего цикл оказывался бесконечным.
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.7 (Питер Эйзен-
траут)
• Поддержка тестирования PL/Python и связанных модулей при сборке с использованием Python
3 и MSVC (Эндрю Дунстан)
• Устранение ошибок при изначальном построении индексов contrib/bloom (Томаш Вондра,
Том Лейн)
Предотвращение возможного исчезновения последнего кортежа таблицы из индекса. Исправ-
ление подсчёта количества кортежей в частичных индексах.
• Переименование функций b64_encode и b64_decode во избежание конфликта со встроенными
функциями Solaris 11.4 (Райнер Орт)
2313Замечания к выпуску
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией 2018e (Том
Лейн)
В этой версии усовершенствован компилятор данных часовых поясов zic для работы с отрица-
тельными смещениями при переходе на летнее время. Хотя проект PostgreSQL в настоящее
время не поставляет такие данные часовых поясов, zic может применяться с данными, полу-
ченными непосредственно от IANA, поэтому кажется разумным обновить zic сейчас.
• Обновление данных часовых поясов до версии tzdata 2018d, включающее изменения правил
перехода на летнее время в Палестине и Антарктиде (станция Кейси), плюс корректировку
исторических данных для Португалии и её колоний, а также Уругвая и островов Эндербери,
Ямайка, Теркс и Кайкос.
E.6. Выпуск 10.3
Дата выпуска:
2018-03-01
В этот выпуск вошли различные исправления, внесённые после версии 10.2. За информацией о
нововведениях 10 версии обратитесь к Разделу E.9.
E.6.1. Миграция на версию 10.3
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Однако если в вашей СУБД не все пользователи взаимно доверяют друг другу либо если вы под-
держиваете приложение или расширение, предназначенное для использования в произвольных
ситуациях, настоятельно рекомендуется прочитать об изменениях в первой записи ниже и пред-
принять соответствующие действия для защиты вашей инсталляции или кода.
Также изменения, описанные во втором пункте списка ниже, могут приводить к сбоям функций,
используемых в индексных выражениях или материализованных представлениях, во время авто-
матического анализа или при восстановлении выгруженных данных. Поэтому после обновления
проверьте журнал сервера на предмет подобных проблем и исправьте затронутые функции.
Также, если вы обновляете сервер с более ранней версии, чем 10.2, см. Раздел E.7.
E.6.2. Изменения
• Добавление в документацию информации о настройке серверов и приложений для защиты от
атак с внедрением троянского кода через путь поиска (Ной Миш)
Когда используется значение search_path, включающее схемы, доступные для записи зло-
намеренному пользователю, он может перехватывать управление над выполнением запросов
и затем запускать произвольный SQL-код с правами атакуемого пользователя. Хотя есть воз-
можность составлять запросы, защищённые от подобного перехвата, это требует кропотли-
вой работы, и при этом очень легко что-то упустить. Поэтому мы рекомендуем использовать
конфигурации, в которых пути поиска не могут включать недоверенные схемы. Соответству-
ющая информация добавлена в Подраздел 5.8.6 (для пользователей и администраторов баз
данных), Раздел 34.1 (для разработчиков приложений), Подраздел 38.16.1 (для разработчиков
расширений) и CREATE FUNCTION (для разработчиков функций с характеристикой SECURITY
DEFINER). (CVE-2018-1058)
• Предотвращение использования небезопасных значений search_path в pg_dump и других кли-
ентских программах (Ной Миш, Том Лейн)
pg_dump, pg_upgrade, vacuumdb и другие приложения, предоставляемые PostgreSQL, были
уязвимы для перехвата выполнения, описанного в предыдущем пункте; так как эти прило-
жения обычно запускаются суперпользователями, они представляли собой привлекательные
средства для атаки. Чтобы защитить их вне зависимости от того, защищена ли вся инсталля-
ция в целом, они были изменены так, чтобы для них параметр search_path содержал только
pg_catalog. Теперь это так же касается и рабочих процессов автоочистки.
2314Замечания к выпуску
В случаях, когда этими программами неявно вызываются определённые пользователем функ-
ции — например, это могут быть пользовательские функции в выражениях индексов — бо-
лее строгое значение search_path может приводить к ошибкам, которые потребуется испра-
вить так, чтобы эти функции никак не зависели от пути поиска, с которым они выполняются.
Это всегда рекомендовалось делать, но сейчас это необходимо для корректного поведения.
(CVE-2018-1058)
• Предотвращение попыток логической репликации передавать изменения в непубликуемых от-
ношениях (Питер Эйзентраут)
Публикация всех таблиц (с пометкой FOR ALL TABLES) могла некорректно передавать измене-
ния в материализованных представлениях и таблицах information_schema, которые не долж-
ны попадать в поток изменений.
• Исправление некорректного поведения перепроверок одновременных изменений со ссылками
CTE, фигурирующими во внутренних планах (Том Лейн)
Если ссылка на CTE (содержимое предложения WITH) использовалась в InitPlan или SubPlan, и
запросу требовалось провести перепроверку из-за попытки изменения или блокировки одно-
временно изменяемой строки, могли быть получены неверные результаты.
• Устранение сбоев планировщика при перекрывающихся предложениях соединения слиянием
во внешнем соединении (Том Лейн)
Эти дефекты приводили в особых случаях к ошибкам планировщика «left and right pathkeys
do not match in mergejoin» (нарушено соответствие левых и правых ключей пути в соединении
слиянием) или «outer pathkeys do not match mergeclauses» (внешние ключи пути не соответ-
ствуют предложениям слияния).
• Исправление ошибки в pg_upgrade, когда не удавалось сохранить relfrozenxid для материа-
лизованных представлений (Том Лейн, Андрес Фройнд)
Данное упущение могло приводить к разрушению данных в материализованных пред-
ставлениях после обновления. Это могло проявляться в ошибках «could not access status
of transaction» (не удалось получить состояние транзакции) или «found xmin from before
relfrozenxid» (найден xmin перед relfrozenxid). Эта проблема была более вероятна в редко об-
новляемых материализованных представлениях или в представлениях, обновляемых только
командой REFRESH MATERIALIZED VIEW CONCURRENTLY.
Если такое разрушение имело место, его можно исправить, обновив материализованное пред-
ставление (без указания CONCURRENTLY).
• Исправление некорректного вывода pg_dump для некоторых граничных значений последова-
тельностей (Алексей Баштанов)
• Исправление неправильной обработки в pg_dump объектов STATISTICS (Том Лейн)
Схема объекта расширенной статистики неправильно помечалась в оглавлении таблицы вы-
гружаемых данных, что могло приводить к некорректным результатам при восстановлении от-
дельных схем. Также некорректно восстанавливалась информация о владельце. Кроме того,
логика работы изменена так, чтобы объекты статистики выгружались/восстанавливались или
нет как независимые объекты, без учёта того, производится ли выгрузка/восстановление таб-
лицы, к которой они привязаны. Исходное определение не должно распространяться на пла-
нируемое будущее расширение статистики нескольких таблиц.
• Исправление некорректной обработки имён функций PL/Python в стеках ошибки CONTEXT (Том
Лейн)
Ошибка, произошедшая во вложенном вызове функции PL/Python (то есть функции, вызван-
ной через SPI-запрос из другой функции PL/Python), могла привести к тому, что в трассировке
стека вместо ожидаемого результата имя внутренней функции фигурировало дважды. Также
2315Замечания к выпуску
ошибка во вложенном блоке PL/Python DO могла привести к обращению по нулевому указате-
лю на некоторых платформах.
• Максимальное значение log_min_duration для contrib/auto_explain доведено до INT_MAX,
что составляет около 24 суток вместо 35 минут (Том Лейн)
• Для разнообразных переменных GUC добавлена пометка PGDLLIMPORT в целях облегчения пе-
реноса модулей расширений в Windows (Метин Дослу)
E.7. Выпуск 10.2
Дата выпуска:
2018-02-08
В этот выпуск вошли различные исправления, внесённые после версии 10.1. За информацией о
нововведениях 10 версии обратитесь к Разделу E.9.
E.7.1. Миграция на версию 10.2
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Однако если вы используете оператор ~&gt; расширения contrib/cube, прочитайте ниже запись о
нём.
Также, если вы обновляете сервер с более ранней версии, чем 10.1, см. Раздел E.8.
E.7.2. Изменения
• Исправление обработки ключей секционирования, содержащих несколько выражений (Альва-
ро Эррера. Дэвид Роули)
Эта ошибка приводила к сбоям или, со специально сконструированными данными, к раскры-
тию произвольного содержимого памяти обслуживающего процесса. (CVE-2018-1052)
• Временные файлы, создаваемые программой pg_upgrade, должны быть недоступны для чте-
ния всеми пользователями (Том Лейн, Ной Миш)
Программа pg_upgrade обычно ограничивает доступ к своим временным файлам, чтобы их
мог читать и записывать только запускающий её пользователь. Но временные файлы, содер-
жащие вывод pg_dumpall -g могли быть доступны для чтения группе или всем пользовате-
лям, а возможно и для записи, если это допускало значение umask этого пользователя. При
типичном использовании в многопользовательских системах umask и/или разрешения в рабо-
чем каталоге достаточно жёсткие и эта проблема неактуальна; но pg_upgrade может исполь-
зоваться и в сценариях, где это упущение могло привести, например, к утечке паролей баз
данных. (CVE-2018-1053)
• Исправление очистки кортежей, которые были изменены при установленной блокировке раз-
деляемого ключа (Андрес Фройнд, Альваро Эррера)
В некоторых случаях операция VACUUM не удаляла такие кортежи, даже когда они теряли акту-
альность, что приводило к различным сценариям повреждения данных.
• Исправление упущения, когда метастраница хеш-индекса не помечалась как «грязная» по-
сле добавления новой страницы переполнения, что могло приводить к порче индекса (Лисянь
Цзоу, Амит Капила)
• Осуществление очистки очереди добавлений индекса GIN при выполнении VACUUM (Масахи-
ко Савада)
Это необходимо для гарантированного удаления неактуальных записей индекса. Прежний код
делал это в другом порядке, позволяя операции VACUUM пропускать очистку, если какие-то
другие процессы производили очистку параллельно. Однако при этом в индексе могли оста-
ваться некорректные записи.
2316Замечания к выпуску
• Исправление неправильной блокировки буфера при некоторых чтениях LSN (Якоб Чемпион,
Асим Правин, Ашвин Агравал)
Эти ошибки могли приводит к некорректному поведению при многопоточной нагрузке. По-
тенциальные последствия не были характеризованы полностью.
• Исправление некорректных результатов запросов в случаях, когда происходило упрощение
подзапросов, результаты которых использовались в GROUPING SETS (Хейкки Линнакангас)
• Исправление обработки ограничений секционирования по списку с ключами секционирова-
ния логического типа и массивами (Амит Ланготе)
• Исключение неоправданной ошибки в запросе с деревом наследования, который выполнял-
ся одновременно с тем, как некоторая дочерняя таблица удалялась из этого дерева командой
ALTER TABLE NO INHERIT (Том Лейн)
• Устранение разнообразных ошибок взаимоблокировки при выполнении в нескольких сеансах
команды CREATE INDEX CONCURRENTLY (Джефф Джейнс)
• Изменение полей размера таблицы в процессе VACUUM FULL на более раннем этапе (Амит Ка-
пила)
Это предупреждает неоптимальное поведение при перестраивании хеш-индексов таблицы,
так как для расчёта начального размера хеша используется статистика pg_class.
• Исправление работы UNION/INTERSECT/EXCEPT с нулём столбцов (Том Лейн)
• Запрет использования столбцов идентификации с типизированными таблицами и секциями
(Микаэль Пакье)
Такое использование теперь будет считаться неподдерживаемым.
• Исправление разнообразных ошибок, когда в столбец идентификации при добавлении записи
не вставлялось правильное значение по умолчанию (Микаэль Пакье, Питер Эйзентраут)
В некоторых контекстах, а именно в COPY и ALTER TABLE ADD COLUMN, ожидаемое значение по
умолчанию не применялось, а вместо него вставлялось значение NULL.
• Устранение ошибок в ситуациях, когда дерево наследования содержит дочерние сторонние
таблицы (Эцуро Фудзита)
Комбинация обычных и сторонних таблиц в дереве наследования провоцировала построение
некорректных планов в запросах UPDATE и DELETE. Это приводило к видимым ошибкам в неко-
торых случаях, особенно когда в дочерней сторонней таблице присутствовали триггеры уров-
ня строк.
• Исправление дефекта со связанным подзапросом SELECT внутри VALUES в подзапросе LATERAL
(Том Лейн)
• Устранение ошибки планировщика «could not devise a query plan for the given query» (не уда-
лось выработать план для данного запроса) в некоторых случаях, включая вложенные UNION
ALL в подзапросе LATERAL (Том Лейн)
• Реализована возможность использовать статистику функциональной зависимости для логиче-
ских столбцов (Том Лейн)
Ранее, хотя расширенную статистику можно было объявить и собирать по логическим столб-
цам, планировщик не мог её применить.
• Устранение недооценивания количества групп, выдаваемых подзапросами, в которых вызыва-
ются функции, возвращающие множества, в группируемых столбцах (Том Лейн)
В случаях, подобных SELECT DISTINCT unnest(foo), в версии 10.0 приблизительная оценка ко-
личества строк стала давать меньшее число по сравнению с предыдущими версиями, что мог-
2317Замечания к выпуску
ло приводить к выбору неоптимальных планов. Теперь восстановлен предыдущий алгоритм
оценивания.
• Исправление работы триггеров в процессах логической репликации (Петр Желинек)
• Исправление логического декодирования, чтобы файлы на диске корректно очищались от
данных сбойных транзакций (Атсуши Торикоши)
Процедура логического декодирования может выносить записи WAL на диск, если транзакции
генерируют много записей WAL. Обычно эти файлы очищаются после фиксирования транзак-
ции или поступления записи о её прерывании; но в отсутствие таких записей код очистки ра-
ботал неправильно.
• Исправление тайм-аута в процессе walsender и реакции на прерывания при обработке боль-
шой транзакции (Петр Желинек)
• Устранение условий гонки при удалении источника репликации, когда ожидание удаляющего
процесса могло быть бесконечным (Том Лейн)
• Предоставление членам роли pg_read_all_stats возможности видеть статистику walsender в
представлении pg_stat_replication (Фейке Стинберген)
• Отображение процессов walsender, передающих базовые резервные копии, как активные в
представлении pg_stat_activity (Магнус Хагандер)
• Исправление обозначения метода аутентификации scram-sha-256 в представлении
pg_hba_file_rules (Микаэль Пакье)
Ранее его название выводилось как scram-sha256, что могло смущать пользователей некор-
ректным написанием.
• Добавление в has_sequence_privilege() поддержки проверок WITH GRANT OPTION, как это сде-
лано в других функциях проверки прав (Джо Конвей)
• В базах данных с кодировкой UTF8 любые XML-объявления, выбирающие другую кодировку,
должны игнорироваться (Павел Стехуле, Ной Миш)
Мы всегда храним документы XML в кодировке базы данных, так что позволяя libxml обраба-
тывать объявления с другой кодировкой, мы получим ошибочные результаты. Если кодировка
базы — не UTF8, мы в любом случае не обещали поддерживать XML-данные с не ASCII-коди-
ровкой, так что предыдущее поведение сохранено для совместимости ошибок. Это изменение
затрагивает только xpath() и связанные функции; другой код и ранее работал так.
• Обеспечение прямой совместимости с будущими изменениями младших версий протокола
(Роберт Хаас, Бадрул Чоудхури)
Ранее серверы PostgreSQL просто отклоняли запросы на использование версий протокола но-
вее 3.0, так что никакого функционального отличия старших номеров от младших не было. Те-
перь клиенты могут запрашивать версии 3.x и получать в ответ не отказ, а сообщение, говоря-
щее, что сервер поддерживает только версию 3.0. В данный момент от этого ничего не меня-
ется, но перенос этого изменения в предыдущие версии должен ускорить внедрение неболь-
ших усовершенствований протокола в будущем.
• Предоставление возможности клиенту, поддерживающему привязку канала SCRAM, (в част-
ности libpq v11 или новее) подключаться к серверу v10 (Микаэль Пакье)
Версия 10 не реализует такую функциональность, и согласование её использования произво-
дилось некорректно.
• Предотвращение долгоживущих циклов в ConditionVariableBroadcast() (Том Лейн, Томас
Мунро)
При неудачно сложившихся временных интервалах процесс, пытающийся разбудить все спя-
щие процессы по условной переменной, мог зацикливаться на неопределённое время. Вслед-
2318Замечания к выпуску
ствие ограниченного использования условных переменных в v10, эта проблема затрагивала
только параллельные сканирования индексов и некоторые операции со слотами репликации.
• Корректный сброс ожиданий условных переменных при прерывании подтранзакции (Роберт
Хаас)
• Обеспечение своевременного завершения всех дочерних процессов, ожидающих условные пе-
ременные, в случае прекращения работы процесса postmaster (Том Лейн)
• Устранение сбоев параллельных процессов при использовании более чем одного узла Gather
(Томас Мунро)
• Ликвидация зависания в процессе параллельного сканирования индекса при обработке уда-
лённой или наполовину неактуальной страницы индекса (Амит Капила)
• Предотвращение краха в случае, когда при параллельном сканировании битовой карты не
удаётся выделить сегмент разделяемой памяти (Роберт Хаас)
• Исправление реакции на сбой при запуске параллельного рабочего процесса (Амит Капила,
Роберт Хаас)
Ранее параллельный запрос мог зависнуть на неопределённое время, если не удавалось запу-
стить рабочий процесс, вследствие ошибки в fork() или других редких проблем.
• Исключение неоправданной ошибки, которая выдавалась, когда не удавалось получить парал-
лельные исполнители при запуске параллельного запроса (Роберт Хаас)
• Исправление сбора статистики EXPLAIN, получаемой от параллельных исполнителей (Амит Ка-
пила, Томас Мунро)
• Строки запросов, передаваемые параллельным исполнителям, всегда должны завершаться ну-
лём (Томас Мунро)
Это предотвращает вывод мусора в журнал главного процесса от таких исполнителей.
• Устранение небезопасного предположения о выравнивании при работе с типом __int128 (Том
Лейн)
Обычно компиляторы полагают, что переменные __int128 выравниваются по 16-байтовым
границам, но наша инфраструктура выделения памяти не готова гарантировать это, а увели-
чение MAXALIGN кажется неподходящим по множеству причин. В качестве решения код был
изменён так, чтобы тип __int128 можно было использовать только когда мы можем сказать
компилятору, что предполагается не такое крупное выравнивание. Единственный замечен-
ный симптом этой проблемы — сбои в некоторых параллельных запросах с агрегированием.
• Предотвращение сбоев с переполнением стека при планировании операций со множествами с
крайне большой вложенностью (UNION/INTERSECT/EXCEPT) (Том Лейн)
• Предотвращение краха при перепроверке EvalPlanQual в узле сканирования индекса, являю-
щимся внутренним потомком соединения слиянием (Том Лейн)
Это могло происходить только при изменении или выборке SELECT FOR UPDATE данных соеди-
нения, когда одновременно изменялись некоторые выбранные строки.
• Устранение ошибки в процессе автоочистки, когда расширенная статистика для таблицы
определена, но не может быть вычислена (Альваро Эррера)
• Ликвидация обращений по нулевому указателю для некоторых типов адресов LDAP, задавае-
мых в файле pg_hba.conf (Томас Мунро)
• Предотвращение исчерпания памяти из-за разрастания простых хеш-таблиц (Томаш Вондра,
Андрес Фройнд)
• Исправление демонстрационных функций INSTR() в документации по PL/pgSQL (Юго Нагата,
Том Лейн)
2319Замечания к выпуску
В документации утверждалось, что эти функции совместимы с Oracle®, но это было не совсем
так. В частности, по-разному интерпретировалось отрицательное значение третьего парамет-
ра: Oracle воспринимает это значение как последнюю позицию, с которой может начинаться
целевая подстрока, а наши функции считали, что это последняя позиция, где строка может
заканчиваться. Также Oracle выдаёт ошибку в случае нулевого или отрицательного четвёрто-
го параметра, тогда как наши функции возвращали ноль.
Код этого примера был изменён для большего соответствия поведению Oracle. Пользовате-
лям, которые скопировали этот код в свои приложения, возможно, имеет смысл обновить свои
копии.
• Исправление поведения pg_dump, чтобы ACL (разрешения), комментарии и метки безопасно-
сти можно было надёжно идентифицировать в архивных выходных форматах (Том Лейн)
Компонент «метка» записи ACL в архиве обычно представлял собой просто имя целевого объ-
екта. В его начало теперь добавляется тип объекта, чтобы записи ACL соответствовали согла-
шениям, уже принятым для записей комментариев и меток безопасности. Кроме того, обо-
значения комментариев и меток безопасности, заданных для собственно базы данных, теперь
должны начинаться с DATABASE, чтобы они соответствовали тому же соглашению. Это преду-
преждает ложные срабатывания в коде, который пытается найти записи больших объектов по
строкам, начинающимся со слов LARGE OBJECT. Прежнее поведение могло приводить к непра-
вильной классификации записей как данные и нежелательным результатам при восстановле-
нии выгруженной только схемы или только данных.
Заметьте, что следствием этого стало изменение видимого пользователями вывода pg_restore
–list.
• Переименование функции copy_file_range в pg_rewind во избежание конфликта с новым си-
стемным вызовом Linux с таким же именем (Андрес Фройнд)
Это изменение предотвращает ошибки при сборке с новыми версиями glibc.
• В ecpg добавлено выявление массивов индикаторов с неправильной длиной и сообщение об
ошибке (Дэвид Рейдер)
• Изменение поведения оператора cube ~&gt; int в расширении contrib/cube для обеспечения его
совместимости с поиском kNN (Александр Коротков)
Смысл второго аргумента (выбирающего размерность) был изменён, чтобы можно было опре-
делённо сказать, какое именно значение выбирается в кубах переменных размерностей.
Это изменение нарушает совместимость, но так как этот оператор предназначался для по-
исков kNN, в прежнем виде он был бесполезен. После установки этого обновления все мате-
риализованные представления или индексы с выражениями, использующими этот оператор,
необходимо обновить/перестроить.
• Предотвращение срабатывания проверки истинности внутри libc в расширении contrib/
hstore из-за использования memcpy() с равными указателями источника и получателя (Томаш
Вондра)
• Исправление некорректного отображения битовых карт NULL для кортежей в contrib/
pageinspect (Максим Милютин)
• Исправление некорректного вывода функции hash_page_items() расширения contrib/
pageinspect (Масахико Савада)
• В расширении contrib/postgres_fdw ликвидирована ошибка планировщика «outer pathkeys
do not match mergeclauses» (внешние ключи пути не соответствуют предложениям слияния)
при построении плана, включающего удалённое соединение (Роберт Хаас)
• В contrib/postgres_fdw предотвращён сбой планировщика при дублировании элементов
GROUP BY (Дживан Чок)
2320Замечания к выпуску
• Добавление современных примеров настройки автозапуска Postgres в macOS (Том Лейн)
Скрипты в contrib/start-scripts/osx используют инфраструктуру, которая устарела десять
лет назад, и абсолютно неработоспособны во всех версиях macOS, выпущенных в последние
два года. Добавлен новый подкаталог contrib/start-scripts/macos со скриптами, использую-
щими новую инфраструктуру launchd.
• Исправление некорректного выбора зависящих от конфигурации библиотек OpenSSL в
Windows (Эндрю Дунстан)
• Поддержка компоновки с версиями libperl, собранными компилятором MinGW (Ной Миш)
Это позволяет собирать PL/Perl с некоторыми распространёнными дистрибутивами Perl для
Windows.
• Исправление в сборке MSVC проверки, требуется ли 32-битной libperl определение -
D_USE_32BIT_TIME_T (Ной Миш)
Имеющиеся дистрибутивы Perl ожидают разного, и при этом нет никакой возможности на-
дёжно проверить это, поэтому пришлось добавить проверку фактического поведения исполь-
зуемой библиотеки во время компиляции.
• В Windows обработчик аварийного завершения должен устанавливаться на более раннем эта-
пе запуска главного процесса (Такаюки Цунакава)
Это поможет получить дамп памяти при ошибках в те моменты в начале запуска, в которые
раньше дамп не записывался.
• В Windows устранены сбои, связанные с преобразованием кодировок при выводе сообщений
на самых ранних стадиях запуска процесса postmaster (Такаюки Цунакава)
• Использование нашего ранее написанного кода циклических блокировок для Motorola 68K во
OpenBSD, а также в NetBSD (Давид Карлье)
• Добавление поддержки циклических блокировок для Motorola 88K (Давид Карлье)
• Обновление данных часовых поясов до версии tzdata 2018c, включающее изменения правил
перехода на летнее время в Бразилии, в Сан-Томе и Принсипи, а также корректировки ис-
торических данных для Боливии, Японии и Южного Судана. Был удалён часовой пояс US/
Pacific-New (это был просто псевдоним для пояса America/Los_Angeles).
E.8. Выпуск 10.1
Дата выпуска:
2017-11-09
В этот выпуск вошли различные исправления, внесённые после версии 10.0. За информацией о
нововведениях 10 версии обратитесь к Разделу E.9.
E.8.1. Миграция на версию 10.1
Если используется версия 10.X, выгрузка/восстановление базы не требуется.
Однако если вы используете индексы BRIN, прочитайте четвёртую запись в списке изменений.
E.8.2. Изменения
• Обеспечение проверки разрешений на уровне таблиц и политик RLS при выполнении
INSERT … ON CONFLICT DO UPDATE во всех случаях (Дин Рашид)
Путь изменения данных в команде INSERT … ON CONFLICT DO UPDATE требовал наличия раз-
решения SELECT для всех столбцов в решающем индексе, но в случае указания решающего
ограничения по имени должная проверка отсутствовала. Кроме того, для таблиц с включён-
2321Замечания к выпуску
ной защитой на уровне строк не проверялось, соответствуют ли изменённые строки полити-
кам SELECT (вне зависимости от способа задания решающего индекса). (CVE-2017-15099)
• Устранение сбоя при несовпадении типа записи в json{b}_populate_recordset() (Микаэль
Пакье, Том Лейн)
Эти функции использовали тип результата, заданный в предложении FROM … AS, не прове-
ряя, соответствует ли он фактическому типу поступившего кортежа. В случае несоответствия
обычно происходил сбой, хотя также вероятным было раскрытие содержимого памяти серве-
ра. (CVE-2017-15098)
• Исправление скриптов запуска сервера — переключение на $PGUSER до открытия файла
$PGLOG (Ной Миш)
Ранее файл журнала postmaster открывался ещё под именем root. Таким образом, владелец
базы данных мог произвести атаку на другого пользователя системы, сделав $PGLOG символи-
ческой ссылкой на некоторый другой файл, который в результате можно было испортить до-
бавленными в него сообщениями журнала.
По умолчанию эти скрипты никуда не устанавливаются. Если вы использовали их, замените
свои экземпляры новыми копиями либо внесите те же коррективы в свои вручную изменён-
ные скрипты. Если владельцем существующего файла $PGLOG является root, его нужно уда-
лить или переименовать прежде чем перезапускать сервер с помощью исправленного скрип-
та. (CVE-2017-12172)
• Исправление вычисления сводных данных индекса BRIN для корректной работы при одновре-
менном расширении таблицы (Альваро Эррера)
Ранее в условиях гонки некоторые строки таблицы могли пропадать из индекса. Для устране-
ния последствий предыдущих проявлений этой проблемы может потребоваться перестроить
существующие индексы BRIN.
• Предупреждение возможных сбоев при параллельных изменениях индекса BRIN (Том Лейн)
В определённых условиях гонки могли возникать ошибки «invalid index offnum» (неверный но-
мер смещения в индексе) или «inconsistent range map» (несогласованность в карте диапазо-
нов).
• Предотвращение в ходе логической репликации присвоения NULL нереплицируемым столб-
цам при репликации UPDATE (Петр Желинек)
• Исправление механизма логической репликации, чтобы триггеры BEFORE ROW DELETE вызыва-
лись в должное время (Масахико Савада)
Ранее этого не происходило, если в таблице также имелся триггер BEFORE ROW UPDATE.
• Устранение сбоя при вызове логического декодирования из функции, использующей SPI, в
частности, из любой функции на одном из языков PL (Том Лейн)
• Игнорирование CTE (общих табличных выражений) при обращении к целевой таблице для вы-
полнения INSERT/UPDATE/DELETE и недопущение сопоставления имён целевых таблиц, задан-
ных с указанием схемы, с именами переходных таблиц в триггерах (Томас Мунро)
В результате для CTE, связанных с командами DML, восстановлено поведение, имевшее место
до версии 10.
• Уход от вычисления выражений в аргументах агрегатной функции для строк, не удовлетворя-
ющих условию FILTER (Том Лейн)
Тем самым восстанавливается поведение, наблюдавшееся до 10 версии (и описанное в стан-
дарте SQL).
• Исправление некорректных результатов запросов, содержащих в нескольких столбцах
GROUPING SETS одну и ту же простую переменную (Том Лейн)
2322Замечания к выпуску
• Устранение утечки памяти на время выполнения запроса при вычислении функции, возвра-
щающей множество, в целевом списке SELECT (Том Лейн)
• Реализована возможность параллельного выполнения подготовленных операторов с общими
планами (Амит Капила, Кунтал Гхош)
• Корректировка неправильных решений по распараллеливанию для вложенных запросов (Амит
Капила, Кунтал Гхош)
• Устранение сбоев в обработке параллельных запросов, возможных при удалении недавно ис-
пользованной роли (Амит Капила)
• Устранение сбоя при параллельном сканировании битовой карты с узлом плана BitmapAnd,
расположенным под узлом BitmapOr (Дилип Кумар)
• Исправление в функциях json_build_array(), json_build_object() и их аналогах для jsonb
обработки явно заданных аргументов VARIADIC (Микаэль Пакье)
• Исправление логики «частей работы» автоочистки для предупреждения возможных сбоев и
незаметной потери частей (Альваро Эррера)
• Устранение сбоев в особых случаях при добавлении столбцов в конец представления (Том
Лейн)
• Фиксирование правильных зависимостей когда представление или правило содержит узлы вы-
ражения FieldSelect или FieldStore (Том Лейн)
В отсутствие этих зависимостей команда DROP со столбцом или типом данных может выпол-
ниться, когда не должна, что вызовет ошибки при последующем использовании представле-
ния или правила. Данное исправление не защищает существующие представления/правила, а
повлияет только на создаваемые в будущем.
• Правильное определение хешируемости диапазонных типов данных (Том Лейн)
Планировщик ошибочно полагал, что любой диапазонный тип может хешироваться для ис-
пользования в соединениях или агрегировании по хешу, но на самом деле он должен прове-
рять, поддерживает ли хеширование подтип диапазона. Это не касается встроенных диапазон-
ных типов, так как все они всё равно хешируемые.
• Игнорирование узлов выражений RelabelType должным образом при рассмотрении статисти-
ки по функциональным зависимостям (Дэвид Роули)
Это позволяет, например, правильно использовать расширенную статистику по столбцам
varchar.
• Предотвращение разделения информации переходного состояния между сортирующими агре-
гатными функциями (Дэвид Роули)
Вследствие этого разделения возникали сбои во встроенных сортирующих агрегатах и могли
также возникать в подобных пользовательских функциях. Начиная с версии 11, предусмотре-
ны средства для надёжной защиты от таких случаев, а в ветвях стабильных выпусков просто
отключена оптимизация.
• Недопущение игнорирования значения idle_in_transaction_session_timeout, если до этого
произошёл таймаут оператора (statement_timeout) (Лукас Фиттл)
• Устранение маловероятной потери сообщений NOTIFY вследствие зацикливания идентифика-
торов транзакций (Марко Тииккая, Том Лейн)
Если в сеансе не выполнялись никакие запросы, то есть он просто ждал уведомлений и за это
время прошло более 2 миллиардов транзакций, он начинал пропускать уведомления от парал-
лельно фиксируемых транзакций.
• Уменьшение частоты запросов на сброс данных в процессе копирования файлов во избежание
проблем с производительностью в macOS, в частности с новой файловой системой APFS (Том
Лейн)
2323Замечания к выпуску
• Реализована возможность использовать режим FREEZE команды COPY на уровне изоляции
транзакций REPEATABLE READ или выше (Ной Миш)
Этот сценарий использования был непреднамеренно потерян вследствие предыдущего ис-
правления ошибки.
• Исправление функции AggGetAggref(), чтобы возвращались корректные узлы Aggref для
функций завершения агрегатов с объединёнными промежуточными вычислениями (Том Лейн)
• Исправление нечётких указаний схемы в некоторых новых запросах в pg_dump и psql (Вита-
лий Буровой, Том Лейн, Ной Миш)
• Уход от использования оператора @&gt; в запросах psql для команды \d (Том Лейн)
Это предотвращает проблемы, возникающие при установке расширения parray_gin, так как в
нём определён конфликтующий оператор.
• Исправление в pg_basebackup сравнения путей табличных пространств посредством приведе-
ния путей к канонической форме (Микаэль Пакье)
Это особенно полезно в Windows.
• Исправление libpq, чтобы для её работы не требовалось существование домашнего каталога
пользователя (Том Лейн)
В версии 10 невозможность найти домашний каталог при попытке прочитать ~/.pgpass счита-
лась критической ошибкой, но эта ситуация должна обрабатываться так же, как и отсутствие
данного файла. И в версии 10, и в ветвях предыдущих выпусков была допущена та же ошибка
при чтении ~/.pg_service.conf, хотя это было менее очевидно, так как данный файл исполь-
зовался только при указании имени службы.
• В ecpglib исправлена обработка обратной косой черты в строковых константах в зависимости
от значения standard_conforming_strings (Такаюки Цунакава)
• Игнорирование в ecpglib дробной части при вводе целочисленных значений в режиме совме-
стимости с Informix (Гао Цзэнци, Михаэль Мескес)
• Добавление отсутствующего предварительного требования temp-install для целей типа check в
Make (Ной Миш)
Некоторые невыполняемые по умолчанию тестовые процедуры, подобные make check, не про-
веряли актуальность временной инсталляции.
• Обновление данных часовых поясов до версии tzdata 2017c, включающее изменения правил
перехода на летнее время на Фиджи, в Намибии, Серверном Кипре, Судане, Тонга и на ост-
ровах Теркс и Кайкос, плюс корректировку исторических данных для Аляски, Апии, Бирмы,
Калькутты, Детройта, Ирландии, Намибии и Паго-Паго.
• В документации для HTML-якорей восстановлен верхний регистр (Питер Эйзентраут)
Вследствие изменений инструментария в документации 10.0 для внутренних HTML-якорей
был изменён регистр строк, что привело к повреждению некоторых внешних ссылок на доку-
ментацию на нашем сайте. Поэтому было решено вернуться к предыдущему стилю со строка-
ми в верхнем регистре.
E.9. Выпуск 10
Дата выпуска:
2017-10-05
E.9.1. Обзор
В число ключевых усовершенствований PostgreSQL 10 входят:
• Логическая репликация по схеме публикации/подписки
2324Замечания к выпуску
• Декларативное секционирование таблиц
• Улучшение распараллеливания запросов
• Значительное увеличение общей производительности
• Более сильная защита паролей с использованием SCRAM-SHA-256
• Улучшенные средства мониторинга и управления
Предыдущие пункты более подробно описаны в следующих разделах.
E.9.2. Миграция на версию 10
Тем, кто хочет мигрировать данные из любой предыдущей версии, необходимо выполнить выгруз-
ку/загрузку данных с помощью pg_dumpall или воспользоваться pg_upgrade.
В версии 10 реализован ряд изменений, которые могут повлиять на совместимость с предыдущими
выпусками. Примите к сведению следующие несовместимости:
• После обновления с помощью pg_upgrade с любой предыдущей основной версии PostgreSQL
необходимо перестроить хеш-индексы (Митхун Сай, Роберт Хаас, Амит Капила)
Необходимость данного требования продиктована значительным усовершенствованием меха-
низма хеш-индексов. Для облегчения задачи переиндексации pg_upgrade создаст вспомога-
тельный скрипт.
• Переименование каталога с журналом предзаписи из pg_xlog в pg_wal, а также переименова-
ние каталога с информацией о состоянии транзакций из pg_clog в pg_xact (Микаэль Пакье)
Старые имена неоднократно вводили пользователей в заблуждение — пользователи думали,
что эти каталоги содержат только несущественные файлы журналов, и вручную удаляли фай-
лы журналов предзаписи или состояния транзакций, что приводило к необратимой потере
данных. Эти переименования призваны предотвратить такие ошибки в будущем.
• Замена в именах функций SQL, утилит и параметров всех упоминаний «xlog» на «wal» (Роберт
Хаас)
Например, имя pg_switch_xlog() поменялось на pg_switch_wal(), pg_receivexlog — на
pg_receivewal, а –xlogdir — на –waldir. Это было сделано вместе с переименованием ката-
лога pg_xlog для согласованности; и вообще термин «xlog» теперь нигде не может встретить-
ся пользователю.
• Замена в связанных с WAL функциях и представлениях location на lsn (Дэвид Роули)
Ранее имело место несогласованное употребление обоих терминов.
• Изменение реализации функций, возвращающих множества, в списке SELECT (Андрес Фройнд)
Функции, возвращающие множества, теперь вычисляются до вычисления скалярных выра-
жений в списке SELECT, практически так же, как если бы они были помещены в предложение
LATERAL FROM. Это даёт более понятное поведение в случаях, когда присутствуют несколько
таких функций. Если они возвращают разное количество строк, все результаты дополняют-
ся до наибольшего количества строк значениями NULL. Ранее результаты обрабатывались в
цикле, пока все функции не завершались, и в результате получалось количество строк, рав-
ное наименьшему общему кратному периодов функций. Кроме того, функции, возвращающие
множества, теперь нельзя использовать в конструкциях CASE и COALESCE. За дополнительными
сведениями обратитесь к Подразделу 38.5.8.
• Использование стандартного синтаксиса конструктора строки в UPDATE … SET (списо-
к_столбцов) = конструктор_строки (Том Лейн)
Теперь конструктор_строки может начинаться со слова ROW; ранее его надо было опускать. Ес-
ли в списке_столбцов фигурирует имя только одного столбца, конструктор_строки должен ис-
2325Замечания к выпуску
пользовать ключевое слово ROW, так как иначе он не будет корректным конструктором строки,
а будет восприниматься как выражение в скобках. Также запись имя_таблицы.</em> в конструк-
торе_строки теперь разворачивается в набор столбцов, как и в других случаях использования
конструктора_строки.
• Когда ALTER TABLE … ADD PRIMARY KEY помечает столбцы как NOT NULL, это изменение те-
перь распространяется также на дочерние таблицы в иерархии наследования (Микаэль Па-
кье)
• Предотвращение срабатывания триггеров уровня оператора более одного раза для одного
оператора (Том Лейн)
В случаях, когда пишущие CTE изменяли одну таблицу, изменяемую внешним оператором ли-
бо другими пишущими CTE, триггеры BEFORE STATEMENT и AFTER STATEMENT вызывались неод-
нократно. Также, если в таблице были определены триггеры уровня оператора, в результате
действий для обеспечения целостности внешнего ключа (например, ON DELETE CASCADE), они
могли вызываться несколько раз для одного внешнего SQL-оператора. Это поведение противо-
речит стандарту SQL и было исправлено.
• Перемещение полей метаданных последовательностей в новый системный каталог
pg_sequence (Питер Эйзентраут)
Отношение последовательности содержит теперь только поля, которые могут быть измене-
ны функцией nextval(), то есть last_value, log_cnt и is_called. Другие свойства последова-
тельности, такие как начальное значение и шаг увеличения, сохраняются в соответствующей
строке в каталоге pg_sequence. Действие ALTER SEQUENCE теперь полностью транзакционное
и, как следствие, блокирует последовательность до фиксации транзакции. Функции nextval()
и setval() остаются нетранзакционными.
Основная несовместимость, привнесённая этим изменением, состоит в том, что из отно-
шения последовательности теперь можно прочитать только три поля, перечисленные вы-
ше. Чтобы получить другие свойства последовательности, приложения должны обратить-
ся к pg_sequence. Также для этого можно использовать новое системное представление
pg_sequences; оно выдаёт столбцы с именами, более подходящими для существующего кода.
Кроме того, последовательности, созданные для столбцов SERIAL, теперь генерируют 32-бит-
ные значения, тогда как предыдущие версии генерировали 64-битные. Это отличие никак не
проявляется, если значения просто сохраняются в столбце.
Переработан и вывод команды psql \d для последовательностей.
• Передача по умолчанию программой pg_basebackup данных WAL, необходимых для восстанов-
ления резервной копии (Магнус Хагандер)
При этом в pg_basebackup подразумеваемое значение -X/–wal-method меняется на stream.
Для воспроизведения старого поведения был добавлен вариант значения none. Параметр
pg_basebackup -x был удалён (используйте вместо него -X fetch).
• Изменение записей логической репликации в pg_hba.conf (Питер Эйзентраут)
В предыдущих версиях для подключения логической репликации требовалось указать
replication в столбце базы данных. С этого выпуска логической репликации соответствует
обычная запись с именем базы данных или ключевым словом, например, all. Для физической
репликации по-прежнему используется ключевое слово replication. Так как встроенная ло-
гическая репликация появилась только в этом выпуске, это изменение может затронуть толь-
ко пользователей сторонних средств логической репликации.
• Все действия в pg_ctl по умолчанию должны ожидать завершения операции (Питер Эйзентра-
ут)
Ранее некоторые действия pg_ctl не ждали завершения и для ожидания требовалось использо-
вать ключ -w.
2326Замечания к выпуску
• Изменение значения по умолчанию серверного параметра log_directory с pg_log на log (Ан-
дреас Карлссон)
• Добавление параметра конфигурации ssl_dh_params_file для указания имени файла с нестан-
дартными параметрами OpenSSL DH (Хейкки Линнакангас)
Тем самым заменяется жёстко заданное и недокументированное имя файла dh1024.pem. За-
метьте, что файл dh1024.pem по умолчанию больше не обрабатывается; вы должны задать этот
параметр, если хотите использовать свои параметры DH.
• Увеличение размера стандартных параметров DH, используемых для эфемерных DH-шифров
OpenSSL, до 2048 бит (Хейкки Линнакангас)
Размер предопределённых в коде параметров DH был увеличен с 1024 до 2048 бит, так что об-
мен ключами DH стал более устойчивым к подбору шифра. Однако некоторые старые реали-
зации SSL, в частности некоторые ревизии Java Runtime Environment версии 6, не принимают
параметры DH длиннее 1024 бит и, таким образом, не смогут подключиться через SSL. Если
вам необходимо поддерживать такие старые клиенты, вы можете использовать нестандартные
параметры DH размером 1024 бита вместо предопределённых параметров по умолчанию. См.
ssl_dh_params_file.
• Ликвидация возможности хранения незашифрованных паролей на сервере (Хейкки Линнакан-
гас)
Серверный параметр password_encryption больше не поддерживает значения off и plain.
Вариант UNENCRYPTED также теперь не поддерживается в командах CREATE/ALTER USER …
PASSWORD. Аналогично был удалён ключ –unencrypted команды createuser. Незашифрованные
пароли, перенесённые из старых версий, в этой версии будут храниться в зашифрованном ви-
де. Значением по умолчанию параметра password_encryption остаётся md5.
• Добавление серверных параметров min_parallel_table_scan_size и min_parallel_index_scan_size
для управления параллельными запросами (Амит Капила, Роберт Хаас)
Они заменяют переменную min_parallel_relation_size, которая была слишком общей.
• Не заключённый в кавычки текст в shared_preload_libraries и связанных серверных парамет-
рах не должен переводиться в нижний регистр (Куэль Чжо)
Эти параметры на самом деле представляют собой списки имён файлов, но ранее они воспри-
нимались как списки SQL-идентификаторов и обрабатывались по другим правилам.
• Удаление серверного параметра sql_inheritance (Роберт Хаас)
При выключенном значении этого параметра запросы, обращающиеся к родительским табли-
цам, перестают учитывать дочерние. Однако стандарт SQL требует, чтобы они учитывались, и
это поведение было принято по умолчанию в PostgreSQL 7.1.
• Реализация возможности передавать многомерные массивы в функции на PL/Python и возвра-
щать вложенные списки Python (Алексей Грищенко, Дэйв Крамер, Хейкки Линнакангас)
Это изменение потребовало нарушить обратную совместимость в части обработки масси-
вов составных типов в PL/Python. Раньше можно было вернуть массив составных типов как
[[col1, col2], [col1, col2]]; но теперь это будет интерпретироваться как двухмерный мас-
сив. Составные типы в массивах для однозначности должны возвращаться теперь в виде кор-
тежей Python, а не в виде списков. То есть предыдущую запись нужно заменить на [(col1,
col2), (col1, col2)].
• Удаление механизма автозагрузки «модулей» PL/Tcl (Том Лейн)
На замену этой функциональности пришли новые серверные параметры pltcl.start_proc и
pltclu.start_proc, которые проще в использовании и дают возможности, подобные имеющимся
в других языках программирования.
2327Замечания к выпуску
• Ликвидация поддержки выгрузки данных с серверов до 8.0 утилитами pg_dump/pg_dumpall
(Том Лейн)
Пользователям, которым нужно выгрузить данные с серверов до 8.0, остаётся использовать
dump из PostgreSQL версии 9.6 или старее. Выгруженные этими версиями данные должны
успешно загружаться на новых серверах.
• Ликвидация поддержки хранения даты/времени и интервалов в виде чисел с плавающей точ-
кой (Том Лейн)
Параметр configure –disable-integer-datetimes был удалён. Использование для таких зна-
чений чисел с плавающей точкой не давало значимых преимуществ и не было вариантом по
умолчанию, начиная с PostgreSQL 8.3.
• Ликвидация поддержки сервером клиент-серверного протокола версии 1.0 (Том Лейн)
Этот протокол не поддерживался клиентами со времён PostgreSQL 6.3.
• Удаление модуля contrib/tsearch2 (Роберт Хаас)
Этот модуль обеспечивал совместимость с версией полнотекстового поиска, которая постав-
лялась с серверами PostgreSQL до версии 8.3.
• Ликвидация приложений командной строки createlang и droplang (Питер Эйзентраут)
Они перешли в разряд устаревших в PostgreSQL 9.1. Вместо них можно непосредственно ис-
пользовать команды CREATE EXTENSION и DROP EXTENSION.
• Ликвидация поддержки вызовов функций версии 0 (Андрес Фройнд)
Расширения, предоставляющие функции, реализованные на C, теперь должны использовать
соглашение о вызовах версии 1. Версия 0 считалась устаревшей с 2001 года.
E.9.3. Изменения
Ниже вы найдёте подробный список изменений, произошедших между предыдущим основным вы-
пуском и PostgreSQL 10.
E.9.3.1. Сервер
E.9.3.1.1. Параллельное выполнение запросов
• Поддержка параллельного сканирования индексов типа B-дерево (Рахила Сьед, Амит Капила,
Роберт Хаас, Рафия Сабих)
Благодаря этому поиск в страницах индекса-B-дерева могут производить параллельно
несколько рабочих процессов.
• Поддержка параллельного сканирования кучи по битовой карте (Дилип Кумар)
Это позволяет распределить одно сканирование индекса между параллельными исполнителя-
ми, обрабатывающими разные области кучи.
• Реализована возможность выполнения соединения слиянием в параллельном режиме (Дилип
Кумар)
• Реализована возможность выполнения несвязанных запросов в параллельном режиме (Амит
Капила)
• Улучшение возможности параллельных процессов возвращать ранее отсортированные данные
(Рушаб Латиа)
• Расширение использования параллельных запросов в функциях процедурных языков (Роберт
Хаас, Рафия Сабих)
2328Замечания к выпуску
• Добавление серверного параметра max_parallel_workers для ограничения числа рабочих про-
цессов, которые могут использоваться для распараллеливания запросов (Жульен Рухо)
Значение этого параметра можно сделать меньше max_worker_processes, чтобы зарезервиро-
вать рабочие процессы для других целей, кроме параллельных запросов.
• Включение распараллеливания по умолчанию (значение по умолчанию параметра
max_parallel_workers_per_gather стало равно 2).
E.9.3.1.2. Индексы
• Добавление регистрации в журнале предзаписи операций с хеш-индексами (Амит Капила)
В результате хеш-индексы становятся отказоустойчивыми и пригодными к репликации. Преж-
нее предостережение относительно их использование удалено.
• Улучшение производительности хеш-индекса (Амит Капила, Митхун Сай, Ашутош Шарма)
• Добавление поддержки индексов SP-GiST для типов данных INET и CIDR (Эмре Хасегели)
• Добавление параметра для включения более активного вычисления сводных данных индекса
BRIN (Альваро Эррера)
Новый параметр CREATE INDEX позволяет автоматически обновлять сводную запись для
предыдущей зоны страниц BRIN при создании новой зоны.
• Добавление функций для удаления и повторного добавления сводных записей BRIN для зон
индекса BRIN (Альваро Эррера)
Новая SQL-функция brin_summarize_range() обновляет сводные записи индекса BRIN для
определённой зоны, а brin_desummarize_range() удаляет их. Это полезно для обновления
данных зоны, которая стала меньше в результате действия команд UPDATE и DELETE.
• Более точный расчёт выгоды от применения сканирования по индексу BRIN (Дэвид Роули, Эм-
ре Хасегели)
• Ускорение операций добавления и изменения записей в GiST благодаря более эффективному
использованию пространства индекса (Андрей Бородин)
• Минимизация блокировок страниц при очистке индексов GIN (Андрей Бородин)
E.9.3.1.3. Блокировки
• Сокращение блокировок, необходимых для изменения параметров таблиц (Саймон Риггс, Фаб-
рицио де Ройес Мелло)
Например, изменить параметр effective_io_concurrency для таблицы теперь можно с более лёг-
кой блокировкой.
• Реализация регулировки пределов для повышения уровня предикатных блокировок (Дагфинн
Ильмари Маннсакер)
Повышением уровня блокировок теперь можно управлять с помощью двух новых параметров
сервера, max_pred_locks_per_relation и max_pred_locks_per_page.
E.9.3.1.4. Оптимизатор
• Добавление статистики по нескольким столбцам, позволяющей вычислять коэффициент кор-
реляции и число различных значений (Томаш Вондра, Дэвид Роули, Альваро Эррера)
Появились новые команды: CREATE STATISTICS, ALTER STATISTICS и DROP STATISTICS. Это по-
лезно для оценки использования памяти запросом и для консолидации статистики по отдель-
ным столбцам.
• Увеличение производительности запросов, сталкивающихся с ограничениями безопасности
на уровне строк (Том Лейн)
2329Замечания к выпуску
Теперь оптимизатор лучше понимает, куда можно поместить условия фильтра RLS, благодаря
чему он может строить лучшие планы, при этом гарантируя выполнение условий RLS.
E.9.3.1.5. Общая производительность
• Ускорение агрегатных функций, которые вычисляют сумму с накоплением, используя ариф-
метику типа numeric, включая некоторые вариации SUM(), AVG() и STDDEV() (Хейкки Линна-
кангас)
• Увеличение скорости преобразований кодировок символов с использованием цифровых дере-
вьев (Кётаро Хоригути, Хейкки Линнакангас)
• Уменьшение издержек вычисления выражений при выполнении запросов, а также издержек
обращения к узлу плана (Андрес Фройнд)
Это особенно полезно для запросов, обрабатывающих множество строк.
• Возможность использования агрегирования по хешу при обработке наборов группирования
(Эндрю Гирт)
• Использование гарантий уникальности для оптимизации определённых типов соединений
(Дэвид Роули)
• Ускорение сортировки типа данных macaddr (Брандур Лич)
• Сокращение издержек на отслеживание статистики в сеансах, когда задействуются тысячи
отношений (Александр Алексеев)
E.9.3.1.6. Мониторинг
• Возможность явного управления отображением командой EXPLAIN времени планирования и
выполнения (Ашутош Бапат)
По умолчанию время планирования и выполнения выводится командой EXPLAIN ANALYZE и не
выводится в других случаях. Явно управлять этим позволяет новый параметр SUMMARY коман-
ды EXPLAIN.
• Добавлены новые стандартные роли для мониторинга (Дейв Пейдж)
Новые роли pg_monitor, pg_read_all_settings, pg_read_all_stats и pg_stat_scan_tables
позволяют упростить конфигурацию разрешений.
• Исправление передачи информации сборщику статистики во время REFRESH MATERIALIZED
VIEW (Джим Млодженски)
E.9.3.1.6.1. Ведение журнала
• Изменение префикса log_line_prefix, чтобы по умолчанию все строки журнала postmaster со-
держали текущее время (с миллисекундами) и идентификатор процесса (Кристоф Берг)
Ранее префикс по умолчанию был пустым.
• Добавление функций для получения содержимого каталогов журнала сообщений и WAL (Дейв
Пейдж)
Новые функции называются соответственно pg_ls_logdir() и pg_ls_waldir() и могут выпол-
няться не только суперпользователями (при наличии достаточных разрешений).
• Добавление функции pg_current_logfile() для чтения имён текущих файлов, в которые сбор-
щик сообщений выводит потоки stderr и csvlog (Жиль Даролд)
• Вывод в журнал сервера адреса и номера порта для каждого принимающего соединения соке-
та при запуске postmaster (Том Лейн)
2330Замечания к выпуску
Также добавление в сообщение об ошибке привязки к определённому сокету адреса этого со-
кета.
• Устранение лишних сообщений о запуске и остановке подпроцессов запускающего процесса
(Том Лейн)
Теперь уровень этих сообщений понижен до DEBUG1.
• Уменьшение уровня важности сообщений для уровней отладки, контролируемых параметром
log_min_messages (Роберт Хаас)
Это затрагивает также сообщения отладочных уровней client_min_messages.
E.9.3.1.6.2. Представление pg_stat_activity
• Добавление в pg_stat_activity информации о состоянии низкоуровневых ожиданий (Мика-
эль Пакье, Роберт Хаас)
Это позволяет отслеживать множество событий ожидания на низком уровне, включая ожида-
ния защёлок, записи/чтения/сброса файлов, чтения/записи со стороны клиента и синхронной
репликации.
• Отображение в pg_stat_activity вспомогательных и фоновых рабочих процессов, а также
процессов-передатчиков WAL (Кунтал Гхош, Микаэль Пакье)
Это упрощает мониторинг. Тип процесса обозначается в новом столбце backend_type.
• В pg_stat_activity реализовано отображение SQL-запросов, выполняемых параллельными
исполнителями (Рафия Сабих)
• Переименование в pg_stat_activity.wait_event_type значений LWLockTranche и LWLockNamed
в LWLock (Роберт Хаас)
Это делает вывод более согласованным.
E.9.3.1.7. Аутентификация
• Добавление поддержки SCRAM-SHA-256 для проверки и хранения паролей (Микаэль Пакье,
Хейкки Линнакангас)
Это обеспечивает лучшую безопасность по сравнению с существующим методом md5.
• Изменение типа серверного параметра password_encryption с boolean на enum (Микаэль Па-
кье)
Это потребовалось для поддержки различных вариантов хеширования паролей.
• Добавление представления pg_hba_file_rules для просмотра содержимого pg_hba.conf (Ха-
рибабу Комми)
Это представление показывает содержимое файла, а не действующие в данный момент пара-
метры.
• Поддержка нескольких серверов RADIUS (Магнус Хагандер)
Все связанные с RADIUS параметры теперь стали множественными и принимают список сер-
веров через запятую.
E.9.3.1.8. Конфигурация сервера
• Возможность обновления конфигурации SSL при перезагрузке конфигурации (Андреас
Карлссон, Том Лейн)
Это позволяет переконфигурировать SSL без перезапуска сервера, используя pg_ctl reload,
SELECT pg_reload_conf() или отправив сигнал SIGHUP. Однако, перезагрузка конфигурации
2331Замечания к выпуску
SSL не сработает, если для использования SSL-ключа сервера требуется пароль, так как ника-
кой возможности запросить его нет. В этом случае главный процесс (postmaster) продолжит
использовать изначальную конфигурацию, пока не будет перезапущен.
• Устранение практического предела для максимального значения bgwriter_lru_maxpages
(Джим Нэсби)
E.9.3.1.9. Надёжность
• После создания или удаления файлов следует выполнять fsync для каталога их содержащего
(Микаэль Пакье)
Это сокращает риск потери данных при отключении питания.
E.9.3.1.9.1. Журнал предзаписи (WAL)
• Предотвращение ненужных контрольных точек и архивации WAL в простаивающих системах
(Микаэль Пакье)
• Добавление серверного параметра wal_consistency_checking для внесения в WAL информации,
позволяющей проверять целостность на ведомом сервере (Кунтал Гхош, Роберт Хаас)
В случае выявления любого нарушения при проверке целостности на ведомом сервере выда-
ётся критическая ошибка.
• Увеличение максимально допустимого размера сегмента WAL до одного гигабайта (Бина
Эмерсон)
Увеличивая размер сегментов WAL, можно сократить частоту вызова archive_command и
уменьшить число файлов WAL.
E.9.3.2. Репликация и восстановление
• Реализация возможности логически реплицировать таблицы на подчинённые серверы (Петр
Желинек)
Логическая репликация даёт большую гибкость, чем физическая; в том числе позволяет ор-
ганизовывать репликацию между разными основными версиями PostgreSQL, а также избира-
тельную репликацию.
• Возможность ожидания подтверждения фиксации от ведомых серверов вне зависимости от их
порядка в списке synchronous_standby_names (Масахико Савада)
Ранее сервер всегда ожидал ответа от активных ведомых серверов, стоящих первыми в списке
synchronous_standby_names. Новое ключевое слово ANY в synchronous_standby_names позволя-
ет выбрать ожидание любого числа серверов, вне зависимости от их порядка. Это называется
фиксацией на основе кворума.
• Упрощение изменений конфигурации, которые необходимо внести для организации потоково-
го копирования и репликации (Магнус Хагандер, Дан Мин Хыонг)
В частности, были изменены значения по умолчанию для параметров wal_level,
max_wal_senders, max_replication_slots и hot_standby, чтобы они были пригодны для такого ис-
пользования в исходном состоянии.
• По умолчанию репликация разрешается для локальных подключений в pg_hba.conf (Микаэль
Пакье)
Ранее строки для подключений репликации в pg_hba.conf по умолчанию были закомментиро-
ваны. Это особенно полезно для pg_basebackup.
• Добавление в pg_stat_replication столбцов с информацией о задержках репликации (Томас
Мунро)
Новые столбцы называются write_lag, flush_lag и replay_lag.
2332Замечания к выпуску
• Возможность указания точки остановки восстановления по LSN (последовательному номеру в
журнале) в recovery.conf (Микаэль Пакье)
Ранее точку остановки можно было задать только по времени или идентификатору транзак-
ции.
• Предоставление пользователям возможности отключить в функции pg_stop_backup() ожида-
ние архивации всех файлов WAL (Дэвид Стил)
Этим поведением управляет необязательный второй аргумент функции pg_stop_backup().
• Возможность создания временных слотов репликации (Петр Желинек)
Временные слоты автоматически удаляются при завершении сеанса или при ошибке.
• Увеличение производительности воспроизведения в режиме горячего резерва благодаря оп-
тимизации обработки исключительных блокировок (Саймон Риггс, Дэвид Роули)
• Ускорение восстановления при двухфазной фиксации (Стас Кельвич, Никхил Сонтакке, Мика-
эль Пакье)
E.9.3.3. Запросы
• Добавление функции XMLTABLE, преобразующей данные в формате XML в набор табличных
строк (Павел Стехуле, Альваро Эррера)
• Исправление обработки в регулярных выражениях классов символов для символов с больши-
ми кодами, в частности, для символов Unicode больше U+7FF (Том Лейн)
Ранее такие символы никогда не воспринимались как принадлежащие классам, зависящим от
локали, например [[:alpha:]].
E.9.3.4. Служебные команды
• Добавление синтаксиса секционирования для автоматического создания ограничений секций
и распределения операций добавления и изменения кортежей (Амит Ланготе)
Этот синтаксис поддерживает секционирование по спискам и по диапазонам.
• Добавление для триггеров AFTER переходных таблиц, содержащих изменённые строки (Кевин
Гриттнер, Томас Мунро)
Содержимое переходных таблиц доступно в триггерах, написанных на языках программирова-
ния на стороне сервера.
• Реализация ограничительных политик защиты на уровне строк (Стивен Фрост)
Ранее все политики были разрешительными, то есть при выполнении условия любой политики
доступ разрешался. Но теперь при невыполнении ограничительной политики доступ будет за-
прещён. Эти типы политик можно комбинировать вместе.
• При создании ограничения внешнего ключа разрешение REFERENCES должно требоваться
только для целевой таблицы (Том Лейн)
Ранее также требовалось разрешение REFERENCES в таблице внешнего ключа. Это требование
было реализовано из-за недопонимания SQL-стандарта. Так как для создания в таблице огра-
ничения внешнего ключа (или подобного) требуются иметь права владельца этой таблицы, до-
полнительное требование разрешения REFERENCES кажется довольно бессмысленным.
• Реализация прав по умолчанию для схем (Матеус Оливейра)
Эти права задаются командой ALTER DEFAULT PRIVILEGES.
• Добавление команды CREATE SEQUENCE AS для создания последовательностей определённого
целочисленного типа данных (Питер Эйзентраут)
2333Замечания к выпуску
Это упрощает создание последовательностей с интервалом значений, соответствующим типу
базовых столбцов.
• Поддержка команды COPY представление FROM источник для представлений с триггерами
INSTEAD INSERT (Харибабу Комми)
Триггеры получают строки данных, которые читает команда COPY.
• Допущение указания имени функции без аргументов в командах DDL, если это имя уникально
(Питер Эйзентраут)
Например, теперь допускается указание DROP FUNCTION с именем функции без аргументов, ес-
ли существует только одна функция с таким именем. Такое поведение требуется стандартом
SQL.
• Реализация возможности удалять несколько функций, операторов и агрегатов одной коман-
дой DROP (Питер Эйзентраут)
• Поддержка предложения IF NOT EXISTS в командах CREATE SERVER, CREATE USER MAPPING и
CREATE COLLATION (Анастасия Лубенникова, Питер Эйзентраут)
• Добавление в вывод VACUUM VERBOSE количества пропущенных замороженных страниц и ста-
рейшего xmin (Масахико Савада, Саймон Риггс)
Эта информация также включается в вывод с log_autovacuum_min_duration.
• Ускорение удаления конечных пустых страниц кучи в процессе операции VACUUM (Клаудио
Фрейре, Альваро Эррера)
E.9.3.5. Типы данных
• Добавление поддержки полнотекстового поиска для типов JSON и JSONB (Дмитрий Долгов)
С этими типами данных теперь могут использоваться функции ts_headline() и
to_tsvector().
• Добавление поддержки MAC-адресов EUI-64 в виде нового типа данных macaddr8 (Харибабу
Комми)
Этот тип дополняет ранее реализованную поддержку MAC-адресов EUI-48 (тип macaddr).
• Добавление столбцов идентификации для назначения числовых значений столбцам при добав-
лении данных (Питер Эйзентраут)
Этот механизм подобен столбцам SERIAL, но соответствует стандарту SQL.
• Реализация возможности переименовывать значения ENUM (Дагфинн Ильмари Маннсакер)
Для этого используется синтаксис ALTER TYPE … RENAME VALUE.
• Исправление обращения с псевдотипами массивов (anyarray) как с массивами в функциях
to_json() и to_jsonb() (Эндрю Дунстан)
Ранее столбцы, объявленные как anyarray, (в частности, столбцы в представлении pg_stats)
преобразовывались не в массивы, а в строки JSON.
• Добавление операторов для умножения и деления значений money на значения int8 (Питер
Эйзентраут)
Ранее в таких случаях значения int8 приводились к типу float8, а затем использовались опе-
раторы money-и-float8. Новое поведение предупреждает возможную потерю точности. Но за-
метьте, что при делении money на int8 теперь дробная часть отбрасывается, как и в других
случаях целочисленного деления, тогда как ранее происходило округление.
2334Замечания к выпуску
• Проверка переполнения в функции ввода типа money (Питер Эйзентраут)
E.9.3.6. Функции
• Добавление упрощённой функции regexp_match() (Эмре Хасегели)
Эта функция подобна regexp_matches(), но возвращает только результаты первого вхожде-
ния, поэтому для её результата не требуется множество, так что её удобнее использовать в
простых случаях.
• Новая версия оператора удаления для jsonb, принимающая массив ключей для удаления
(Магнус Хагандер)
• Реализация рекурсивной обработки объектов и массивов JSON в функции
json_populate_record() и родственных ей (Никита Глухов)
Благодаря этому изменению массивы JSON корректно преобразуются в поля-массивы в целе-
вом типе SQL, а объекты JSON — в поля, представляющие собой составные типы. Ранее в та-
ких случаях происходила ошибка при попытке передать строковое представление JSON-зна-
чения функциям array_in() и record_in(), так как синтаксис полученной строки не соответ-
ствовал ожидаемому этими функциями.
• Добавление функции txid_current_if_assigned(), возвращающей идентификатор текущей
транзакции или NULL, если транзакции не присвоен идентификатор (Крейг Рингер)
Этим данная функция отличается от txid_current(), которая всегда возвращает идентифика-
тор транзакции (назначая его, если он отсутствует). Данную функцию, в отличие от неё, мож-
но выполнять на ведомых серверах.
• Добавление функции txid_status(), проверяющей, была ли зафиксирована транзакция
(Крейг Рингер)
Это позволяет проверить после неожиданного обрыва соединения, была ли зафиксирована
предыдущая транзакция, если вы просто не успели получить уведомление об этом.
• Добавление функции make_date(), интерпретирующей отрицательные числа, как годы до на-
шей эры (Альваро Эррера)
• Функции to_timestamp() и to_date() не должны принимать поля вне допустимых пределов
(Артур Закиров)
Например, ранее вызов to_date(‘2009-06-40’,’YYYY-MM-DD’) выполнялся успешно и возвра-
щалась дата 2009-07-10. Теперь с такими аргументами будет выдаваться ошибка.
E.9.3.7. Языки программирования на стороне сервера
• Возможность вызывать функции cursor() и execute() в PL/Python как методы их аргумента —
объекта plan (Питер Эйзентраут)
Это позволяет придерживаться более объектно-ориентированного стиля программирования.
• Реализована возможность получать значения оператора GET DIAGNOSTICS в PL/pgSQL в эле-
ментах массива (Том Лейн)
Ранее синтаксическое ограничение не допускало использования в качестве целевой перемен-
ной элемента массива.
E.9.3.7.1. PL/Tcl
• Возможность возвращать составные типы и наборы данных из функций PL/Tcl (Карл Лехенбау-
эр)
• Добавление команды subtransaction в PL/Tcl (Виктор Вагнер)
2335Замечания к выпуску
Это позволяет обработать ошибку в запросах PL/Tcl, не прерывая всю функцию.
• Добавление серверных параметров pltcl.start_proc и pltclu.start_proc для указания функций
инициализации, которые будут вызываться при запуске PL/Tcl (Том Лейн)
E.9.3.8. Клиентские интерфейсы
• Реализована возможность указания нескольких адресов или имён серверов в строках подклю-
чения libpq и в строках URI (Роберт Хаас, Хейкки Линнакангас)
Функции libpq будут подключаться к первому работоспособному узлу из этого списка.
• В строках подключения libpq и URI добавлена возможность затребовать сервер для чтения/за-
писи, то есть ведущий, а не ведомый сервер (Виктор Вагнер, Митхун Сай)
Это полезно при указании нескольких имён узлов. Соответствующий параметр подключения
libpq — target_session_attrs.
• Реализована возможность задавать в параметрах подключения libpq имя файла паролей (Джу-
лиан Маркворт)
Ранее его можно было задать только в переменной окружения.
• Добавлена функция PQencryptPasswordConn(), позволяющая создавать больше видов зашиф-
рованных паролей на стороне клиента (Микаэль Пакье, Хейкки Линнакангас)
Ранее функцией PQencryptPassword() можно было создавать только пароли, зашифрован-
ные MD5. Новая функция может также создавать и пароли, зашифрованные методом SCRAM-
SHA-256.
• Изменение версии препроцессора ecpg с 4.12 на 10 (Том Лейн)
Впредь версия ecpg будет соответствовать номеру версии дистрибутива PostgreSQL.
E.9.3.9. Клиентские приложения
• Добавлена поддержка условных ветвлений в psql (Кори Хинкер)
В psql появились метакоманды \if, \elif, \else и \endif. Это полезно в первую очередь для
скриптов.
• Добавление в psql метакоманды \gx для выполнения запроса (запуска команды \g) в расши-
ренном режиме (\x) (Кристоф Берг)
• Расширение переменных psql внутри строк, заключённых в обратные апострофы (Том Лейн)
Это особенно полезно в новых командах условного ветвления psql.
• Недопущение установки некорректных значений для специальных переменных psql (Даниэль
Верите, Том Лейн)
Ранее, если какой-либо специальной переменной psql присваивалось некорректное значение,
оно просто игнорировалось и применялось поведение по умолчанию. Теперь \set со специаль-
ной переменной выдаст ошибку при недопустимом новом значении. В виде особого исключе-
ния \set с пустым или без нового значения по-прежнему действует как присвоение перемен-
ной значения on; но теперь в переменной действительно оказывается это значение, а не пу-
стая строка. Команда \unset со специальной переменной теперь действительно сбрасывает
переменную так, что она получает значение по умолчанию, то есть то значение, которая она
имела при запуске. В итоге управляющая переменная теперь всегда имеет отображаемое зна-
чение, отражающее, что фактически делает psql.
• Добавление переменных, показывающих версию сервера и psql (Фабьен Коэльо)
2336Замечания к выпуску
• Добавление в команды \d (показать отношение) и \dD (показать домен) вывода правила сорти-
ровки, допустимости NULL и свойств по умолчанию в отдельных столбцах (Питер Эйзентраут)
Ранее вся эта информация выводилась в одном столбце «Модификаторы».
• Унификация поведения команд \d в случаях, когда запрошенный объект не найден (Даниэль
Густафссон)
Теперь все они выводят сообщения об этом в stderr, а не в stdout, и текст сообщения стал бо-
лее единообразным.
• Усовершенствование дополнения табуляцией в psql (Джефф Джейнс, Иэн Барвик, Андреас
Карлссон, Сероп Саркуни, Томас Мунро, Кевин Гриттнер. Дагфинн Ильмари Маннсакер)
• Добавление в pgbench параметра –log-prefix для установки префикса файла журнала (Ма-
сахико Савада)
• Возможность разбивать метакоманды pgbench на несколько строк (Фабьен Коэльо)
Теперь метакоманду можно продолжить на следующей строке, введя обратную косую черту
перед переводом строки.
• Устранение ограничения на положение параметра -M по отношению к другим параметрам ко-
мандной строки (Том Лейн)
E.9.3.10. Серверные приложения
• Добавление в pg_receivewal параметра -Z/–compress для включения сжатия (Микаэль Пакье)
• Добавление в pg_recvlogical параметра –endpos для указания конечной позиции (Крейг Рин-
гер)
Этот параметр дополняет существовавший ранее параметр –startpos.
• Переименование параметров initdb –noclean и –nosync в –no-clean и –no-sync (Вик Фи-
ринг, Питер Эйзентраут)
Старое написание по-прежнему поддерживается.
E.9.3.10.1. pg_dump, pg_dumpall, pg_restore
• В pg_restore реализована возможность исключать схемы (Михаэль Банк)
Для этого добавлен новый ключ -N/–exclude-schema.
• В pg_dump добавлен параметр –no-blobs (Гийом Леларж)
Этот ключ отключает выгрузку больших объектов.
• В pg_dumpall добавлен ключ –no-role-passwords для отказа от чтения паролей ролей (Ро-
бинс Таракан, Саймон Риггс)
Это позволяет использовать pg_dumpall не только суперпользователям; без этого ключа
pg_dumpall пытается прочитать пароли, а обычным пользователям это не разрешается.
• Поддержка использования синхронных снимков при выгрузке данных с ведомого сервера
(Петр Желинек)
• Выполнение fsync() (синхронизации с ФС) для файлов, записываемых утилитами pg_dump и
pg_dumpall (Микаэль Пакье)
Это позволяет более уверенно гарантировать, что выгруженные файлы безопасно сохранены
на диске, до завершения работы программы. Это поведение можно отключить новым ключом
–no-sync.
2337Замечания к выпуску
• В pg_basebackup реализована возможность передавать журнал предзаписи в режиме tar (Маг-
нус Хагандер)
Содержимое WAL будет храниться в отдельном от основной копии файле tar.
• Использование в pg_basebackup временных слотов репликации (Магнус Хагандер)
Временные слоты репликации будут задействоваться по умолчанию, когда pg_basebackup ис-
пользует передачу WAL с параметрами по умолчанию.
• Более аккуратное выполнение синхронизации с ФС везде, где это требуется в pg_basebackup и
pg_receivewal (Микаэль Пакье)
• Добавление в pg_basebackup ключа –no-sync для отключения синхронизации с ФС (Микаэль
Пакье)
• Улучшение обработки в pg_basebackup пропускаемых каталогов (Дэвид Стил)
• Добавление параметра ожидания для операции повышения роли в pg_ctl (Питер Эйзентраут)
• Добавление длинных ключей для работы pg_ctl с ожиданием (–wait) и без ожидания (–no-
wait) (Вик Фиринг)
• Добавление длинного ключа для параметров, которые pg_ctl передаёт серверу (–options)
(Питер Эйзентраут)
• В ожидании готовности сервера команда pg_ctl start –wait должна наблюдать за
postmaster.pid, а не пытаться установить подключение (Том Лейн)
Процесс postmaster теперь может сигнализировать о своей готовности принимать подключе-
ния в файле postmaster.pid, и pg_ctl теперь проверяет этот файл, чтобы определить, что сер-
вер запущен. Этот метод эффективнее и надёжнее старого, а кроме того он избавляет от сооб-
щений о неудавшихся попытках подключения при запуске.
• Уменьшение времени реакции pg_ctl в ожидании запуска/остановки процесса postmaster (Том
Лейн)
Теперь pg_ctl проверяет изменения состояния postmaster не один (как раньше), а десять раз в
секунду.
• Возврат ненулевого кода состояния при выходе pg_ctl, если ожидаемая операция не заверши-
лась за отведённое время (Питер Эйзентраут)
Теперь операции start и promote возвращают в таких случаях код состояния 1, а не 0. Опера-
ция stop делала это всегда.
E.9.3.11. Исходный код
• Переход на нумерацию версий с двумя компонентами (Питер Эйзентраут, Том Лейн)
Номера выпусков теперь состоят из двух частей (например, 10.1), а не из трёх (например,
9.6.3). Основные версии теперь будут увеличивать только первое число, а корректирующие
выпуски — только второе. В названии ветвей выпусков будет включаться только одно число
(например, 10 вместо 9.6). Это изменение произведено для того, чтобы пользователям было
понятнее, что есть основная, а что — дополнительная версия PostgreSQL.
• Улучшение поведения pgindent (Пётр Стефаняк, Том Лейн)
Мы перешли на новую версию pg_bsd_indent, включающую последние усовершенствования из
проекта FreeBSD. В результате устранено множество мелких ошибок, которые приводили к
странным решениям относительно форматирования кода C. Одно из самых заметных измене-
ний — строки в скобках (например, вызов функции, записанный в нескольких строках) теперь
2338Замечания к выпуску
единообразно выравниваются по открывающей скобке, даже если в результате код будет вы-
ходить за правую границу.
• Возможность использования библиотеки ICU для поддержки правил сортировки (Питер Эй-
зентраут)
Библиотека ICU реализует версионирование, что позволяет выявлять изменения правил сор-
тировки от версии к версии. Она подключается параметром configure –with-icu. По умолча-
нию для сортировки по-прежнему используется встроенная библиотека операционной систе-
мы.
• Автоматическое добавление для всех функций PG_FUNCTION_INFO_V1 пометки DLLEXPORT в
Windows (Лауренц Альбе)
Если сторонний код использует объявления функций с характеристикой extern, они также
должны иметь пометки DLLEXPORT в этих объявлениях.
• Ликвидация ставших ненужными SPI-функций SPI_push(), SPI_pop(),
SPI_push_conditional(), SPI_pop_conditional() и SPI_restore_connection() (Том Лейн)
Теперь их функциональность реализуется автоматически. Сейчас остались пустые макросы с
такими именами (чтобы не требовалось немедленно обновлять внешние модули), но в конце
концов их вызовы должны быть удалены.
Побочным эффектом этого изменения стало то, что SPI_palloc() и родственные функции те-
перь требуют активного SPI-подключения; их действие не сводится к простому palloc(), ес-
ли его нет. Предыдущее такое поведение оказалось не очень полезным и было чревато неожи-
данными утечками памяти.
• Возможность динамического выделения разделяемой памяти (Томас Мунро, Роберт Хаас)
• Добавление механизма выделения памяти, подобного slab, для эффективного выделения па-
мяти фиксированного размера (Томаш Вондра)
• Использование семафоров POSIX вместо SysV в Linux и FreeBSD (Том Лейн)
Это снимает некоторые присущие платформе лимиты на использование семафоров SysV.
• Улучшение поддержки 64-битных атомарных операций (Андрес Фройнд)
• Использование 64-битных атомарных операций на платформе ARM64 (Роман Шапошник)
• Переход к использованию функции clock_gettime(), если она доступна, для замеров длитель-
ности (Том Лейн)
Если clock_gettime() недоступна, по-прежнему будет использоваться gettimeofday().
• Добавление более надёжных генераторов случайных чисел для криптографического использо-
вания (Магнус Хагандер, Микаэль Пакье, Хейкки Линнакангас)
Если надёжный генератор случайных чисел не обнаруживается, процедура configure прервёт-
ся, если только дополнительно не передать ключ –disable-strong-random. Однако с этим
ключом функции pgcrypto, которым требуется надёжный генератор случайных чисел, будут
отключены.
• В функции WaitLatchOrSocket() налажено ожидание подключения сокета в Windows (Андрес
Фройнд)
• Функции tupconvert.c более не преобразуют кортежи только для того, чтобы включить в них
другой OID составного типа (Ашутош Бапат, Том Лейн)
В большинстве точек вызова этот OID составного типа не нужен; но если результирующий
кортеж будет использоваться как составное значение Datum, требуются дополнительные дей-
ствия, чтобы в нём оказался корректный OID.
2339Замечания к выпуску
• Ликвидация портов SCO и Unixware (Том Лейн)
• Переработка процесса сборки документации (Александр Лахин)
• Использование XSLT для сборки документации PostgreSQL (Питер Эйзентраут)
Ранее использовались программы Jade, DSSSL и JadeTex.
• Сборка HTML-документации по умолчанию со стилями XSLT (Питер Эйзентраут)
E.9.3.12. Дополнительные модули
• Реализация в file_fdw возможности читать вывод программ, так же как и содержимое файлов
(Кори Хинкер, Адам Гомаа)
• В postgres_fdw реализована передача агрегатных функций на удалённый сервер, когда это
возможно (Дживан Чок, Ашутош Бапат)
Это сокращает объём данных, который должен передаваться со стороннего сервера и избавля-
ет запрашивающий сервер от вычисления агрегатной функции.
• postgres_fdw может передавать соединения отношений на сторонний сервер в большем числе
случаев (Дэвид Роули, Ашутош Бапат, Эцуро Фудзита)
• Исправление поддержки столбцов OID в таблицах postgres_fdw (Эцуро Фудзита)
Ранее в столбцах OID всегда возвращались нули.
• Реализация в btree_gist и btree_gin возможности индексировать типы-перечисления (Эндрю
Дунстан)
Это позволяет использовать перечисления в ограничениях-исключениях.
• Добавление в btree_gist поддержки индексации для типа данных UUID (Пол Юнгвирт)
• Добавлено расширение amcheck, которое может проверять корректность индексов-B-деревьев
(Питер Геохеган)
• Отображение в pg_stat_statements игнорируемых констант как $N, а не как ? (Лукас Фиттл)
• Улучшение в модуле cube обработки кубов с нулевой размерностью (Том Лейн)
При этом также улучшена работа со значениями infinite и NaN.
• Сокращение числа блокировок при обращении к представлению pg_buffercache (Иван Карты-
шов)
Как следствие, его можно более беспрепятственно использовать в производственных средах.
• Добавление в pgstattuple функции pgstathashindex() для просмотра статистики хеш-индексов
(Ашутош Шарма)
• Возможность использовать GRANT для управления доступом к функциям pgstattuple (Стивен
Фрост)
Это позволяет администраторам разрешать вызывать эти функции не только суперпользовате-
лям.
• Сокращение числа блокировок в pgstattuple при просмотре хеш-индексов (Амит Капила)
• Добавление в pageinspect функции page_checksum() для получения контрольной суммы стра-
ницы (Томаш Вондра)
• Добавление в pageinspect функции bt_page_items(), которая выводит элементы страницы для
переданного образа страницы (Томаш Вондра)
• Добавление поддержки хеш-индексов в pageinspect (Джеспер Педерсен, Ашутош Шарма)
2340Замечания к выпуску
E.9.4. Благодарственный список
Перечисленные ниже (в алфавитном порядке) лица сделали вклад в этот выпуск, разрабатывая,
совершенствуя и рецензируя код, принимая правки, проводя тестирование или сообщая о пробле-
мах.
Адам Брайтвелл (Adam Brightwell)
Адам Брюссельбек (Adam Brusselback)
Адам Гомаа (Adam Gomaa)
Адам Сах (Adam Sah)
Адриан Клавер (Adrian Klaver)
Аидан Ван Дик (Aidan Van Dyk)
Александр Алексеев (Aleksander Alekseev)
Александр Коротков (Alexander Korotkov)
Александр Лахин (Alexander Lakhin)
Александр Сосна (Alexander Sosna)
Алексей Баштанов (Alexey Bashtanov)
Алексей Грищенко (Alexey Grishchenko)
Алексей Исайко (Alexey Isayko)
Альваро Эрнандес Тортоза (Álvaro Hernández Tortosa)
Альваро Эррера (Álvaro Herrera)
Амит Капила (Amit Kapila)
Амит Ланготе (Amit Langote)
Амит Хандекар (Amit Khandekar)
Амул Сул (Amul Sul)
Анастасия Лубенникова (Anastasia Lubennikova)
Андреас Джозеф Крог (Andreas Joseph Krogh)
Андреас Зельтенрейх (Andreas Seltenreich)
Андреас Карлссон (Andreas Karlsson)
Андреас Шербаум (Andreas Scherbaum)
Андрей Бородин (Andrey Borodin)
Андрей Лизенко (Andrey Lizenko)
Андрес Фройнд (Andres Freund)
Антонин Хоуска (Antonin Houska)
Антс Аасма (Ants Aasma)
Арсений Шер (Arseny Sher)
Артур Закиров (Artur Zakirov)
Арьен Нинхаус (Arjen Nienhuis)
Атсуши Торикоши (Atsushi Torikoshi)
Ашвин Агравал (Ashwin Agrawal)
Ашутош Бапат (Ashutosh Bapat)
Ашутош Шарма (Ashutosh Sharma)
Аюми Исии (Ayumi Ishii)
Бейзил Бурк (Basil Bourque)
Бен де Грааф (Ben de Graaff)
Бенедикт Грундман (Benedikt Grundmann)
Бернд Хелмле (Bernd Helmle)
Бина Эмерсон (Beena Emerson)
Брандур Лич (Brandur Leach)
Брин Хаган (Breen Hagan)
Бруно Вольф III (Bruno Wolff III)
Брэд Дейонг (Brad DeJong)
Брюс Момджян (Bruce Momjian)
Вайшнави Прабакаран (Vaishnavi Prabakaran)
Венката Балажи Наготи (Venkata Balaji Nagothi)
Вик Фиринг (Vik Fearing)
Вики Вергара (Vicky Vergara)
Виктор Вагнер (Victor Wagner)
2341Замечания к выпуску
Винаяк Покале (Vinayak Pokale)
Вирен Неги (Viren Negi)
Виталий Буровой (Vitaly Burovoy)
Владимир Кунщиков (Vladimir Kunshchikov)
Владимир Русинов (Vladimir Rusinov)
Габриэль Бартолини (Gabriele Bartolini)
Габриэль Рот (Gabrielle Roth)
Гао Цзэнци (Gao Zengqi)
Генри Болерт (Henry Boehlert)
Гердан Сантос (Gerdan Santos)
Гийом Леларж (Guillaume Lelarge)
Грег Аткинс (Greg Atkins)
Грег Бурек (Greg Burek)
Григорий Смолкин (Grigory Smolkin)
Грэхем Даттон (Graham Dutton)
Давид Феттер (David Fetter)
Дагфинн Ильмари Маннсакер (Dagfinn Ilmari Mannsåker)
Дайсукэ Хигути (Daisuke Higuchi)
Дамиан Кирога (Damian Quiroga)
Дан Мин Хыонг (Dang Minh Huong)
Даниель Вестерман (Daniel Westermann)
Данило Глинский (Danylo Hlynskyi)
Даниэле Вараццо (Daniele Varrazzo)
Даниэль Верите (Daniel Vérité)
Даниэль Густафссон (Daniel Gustafsson)
Дарко Прелец (Darko Prelec)
Деврим Гюндюз (Devrim Gündüz)
Дейв Крамер (Dave Cramer)
Дейв Пейдж (Dave Page)
Денис Смирнов (Denis Smirnov)
Дениш Патель (Denish Patel)
Деннис Бьорклунд (Dennis Björklund)
Джанни Чиолли (Gianni Ciolli)
Джаред Уорд (Jarred Ward)
Джастин Муис (Justin Muise)
Джастин Призби (Justin Pryzby)
Джеймс Паркс (James Parks)
Джейсон Ли (Jason Li)
Джейсон О’Доннелл (Jason O’Donnell)
Джейсон Петерсен (Jason Petersen)
Джереми Финцель (Jeremy Finzel)
Джереми Шнайдер (Jeremy Schneider)
Джеспер Педерсен (Jesper Pedersen)
Джефф Девис (Jeff Davis)
Джефф Джейнс (Jeff Janes)
Джефф Дэфо (Jeff Dafoe)
Дживан Ладхе (Jeevan Ladhe)
Дживан Чок (Jeevan Chalke)
Джим Млодженски (Jim Mlodgenski)
Джим Нэсби (Jim Nasby)
Джинью Чжан (Jinyu Zhang)
Джо Конвей (Joe Conway)
Джон Беркус (Josh Berkus)
Джон Харви (John Harvey)
Джордан Гигов (Jordan Gigov)
Джош Сореф (Josh Soref)
Джоэл Джейкобсон (Joel Jacobson)
Джузеппе Брокколо (Giuseppe Broccolo)
2342Замечания к выпуску
Джулиан Маркворт (Julian Markwort)
Джун-сок Ян (Junseok Yang)
Дилип Кумар (Dilip Kumar)
Дилян Палаузов (Dilyan Palauzov)
Дин Рашид (Dean Rasheed)
Дмитрий Долгов (Dmitry Dolgov)
Дмитрий Иванов (Dimitry Ivanov)
Дмитрий Павлов (Dima Pavlov)
Дмитрий Сарафанников (Dmitriy Sarafannikov)
Дмитрий Федин (Dmitry Fedin)
Дон Моррисон (Don Morrison)
Дэвид Джонстон (David Johnston)
Дэвид Кристенсен (David Christensen)
Дэвид Роули (David Rowley)
Дэвид Рэйдер (David Rader)
Дэвид Стил (David Steele)
Дэн Вуд (Dan Wood)
Евгений Казаков (Eugene Kazakov)
Евгений Коньков (Eugen Konkov)
Егор Рогов (Egor Rogov)
Жиль Даролд (Gilles Darold)
Жульен Рухо (Julien Rouhaud)
И Вэнь Вон (Yi Wen Wong)
Иван Картышов (Ivan Kartyshov)
Игорь Корот (Igor Korot)
Ильдус Курбангалиев (Ildus Kurbangaliev)
Иэн Барвик (Ian Barwick)
Йелте Феннема (Jelte Fennema)
Йерун ван дер Хам (Jeroen van der Ham)
Йон Нельсон (Jon Nelson)
КайГай Кохэй (KaiGai Kohei)
Кайл Конрой (Kyle Conroy)
Карен Хаддлстон (Karen Huddleston)
Карл Лехенбауэр (Karl Lehenbauer)
Карл О. Пинц (Karl O. Pinc)
Каспер Жук (Kacper Zuk)
Каталин Якоб (Catalin Iacob)
Кевин Гриттнер (Kevin Grittner)
Кейт Фиске (Keith Fiske)
Ким Росе Карлсен (Kim Rose Carlsen)
Клаудио Фрейре (Claudio Freire)
Клинтон Адамс (Clinton Adams)
Конст Чжан (Const Zhang)
Константин Евтеев (Konstantin Evteev)
Константин Книжник (Konstantin Knizhnik)
Константин Пан (Constantin Pan)
Кори Хинкер (Corey Huinker)
Крейг Рингер (Craig Ringer)
Крис Бенди (Chris Bandy)
Крис Ричардс (Chris Richards)
Крис Рупрехт (Chris Ruprecht)
Кристиан Ульрих (Christian Ullrich)
Кристоф Берг (Christoph Berg)
Кунтал Гхош (Kuntal Ghosh)
Курт Карталтепе (Kurt Kartaltepe)
Куэль Чжо (QL Zhuo)
Кётаро Хоригути (Kyotaro Horiguchi)
Лауренц Альбе (Laurenz Albe)
2343Замечания к выпуску
Леонардо Чекки (Leonardo Cecchi)
Лукас Фиттл (Lukas Fittl)
Людовик Вожуа-Пепин (Ludovic Vaugeois-Pepin)
Магнус Хагандер (Magnus Hagander)
Майк Пальмиотто (Mike Palmiotto)
Майкл Дэй (Michael Day)
Максим Милютин (Maksim Milyutin)
Максим Соболев (Maksym Sobolyev)
Марек Чворен (Marek Cvoren)
Марк Дилгер (Mark Dilger)
Марк Кирквуд (Mark Kirkwood)
Марк Петер (Mark Pether)
Марк Расбах (Marc Rassbach)
Марк-Олаф Яшке (Marc-Olaf Jaschke)
Марко Тииккая (Marko Tiikkaja)
Маркос Кастедо (Marcos Castedo)
Маркус Винанд (Markus Winand)
Марллиус Рибейро (Marllius Ribeiro)
Марти Раудсепп (Marti Raudsepp)
Мартин Маркес (Martín Marqués)
Масахико Савада (Masahiko Sawada)
Матеус Оливейра (Matheus Oliveira)
Мерлин Монкьюр (Merlin Moncure)
Микаэль Пакье (Michael Paquier)
Милош Урбанек (Milos Urbanek)
Митхун Сай (Mithun Cy)
Михаэль Банк (Michael Banck)
Михаэль Мескес (Michael Meskes)
Михаэль Овермайер (Michael Overmeyer)
Мойше Джейкобсон (Moshe Jacobson)
Муртуза Забуавала (Murtuza Zabuawala)
Мэтью Феньяк (Mathieu Fenniak)
Наоки Окано (Naoki Okano)
Натан Боссарт (Nathan Bossart)
Натан Вагнер (Nathan Wagner)
Неха Хатри (Neha Khatri)
Неха Шарма (Neha Sharma)
Никита Глухов (Nikita Glukhov)
Николай Никитин (Nikolay Nikitin)
Николай Шаплов (Nikolay Shaplov)
Николас Бачелли (Nicolas Baccelli)
Николас Гини (Nicolas Guini)
Николас Товен (Nicolas Thauvin)
Николаус Тиль (Nikolaus Thiel)
Никхил Сонтакке (Nikhil Sontakke)
Нил Андерсон (Neil Anderson)
Ной Миш (Noah Misch)
Нориёси Синода (Noriyoshi Shinoda)
Олаф Гавенда (Olaf Gawenda)
Олег Бартунов (Oleg Bartunov)
Оскари Сааренмаа (Oskari Saarenmaa)
Отар Шавадзе (Otar Shavadze)
Паван Деоласи (Pavan Deolasee)
Павел Голубь (Pavel Golub)
Павел Райскуп (Pavel Raiskup)
Павел Стехуле (Pavel Stehule)
Павел Ханак (Pavel Hanák)
Пареш Мор (Paresh More)
2344Замечания к выпуску
Петр Желинек (Petr Jelínek)
Питер Геохеган (Peter Geoghegan)
Питер Эйзентраут (Peter Eisentraut)
Пол Рамсей (Paul Ramsey)
Пол Юнгвирт (Paul Jungwirth)
Прабхат Саху (Prabhat Sahu)
Пьер-Эммануэль Андре (Pierre-Emmanuel André)
Пэн Сунь (Peng Sun)
Пётр Стефаняк (Piotr Stefaniak)
Рагнар Оухтерлони (Ragnar Ouchterlony)
Радек Слупик (Radek Slupik)
Раджкумар Рагхуванши (Rajkumar Raghuwanshi)
Райан Мерфи (Ryan Murphy)
Рафа де ла Торре (Rafa de la Torre)
Рафия Сабих (Rafia Sabih)
Рахила Сьед (Rahila Syed)
Регина Обе (Regina Obe)
Ричард Пистоль (Richard Pistole)
Роберт Хаас (Robert Haas)
Робинс Таракан (Robins Tharakan)
Род Тейлор (Rod Taylor)
Роман Шапошник (Roman Shaposhnik)
Рушаб Латиа (Rushabh Lathia)
Саймон Риггс (Simon Riggs)
Сандип Таккар (Sandeep Thakkar)
Свейн Свейнссон (Sveinn Sveinsson)
Свен Р. Кунце (Sven R. Kunze)
Себастьян Луке (Sebastian Luque)
Сергей Бурладян (Sergey Burladyan)
Сергей Копосов (Sergey Koposov)
Сероп Саркуни (Sehrope Sarkuni)
Симоне Готти (Simone Gotti)
Синтия Шан (Cynthia Shang)
Синъити Мацуда (Shinichi Matsuda)
Скотт Милликен (Scott Milliken)
Спенсер Томасон (Spencer Thomason)
Стас Кельвич (Stas Kelvich)
Степан Пестерников (Stepan Pesternikov)
Стив Рэндалл (Steve Randall)
Стив Сингер (Steve Singer)
Стивен Винфилд (Steven Winfield)
Стивен Фрост (Stephen Frost)
Стивен Фэклер (Steven Fackler)
Сурадж Хараге (Suraj Kharage)
Тайки Кондо (Taiki Kondo)
Такаюки Цунакава (Takayuki Tsunakawa)
Такэси Идэриха (Takeshi Ideriha)
Тахир Фахрутдинов (Tahir Fakhroutdinov)
Тацуо Исии (Tatsuo Ishii)
Тацуро Ямада (Tatsuro Yamada)
Тим Гудэйр (Tim Goodaire)
Тобиас Бусман (Tobias Bussmann)
Том Браун (Thom Brown)
Том Дунстан (Tom Dunstan)
Том Лейн (Tom Lane)
Тома ван Тилбург (Tom van Tilburg)
Томас Келлерер (Thomas Kellerer)
Томас Мунро (Thomas Munro)
2345Замечания к выпуску
Томаш Вондра (Tomas Vondra)
Томонари Кацумата (Tomonari Katsumata)
Тушар Ахуджа (Tushar Ahuja)
Фабрицио де Ройес Мелло (Fabrízio de Royes Mello)
Фабьен Коэльо (Fabien Coelho)
Фейке Стинберген (Feike Steenbergen)
Феликс Герзаге (Felix Gerzaguet)
Филип Йирсак (Filip Jirsák)
Филипп Бодуэн (Philippe Beaudoin)
Фудзии Масао (Fujii Masao)
Фёдор Сигаев (Teodor Sigaev)
Хайме Казанова (Jaime Casanova)
Ханс Бушман (Hans Buschmann)
Харибабу Комми (Haribabu Kommi)
Хейкки Линнакангас (Heikki Linnakangas)
Хуань Жуань (Huan Ruan)
Чепмен Флэк (Chapman Flack)
Чжоу Дигоал (Zhou Digoal)
Чжэнь Мин Ян (Zhen Ming Yang)
Чуаньтин Ван (Chuanting Wang)
Чхве Ду-Вон (Choi Doo-Won)
Чэнь Хуацзюнь (Chen Huajun)
Шо Като (Sho Kato)
Шон Фаррел (Sean Farrell)
Шэй Роджански (Shay Rojansky)
Эйдзи Сэки (Eiji Seki)
Эйлер Тавейра (Euler Taveira)
Эмил Иггланд (Emil Iggland)
Эмре Хасегели (Emre Hasegeli)
Энди Абелисто (Andy Abelisto)
Эндрю Вилрайт (Andrew Wheelwright)
Эндрю Гирт (Andrew Gierth)
Эндрю Дунстан (Andrew Dunstan)
Энрике Менесес (Enrique Meneses)
Эрвин Брандштеттер (Erwin Brandstetter)
Эрик Нордстром (Erik Nordström)
Эрик Рижкерс (Erik Rijkers)
Эцуро Фудзита (Etsuro Fujita)
Юго Нагата (Yugo Nagata)
Якоб Еггер (Jakob Egger)
E.10. Release 9.6.11
Дата выпуска:
2018-11-08
В этот выпуск вошли различные исправления, внесённые после версии 9.6.10. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.10.1. Миграция на версию 9.6.11
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.6.9, см. Раздел E.12.
E.10.2. Изменения
• Устранение сбоев, которые могли возникать в особых случаях в семействе функций has_объ-
ект_privilege() (Том Лейн)
2346Замечания к выпуску
Эти функции должны возвращать NULL, а не выдавать ошибку при получении неверного
OID. Некоторые из этих функций делали это и прежде, но не все. Кроме того, в функции
has_column_privilege() на некоторых платформах могли иметь место и другие сбои.
• Недопущение замедления порядка O(N^2) в функциях match/split с регулярными выражения-
ми при обработке длинных строк (Эндрю Гирт)
• Исправление дефекта в обработке стандартных многосимвольных операторов, следующих
непосредственно за комментарием или символами + и - (Эндрю Гирт)
Следствием данного упущения могли быть ошибки при разборе или неправильное определе-
ние приоритета операторов.
• Недопущение замедления порядка O(N^3) при обработке лексическим анализатором длин-
ных строк из символов + или - (Эндрю Гирт)
• Исправление некорректного выполнения подчинённых планов при сканировании внешнего
запроса в обратном направлении (Эндрю Гирт)
• Исправление ошибочного поведения UPDATE/DELETE … WHERE CURRENT OF … после переме-
щения курсора (Том Лейн)
Курсор, сканирующий несколько отношений (в частности, дерево наследования), мог работать
неправильно, возвращаясь к предыдущему отношению.
• Исправление в функции EvalPlanQual обработки узлов InitPlan, которые выполняются по
условию (Эндрю Гирт, Том Лейн)
Вследствие ошибки реализации могли возникать сложновоспроизводимые сбои или выдавать-
ся неправильные результаты при одновременных запросах на изменение, содержащих изоли-
рованные вложенные SELECT в конструкции CASE.
• Исправление проверок классов символов для корректной поддержки в Windows символов
Unicode выше U+FFFF (Том Лейн, Кэндзи Уно)
Эта ошибка проявлялась в операциях полнотекстового поиска, а также в работе модулей
contrib/ltree и contrib/pg_trgm.
• Недопущение передачи вложенных SELECT с оконными функциями, а также с указаниями
LIMIT или OFFSET, параллельным исполнителям (Амит Капила)
В таких случаях поведение могло быть несогласованным из-за того, что разные исполнители
получали разные результаты вследствие вариативности в порядке строк.
• Смена владельца последовательности, принадлежащей сторонней таблице, при выполнении
ALTER OWNER для этой таблицы (Питер Эйзентраут)
Операция смены владельца должна распространяться и на такие последовательности, но
раньше сторонние таблицы она не затрагивала.
• Обеспечение обработки сервером уже полученных прерываний NOTIFY и SIGTERM до начала
ожидания данных от клиента (Джефф Джейнс, Том Лейн)
• Устранение ошибки, приводившей к выделению лишней памяти для строки результатов
array_out() (Кэйити Хиробэ)
• Ликвидация утечки памяти при сканировании индекса SP-GiST (Том Лейн)
Сколько-нибудь значительное проявление этой утечки наблюдалось, только когда для ограни-
чения-исключения, использующего SP-GiST, в индекс поступало много записей.
• Закрытие файла сопоставлений в ApplyLogicalMappingFile() после завершения его использо-
вания (Томаш Вондра)
2347Замечания к выпуску
Ранее дескриптор файла терялся, что могло в итоге приводить к сбоям при логическом деко-
дировании.
• Устранение ошибки логического декодирования в случаях, когда сопоставленная таблица ка-
талога постоянно перезаписывается, например, в результате действия VACUUM FULL (Андрес
Фройнд)
• Предотвращение запуска сервера со значением wal_level, недостаточно большим для под-
держки существующего слота репликации (Андрес Фройнд)
• Предотвращение сбоя в случаях, когда служебная команда создаёт бесконечную рекурсию
(Том Лейн)
• Устранение в процессе инициализации горячего резерва проблемы дублирующихся XID, ко-
торые образуются при выполнении двухфазных транзакций на ведущем сервере (Микаэль Па-
кье, Константин Книжник)
• Исправление поведения событийных триггеров при обработке вложенных команд ALTER TABLE
(Микаэль Пакье, Альваро Эррера)
• Передача параллельным исполнителям времени начала оператора и транзакции от родитель-
ского процесса (Константин Книжник)
Тем самым исправлено поведение таких функций, как transaction_timestamp(), выполняю-
щихся в параллельном исполнителе.
• Обеспечение корректного выравнивания при передаче расширенных значений данных парал-
лельным исполнителям, что позволяет избежать сбоев на платформах, требовательных к вы-
равниванию (Том Лейн, Амит Капила)
• Исправление логики переработки файла WAL для правильного выполнения этой операции на
ведомых серверах (Микаэль Пакье)
В зависимости от значения параметра archive_mode ведомый сервер мог не удалить некото-
рые файлы WAL, подлежащие удалению.
• Исправление обработки времени фиксации транзакций в процессе восстановления (Масахико
Савада, Микаэль Пакье)
Если отслеживание времени фиксации не было включено постоянно, в процессе восстановле-
ния мог произойти сбой при попытке получить время фиксации транзакции, для которой оно
не было записано.
• Использование случайной затравки для random() в initdb, а также в сервере, запускаемом в
режиме начальной загрузки и в монопольном режиме (Ной Миш)
Практическая польза этого изменения состоит прежде всего в разрешении проблемы, когда
программа initdb не могла использовать общую память POSIX, считая её недоступной, из-за
конфликтов имён, вызванных использованием одинаковой затравки.
• Возможность прерывания операции выделения памяти в DSM (Крис Трэверс)
• Предупреждение сбоя в параллельном исполнителе при загрузке расширения, пытающегося
обратиться к системным кешам в своей функции инициализации (Томас Мунро)
Мы не считаем это удачным приёмом программирования расширений, но до внедрения парал-
лельных запросов это работало, а значит должно поддерживаться и теперь.
• Исправление поведения при динамическом включении параметра full_page_writes (Кётаро
Хоригути)
• Недопущение возможного сбоя в результате двойного освобождения памяти при повторном
сканировании SP-GiST (Эндрю Гирт)
• Предупреждение возможного переполнения буфера при воспроизведении операции распаков-
ки страницы GIN из WAL (Александр Коротков, Шивасубраманьян Рамасубраманьян)
2348Замечания к выпуску
• Выполнение операции fsync, ранее упущенной, для каталога слотов репликации (Константин
Книжник, Микаэль Пакье)
• Устранение неожиданных тайм-аутов при использовании wal_sender_timeout на медленном
сервере (Ной Миш)
• Исправление вычисления подходящей точки согласованности WAL в процессах горячего ре-
зерва (Александр Кукушкин, Микаэль Пакье)
Выбор правильной точки позволяет предотвратить некорректное поведение сразу после того,
как ведомый сервер достигает согласованного состояния базы при воспроизведении WAL.
• Корректная остановка фоновых рабочих процессов при получении главным процессом запро-
са на быстрое отключение до завершения запуска базы (Александр Кукушкин)
• Обновление карты свободного пространства при воспроизведении из WAL изменений флагов
замороженных/полностью видимых страниц (Альваро Эррера)
Ранее мы не заботились об этом, считая, что в карте свободного пространства в любом слу-
чае нет важной информации. Однако если она сильно устаревает, это может привести к зна-
чительному снижению производительности после повышения ведомого сервера до основного.
Эта карта в конце концов будет исправлена в результате обновлений, но мы хотим иметь её в
хорошем состоянии раньше, поэтому стоит приложить дополнительные усилия и поддержи-
вать её актуальность при воспроизведении WAL.
• Предотвращение преждевременного освобождения ресурсов параллельных исполнителей по
окончании запроса или при достижении предельного числа кортежей (Амит Капила)
В этот момент завершение исполнителя допустимо, только если вызывающий процесс не мо-
жет запросить обратное сканирование.
• Отказ от вызова обработчиков atexit при обработке SIGQUIT (Хейкки Линнакангас)
• Исключение сопоставлений пользователей для сторонних серверов из состава расширений
(Том Лейн)
При выполнении CREATE USER MAPPING в скрипте расширения для создаваемого сопоставле-
ния добавлялась зависимость, чего не должно быть. Сопоставления пользователей, как и ро-
ли, не могут быть членами расширений.
• Исправление поведения syslogger в случае ошибок при попытке открыть файлы CSV (Том
Лейн)
• Исправление кода psql, а также примеров в документации, чтобы функция PQconsumeInput()
вызывалась перед PQnotifies() (Том Лейн)
Тем самым решена проблема, когда psql не выдавал полученное сообщение NOTIFY до следую-
щей команды.
• Устранение возможной несогласованности при сортировке различных имён объектов в
pg_dump (Джейкоб Чемпион)
• Исправление pg_restore, чтобы при выдаче команд DISABLE/ENABLE TRIGGER имя таблицы до-
полнялось схемой (Том Лейн)
Это предотвращает сбои, возможные при новой политике выполнения восстановления с огра-
ниченным путём поиска.
• В pg_upgrade исправлена обработка событийных триггеров в расширениях (Харибабу Комми)
Ранее pg_upgrade не сохранял связь событийных триггеров с расширениями.
• Исправление проверки состояния кластера в pg_upgrade, чтобы она корректно выполнялась
на ведомом сервере (Брюс Момджян)
• Ограничение числа размерностей в значениях cube во всех функциях contrib/cube (Андрей
Бородин)
2349Замечания к выпуску
Ранее в некоторых функциях, связанных с кубами, можно было создать такие значения, кото-
рые затем не принимала функция cube_in(), что вызывало ошибки при восстановлении вы-
груженных данных.
• Недопущение передачи расширением contrib/postgres_fdw предложений ORDER BY, не со-
держащих переменных, на удалённый сервер (Эндрю Гирт)
• Исправление функции unaccent() в расширении contrib/unaccent, чтобы она использовала
словарь текстового поиска unaccent, находящийся в той же схеме, где и сама функция (Том
Лейн)
Ранее она пыталась найти словарь по пути поиска, но могла не обнаружить его, если путь по-
иска был ограничен.
• Устранение проблем при сборке в macOS 10.14 (Mojave) (Том Лейн)
Усовершенствование скрипта configure, чтобы в CPPFLAGS добавлялся ключ -isysroot; без
этого PL/Perl и PL/Tcl нельзя сконфигурировать или собрать в macOS 10.14. Значение sysroot
можно переопределить во время конфигурирования или сборки, установив переменную
PG_SYSROOT в аргументах configure или make.
Теперь рекомендуется, чтобы для связанных с Perl расширений во флагах компилятора указы-
валось $(perl_includespec), а не -I$(perl_archlibexp)/CORE. Второй вариант по-прежнему
будет работать на большинстве платформ, но не в последних macOS.
Также теперь не требуется указывать вручную ключ –with-tclconfig, чтобы собрать PL/Tcl в
последних версиях macOS.
• Исправление скриптов сборки с MSVC и регрессионного тестирования для работы с последни-
ми версиями Perl (Эндрю Дунстан)
Это изменение вызвано тем, что Perl теперь по умолчанию не включает текущий каталог в
свой путь поиска.
• Реализована возможность запускать регрессионные тесты в Windows с учётной записью адми-
нистратора (Эндрю Дунстан)
Чтобы это было безопасно, pg_regress теперь лишает себя расширенных прав при запуске.
• Снятие запрета на возврат из функций сравнения btree значений INT_MIN (Том Лейн)
До настоящего времени мы не позволяли типозависимым функциям сравнения возвращать
INT_MIN, благодаря чему вызывающий код мог сменить порядок сортировки, просто изменив
знак результата сравнения. Однако это могло вызывать проблемы с функциями сравнения,
возвращающими непосредственно результат memcmp(), strcmp() и подобных функций, так как
POSIX не накладывает на него никаких ограничений. Как минимум некоторые последние вер-
сии memcmp() могут возвращать INT_MIN, что приводило к нарушению порядка сортировки. В
связи с этим мы убрали это ограничение. Там же, где требуется поменять порядок сортировки
на противоположный, теперь нужно использовать макрос INVERT_COMPARE_RESULT().
• Устранение риска рекурсии при обработке сообщений об аннулировании общего кеша (Том
Лейн)
Эта ошибка могла привести, например, к сбою при обращении к системному каталогу или ин-
дексу, который был только что обработан командой VACUUM FULL.
В результате этого изменения функция LockAcquire теперь может возвращать новый код ре-
зультата, что теоретически может вызвать проблемы при использовании этой функции, хо-
тя для этого схема её использования должна быть весьма необычной. Также был изменён API
функции LockAcquireExtended.
• Сохранение и восстановление глобальных переменных SPI в SPI_connect() и SPI_finish()
(Чепмен Флэк, Том Лейн)
2350Замечания к выпуску
Это предотвращает накладки, возможные при вызове из одной функции, использующей SPI,
другой такой функции.
• Предотвращение использования потенциально невыравненных буферов страниц (Том Лейн)
Добавлены новые типы-объединения PGAlignedBlock и PGAlignedXLogBlock, которые должны
использоваться вместо простых массивов char, чтобы компилятор гарантированно выравни-
вал адрес начала буфера. В результате устраняется риск аварийного сбоя на платформах, чув-
ствительных к выравниванию, и может увеличиться быстродействие даже на тех платформах,
где выравнивание не требуется.
• Приведение в src/port/snprintf.c значения результата snprintf() в соответствие со стан-
дартом C99 (Том Лейн)
На платформах, где этот код используется (в основном в Windows), его несовременное поведе-
ние (не соответствующие C99) могло препятствовать выявлению переполнения буфера, если
вызывающий код рассчитывал на семантику C99.
• Требование обязательного использования -msse2 при сборке компилятором clang для i386
(Андрес Фройнд)
Тем самым решается проблема отсутствия проверок переполнения при операциях с плаваю-
щей точкой.
• Исправление в configure проверки, определяющей, результат какого типа возвращает
strerror_r() (Том Лейн)
Предыдущая реализация давала неправильный ответ при сборке с использованием компиля-
тора icc в Linux (возможно, и в других случаях), в результате чего libpq не выдавала полезные
сообщения при возникновении системных ошибок.
• Обновление данных часовых поясов до версии tzdata 2018g, включающее изменений правил
перехода на летнее время в России (Волгограде), Чили, Марокко и на Фиджи, а также коррек-
тировку исторических данных для Китая, Гавайев, Японии, Макао и Северной Кореи.
E.11. Выпуск 9.6.10
Дата выпуска:
2018-08-09
В этот выпуск вошли различные исправления, внесённые после версии 9.6.9. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.11.1. Миграция на версию 9.6.10
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.6.9, см. Раздел E.12.
E.11.2. Изменения
• Осуществление полного сброса состояния libpq между попытками соединения (Том Лейн)
Непривилегированный пользователь dblink или postgres_fdw мог обойти проверки, пред-
назначенные для предотвращения использования учётных данных на стороне сервера, на-
пример, файла ~/.pgpass, принадлежащего пользователю ОС, от имени которого работа-
ет сервер. В частности, уязвимость затрагивает серверы, принимающие локальные подклю-
чения с методом peer. Возможны были и другие атаки, например, SQL-инъекции в сеансе
postgres_fdw. Для атаки на postgres_fdw через эту уязвимость пользователь должен был
иметь возможность создавать объект стороннего сервера с нужными параметрами подключе-
ния, но атаку на dblink мог произвести любой пользователь, имеющий к нему доступ. Вообще
любой пользователь, имеющий возможность менять параметры подключения для приложения
на базе libpq, мог производить непредусмотренные действия, но другие эффективные сцена-
2351Замечания к выпуску
рии эксплуатации этого сложно придумать. Мы благодарим Андрея Красичкова за сообщение
о данном дефекте. (CVE-2018-10915)
• Исправление поведения INSERT … ON CONFLICT UPDATE с более сложным представлением,
чем просто SELECT * FROM … (Дин Рашид, Амит Ланготе)
Ошибочное развёртывание изменяемого представления могло приводить к сбоям или ошиб-
кам «attribute … has the wrong type» (атрибут … имеет неверный тип), если список SELECT
представления не соответствовал в точности списку столбцов нижележащей таблицы. Более
того, развив атаку через эту уязвимость, злоумышленник мог изменять столбцы, не имея для
них права UPDATE, но имея права INSERT и UPDATE для некоторых других столбцов в таблице.
Любой пользователь также мог эксплуатировать её для раскрытия содержимого памяти сер-
вера. (CVE-2018-10925)
• Обеспечение своевременного изменения полей relfrozenxid и relminmxid в «зафиксирован-
ных» системных каталогах (Андрес Фройнд)
Из-за чрезмерно оптимистичного кеширования эти изменения могли оказаться невидимыми
для других сеансов, что приводило к случайным ошибкам и/или разрушению данных. Для об-
щих каталогов, таких как pg_authid, проблема была ещё острее, так как устаревшие кеширо-
ванные данные могли попадать в новые сеансы и оставаться в существующих.
• Исправление поведения в ситуации, когда недавно повышенный сервер аварийно завершает-
ся до окончания обработки первой контрольной точки после восстановления (Микаэль Пакье,
Кётаро Хоригути, Паван Деоласи, Альваро Эррера)
В такой ситуации сервер не считал, что при последующем воспроизведении WAL было достиг-
нуто согласованное состояние базы данных, и это препятствовало его перезапуску.
• Исключение выдачи фантомной записи WAL при переработке полностью нулевой страницы
индекса btree (Амит Капила)
Эта ошибка проявлялась в сбоях проверочных утверждений и могла приводить к неоправдан-
ным отменам запросов на серверах горячего резерва.
• При воспроизведении WAL добавлена защита от некорректной длины записи, превышающей 1
ГБ (Микаэль Пакье)
Подобные данные должны считаться некорректными. Ранее код пытался выделить такой объ-
ём и получал критическую ошибку, что делало восстановление невозможным.
• При завершении восстановления запись в файл истории линии времени должна откладывать-
ся, насколько это возможно (Хейкки Линнакангас)
Это позволяет избежать ситуаций с несогласованностью состояния линии времени на диске,
возникавших при сбое в процессе очистки после восстановления (например, при проблеме с
файлом двухфазного состояния).
• Увеличение скорости воспроизведения WAL для транзакций, удаляющих множество отноше-
ний (Фудзии Масао)
В результате этого изменения уменьшается число сканирований общих буферов, поэтому эф-
фект от данного изменения тем больше, чем больше значение shared_buffers.
• Увеличение скорости освобождения блокировки при воспроизведении WAL ведомым сервером
(Томас Мунро)
• Обеспечение согласованной передачи состояния логической трансляции передатчиками WAL
(Саймон Риггс, Савада Масахико)
Ранее код не мог правильно определить, удалось ли нагнать вышестоящий сервер.
• Устранение дефектов в процедуре обработки снимков при логическом декодировании, приво-
дивших к ошибкам декодирования в редких случаях (Арсений Шер, Альваро Эррера)
2352Замечания к выпуску
• Обеспечение корректного сброса кешированного списка индексов таблицы после сбоя при со-
здании индекса (Питер Геохеган)
Ранее в этом списке могли оставаться OID нерабочих индексов, что могло приводить к про-
блемам в том же сеансе.
• Исправление некорректной обработки пустых несжатых страниц списка идентификаторов в
индексах GIN (Шивасубраманьян Рамасубраманьян, Александр Коротков)
Это могло привести к сбою проверочного утверждения после выполнения pg_upgrade для ин-
дексов GIN версии до 9.4 (в 9.4 и последующих версиях такие страницы не создаются).
• Обеспечение реакции на сигналы в процессе VACUUM в цикле удаления страниц B-дерева (Ан-
дрес Фройнд)
С испорченными индексами btree цикл мог оказаться бесконечным, и прервать его можно бы-
ло только аварийно отключив сервер.
• Исправление некорректной оптимизации классов эквивалентности со столбцами составного
типа (Том Лейн)
Вследствие данной ошибки сервер не понимал, что индекс по составному столбцу может обес-
печить порядок сортировки, необходимый для соединения слиянием с данным столбцом.
• Исправление планировщика с целью устранения ошибок «ORDER/GROUP BY expression not
found in targetlist» (выражение ORDER/GROUP BY не найдено в целевом списке) при выполне-
нии некоторых запросов с функциями, возвращающими множества (Том Лейн)
• Исправление синтаксиса конструкции SQL-стандарта FETCH FIRST, чтобы она принимала ($n),
как того требует стандарт (Эндрю Гирт)
• Исправление в EXPLAIN учёта использования ресурсов, в частности, обращений к буферам
(Амит Капила, Томас Мунро)
• Корректное добавление схемы к именам ряда объектов в выводе getObjectDescription (Кёта-
ро Хоригути, Том Лейн)
Имена правил сортировки, преобразований и объектов текстового поиска не дополнялись схе-
мой, тогда как должны были.
• Исправление проверки типа CREATE AGGREGATE с тем, чтобы к агрегатам с переменными аргу-
ментами можно было присоединять функции поддержки распараллеливания (Алексей Башта-
нов)
• Расширение счётчика строк в команде COPY FROM с 32 до 64 бит (Дэвид Роули)
Тем самым были решены две проблемы с входными данными, содержащими более 4G строк:
COPY FROM WITH HEADER терял одну строку на каждые 4G строк (не только первую), а в сообще-
ниях об ошибках выводилось неверное количество строк.
• Добавление в библиотеку ecpg pgtypes функции освобождения строк для исключения про-
блем с управлением памятью в разных модулях (Такаюки Цунакава)
В Windows могут происходить сбои, если вызов free для некоторого блока памяти произво-
дится не из той DLL, которая выделила память (с помощью malloc). Библиотека pgtypes ино-
гда возвращает строки, которые должен освободить вызывающий код, и сделать это корректно
оказывается невозможно. Добавленная функция PGTYPESchar_free() является просто обёрт-
кой free, позволяющей приложениям произвести освобождение по правилам.
• Исправление поддержки в ecpg переменных long long в Windows, а также на других платфор-
мах, где strtoll/strtoull объявлены нестандартно или не объявлены вовсе (Хыонг Дангминь,
Том Лейн)
• Исправление ошибки с определением типа SQL-оператора в PL/pgSQL, когда изменение пра-
вила приводило к изменению семантики оператора в рамках сеанса (Том Лейн)
2353Замечания к выпуску
Эта ошибка приводила к сбоям проверочных утверждений или, в редких случаях, к тому, что
указание INTO STRICT не работало должным образом.
• Исправление запроса пароля в клиентских программах, чтобы отображение корректно отклю-
чалось в Windows, когда stdin — не терминал (Мэтью Стикни)
• Доработка исправления некорректного заключения в кавычки значений для переменных GUC
со списками при формировании дампа (Том Лейн)
Предыдущее исправление для заключения в кавычки значения search_path и других пере-
менных со списками в выводе pg_dump, как оказалось, привело к ошибкам со списками с пу-
стыми элементами и риску потери части длинных файловых путей.
• В pg_dump устранено упущение, когда свойства REPLICA IDENTITY для индексов ограничений
не выгружались (Том Лейн)
Уникальные индексы, созданные вручную, помечались корректно, а индексы, созданные огра-
ничениями UNIQUE или PRIMARY KEY — нет.
• В pg_upgrade теперь правильно проверяется, что старый сервер был выключен штатно (Брюс
Момджян)
Ранее проверка могла сработать некорректно при выключении сервера в незамедлительном
режиме.
• Исправление в contrib/hstore_plperl просмотра скалярных ссылок Perl и предотвращение
сбоя в случае, если не удаётся найти хеш-ссылку там, где она ожидается (Том Лейн)
• Устранение сбоя в функции модуля contrib/ltree при получении на вход пустого массива
(Пьер Дюкроке)
• Исправление обработки ошибок в ряде мест, где мог выдаваться некорректный код ошибки
(Микаэль Пакье, Том Лейн, Магнус Хагандер)
• Переоформление скриптов Makefile для обеспечения компоновки программ с собранными в
том же дереве библиотеками (например, libpq.so), а не с теми, что могут уже находиться в
системных каталогах библиотек (Том Лейн)
Это позволяет избежать проблем при сборке на платформах, где представлены старые версии
библиотек PostgreSQL.
• Обновление данных часовых поясов до версии tzdata 2018e, включающее изменение правил
перехода на летнее время в Северной Корее, а также корректировку исторических данных
для Чехословакии.
В это обновление вошло переопределение «летнего времени», которое действует в Ирландии,
а также действовало в прошлом в Намибии и в Чехословакии. В этих юрисдикциях стандарт-
ное время действует летом, а время для экономии света — зимой, поэтому при переходе на
это время сдвиг производится на час назад, а не на час вперёд. Это не влияет ни на фактиче-
ское смещение от UTC, ни на используемое сокращение часового пояса; эта особенность про-
является лишь в том, что в таких случаях столбец is_dst в представлении pg_timezone_names
будет содержать true для зимнего периода, и false для летнего.
E.12. Выпуск 9.6.9
Дата выпуска:
2018-05-10
В этот выпуск вошли различные исправления, внесённые после версии 9.6.8. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.12.1. Миграция на версию 9.6.9
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
2354Замечания к выпуску
Однако если вы используете расширение adminpack, его нужно обновить, следуя указаниям в пер-
вой записи в списке изменений.
Кроме того, если вас касаются ошибки с пометкой функций, описанные во второй и третьей записи
ниже, потребуются дополнительные действия для исправления каталогов баз данных.
Если вы обновляете сервер с более ранней версии, чем 9.6.8, см. также Раздел E.13.
E.12.2. Изменения
• Лишение роли public права на выполнение функции pg_logfile_rotate() из contrib/
adminpack (Стивен Фрост)
Функция pg_logfile_rotate() является устаревшей оболочкой функции ядра
pg_rotate_logfile(). Когда в последней была удалена жёсткая проверка суперпользователя,
чтобы доступ к этой функции ограничивался правами SQL, эти изменения следовало отразить
и в pg_logfile_rotate(), но это было упущено. Таким образом, с установленным расширени-
ем adminpack любой пользователь мог запросить прокрутку файла журнала, что можно счи-
тать некритичным нарушением безопасности.
После установки этого обновления администраторы должны обновить adminpack, выпол-
нив ALTER EXTENSION adminpack UPDATE в каждой базе данных, где установлен adminpack.
(CVE-2018-1115)
• Исправление некорректных пометок изменчивости для нескольких встроенных функций (То-
мас Мунро, Том Лейн)
Функции query_to_xml, cursor_to_xml, cursor_to_xmlschema, query_to_xmlschema и
query_to_xml_and_xmlschema должны были считаться изменчивыми, так как они выполняют
пользовательские запросы, в которых могут быть изменчивые операции. Однако они не бы-
ли помечены должным образом, что было чревато неправильной оптимизацией запросов. Это
было исправлено для новых инсталляций в результате корректировки исходных данных ката-
лога, но в существующих инсталляциях ошибочные пометки сохранятся. При практическом
использовании этих функций риск кажется небольшим, но в случае необходимости их мож-
но исправить, вручную изменив записи этих функций в pg_proc. Например: ALTER FUNCTION
pg_catalog.query_to_xml(text, boolean, boolean, text) VOLATILE. (Заметьте, что это нуж-
но будет проделать в каждой базе данных инсталляции.) Также вы можете обновить базу до
версии с корректными исходными данными, воспользовавшись pg_upgrade.
• Исправление некорректных пометок параллельно-безопасности для нескольких встроенных
функций (Thomas Munro, Tom Lane)
Функции brin_summarize_new_values, gin_clean_pending_list, cursor_to_xml,
cursor_to_xmlschema, ts_rewrite, ts_stat и binary_upgrade_create_empty_extension долж-
ны были считаться параллельно-небезопасными, так как одни из них непосредственно моди-
фицируют базу данных, а другие выполняют пользовательские запросы, которые могут это де-
лать. Они были некорректно помечены как параллельно-безопасные, что могло приводить к
неожиданным ошибкам запросов. Это было исправлено для новых инсталляций в результате
корректировки исходных данных каталога, но в существующих инсталляциях ошибочные по-
метки сохранятся. При практическом использовании этих функций риск кажется небольшим,
если только не включён режим force_parallel_mode, но в случае необходимости их мож-
но исправить, вручную изменив записи этих функций в pg_proc. Например: ALTER FUNCTION
pg_catalog.brin_summarize_new_values(regclass) PARALLEL UNSAFE. (Заметьте, что это нуж-
но будет проделать в каждой базе данных инсталляции.) Также вы можете обновить базу до
версии с корректными исходными данными, воспользовавшись pg_upgrade.
• Предотвращение повторного использования для TOAST идентификаторов OID, соответствую-
щих уже неактуальным, но ещё не очищенным записям TOAST (Паван Деоласи)
После зацикливания счётчика OID имеется возможность использования для значения TOAST
идентификатора OID, соответствующего ранее удалённой записи в той же таблице TOAST.
2355Замечания к выпуску
Если запись не была очищена к тому времени, это приводило к ошибкам «unexpected chunk
number 0 (expected 1) for toast value nnnnn» (неожиданный номер порции 0 (ожидался 1) для
значения TOAST nnnnn), которые сохранялись до удаления неактуальной записи командой
VACUUM. В качестве решения выбор таких OID при создании новых записей TOAST теперь ис-
ключается.
• Изменение алгоритма ANALYZE в части модификации pg_class.reltuples (Дэвид Гулд)
Ранее плотность кортежей могла обновляться только для страниц, прошедших обработку
ANALYZE, для остальных плотность считалась прежней. В большой таблице, где ANALYZE выби-
рает лишь небольшой процент страниц, это означает, что возможно лишь незначительное из-
менение общей оценки плотности кортежей, и поэтому reltuples будет меняться практиче-
ски пропорционально изменениям физического размера таблицы (relpages) вне зависимо-
сти от того, что фактически происходит в таблице. В результате может наблюдаться настоль-
ко большое увеличение reltuples по сравнению с реальностью, что автоматическая очистка
практически отключается. Для исправления этой ошибки принимается, что выборка ANALYZE
является статистически несмещённой (какой она и должна быть), и наблюдаемая в ней плот-
ность просто экстраполируется на всю таблицу.
• Предупреждение взаимоблокировок в параллельных командах CREATE INDEX CONCURRENTLY,
выполняемых на уровнях изоляции SERIALIZABLE и REPEATABLE READ (Том Лейн)
• Устранение возможности замедленного выполнения REFRESH MATERIALIZED VIEW
CONCURRENTLY (Томас Мунро)
• Устранение ошибки в UPDATE/DELETE … WHERE CURRENT OF в случае, когда задействованный
курсор использует план сканирования только индекса (Юго Нагата, Том Лейн)
• Исправление некорректного планирования, когда предложения соединения передавались в
параметризованные пути (Эндрю Гирт, Том Лейн)
Эта ошибка могла привести к неправильной классификации условия как «фильтра соедине-
ния» для внешнего соединения, тогда как оно должно быть простым «фильтром», и в итоге
мог получиться некорректный результат соединения.
• Устранение возможности некорректного построения плана сканирования только индекса в
случаях, когда один столбец таблицы фигурирует в нескольких индексах, но не во всех этих
индексах используются классы операторов, которые могут выдать значение столбца (Кётаро
Хоригути)
• Исправление некорректной оптимизации ограничений CHECK с гарантированными NULL-под-
выражениями в условиях верхнего уровня AND/OR (Том Лейн, Дин Рашид)
В результате, например, ограничение-исключение могло исключить из запроса дочернюю
таблицу, которая не должна быть исключена.
• Устранение сбоя исполнителя в результате двойного освобождения памяти с некоторыми ва-
риантами использования GROUPING SETS (Питер Геохеган)
• Предотвращение сбоя в случае, когда триггер события перезаписи таблицы добавляется од-
новременно с выполнением команды, которая может вызвать такой триггер (Альваро Эррера,
Эндрю Гирт, Том Лейн)
• Предотвращение ошибки при прерывании запроса или прекращении сеанса в момент фикси-
рования подготовленной транзакции (Стас Кельвич)
• Ликвидация утечки памяти на время выполнения запроса в последовательно выполняемых со-
единениях по хешу (Том Лейн)
• Устранение возможных утечек или двойного освобождения закреплений буферов карты види-
мости (Амит Капила)
• Устранение неоправданной пометки страниц как полностью видимых (Дэн Вуд, Паван Деола-
си, Альваро Эррера)
2356Замечания к выпуску
Это могло происходить при блокировании (но не удалении) некоторых кортежей. Хотя за-
просы будут продолжать выполняться корректно, процедура очистки обычно игнорирует та-
кие страницы, вследствие чего кортежи на них никогда не будут замораживаться. В послед-
них выпусках это в конце концов приведёт к появлению ошибок вида «found multixact nnnnn
from before relminmxid nnnnn» (найдена мультитранзакция nnnnn, предшествующая relminmxid
nnnnn).
• Исправление излишне строгой проверки в heap_prepare_freeze_tuple (Альваро Эррера)
Это могло приводить к необоснованной ошибке «cannot freeze committed xmax» (не удаётся за-
морозить зафиксированный xmax) в базах данных, обновлённых с помощью pg_upgrade с вер-
сии 9.2 или старее.
• Устранение потери указателя в случаях, когда написанный на С триггер, выполняемый до из-
менения строки, возвращает старый кортеж («old») (Рушаб Латиа)
• Понижение уровня блокировки при планировании работы автоочистки (Джефф Джейнс)
Предыдущее поведение создавало значительные препятствия для параллельного выполнения
рабочих процессов в базах, содержащих множество таблиц.
• Обеспечение копирования имени клиентского компьютера при копировании данных
pg_stat_activity в локальную память (Эдмунд Хорнер)
Ранее предположительно локальный экземпляр содержал указатель на разделяемую память,
вследствие чего содержимое поля с именем клиентского компьютера могло неожиданно из-
мениться при отключении какого-либо сеанса.
• Исправление некорректной обработки нескольких составных аффиксов в словарях ispell (Ар-
тур Закиров)
• Исправление поиска (то есть сканирования индекса с операторами неравенства), зависимого
от правила сортировки, в индексах SP-GiST, построенных по текстовым столбцам (Том Лейн)
Такой поиск мог возвращать неправильный набор строк для большинства правил сортировки,
отличных от C.
• Предотвращение утечки памяти на время выполнения запроса в классах операторов SP-GiST,
использующих переходящие значения (Антон Дигнос)
• Корректировка вычисления количества кортежей в индексе при изначальном построении ин-
декса SP-GiST (Томаш Вондра)
Ранее количество кортежей в индексе считалось равным количеству кортежей в нижележа-
щей таблице, что неверно в случае частичного индекса.
• Корректировка вычисления количества кортежей в индексе при очистке индекса GiST (Ан-
дрей Бородин)
Ранее оно считалось равным примерному количеству кортежей в куче, что провоцировало
неточность и определённо было ошибочным в случае частичного индекса.
• Исправление поведения в особом случае, когда ведомый реплицирующий сервер «застревал»
на записи продолжения WAL (Кётаро Хоригути)
• При логическом декодировании приняты меры во избежание двойной обработки данных WAL
при перезапуске передатчика WAL (Крейг Рингер)
• Поддержка использования scalarltsel и scalargtsel с расширенными типами данных (То-
маш Вондра)
• Уменьшение потребления памяти libpq в случаях, когда сервер выдаёт ошибку после получе-
ния большого объёма результата запроса (Том Лейн)
2357Замечания к выпуску
Полученный ранее результат должен быть отброшен до, а не после обработки ошибки. На
некоторых платформах, в частности в Linux это может влиять на то, сколько памяти будет за-
нимать приложение.
• Устранение сбоев в ecpg, вызванных двойным освобождением памяти (Патрик Крекер, Джи-
ван Ладхе)
• Исправление обработки переменных long long int в ecpg, собранном с использованием
MSVC (Михаэль Мескес, Эндрю Гирт)
• Исправление некорректного заключения в кавычки значений для переменных GUC со списка-
ми при формировании дампа (Микаэль Пакье, Том Лейн)
Переменные local_preload_libraries, session_preload_libraries,
shared_preload_libraries и temp_tablespaces не заключались в кавычки корректно в выводе
pg_dump. Это могло приводить к проблемам, если эти переменным присваивались значения в
конструкциях CREATE FUNCTION … SET или ALTER DATABASE/ROLE … SET.
• Предотвращение отказа pg_recvlogical при подключении к серверам PostgreSQL до 10 версии
(Микаэль Пакье)
В результате предыдущего исправления программа pg_recvlogical, не проверяя версию серве-
ра, выдавала команду, которая должна предназначаться только серверам версии 10 и новее.
• Исправление поведения pg_rewind, чтобы на целевом сервере удалялись файлы, которые мог-
ли быть удалены в процессе выполнения на исходном сервере (Такаюки Цунакава)
В противном случае на целевом сервере могла нарушаться согласованность данных, особенно
если это был файл сегмента WAL.
• Исправление в pg_rewind обработки таблиц в дополнительных табличных пространствах (Та-
каюки Цунакава)
• Исправление обработки целочисленного переполнения в циклах FOR на языке PL/pgSQL (Том
Лейн)
Исправление обработки целочисленного переполнения в циклах FOR на языке PL/pgSQL (Том
Лейн)
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.7 (Питер Эйзен-
траут)
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.7 (Питер Эйзен-
траут)
• Устранение ошибок при изначальном построении индексов contrib/bloom (Томаш Вондра,
Том Лейн)
Предотвращение возможного исчезновения последнего кортежа таблицы из индекса. Исправ-
ление подсчёта количества кортежей в частичных индексах.
• Переименование функций b64_encode и b64_decode во избежание конфликта со встроенными
функциями Solaris 11.4 (Райнер Орт)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией 2018e (Том
Лейн)
В этой версии усовершенствован компилятор данных часовых поясов zic для работы с отрица-
тельными смещениями при переходе на летнее время. Хотя проект PostgreSQL в настоящее
время не поставляет такие данные часовых поясов, zic может применяться с данными, полу-
ченными непосредственно от IANA, поэтому кажется разумным обновить zic сейчас.
• Обновление данных часовых поясов до версии tzdata 2018d, включающее изменения правил
перехода на летнее время в Палестине и Антарктиде (станция Кейси), плюс корректировку
2358Замечания к выпуску
исторических данных для Португалии и её колоний, а также Уругвая и островов Эндербери,
Ямайка, Теркс и Кайкос.
E.13. Выпуск 9.6.8
Дата выпуска:
2018-03-01
В этот выпуск вошли различные исправления, внесённые после версии 9.6.7. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.13.1. Миграция на версию 9.6.8
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если в вашей СУБД не все пользователи взаимно доверяют друг другу либо если вы под-
держиваете приложение или расширение, предназначенное для использования в произвольных
ситуациях, настоятельно рекомендуется прочитать об изменениях в первой записи ниже и пред-
принять соответствующие действия для защиты вашей инсталляции или кода.
Также изменения, описанные во втором пункте списка ниже, могут приводить к сбоям функций,
используемых в индексных выражениях или материализованных представлениях, во время авто-
матического анализа или при восстановлении выгруженных данных. Поэтому после обновления
проверьте журнал сервера на предмет подобных проблем и исправьте затронутые функции.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.7, см. Раздел E.14.
E.13.2. Изменения
• Добавление в документацию информации о настройке серверов и приложений для защиты от
атак с внедрением троянского кода через путь поиска (Ной Миш)
Когда используется значение search_path, включающее схемы, доступные для записи зло-
намеренному пользователю, он может перехватывать управление над выполнением запросов
и затем запускать произвольный SQL-код с правами атакуемого пользователя. Хотя есть воз-
можность составлять запросы, защищённые от подобного перехвата, это требует кропотли-
вой работы, и при этом очень легко что-то упустить. Поэтому мы рекомендуем использовать
конфигурации, в которых пути поиска не могут включать недоверенные схемы. Соответству-
ющая информация добавлена в Подраздел 5.8.6 (для пользователей и администраторов баз
данных), Раздел 34.1 (для разработчиков приложений), Подраздел 38.16.1 (для разработчиков
расширений) и CREATE FUNCTION (для разработчиков функций с характеристикой SECURITY
DEFINER). (CVE-2018-1058)
• Предотвращение использования небезопасных значений search_path в pg_dump и других кли-
ентских программах (Ной Миш, Том Лейн)
pg_dump, pg_upgrade, vacuumdb и другие приложения, предоставляемые PostgreSQL, были
уязвимы для перехвата выполнения, описанного в предыдущем пункте; так как эти прило-
жения обычно запускаются суперпользователями, они представляли собой привлекательные
средства для атаки. Чтобы защитить их вне зависимости от того, защищена ли вся инсталля-
ция в целом, они были изменены так, чтобы для них параметр search_path содержал только
pg_catalog. Теперь это так же касается и рабочих процессов автоочистки.
В случаях, когда этими программами неявно вызываются определённые пользователем функ-
ции — например, это могут быть пользовательские функции в выражениях индексов — бо-
лее строгое значение search_path может приводить к ошибкам, которые потребуется испра-
вить так, чтобы эти функции никак не зависели от пути поиска, с которым они выполняются.
Это всегда рекомендовалось делать, но сейчас это необходимо для корректного поведения.
(CVE-2018-1058)
• Исправление некорректного поведения перепроверок одновременных изменений со ссылками
CTE, фигурирующими во внутренних планах (Том Лейн)
2359Замечания к выпуску
Если ссылка на CTE (содержимое предложения WITH) использовалась в InitPlan или SubPlan, и
запросу требовалось провести перепроверку из-за попытки изменения или блокировки одно-
временно изменяемой строки, могли быть получены неверные результаты.
• Устранение сбоев планировщика при перекрывающихся предложениях соединения слиянием
во внешнем соединении (Том Лейн)
Эти дефекты приводили в особых случаях к ошибкам планировщика «left and right pathkeys
do not match in mergejoin» (нарушено соответствие левых и правых ключей пути в соединении
слиянием) или «outer pathkeys do not match mergeclauses» (внешние ключи пути не соответ-
ствуют предложениям слияния).
• Исправление ошибки в pg_upgrade, когда не удавалось сохранить relfrozenxid для материа-
лизованных представлений (Том Лейн, Андрес Фройнд)
Данное упущение могло приводить к разрушению данных в материализованных пред-
ставлениях после обновления. Это могло проявляться в ошибках «could not access status
of transaction» (не удалось получить состояние транзакции) или «found xmin from before
relfrozenxid» (найден xmin перед relfrozenxid). Эта проблема была более вероятна в редко об-
новляемых материализованных представлениях или в представлениях, обновляемых только
командой REFRESH MATERIALIZED VIEW CONCURRENTLY.
Если такое разрушение имело место, его можно исправить, обновив материализованное пред-
ставление (без указания CONCURRENTLY).
• Исправление некорректной обработки имён функций PL/Python в стеках ошибки CONTEXT (Том
Лейн)
Ошибка, произошедшая во вложенном вызове функции PL/Python (то есть функции, вызван-
ной через SPI-запрос из другой функции PL/Python), могла привести к тому, что в трассировке
стека вместо ожидаемого результата имя внутренней функции фигурировало дважды. Также
ошибка во вложенном блоке PL/Python DO могла привести к обращению по нулевому указате-
лю на некоторых платформах.
• Максимальное значение log_min_duration для contrib/auto_explain доведено до INT_MAX,
что составляет около 24 суток вместо 35 минут (Том Лейн)
• Для разнообразных переменных GUC добавлена пометка PGDLLIMPORT в целях облегчения пе-
реноса модулей расширений в Windows (Метин Дослу)
E.14. Выпуск 9.6.7
Дата выпуска:
2018-02-08
В этот выпуск вошли различные исправления, внесённые после версии 9.6.6. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.14.1. Миграция на версию 9.6.7
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы используете оператор ~&gt; расширения contrib/cube, прочитайте ниже запись о
нём.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.6, см. Раздел E.15.
E.14.2. Изменения
• Временные файлы, создаваемые программой pg_upgrade, должны быть недоступны для чте-
ния всеми пользователями (Том Лейн, Ной Миш)
Программа pg_upgrade обычно ограничивает доступ к своим временным файлам, чтобы их
мог читать и записывать только запускающий её пользователь. Но временные файлы, содер-
2360Замечания к выпуску
жащие вывод pg_dumpall -g могли быть доступны для чтения группе или всем пользовате-
лям, а возможно и для записи, если это допускало значение umask этого пользователя. При
типичном использовании в многопользовательских системах umask и/или разрешения в рабо-
чем каталоге достаточно жёсткие и эта проблема неактуальна; но pg_upgrade может исполь-
зоваться и в сценариях, где это упущение могло привести, например, к утечке паролей баз
данных. (CVE-2018-1053)
• Исправление очистки кортежей, которые были изменены при установленной блокировке раз-
деляемого ключа (Андрес Фройнд, Альваро Эррера)
В некоторых случаях операция VACUUM не удаляла такие кортежи, даже когда они теряли акту-
альность, что приводило к различным сценариям повреждения данных.
• Осуществление очистки очереди добавлений индекса GIN при выполнении VACUUM (Масахи-
ко Савада)
Это необходимо для гарантированного удаления неактуальных записей индекса. Прежний код
делал это в другом порядке, позволяя операции VACUUM пропускать очистку, если какие-то
другие процессы производили очистку параллельно. Однако при этом в индексе могли оста-
ваться некорректные записи.
• Исправление неправильной блокировки буфера при некоторых чтениях LSN (Якоб Чемпион,
Асим Правин, Ашвин Агравал)
Эти ошибки могли приводит к некорректному поведению при многопоточной нагрузке. По-
тенциальные последствия не были характеризованы полностью.
• Исправление некорректных результатов запросов в случаях, когда происходило упрощение
подзапросов, результаты которых использовались в GROUPING SETS (Хейкки Линнакангас)
• Исключение неоправданной ошибки в запросе с деревом наследования, который выполнял-
ся одновременно с тем, как некоторая дочерняя таблица удалялась из этого дерева командой
ALTER TABLE NO INHERIT (Том Лейн)
• Устранение разнообразных ошибок взаимоблокировки при выполнении в нескольких сеансах
команды CREATE INDEX CONCURRENTLY (Джефф Джейнс)
• Устранение ошибок в ситуациях, когда дерево наследования содержит дочерние сторонние
таблицы (Эцуро Фудзита)
Комбинация обычных и сторонних таблиц в дереве наследования провоцировала построение
некорректных планов в запросах UPDATE и DELETE. Это приводило к видимым ошибкам в неко-
торых случаях, особенно когда в дочерней сторонней таблице присутствовали триггеры уров-
ня строк.
• Исправление дефекта со связанным подзапросом SELECT внутри VALUES в подзапросе LATERAL
(Том Лейн)
• Устранение ошибки планировщика «could not devise a query plan for the given query» (не уда-
лось выработать план для данного запроса) в некоторых случаях, включая вложенные UNION
ALL в подзапросе LATERAL (Том Лейн)
• Исправление логического декодирования, чтобы файлы на диске корректно очищались от
данных сбойных транзакций (Атсуши Торикоши)
Процедура логического декодирования может выносить записи WAL на диск, если транзакции
генерируют много записей WAL. Обычно эти файлы очищаются после фиксирования транзак-
ции или поступления записи о её прерывании; но в отсутствие таких записей код очистки ра-
ботал неправильно.
• Исправление тайм-аута в процессе walsender и реакции на прерывания при обработке боль-
шой транзакции (Петр Желинек)
• Добавление в has_sequence_privilege() поддержки проверок WITH GRANT OPTION, как это сде-
лано в других функциях проверки прав (Джо Конвей)
2361Замечания к выпуску
• В базах данных с кодировкой UTF8 любые XML-объявления, выбирающие другую кодировку,
должны игнорироваться (Павел Стехуле, Ной Миш)
Мы всегда храним документы XML в кодировке базы данных, так что позволяя libxml обраба-
тывать объявления с другой кодировкой, мы получим ошибочные результаты. Если кодировка
базы — не UTF8, мы в любом случае не обещали поддерживать XML-данные с не ASCII-коди-
ровкой, так что предыдущее поведение сохранено для совместимости ошибок. Это изменение
затрагивает только xpath() и связанные функции; другой код и ранее работал так.
• Обеспечение прямой совместимости с будущими изменениями младших версий протокола
(Роберт Хаас, Бадрул Чоудхури)
Ранее серверы PostgreSQL просто отклоняли запросы на использование версий протокола но-
вее 3.0, так что никакого функционального отличия старших номеров от младших не было. Те-
перь клиенты могут запрашивать версии 3.x и получать в ответ не отказ, а сообщение, говоря-
щее, что сервер поддерживает только версию 3.0. В данный момент от этого ничего не меня-
ется, но перенос этого изменения в предыдущие версии должен ускорить внедрение неболь-
ших усовершенствований протокола в будущем.
• Исправление реакции на сбой при запуске параллельного рабочего процесса (Амит Капила,
Роберт Хаас)
Ранее параллельный запрос мог зависнуть на неопределённое время, если не удавалось запу-
стить рабочий процесс, вследствие ошибки в fork() или других редких проблем.
• Исправление сбора статистики EXPLAIN, получаемой от параллельных исполнителей (Амит Ка-
пила, Томас Мунро)
• Устранение небезопасного предположения о выравнивании при работе с типом __int128 (Том
Лейн)
Обычно компиляторы полагают, что переменные __int128 выравниваются по 16-байтовым
границам, но наша инфраструктура выделения памяти не готова гарантировать это, а увели-
чение MAXALIGN кажется неподходящим по множеству причин. В качестве решения код был
изменён так, чтобы тип __int128 можно было использовать только когда мы можем сказать
компилятору, что предполагается не такое крупное выравнивание. Единственный замечен-
ный симптом этой проблемы — сбои в некоторых параллельных запросах с агрегированием.
• Предотвращение сбоев с переполнением стека при планировании операций со множествами с
крайне большой вложенностью (UNION/INTERSECT/EXCEPT) (Том Лейн)
• Ликвидация обращений по нулевому указателю для некоторых типов адресов LDAP, задавае-
мых в файле pg_hba.conf (Томас Мунро)
• Исправление демонстрационных функций INSTR() в документации по PL/pgSQL (Юго Нагата,
Том Лейн)
В документации утверждалось, что эти функции совместимы с Oracle®, но это было не совсем
так. В частности, по-разному интерпретировалось отрицательное значение третьего парамет-
ра: Oracle воспринимает это значение как последнюю позицию, с которой может начинаться
целевая подстрока, а наши функции считали, что это последняя позиция, где строка может
заканчиваться. Также Oracle выдаёт ошибку в случае нулевого или отрицательного четвёрто-
го параметра, тогда как наши функции возвращали ноль.
Код этого примера был изменён для большего соответствия поведению Oracle. Пользовате-
лям, которые скопировали этот код в свои приложения, возможно, имеет смысл обновить свои
копии.
• Исправление поведения pg_dump, чтобы ACL (разрешения), комментарии и метки безопасно-
сти можно было надёжно идентифицировать в архивных выходных форматах (Том Лейн)
Компонент «метка» записи ACL в архиве обычно представлял собой просто имя целевого объ-
екта. В его начало теперь добавляется тип объекта, чтобы записи ACL соответствовали согла-
2362Замечания к выпуску
шениям, уже принятым для записей комментариев и меток безопасности. Кроме того, обо-
значения комментариев и меток безопасности, заданных для собственно базы данных, теперь
должны начинаться с DATABASE, чтобы они соответствовали тому же соглашению. Это преду-
преждает ложные срабатывания в коде, который пытается найти записи больших объектов по
строкам, начинающимся со слов LARGE OBJECT. Прежнее поведение могло приводить к непра-
вильной классификации записей как данные и нежелательным результатам при восстановле-
нии выгруженной только схемы или только данных.
Заметьте, что следствием этого стало изменение видимого пользователями вывода pg_restore
–list.
• Переименование функции copy_file_range в pg_rewind во избежание конфликта с новым си-
стемным вызовом Linux с таким же именем (Андрес Фройнд)
Это изменение предотвращает ошибки при сборке с новыми версиями glibc.
• В ecpg добавлено выявление массивов индикаторов с неправильной длиной и сообщение об
ошибке (Дэвид Рейдер)
• Изменение поведения оператора cube ~&gt; int в расширении contrib/cube для обеспечения его
совместимости с поиском kNN (Александр Коротков)
Смысл второго аргумента (выбирающего размерность) был изменён, чтобы можно было опре-
делённо сказать, какое именно значение выбирается в кубах переменных размерностей.
Это изменение нарушает совместимость, но так как этот оператор предназначался для по-
исков kNN, в прежнем виде он был бесполезен. После установки этого обновления все мате-
риализованные представления или индексы с выражениями, использующими этот оператор,
необходимо обновить/перестроить.
• Предотвращение срабатывания проверки истинности внутри libc в расширении contrib/
hstore из-за использования memcpy() с равными указателями источника и получателя (Томаш
Вондра)
• Исправление некорректного отображения битовых карт NULL для кортежей в contrib/
pageinspect (Максим Милютин)
• В расширении contrib/postgres_fdw ликвидирована ошибка планировщика «outer pathkeys
do not match mergeclauses» (внешние ключи пути не соответствуют предложениям слияния)
при построении плана, включающего удалённое соединение (Роберт Хаас)
• Добавление современных примеров настройки автозапуска Postgres в macOS (Том Лейн)
Скрипты в contrib/start-scripts/osx используют инфраструктуру, которая устарела десять
лет назад, и абсолютно неработоспособны во всех версиях macOS, выпущенных в последние
два года. Добавлен новый подкаталог contrib/start-scripts/macos со скриптами, использую-
щими новую инфраструктуру launchd.
• Исправление некорректного выбора зависящих от конфигурации библиотек OpenSSL в
Windows (Эндрю Дунстан)
• Поддержка компоновки с версиями libperl, собранными компилятором MinGW (Ной Миш)
Это позволяет собирать PL/Perl с некоторыми распространёнными дистрибутивами Perl для
Windows.
• Исправление в сборке MSVC проверки, требуется ли 32-битной libperl определение -
D_USE_32BIT_TIME_T (Ной Миш)
Имеющиеся дистрибутивы Perl ожидают разного, и при этом нет никакой возможности на-
дёжно проверить это, поэтому пришлось добавить проверку фактического поведения исполь-
зуемой библиотеки во время компиляции.
• В Windows обработчик аварийного завершения должен устанавливаться на более раннем эта-
пе запуска главного процесса (Такаюки Цунакава)
2363Замечания к выпуску
Это поможет получить дамп памяти при ошибках в те моменты в начале запуска, в которые
раньше дамп не записывался.
• В Windows устранены сбои, связанные с преобразованием кодировок при выводе сообщений
на самых ранних стадиях запуска процесса postmaster (Такаюки Цунакава)
• Использование нашего ранее написанного кода циклических блокировок для Motorola 68K во
OpenBSD, а также в NetBSD (Давид Карлье)
• Добавление поддержки циклических блокировок для Motorola 88K (Давид Карлье)
• Обновление данных часовых поясов до версии tzdata 2018c, включающее изменения правил
перехода на летнее время в Бразилии, в Сан-Томе и Принсипи, а также корректировки ис-
торических данных для Боливии, Японии и Южного Судана. Был удалён часовой пояс US/
Pacific-New (это был просто псевдоним для пояса America/Los_Angeles).
E.15. Выпуск 9.6.6
Дата выпуска:
2017-11-09
В этот выпуск вошли различные исправления, внесённые после версии 9.6.5. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.15.1. Миграция на версию 9.6.6
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы используете индексы BRIN, прочитайте четвёртую запись в списке изменений.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.4, см. Раздел E.17.
E.15.2. Изменения
• Обеспечение проверки разрешений на уровне таблиц и политик RLS при выполнении
INSERT … ON CONFLICT DO UPDATE во всех случаях (Дин Рашид)
Путь изменения данных в команде INSERT … ON CONFLICT DO UPDATE требовал наличия раз-
решения SELECT для всех столбцов в решающем индексе, но в случае указания решающего
ограничения по имени должная проверка отсутствовала. Кроме того, для таблиц с включён-
ной защитой на уровне строк не проверялось, соответствуют ли изменённые строки полити-
кам SELECT (вне зависимости от способа задания решающего индекса). (CVE-2017-15099)
• Устранение сбоя при несовпадении типа записи в json{b}_populate_recordset() (Микаэль
Пакье, Том Лейн)
Эти функции использовали тип результата, заданный в предложении FROM … AS, не прове-
ряя, соответствует ли он фактическому типу поступившего кортежа. В случае несоответствия
обычно происходил сбой, хотя также вероятным было раскрытие содержимого памяти серве-
ра. (CVE-2017-15098)
• Исправление скриптов запуска сервера — переключение на $PGUSER до открытия файла
$PGLOG (Ной Миш)
Ранее файл журнала postmaster открывался ещё под именем root. Таким образом, владелец
базы данных мог произвести атаку на другого пользователя системы, сделав $PGLOG символи-
ческой ссылкой на некоторый другой файл, который в результате можно было испортить до-
бавленными в него сообщениями журнала.
По умолчанию эти скрипты никуда не устанавливаются. Если вы использовали их, замените
свои экземпляры новыми копиями либо внесите те же коррективы в свои вручную изменён-
ные скрипты. Если владельцем существующего файла $PGLOG является root, его нужно уда-
лить или переименовать прежде чем перезапускать сервер с помощью исправленного скрип-
та. (CVE-2017-12172)
2364Замечания к выпуску
• Исправление вычисления сводных данных индекса BRIN для корректной работы при одновре-
менном расширении таблицы (Альваро Эррера)
Ранее в условиях гонки некоторые строки таблицы могли пропадать из индекса. Для устране-
ния последствий предыдущих проявлений этой проблемы может потребоваться перестроить
существующие индексы BRIN.
• Предупреждение возможных сбоев при параллельных изменениях индекса BRIN (Том Лейн)
В определённых условиях гонки могли возникать ошибки «invalid index offnum» (неверный но-
мер смещения в индексе) или «inconsistent range map» (несогласованность в карте диапазо-
нов).
• Устранение сбоя при вызове логического декодирования из функции, использующей SPI, в
частности, из любой функции на одном из языков PL (Том Лейн)
• Исправление некорректных результатов запросов, содержащих в нескольких столбцах
GROUPING SETS одну и ту же простую переменную (Том Лейн)
• Корректировка неправильных решений по распараллеливанию для вложенных запросов (Амит
Капила, Кунтал Гхош)
• Устранение сбоев в обработке параллельных запросов, возможных при удалении недавно ис-
пользованной роли (Амит Капила)
• Исправление в функциях json_build_array(), json_build_object() и их аналогах для jsonb
обработки явно заданных аргументов VARIADIC (Микаэль Пакье)
• Корректное недопущение попыток приведения бесконечных значений с плавающей точкой к
типу numeric (Том Лейн, КайГай Кохэй)
Ранее поведение зависело от платформы.
• Устранение сбоев в особых случаях при добавлении столбцов в конец представления (Том
Лейн)
• Фиксирование правильных зависимостей когда представление или правило содержит узлы вы-
ражения FieldSelect или FieldStore (Том Лейн)
В отсутствие этих зависимостей команда DROP со столбцом или типом данных может выпол-
ниться, когда не должна, что вызовет ошибки при последующем использовании представле-
ния или правила. Данное исправление не защищает существующие представления/правила, а
повлияет только на создаваемые в будущем.
• Правильное определение хешируемости диапазонных типов данных (Том Лейн)
Планировщик ошибочно полагал, что любой диапазонный тип может хешироваться для ис-
пользования в соединениях или агрегировании по хешу, но на самом деле он должен прове-
рять, поддерживает ли хеширование подтип диапазона. Это не касается встроенных диапазон-
ных типов, так как все они всё равно хешируемые.
• Игнорирование узлов выражений RelabelType при определении уникальности содержимого
отношения (Дэвид Роули)
Это позволяет применить оптимизацию, когда результирующий столбец имеет тип varchar.
• Предотвращение разделения информации переходного состояния между сортирующими агре-
гатными функциями (Дэвид Роули)
Вследствие этого разделения возникали сбои во встроенных сортирующих агрегатах и могли
также возникать в подобных пользовательских функциях. Начиная с версии 11, предусмотре-
ны средства для надёжной защиты от таких случаев, а в ветвях стабильных выпусков просто
отключена оптимизация.
• Недопущение игнорирования значения idle_in_transaction_session_timeout, если до этого
произошёл таймаут оператора (statement_timeout) (Лукас Фиттл)
2365Замечания к выпуску
• Устранение маловероятной потери сообщений NOTIFY вследствие зацикливания идентифика-
торов транзакций (Марко Тииккая, Том Лейн)
Если в сеансе не выполнялись никакие запросы, то есть он просто ждал уведомлений и за это
время прошло более 2 миллиардов транзакций, он начинал пропускать уведомления от парал-
лельно фиксируемых транзакций.
• Предупреждение сбоя SIGBUS в Linux, когда в памяти DSM запрашивается область объёма,
превышающего свободный объём в tmpfs (Томас Мунро)
• Уменьшение частоты запросов на сброс данных в процессе копирования файлов во избежание
проблем с производительностью в macOS, в частности с новой файловой системой APFS (Том
Лейн)
• Предотвращение маловероятного сбоя при рекурсивном срабатывании триггеров (Том Лейн)
• Реализована возможность использовать режим FREEZE команды COPY на уровне изоляции
транзакций REPEATABLE READ или выше (Ной Миш)
Этот сценарий использования был непреднамеренно потерян вследствие предыдущего ис-
правления ошибки.
• Корректное восстановление значения umask при ошибке создания файла в COPY или
lo_export() (Питер Эйзентраут)
• Улучшение сообщения об ошибке в случае дублирующихся имён столбцов в ANALYZE (Натан
Боссарт)
• Добавление пропущенных случаев в GetCommandLogLevel() для устранения ошибок при ис-
пользовании определённых SQL-команд, когда log_statement имеет значение ddl (Микаэль
Пакье)
• Исправление разбора последней строки в файле pg_hba.conf, завершающемся не символом
перевода строки (Том Лейн)
• Исправление функции AggGetAggref(), чтобы возвращались корректные узлы Aggref для
функций завершения агрегатов с объединёнными промежуточными вычислениями (Том Лейн)
• Исправление pg_dump, чтобы команды GRANT выдавались в корректном порядке (Стивен
Фрост)
• Исправление в pg_basebackup сравнения путей табличных пространств посредством приведе-
ния путей к канонической форме (Микаэль Пакье)
Это особенно полезно в Windows.
• Исправление libpq, чтобы для её работы не требовалось существование домашнего каталога
пользователя (Том Лейн)
В версии 10 невозможность найти домашний каталог при попытке прочитать ~/.pgpass счита-
лась критической ошибкой, но эта ситуация должна обрабатываться так же, как и отсутствие
данного файла. И в версии 10, и в ветвях предыдущих выпусков была допущена та же ошибка
при чтении ~/.pg_service.conf, хотя это было менее очевидно, так как данный файл исполь-
зовался только при указании имени службы.
• Исправление в libpq защиты от целочисленного переполнения в счётчике строк в PGresult
(Микаэль Пакье)
• Исправление в ecpg обработки объявлений курсора вне текущей области с переменными типа
указатель или массив (Михаэль Мескес)
• В ecpglib исправлена обработка обратной косой черты в строковых константах в зависимости
от значения standard_conforming_strings (Такаюки Цунакава)
• Игнорирование в ecpglib дробной части при вводе целочисленных значений в режиме совме-
стимости с Informix (Гао Цзэнци, Михаэль Мескес)
2366Замечания к выпуску
• Исправление регрессионных тестов ecpg для более стабильного выполнения в Windows (Кри-
стиан Ульрих, Михаэль Мескес)
• Добавление отсутствующего предварительного требования temp-install для целей типа check в
Make (Ной Миш)
Некоторые невыполняемые по умолчанию тестовые процедуры, подобные make check, не про-
веряли актуальность временной инсталляции.
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2017c
(Том Лейн)
Тем самым исправлены различные дефекты; единственное, что могут заметить пользователи
— правила перевода на летнее время для часового пояса с именем в стиле POSIX в отсутствие
файла posixrules в каталоге данных часового пояса теперь соответствуют текущему закону
США, а не действовавшему десять лет назад.
• Обновление данных часовых поясов до версии tzdata 2017c, включающее изменения правил
перехода на летнее время на Фиджи, в Намибии, Серверном Кипре, Судане, Тонга и на ост-
ровах Теркс и Кайкос, плюс корректировку исторических данных для Аляски, Апии, Бирмы,
Калькутты, Детройта, Ирландии, Намибии и Паго-Паго.
E.16. Выпуск 9.6.5
Дата выпуска:
2017-08-31
В этот выпуск вошло несколько исправлений, внесённых после версии 9.6.4. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.16.1. Миграция на версию 9.6.5
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.4, см. Раздел E.17.
E.16.2. Изменения
• Отображение сторонних таблиц в представлении information_schema.table_privileges (Пи-
тер Эйзентраут)
Раньше сторонние таблицы отображались в остальных связанных представлениях
information_schema, но отсутствовали в этом.
Так как определение этого представления устанавливается программой initdb, для решения
проблемы будет недостаточно обычного обновления. Если вы хотите исправить существую-
щую инсталляцию, вы можете от имени суперпользователя выполнить в psql:
SET search_path TO information_schema;
CREATE OR REPLACE VIEW table_privileges AS
SELECT CAST(u_grantor.rolname AS sql_identifier) AS grantor,
CAST(grantee.rolname AS sql_identifier) AS grantee,
CAST(current_database() AS sql_identifier) AS table_catalog,
CAST(nc.nspname AS sql_identifier) AS table_schema,
CAST(c.relname AS sql_identifier) AS table_name,
CAST(c.prtype AS character_data) AS privilege_type,
CAST(
CASE WHEN
– object owner always has grant options
pg_has_role(grantee.oid, c.relowner, ‘USAGE’)
OR c.grantable
THEN ‘YES’ ELSE ‘NO’ END AS yes_or_no) AS is_grantable,
2367Замечания к выпуску
CAST(CASE WHEN c.prtype = ‘SELECT’ THEN ‘YES’ ELSE ‘NO’ END AS yes_or_no)
AS with_hierarchy
FROM (
SELECT oid, relname, relnamespace, relkind, relowner,
(aclexplode(coalesce(relacl, acldefault(‘r’, relowner)))).* FROM pg_class
) AS c (oid, relname, relnamespace, relkind, relowner, grantor, grantee,
prtype, grantable),
pg_namespace nc,
pg_authid u_grantor,
(
SELECT oid, rolname FROM pg_authid
UNION ALL
SELECT 0::oid, ‘PUBLIC’
) AS grantee (oid, rolname)
WHERE c.relnamespace = nc.oid
AND c.relkind IN (‘r’, ‘v’, ‘f’)
AND c.grantee = grantee.oid
AND c.grantor = u_grantor.oid
AND c.prtype IN (‘INSERT’, ‘SELECT’, ‘UPDATE’, ‘DELETE’, ‘TRUNCATE’,
‘REFERENCES’, ‘TRIGGER’)
AND (pg_has_role(u_grantor.oid, ‘USAGE’)
OR pg_has_role(grantee.oid, ‘USAGE’)
OR grantee.rolname = ‘PUBLIC’);
Это потребуется повторить для каждой базы данных, требующей исправления (включая
template0).
• Исправление обработки аварийного выхода (например, при получении SIGTERM) при попытке
выполнить ROLLBACK для прерванной транзакции (Том Лейн)
В таких ситуациях мог происходить сбой проверочного утверждения. В выпускаемых сборках
выход всё равно производился, но в журнал выводилось неуместное сообщение «cannot drop
active portal» (удалить активный портал нельзя).
• Удаление проверочного утверждения, которое могло нарушаться при аварийном выходе (Том
Лейн)
• Правильное обнаружение столбцов, имеющих тип диапазона или домена, который определён
поверх искомого составного или доменного типа (Том Лейн)
Определённые команды ALTER, меняющие определение составного или доменного типа, долж-
ны проверять, нет ли в базе данных значений этого типа, и прерываться, если они есть, так
как для изменения или обновления таких значений нет необходимой инфраструктуры. Ранее
эти проверки могли пропустить значения, обёрнутые в типы диапазонов или вложенные доме-
ны, что могло нарушить целостность в базе данных.
• Предотвращение сбоя при передаче по ссылке типов данных фиксированной длины парал-
лельным рабочим процессам (Том Лейн)
• Устранение сбоя в pg_restore при работе в параллельном режиме и использовании фай-
ла-списка объектов, подлежащих восстановлению (Фабрицио де Ройес Мелло)
• Исправление лексического анализатора ecpg, чтобы он принимал предложения RETURNING без
связанных переменных C (Михаэль Мескес)
Благодаря этому программы ecpg могут содержать SQL-конструкции, использующие
RETURNING внутри (например, внутри CTE), не определяя значения, которые будут возвращены
клиенту.
• Доработка лексического анализатора ecpg, чтобы он распознавал продолжения строк команд
C-препроцессора с обратной косой чертой (Михаэль Мескес)
2368Замечания к выпуску
• Улучшение выбора флагов компилятора для PL/Perl в Windows (Том Лейн)
В результате этого исправления предотвращаются сбои PL/Perl, возможные из-за некор-
ректных предположений о ширине значений time_t. Побочным эффектом, который мо-
гут заметить разработчики расширений, стала ликвидация глобального определения
_USE_32BIT_TIME_T в сборках PostgreSQL для Windows. Это не должно приводить к проблемам,
так как тип time_t не используется ни в каких определениях API PostgreSQL.
• Исправление поведения make check при использовании альтернативной (не GNU) программы
make (Томас Мунро)
E.17. Выпуск 9.6.4
Дата выпуска:
2017-08-10
В этот выпуск вошли различные исправления, внесённые после версии 9.6.3. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.17.1. Миграция на версию 9.6.4
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы используете сторонние серверы данных, на которых для проверки подлинности
применяются пароли, прочитайте ниже первую запись в списке изменений.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.3, см. Раздел E.18.
E.17.2. Изменения
• Дальнейшее ограничение видимости pg_user_mappings.umoptions для защиты паролей, сохра-
нённых в свойствах сопоставлений пользователей (Ной Миш)
Исправление дефекта CVE-2017-7486 оказалось некорректным: в результате пользова-
тель мог видеть свойства своего собственного сопоставления, даже когда он не имел пра-
ва USAGE для соответствующего стороннего сервера. В таких свойствах мог содержаться па-
роль, который должен задавать владелец сервера, а не сам пользователь. Так как представ-
ление information_schema.user_mapping_options не показывает свойства в таких случаях, и
pg_user_mappings не должно. (CVE-2017-7547)
Само по себе это исправление корректирует поведение только в новых базах данных, созда-
ваемых initdb. Если вы хотите применить это исправление к существующей базе данных, вам
нужно будет проделать следующие действия:</p>
<ol>
  <li>Добавьте allow_system_table_mods = true в postgresql.conf и перезапустите сервер. (В
версиях, поддерживающих ALTER SYSTEM, вы можете воспользоваться этой командой для
изменения конфигурации, но перезапустить сервер потребуется всё равно.)</li>
  <li>В каждой базе данных кластера выполните от имени суперпользователя следующие ко-
манды:
SET search_path = pg_catalog;
CREATE OR REPLACE VIEW pg_user_mappings AS
SELECT
U.oid
AS umid,
S.oid
AS srvid,
S.srvname
AS srvname,
U.umuser
AS umuser,
CASE WHEN U.umuser = 0 THEN
‘public’
ELSE
A.rolname
END AS usename,
2369Замечания к выпуску
CASE WHEN (U.umuser &lt;&gt; 0 AND A.rolname = current_user
AND (pg_has_role(S.srvowner, ‘USAGE’)
OR has_server_privilege(S.oid, ‘USAGE’)))
OR (U.umuser = 0 AND pg_has_role(S.srvowner, ‘USAGE’))
OR (SELECT rolsuper FROM pg_authid WHERE rolname =
current_user)
THEN U.umoptions
ELSE NULL END AS umoptions
FROM pg_user_mapping U
LEFT JOIN pg_authid A ON (A.oid = U.umuser) JOIN
pg_foreign_server S ON (U.umserver = S.oid);
3.
Не забудьте внести коррективы в базах данных template0 и template1, в противном случае
уязвимость сохранится в базах, которые будут создаваться впоследствии. Чтобы поправить
template0, вам потребуется временно разрешить подключения к ней. В PostgreSQL 9.5 и
новее вы можете выполнить
ALTER DATABASE template0 WITH ALLOW_CONNECTIONS true;
, а внеся поправку в template0, восстановить прежнее состояние командой
ALTER DATABASE template0 WITH ALLOW_CONNECTIONS false;
В более ранних версиях вместо этого используйте пару команд
UPDATE pg_database SET datallowconn = true WHERE datname = ‘template0’;
UPDATE pg_database SET datallowconn = false WHERE datname = ‘template0’;
4.
В заключение удалите параметр конфигурации allow_system_table_mods и ещё раз пере-
запустите postmaster.
• Запрет пустых паролей для всех методов аутентификации по паролю (Хейкки Линнакангас)
Библиотека libpq игнорирует пустое указание пароля и не передаёт его на сервер. Поэтому,
если пароль пользователя пустой, psql и другие клиенты на базе libpq не позволяют подклю-
читься с таким паролем. Как следствие, администратор может решить, что установка пустого
пароля равнозначна запрету входа по паролю. Однако с изменённым клиентом или клиентом
не на базе libpq подключение оказывается возможным, в зависимости от настроенного метода
аутентификации. В частности, самый распространённый метод, md5, принимает пустые паро-
ли. В результате этого изменения сервер не будет принимать пустые пароли во всех случаях.
(CVE-2017-7546)
• Добавление в lo_put() проверки права UPDATE для целевых больших объектов (Том Лейн, Ми-
каэль Пакье)
Функция lo_put(), несомненно, должна требовать наличия тех же прав, что и lowrite(), но
такая проверка отсутствовала, что позволяло пользователю менять данные в большом объек-
те. (CVE-2017-7548)
• Исправление в документации описания процесса обновления резервных серверов с использо-
ванием pg_upgrade (Брюс Момджян)
Ранее в документации говорилось, что нужно запустить/остановить ведущий сервер после за-
пуска pg_upgrade, но до синхронизации резервных серверов. Однако эта последовательность
небезопасна.
• Исправление одновременной блокировки цепочки изменённых кортежей (Альваро Эррера)
Когда цепочка изменённых кортежей блокируется одновременно несколькими сеансами в
неконфликтующем режиме с использованием старого снимка, и все операции завершаются
успешно, существовала возможность, что некоторые из них, несмотря на это, нарушатся (и
заключат, что актуальной версии кортежа нет) из-за условий гонки. В частности, вследствие
этого проверка внешнего ключа могла не увидеть кортеж, который определённо существует,
но изменяется параллельной операцией.
2370Замечания к выпуску
• Устранение риска повреждения данных при замораживании кортежа, в котором XMAX равен
идентификатору мультитранзакции с ровно одним ещё востребованным членом (Фёдор Сига-
ев)
• Предупреждение целочисленного переполнения и краха при сортировке в памяти более чем
одного миллиарда кортежей (Сергей Копосов)
• В Windows необходимо повторять попытки создания процесса в случае ошибки при резервиро-
вании диапазона адресов разделяемой памяти в новом процессе (Том Лейн, Амит Капила)
Это должно устранить периодические сбои при запуске дочерних процессов, возможно, вы-
званные вмешательством антивирусных программ.
• Устранение маловероятной возможности повреждения разделяемой хеш-таблицы предикат-
ных блокировок в сборках для Windows (Томас Мунро, Том Лейн)
• Предотвращение вывода в журнал сообщения о штатном закрытии SSL-соединения (поведе-
ние должно быть таким же, как и при сбросе соединения) (Микаэль Пакье)
• Запрещение передачи сеансовых билетов SSL клиентам (Том Лейн)
Это исправление устраняет сбои при переподключении клиентов с реализациями SSL, в кото-
рых эти билеты используются.
• Исправление кода, устанавливающего tcp_keepalives_idle в Solaris (Том Лейн)
• Исправление дефекта в сборщике статистики, приводящего к потере запросных сообщений,
выдаваемых сразу после перезапуска главного процесса (Том Лейн)
Запросы статистики, выдаваемые в течение полсекунды после предыдущего отключения глав-
ного процесса, по сути терялись.
• Размер приёмного буфера в сборщике статистики должен быть не меньше 100 Кбайт (Том
Лейн)
Это снижает риск потери данных статистики на старых платформах, где размер приёмного бу-
фера по умолчанию меньше.
• Устранение возможности создания некорректного сегмента WAL при повышении резервного
сервера сразу после того, как он обрабатывает запись XLOG_SWITCH (Андрес Фройнд)
• Процесс walsender должен завершаться своевременно, когда клиент инициирует выключение
(Том Лейн)
• Исправление обработки сигналов SIGHUP и SIGUSR1 в процессах walsender (Петр Желинек,
Андрес Фройнд)
• Предотвращение панического состояния, которое могут вызвать процессы walsender во время
контрольной точки при выключении (Андрес Фройнд, Микаэль Пакье)
• Устранение неоправданной паузы при перезапуске процессов walreceiver, возникающей
вследствие условий гонки в главном процессе (Том Лейн)
• Устранение утечки маленьких подтранзакций, оказывающихся на диске при логическом деко-
дировании (Андрес Фройнд)
В результате образовывались временные файлы, занимающие лишнее место на диске.
• Оптимизация операций, необходимых для получения снимков при создании слотов логическо-
го декодирования (Андрес Фройнд, Петр Желинек)
Предыдущий алгоритм оказывался очень неэффективным на сервере со множеством откры-
тых транзакций.
• Устранение условий гонки, при которых создание слотов логического декодирования могло
откладываться на неопределённое время (Андрес Фройнд, Петр Желинек)
2371Замечания к выпуску
• Уменьшение издержек при обработке событий сброса системного кеша (Том Лейн)
Это особенно полезно для логического декодирования, когда сброс кеша происходит часто.
• Ликвидация некорректной эвристики, применяемой в некоторых случаях для оценки избира-
тельности соединения при наличии ограничений внешнего ключа (Дэвид Роули)
В некоторых случаях, когда существовал внешний ключ по нескольким столбцам, но он не
точно соответствовал структуре условия соединения, планировщик использовал эвристиче-
скую оценку, которая оказывалась неподходящей. Теперь в таких случаях будет применяться
та же логика, что была до версии 9.6.
• Исправление поведения в ситуациях, когда INSERT или UPDATE присваивает более одного эле-
мента столбцу с типом домена на базе массива (Том Лейн)
• Разрешение использования оконных функций во вложенных SELECT в аргументах агрегатной
функции (Том Лейн)
• Обеспечение корректного применения предложения CHECK OPTIONS для представления, когда
нижележащая таблица является сторонней (Эцуро Фудзита)
Ранее операция изменения полностью передавалась на сторонний сервер, и если для пред-
ставления задавалось ограничение, оно не проверялось.
• Предупреждение конфликта имён с автоматически генерируемыми типами массивов при вы-
полнении ALTER … RENAME (Вик Фиринг)
Ранее автоматически сгенерированный тип массива во избежание конфликта переименовы-
вался при выполнении CREATE; данное исправление распространяет это поведение и на опера-
ции переименования.
• Устранение потери указателя в ALTER TABLE когда для ограничения, принадлежащего табли-
це, добавлен комментарий (Дэвид Роули)
При повторном применении комментария к воссозданному ограничению мог произойти сбой
со странным сообщением или даже с аварийным завершением.
• Добавление для команды ALTER USER … SET всех вариантов синтаксиса, что принимает
ALTER ROLE … SET (Питер Эйзентраут)
• Допущение для сторонней таблицы создания ограничений CHECK в изначально непроверенном
состоянии (NOT VALID) (Амит Ланготе)
CREATE TABLE просто игнорирует указания NOT VALID для ограничений CHECK, исходя из того,
что таблица должна быть пустой, и поэтому ограничение может сразу считаться проверен-
ным. Но это неверно для команды CREATE FOREIGN TABLE — нет причин полагать, что нижеле-
жащая таблица пуста, и даже если это так, не мы должны решать, что ограничение проверен-
ное. Поэтому такую «оптимизацию» для сторонних таблиц нужно исключить.
• Обновление информации о зависимости при смене типа аргумента или возврата для функции
ввода/вывода с opaque на целевой тип (Хейкки Линнакангас)
CREATE TYPE изменяет функции ввода/вывода, объявленные в давно устаревшем стиле, но ин-
формация о зависимости от этого типа не записывалась, в результате чего после команд DROP
TYPE могли оставаться дефектные определения функций.
• Допущение распараллеливания в плане запроса, когда COPY копирует данные из его результа-
та (Андрес Фройнд)
• Сокращение использования памяти при обработке командой ANALYZE столбцов tsvector
(Хейкки Линнакангас)
• Устранение ненужной потери точности и небрежного округления при умножении и делении
значений money на целые числа или числа с плавающей точкой (Том Лейн)
2372Замечания к выпуску
• Уточнение проверок пробельных символов в функциях, разбирающих идентификаторы, напри-
мер regprocedurein() (Том Лейн)
В зависимости от используемой локали эти функции могли неправильно воспринимать фраг-
менты многобайтных символов как пробелы.
• Использование уместных символов #define из Perl при сборке PL/Perl (Ашутош Шарма, Том
Лейн)
Это предупреждает проблемы переносимости, обычно проявляющиеся в виде ошибок «про-
верки совместимости» в момент загрузки библиотеки при использовании последних версий
Perl.
• Обеспечение в libpq корректного сброса состояния аутентификации GSS/SASL и SSPI после
неудачной попытки подключения (Микаэль Пакье)
Ранее этот сброс не выполнялся и при переходе с SSL-соединения на не SSL ошибка GSS/SASL
при попытке SSL-подключения мешала затем установить обычное подключение, без SSL. С
SSPI этого не происходило, но имела место утечка памяти.
• В psql устранён сбой, возникающий, когда команда COPY FROM STDIN завершалась вводом сиг-
нала EOF с клавиатуры, а затем следовала ещё одна попытка выполнить COPY FROM STDIN (То-
мас Мунро)
Это некорректное поведение наблюдалось в системах, основанных на BSD, (включая macOS),
но не в других.
• Исправление программ pg_dump и pg_restore, чтобы команды REFRESH MATERIALIZED VIEW вы-
давались в конце (Том Лейн)
Это предотвращает ошибки при выгрузке/восстановлении данных, когда материализованное
представление ссылается на таблицы, принадлежащие другому пользователю.
• Улучшение вывода в pg_dump/pg_restore сообщений об ошибках, возникающих в zlib (Влади-
мир Кунщиков, Альваро Эррера)
• Исправление поведения pg_dump с ключом –clean, чтобы событийные триггеры удалялись
должным образом (Том Лейн)
Теперь также правильно назначаются владельцы событийных триггеров; ранее после запуска
скрипта восстановления такие триггеры оказывались принадлежащими суперпользователю.
• Исправление поведения pg_dump с ключом –clean, чтобы существование схемы public не
требовалось (Стивен Фрост)
• Исправление дефекта в pg_dump, когда для пустого класса операторов выдавался некоррект-
ный SQL (Даниэль Густафссон)
• Исправление вывода pg_dump в stdout на платформе Windows (Кунтал Гхош)
Сжатые данные выгрузки в текстовом виде при выводе в stdout оказывались испорченными
из-за того, что дескриптор файла не переводился в двоичный режим.
• Исправление вывода pg_get_ruledef() для правила ON SELECT, связанного с представлением,
в котором переименовывались столбцы (Том Лейн)
В некоторых особых случаях pg_dump использует pg_get_ruledef() для выгрузки представле-
ний, так что эта ошибка могла приводить к сбоям при выгрузке/загрузке.
• Исправление выгрузки внешних соединений с пустыми ограничениями, получающихся, на-
пример, в результате NATURAL LEFT JOIN без общих столбцов (Том Лейн)
• Исправление выгрузки выражений с функциями в предложении FROM в случаях, когда эти вы-
ражения не преобразуются в нечто, напоминающее вызов функции (Том Лейн)
• Исправление вывода pg_basebackup в stdout на платформе Windows (Харибабу Комми)
2373Замечания к выпуску
Архивируемые данные при выводе в stdout оказывались испорченными из-за того, что де-
скриптор файла не переводился в двоичный режим.
• Исправление pg_rewind для корректной работы с файлами больше 2 ГБ (Кунтал Гхош, Мика-
эль Пакье)
Обычно такие файлы в каталогах данных PostgreSQL не образуются, но в некоторых случаях
они могут появиться.
• Исправление pg_upgrade, чтобы в конечной записи в WAL не оказалось wal_level = minimum
(Брюс Момджян)
Это могло препятствовать переподключению обновлённых резервных серверов.
• Исправление в pg_xlogdump вычисления длины записи WAL (Андрес Фройнд)
• В postgres_fdw соединения к удалённым серверам должны устанавливаться заново после ко-
манд ALTER SERVER и ALTER USER MAPPING (Кётаро Хоригути)
Благодаря этому изменения параметров, затрагивающие свойства соединения, вступят в силу
своевременно.
• В postgres_fdw реализована отмена команд управления удалёнными транзакциями (Роберт
Хаас, Рафия Сабих)
Это изменение позволяет быстрее прервать ожидание неотвечающего удалённого сервера в
большем количестве случаев, чем раньше.
• Увеличение MAX_SYSCACHE_CALLBACKS для выделения дополнительного места расширениям
(Том Лейн)
• При сборке разделяемых библиотек с gcc всегда должен передаваться ключ -fPIC, а не -fpic
(Том Лейн)
Это позволяет поддерживать библиотеки расширений большего размера на тех платформах,
где эти ключи не равнозначны.
• Для сборок MSVC реализована обработка ситуации, когда библиотека OpenSSL находится не в
подкаталоге VC (Эндрю Дунстан)
• Для сборок MSVC добавлен нужный путь для заголовочных файлов libxml2 (Эндрю Дунстан)
Это устраняет прежнюю необходимость перемещения файлов в стандартной инсталляции
libxml2 в Windows.
• Сборки MSVC должны распознавать библиотеку Tcl с именем tcl86.lib (Ной Миш)
• В сборках MSVC должны учитываться флаги в параметре PROVE_FLAGS, заданном в командной
строке vcregress.pl (Эндрю Дунстан)
E.18. Выпуск 9.6.3
Дата выпуска:
2017-05-11
В этот выпуск вошли различные исправления, внесённые после версии 9.6.2. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.18.1. Миграция на версию 9.6.3
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если вы используете сторонние серверы данных, на которых для проверки подлинности
применяются пароли, прочитайте ниже первую запись в списке изменений.
А если вы используете сторонние средства репликации, основанные на «логическом декодирова-
нии», обратите внимание на четвёртую запись в списке изменений.
2374Замечания к выпуску
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.2, см. Раздел E.19.
E.18.2. Изменения
• Ограничение видимости pg_user_mappings.umoptions для защиты паролей, сохранённых в
свойствах сопоставлений пользователей (Микаэль Пакье, Фейке Стинберген)
Предыдущая реализация позволяла владельцу объекта стороннего сервера или любому, кто
получил право USAGE, видеть свойства всех сопоставлений, связанных с этим сервером. В том
числе это могли быть и пароли других пользователей. Теперь определение данного представ-
ления изменено для соответствия поведению information_schema.user_mapping_options, так
что эти свойства может прочитать только собственно пользователь сопоставления либо, если
это сопоставление роли PUBLIC, владелец сервера, либо суперпользователь. (CVE-2017-7486)
Само по себе это исправление корректирует поведение только в новых базах данных, созда-
ваемых initdb. Если вы хотите применить это исправление к существующей базе данных, сле-
дуйте исправленной процедуре в списке изменений, относящейся к CVE-2017-7547, в Разде-
ле E.17.
• Предотвращение утечки статистической информации через негерметичные операторы (Питер
Эйзентраут)
Некоторые функции оценки избирательности в планировщике применяют пользовательские
операторы к значениям, получаемым из pg_statistic, например, к наиболее частым значе-
ниям и элементам гистограммы. Это происходит до проверки прав доступа к таблице, так что
злонамеренный пользователь может воспользоваться этим и получить подобные значения из
столбцов таблицы, чтение которых ему запрещено. Для устранения этой уязвимости следует
переходить к общим оценкам, если функция, реализующая оператор, не считается герметич-
ной и вызывающий её пользователь не имеет права на чтение столбца, статистика по которо-
му требуется планировщику. На практике в большинстве случаев одно из этих условий выпол-
няется. (CVE-2017-7484)
• Восстановление восприятия библиотекой libpq переменной окружения PGREQUIRESSL (Даниэль
Густафссон)
Поддержка этой переменной окружения была непреднамеренно ликвидирована в PostgreSQL
9.3, но в документации она осталась. Это создало угрозу безопасности, так как пользовате-
ли могли рассчитывать на то, что она будет требовать SSL-шифрования подключений, но на
самом деле этого не происходило. Теперь эта переменная воспринимается как и раньше, но
имеет меньший приоритет, чем PGSSLMODE, во избежание нарушения конфигураций, работаю-
щих корректно с версиями после 9.3. (CVE-2017-7485)
• Исправление потенциально некорректного начального снимка при логическом декодирова-
нии (Петр Желинек, Андрес Фройнд)
Изначальный снимок, создаваемый для слота репликации с логическим декодированием, мог
быть некорректным. В результате сторонние средства, использующие логическое декодирова-
ние, могли получать неполные/несогласованные начальные данные. Вероятность такого сбоя
увеличивалась, если при создании слота исходный сервер был загружен либо уже существо-
вал другой логический слот.
Если вы используете средство репликации, основанное на логическом декодировании, и копи-
ровали непустой набор данных в начале репликации, имеет смысл пересоздать реплику после
установления этого обновления либо сверить содержимое базы с исходным сервером.
• Исправление потенциального повреждения «слоёв инициализации» нежурналируемых индек-
сов (Роберт Хаас, Микаэль Пакье)
Это повреждение могло приводить к переходу нежурналируемого индекса в ошибочное состо-
яние после сбоя и перезапуска сервера. Устранить возникшую проблему можно было, только
удалив и перестроив индекс.
2375Замечания к выпуску
• Исправление ошибочного восстановления записей pg_subtrans при воспроизведении резерв-
ным сервером подготовленных, но не зафиксированных двухфазных транзакций (Том Лейн)
В большинстве случаев это не имело никаких болезненных последствий, но в особых ситуаци-
ях могло приводить к зацикливанию ссылок в pg_subtrans, что, в свою очередь, провоцирова-
ло бесконечные циклы в запросах, обращающимся к строкам, изменённым двухфазной тран-
закцией.
• Предотвращение возможного сбоя в walsender при ошибке инициализации буфера строки
(Стас Кельвич, Фудзии Масао)
• Предупреждение возможного сбоя при повторном сканировании индекса GiST с использова-
нием только индекса и поиском ближайших соседей (Том Лейн)
• Предотвращение задержек при запуске процессом postmaster нескольких параллельных рабо-
чих процессов (Том Лейн)
Ранее была возможна значительная задержка (до нескольких десятков секунд), когда запросу
требовалось более одного рабочего процесса, либо когда несколько запросов обращались за
рабочими процессами одновременно. На большинстве платформ это происходило при редком
стечении обстоятельств, но на некоторых наблюдалось регулярно.
• Исправление поведения postmaster при обработке сбоя fork() для фонового рабочего процес-
са (Том Лейн)
Ранее postmaster модифицировал элементы своего состояния так, как будто процесс был запу-
щен успешно, что впоследствии приводило к замешательству.
• Исправление потенциальной ошибки «no relation entry for relid 0» (нет записи отношения для
relid 0) при планировании вложенных операций с множествами (Том Лейн)
• Устранение разнообразных мелких дефектов в планировании параллельных запросов (Роберт
Хаас)
• Исключение применения оптимизации «физического целевого списка» к нестандартным ска-
нированиям (Дмитрий Иванов, Том Лейн)
Эта оптимизация предполагала, что получить все столбцы кортежа можно недорого, что дей-
ствительно верно для обычных кортежей Postgres, но с нестандартными провайдерами скани-
рования это может быть не так.
• Использование правильного подвыражения при применении политики защиты на уровне
строк FOR ALL (Стивен Фрост)
В некоторых случаях применялось ограничение WITH CHECK, хотя более уместным было бы
ограничение USING.
• Обеспечение видимости результатов непосредственно предшествующих DDL при разборе за-
просов в скриптах расширений (Жульен Рухо, Том Лейн)
Из-за того, что кеш между командами в скрипте расширения не сбрасывался, запрос к дан-
ным мог не наблюдать эффектов непосредственно предшествующего ему изменения каталога,
например результатов ALTER TABLE … RENAME.
• Ликвидация проверки прав доступа к табличному пространству при перестроении существую-
щего индекса командой ALTER TABLE … ALTER COLUMN TYPE (Ной Миш)
Это команда выдавала ошибку, если вызывающий пользователь не имел права CREATE для таб-
личного пространства, содержащего индекс. Такое поведение малополезно, так что стоит ис-
ключить эту проверку и разрешить перестраивать индекс там, где он находился.
• Предотвращение рекурсивного обращения команды ALTER TABLE … VALIDATE CONSTRAINT к
дочерним таблицам когда ограничение помечено как NO INHERIT (Амит Ланготе)
2376Замечания к выпуску
Это предупреждает нежелательные сбои типа «constraint does not exist» (ограничение не су-
ществует) в случаях, когда в дочерних таблицах нет соответствующего ограничения.
• Устранение потери указателя в COPY … TO когда для исходной таблицы активна защита на
уровне строк (Том Лейн)
Обычно это не имело болезненных последствий, но иногда всё же приводило к неожиданным
ошибкам и сбоям.
• Предупреждение обращения к уже закрытому элементу relcache в CLUSTER и VACUUM FULL (Том
Лейн)
При особом стечении обстоятельств это могло приводить к тому, что индексы в целевом отно-
шении перестраивались с неправильным режимом сохранения.
• Исправление ошибки команды VACUUM, когда она неправильно учитывала страницы, которые
не могла прочитать из-за конфликтующих закреплений страниц (Эндрю Гирт)
Это провоцировало недооценивание количества кортежей в таблице. В худшем случае с чрез-
вычайно востребованной таблицей команда VACUUM могла ошибочно сообщить, что таблица во-
все не содержит кортежей, что приводило к очень плохим решениям при планировании.
• Обеспечение возможности прерывания циклов массовой передачи кортежей в соединении по
хешу при попытке отмены запроса (Том Лейн, Томас Мунро)
• Исправление ошибок в поддержке определённых операторов box в SP-GiST (Никита Глухов)
Сканирование по индексу SP-GiST с использованием операторов &amp;&lt; &amp;&gt; &amp;&lt;| и |&amp;&gt; выдавало
некорректные ответы.
• Исправление проблем с переполнением целочисленных значений при сравнении типов
interval (Кётаро Хоригути, Том Лейн)
Операторы сравнения для типа interval могли выдавать неверные ответы для интервалов,
превышающих 296000 лет. Индексы по столбцам с такими большими значениями следует пе-
рестроить, так как они могут быть испорчены.
• Исправление функции cursor_to_xml(), чтобы она выдавала правильный результат с
tableforest = false (Томас Мунро, Питер Эйзентраут)
Ранее она не добавляла внешний элемент &lt;table&gt;.
• Устранение проблем с округлением в функциях float8_timestamptz() и make_interval()
(Том Лейн)
Эти функции отбрасывали дробную часть, а не округляли числа при преобразовании значения
с плавающей точкой к целому числу микросекунд; это могло приводить к неожиданным сдви-
гам результатов на единицу.
• Исправление функции pg_get_object_address() для членов семейств операторов (Альваро
Эррера)
• Исправление отмены pg_stop_backup() при попытке остановить немонопольное резервное ко-
пирование (Микаэль Пакье, Дэвид Стил)
Когда функция pg_stop_backup() отменялась, ожидая завершения немонопольного резерв-
ного копирования, информация о состоянии оставалась неактуальной; запустить новое моно-
польное копирование было невозможно, возникали и другие небольшие проблемы.
• Улучшение производительности представления pg_timezone_names (Том Лейн, Дэвид Роули)
• Уменьшение издержек при управлении памятью для контекстов, содержащих множество
больших блоков (Том Лейн)
• Исправление неаккуратной обработки редких ошибок в lseek() и close() (Том Лейн)
2377Замечания к выпуску
В типичных ситуациях эти системные вызовы отрабатывают без ошибок, но в случае ошибки
код fd.c мог повести себя некорректно.
• Исправление некорректной проверки факта работы postmaster в виде службы Windows (Мика-
эль Пакье)
Вследствие ошибки для вывода сообщений мог выбираться системный журнал событий (там
где его на самом деле не было), так что запись сообщений фактически не производилась.
• Исправление в ecpg поддержки COMMIT PREPARED и ROLLBACK PREPARED (Масахико Савада)
• Исправление ошибки двойного освобождения при обработке строковых констант, заключён-
ных в доллары, в ecpg (Михаэль Мескес)
• Исправление поведения pgbench с сочетанием параметров –connect и –rate (Фабьен Коэ-
льо)
• Исправление в pgbench обработки развёрнутого написания параметра –builtin согласно до-
кументации (Том Лейн)
• Исправление поведения pg_dump/pg_restore для корректной обработки прав, назначенных для
схемы public, при использовании параметра –clean (Стивен Фрост)
Другие схемы создаются без назначенных для них прав, но схема public представляет собой
исключение; когда она удаляется и восстанавливается вследствие указания –clean, её нуж-
но обработать особым образом.
• В pg_dump исправлена пометка схемы и владельца для комментариев и меток безопасности
некоторых типов объектов БД (Джузеппе Брокколо, Том Лейн)
В простых случаях это не проявлялось никак, но например, при восстановлении с выбором
схемы, могли потеряться комментарии, которые в ней должны быть, из-за того, что они не бы-
ли помечены как принадлежащие схеме своего объекта.
• Исправление ошибки в запросе pg_dump, предназначенном для получения начальных прав,
назначенных для процедурного языка (Питер Эйзентраут)
Вследствие этой ошибки pg_dump всегда полагал, что для языка не определены начальные
права. Так как это справедливо для большинства процедурных языков, последствия ошибки
могли проявляться довольно редко.
• Предотвращение вывода командой pg_restore -l некорректного файла со списком объектов,
когда имена объектов SQL содержат символы перевода строки (Том Лейн)
Символы перевода строки заменяются пробелами, что достаточно для того, чтобы этот список
корректно обработала команда pg_restore -L.
• Исправление поведения pg_upgrade для корректного переноса комментариев и меток без-
опасности, связанных с «большими объектами» (BLOB) (Стивен Фрост)
Ранее такие объекты корректно переносились в новую базу данных, но связанные с ними ком-
ментарии и метки безопасности терялись.
• Улучшение обработки ошибок в функции pg_file_write() из contrib/adminpack (Ной Миш)
В частности, она не реагировала на ошибки в вызове fclose().
• Предупреждение утечки предыдущего безымянного соединения при установлении нового
безымянного соединения в contrib/dblink (Джо Конвей)
• Исправление извлечения триграмм из регулярных выражений в contrib/pg_trgm (Том Лейн)
В некоторых случаях это могло приводить к формированию испорченной структуры данных,
для которой отсутствуют какие-либо соответствия. Вследствие этого при сканировании по ин-
2378Замечания к выпуску
дексам GIN и GiST с использованием триграмм для регулярного выражения могли не нахо-
диться никакие результаты.
• В contrib/postgres_fdw добавлена возможность вынесения на удалённый сервер условий со-
единения, содержащих функции из поставляемых расширений (Дэвид Роули, Ашутош Бапат)
• Поддержка Tcl 8.6 в сборках с MSVC (Альваро Эррера)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2017b
(Том Лейн)
Это устраняет ошибку с некоторыми вариантами перехода на летнее время в январе 2038.
• Обновление данных часовых поясов до версии tzdata 2017b, включающее изменение правил
перехода на летнее время в Чили, Монголии и на Гаити, а также исторические изменения для
Эквадора, Казахстана, Либерии и Испании. Переход к числовым аббревиатурам для ряда ча-
совых поясов в Южной Америке, в Тихом и Индийском океанах, а также в некоторых азиат-
ских и ближневосточных странах.
Ранее в базе данных часовых поясов IANA предоставлялись текстовые аббревиатуры для
всех часовых поясов и иногда при этом указывались аббревиатуры, которые практически не
употреблялись местным населением. Сейчас происходит процесс ухода от этой практики в
пользу использования числовых смещений UTC в тех часовых поясах, где нет никаких свиде-
тельств реального использования английской аббревиатуры. Как минимум на данном этапе,
PostgreSQL продолжит принимать подобные удалённые аббревиатуры при вводе дат/времени.
Но они не будут видны при просмотре представления pg_timezone_names и не будут выводить-
ся с датами/временем.
• Использование корректных правил перехода на летнее время для названий часовых поясов в
стиле POSIX при сборке с MSVC (Дэвид Роули)
Сборочные скрипты для MSVC не устанавливали корректно файл posixrules в дерево катало-
гов timezone. Это приводило к тому, что код timezone переходил к использованию встроенных
представлений о том, какой вариант перехода на летнее время применим для названия поя-
са в стиле POSIX. По историческим причинам это соответствует правилам, которые действо-
вали в США до 2007 г. (то есть переход на летнее время происходил в первое воскресенье ап-
реля, а на зимнее — в последнее воскресенье октября). С этим исправлением для часового по-
яса с названием в стиле POSIX будут использоваться текущие и исторические даты перехода
для пояса US/Eastern. Если для вас это нежелательно, удалите файл posixrules или замени-
те его файлом другого часового пояса (см. Подраздел 8.5.3). Учтите, что вследствие кеширо-
вания вам потребуется перезапустить сервер, чтобы подобные изменения вступили в силу.
E.19. Выпуск 9.6.2
Дата выпуска:
2017-02-09
В этот выпуск вошли различные исправления, внесённые после версии 9.6.1. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.19.1. Миграция на версию 9.6.2
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если в вашей инсталляции проявилась ошибка, описанная в первой записи следующего
списка изменений, после обновления вам может потребоваться предпринять дополнительные дей-
ствия для исправления испорченных индексов.
Также, если вы обновляете сервер с версии, более ранней, чем 9.6.1, см. Раздел E.20.
E.19.2. Изменения
• Исправление поведения в особых условиях, которое приводило к повреждению индексов, со-
здаваемых командой CREATE INDEX CONCURRENTLY (Паван Деоласи, Том Лейн)
2379Замечания к выпуску
Если команда CREATE INDEX CONCURRENTLY применялась для построения индекса, зависящего
от столбца, ранее не индексированного, то у строк, изменяемых транзакциями, выполняемы-
ми одновременно с командой CREATE INDEX, могли оказываться некорректные записи в индек-
се. В случае подозрений, что вас это коснулось, самое надёжное решение — перестроить та-
кие индексы после установки этого обновления.
• Предотвращение утери специального снимка, используемого при сканированиях каталога,
при преждевременной очистке данных (Tom Lane)
Рабочие процессы не учитывали этот снимок, сообщая о своём самом старом xmin, что остав-
ляло возможность для удаления по-прежнему нужных данных параллельными операциями
очистки. Это приводило к появлению плавающих ошибок с сообщениями «ошибка поиска в
кеше для отношения 1255».
• Исправление некорректной записи в WAL, формируемой для индексов BRIN (Кунтал Гхош)
Запись WAL, выдаваемая для страницы BRIN «revmap» при перемещении кортежа индекса в
другую страницу, была некорректной. При воспроизведении журнала соответствующая часть
индекса становилась непригодной, и её требовалось вычислять заново.
• Безусловное фиксирование в WAL создания «слоя инициализации» для нежурналируемых таб-
лиц (Микаэль Пакье)
Ранее это действие пропускалось при wal_level = minimal, но на самом деле это необходимо
даже в этом случае, чтобы нежурналируемая таблица корректно создавалась пустой после
сбоя.
• Если процесс сборщика статистики потерян, перезапускать его и в режиме горячего резерва
(Такаюки Цунакава)
• Обеспечение корректной работы механизма уведомлений горячего резерва, когда он включа-
ется при запуске резервного сервера (Антс Аасма, Крейг Рингер)
• Проверка прерываний в момент ожидания конфликтующего запроса сервером горячего ре-
зерва (Саймон Риггс)
• Предупреждение постоянного перезапуска процесса запуска автоочистки в особых случаях
(Амит Хандекар)
Это исправление решает проблему, возникавшую, когда автоочистка номинально отключена
и есть несколько таблиц, требующих «заморозки», но эти таблицы уже обработаны рабочими
процессами автоочистки.
• Недопущение установки нулевого значения для поля num_sync в synchronous_standby_names
(Фудзии Масао)
Правильный вариант отключения синхронных резервных серверов — задать пустую строку в
качестве всего значения.
• Не учитывать фоновые рабочие процессы при проверке ограничения на число подключений
пользователя (Дэвид Роули)
• Исправление проверки на возможность удаления объекта, принадлежащего расширению (Том
Лейн)
Скрипты обновления расширений должны иметь возможность удалять объекты расширений,
но это запрещалось для последовательностей со столбцами serial, а также, возможно, в других
случаях.
• Исправление отслеживания начальных прав доступа для объектов, принадлежащих расшире-
нию, чтобы это корректно работало с ALTER EXTENSION … ADD/DROP (Стивен Фрост)
Текущие права доступа к объекту в момент добавления его в расширение теперь будут счи-
таться правами по умолчанию; только в случае изменений они будут выгружаться при после-
дующем выполнении pg_dump.
2380Замечания к выпуску
• Команда ALTER TABLE должна сохранять назначения табличных пространств индексам при пе-
рестраивании индексов (Том Лейн, Микаэль Пакье)
Ранее с нестандартными значениями default_tablespace были возможны разрушения индек-
сов.
• Исправление некорректного изменения свойств триггерной функции при изменении свой-
ства «откладываемости» ограничения внешнего ключа с помощью команды ALTER TABLE …
ALTER CONSTRAINT (Том Лейн)
Это приводило к странным сбоям при последующем обращении к внешнему ключу, так как
триггеры срабатывали не в положенное время.
• Недопущение удаления ограничения внешнего ключа при наличии событий, ожидающих об-
работки триггерами, для целевого отношения (Том Лейн)
Это предотвращает ошибки «не удалось найти триггер NNN» и «в отношении NNN нет тригге-
ров».
• Исправление поведения ALTER TABLE … SET DATA TYPE … USING в случаях, когда порядок
столбцов в дочерней таблице отличается от родительской (Альваро Эррера)
Вследствие того, что столбцы в выражении USING не перенумеровывались, возникала ошибка,
обычно такая: «атрибут N имеет неправильный тип».
• Исправление обращения к столбцу OID в случаях, когда таблица с таким столбцом связывает-
ся с родительской, тоже с OID, посредством ALTER TABLE … INHERIT (Амит Ланготе)
В таких случаях столбец OID должен обрабатываться как обычный пользовательский столбец,
но этого не происходило, что приводило к странному поведению при последующих изменени-
ях наследования.
• Команда CREATE TABLE … LIKE … WITH OIDS должна создавать таблицу с OID вне зависи-
мости от того, есть ли OID в таблице, указанной в LIKE (Том Лейн)
• Исправление поведения CREATE OR REPLACE VIEW — запрос представления должен изменяться
до применения новых параметров представления (Дин Рашид)
Ранее в команде происходил сбой, если новые параметры оказывались несогласованными со
старым определением представления.
• Получение правильного идентификатора объекта в ALTER TEXT SEARCH CONFIGURATION (Артур
Закиров)
Ранее расширениям, таким как модули логического декодирования, выдавался неправильный
OID каталога.
• Предупреждение сбоев механизма учёта времени транзакций при запросе особых XID
(FrozenTransactionId и BootstrapTransactionId) (Крейг Рингер)
• Исправление некорректного использования reloptions представлений как reloptions обычных
таблиц (Том Лейн)
Симптомами ошибки были неуместные сообщения «ON CONFLICT не поддерживается
для таблицы …, служащей таблицей каталога» когда целевым отношением INSERT … ON
CONFLICT было представление с каскадной проверкой.
• Исправление некорректного сообщения «допустимое число элементов в целевом списке огра-
ничено N» при использовании ON CONFLICT с широкими таблицами (Том Лейн)
• Устранение ошибок с ложными сообщениями «в запросе обнаружены данные для удалённого
столбца» при выполнении INSERT или UPDATE в таблице с удалённым столбцом (Том Лейн)
• Предотвращение разворачивания foo.* в набор столбцов в исходном выражении UPDATE (Том
Лейн)
2381Замечания к выпуску
Это приводило к ошибкам с сообщением «несоответствие целевого количества в UPDATE —
внутренняя ошибка». Теперь эта запись воспринимается как обозначение переменной «вся-
строка», как и в других контекстах.
• Обеспечение точного определения модификаторов типа столбцов в конструкциях VALUES с
несколькими строками (Том Лейн)
Это устраняет проблемы, возникавшие, когда первое значение в столбце имеет воспринима-
емый модификатор типа (например, длину значения varchar), но последующие значения не
разделяют его ограничение.
• При нахождении незаконченной суррогатной пары Unicode в конце строки символов Unicode
должна выдаваться ошибка (Том Лейн)
Обычно за начальным суррогатным символом Unicode должно следовать продолжение, но
это не проверялось когда такой начальный символ оказывался последним в строке символов
Unicode (U&amp;’…’) или в Unicode-идентификаторе (U&amp;”…”).
• Корректировка выполнения агрегатов с DISTINCT и упорядочиванием, когда несколько таких
агрегатов могут разделять одно состояние перехода (Хейкки Линнакангас)
• Исправление реализации операторов поиска фраз в tsquery (Том Лейн)
Ликвидация некорректных и применяемых несогласованно правил перезаписи, которые пыта-
лись оптимизировать операторы И/ИЛИ/НЕ внутри оператора поиска фразы; вместо этого об-
работка таких выражений была добавлена в сам исполнитель. В результате устранены разно-
образные странности в поведении и возможные сбои в запросах полнотекстового поиска, со-
держащих такие выражения. Также реализовано разумное поведение вложенных операторов
поиска фраз не только с простыми деревьями, растущими влево; исправлено поведение при
удалении стоп-слов из предложения поиска фразы; обеспечена согласованность поиска по ин-
дексу и простого выполнения этих запросов с последовательным сканированием.
• Определённо отрицательному поисковому запросу, например, !foo, должны удовлетворять пу-
стые значения tsvector (Том Дунстан)
Такие соответствия находились при поиске по индексу GIN, но не при последовательном ска-
нировании или поиске по индексу GiST.
• Предотвращение сбоя в ситуации, когда ts_rewrite() заменяет поддерево не верхнего уровня
пустым запросом (Артур Закиров)
• Устранение проблем с производительностью в ts_rewrite() (Том Лейн)
• Исправление обработки в ts_rewrite() вложенных операторов NOT (Том Лейн)
• Увеличение скорости пользовательских агрегатов, использующих в качестве перехода функ-
цию array_append() (Том Лейн)
• Исправление array_fill() для корректной обработки пустых массивов (Том Лейн)
• Предупреждение возможных сбоев в функциях array_position() и array_positions() при об-
работке массивов записей (Джун-сок Янг)
• Устранение выхода на один байт за границу буфера в функции quote_literal_cstr() (Хейкки
Линнакангас)
Этот выход имел место только если входная строка содержала исключительно апострофы и/
или обратные косые черты.
• Предотвращение одновременного выполнения вызовов pg_start_backup() и
pg_stop_backup() (Микаэль Пакье)
Это предупреждает сбой проверки истинности и, вероятно, худшие последствия, в случае, ес-
ли кто-то попытается запустить эти функции параллельно.
2382Замечания к выпуску
• Отключение трансформации, которая пыталась оптимизировать бесполезные преобразования
AT TIME ZONE (Том Лейн)
Вследствие этого выдавались неверные результаты, когда упрощённое выражение использова-
лось в условии индекса.
• Сохранение приведений interval-в-interval, которые на самом деле несут смысловую на-
грузку (Том Лейн)
В некоторых случаях приведения, которые должны были обнулять младшие поля значений
interval, ошибочно считались бессмысленными и просто убирались. В результате, например,
при приведении значения типа INTERVAL MONTH к INTERVAL YEAR поле месяцев не обнулялось.
• Устранения сбоя в ситуациях, когда число рабочих процессов, доступных для параллельных
запросов, уменьшалось при повторном сканировании (Андреас Зельтенрейх)
• Исправление ошибок при передаче значений параметров GUC параллельным исполнителям
(Микаэль Пакье, Том Лейн)
• Допущение возможности для операторов, подготовленных командой PREPARE, иметь парал-
лельные планы (Амит Капила, Тобиас Бусман)
• Исправление некорректного построения параллельных планов для полусоединений (Том
Лейн)
• Исправление оценок количества строк для параллельных соединений (Роберт Хаас)
Эти оценки должны отражать количество строк, которое будет видеть отдельный рабочий
процесс, а не общее их число.
• Исправление планировщика, чтобы он не пытался распараллеливать узлы плана, содержащие
вложенные и инициализирующие планы (Том Лейн, Амит Капила)
• Аннулирование кешированных планов при изменениях в параметрах сторонних таблиц (Амит
Ланготе, Эцуро Фудзита, Ашутош Бапат)
• Исправление плана, формируемого для частичного агрегирования с выражением GROUP BY с
константой (Том Лейн)
• Исправление ошибки планировщика «не удалось найти план для CTE» при обработке кон-
струкции UNION ALL, включающей CTE (Том Лейн)
• Исправление некорректной обработки инициализирующих планов при принудительном добав-
лении узла Material во вложенный план (Том Лейн)
Типичным проявлением этого дефекта были ошибки «в плане не должно быть обращения к
переменной вложенного плана».
• Исправление оценки избирательности соединения по внешнему ключу для полусоединений и
антисоединений, а также в ситуациях с наследованием (Том Лейн)
Новый код, принимающий в рассмотрение связь по внешнему ключу, работал неправильно в
этих случаях, и оценки оказывались хуже, а не лучше, чем в коде до 9.6.
• Исправление pg_dump, чтобы в выгрузку попадали данные последовательности, помеченной
как конфигурационная таблица расширения (Микаэль Пакье)
• Корректировка неправильной обработки ALTER DEFAULT PRIVILEGES … REVOKE в pg_dump
(Стивен Фрост)
Программа pg_dump не выдавала требуемые команды REVOKE в случаях, когда с помощью
ALTER DEFAULT PRIVILEGES некоторые права доступа исключались из начального набора.
• Исправление pg_dump для корректной выгрузки пользовательских приведений и преобразова-
ний, использующих встроенные функции (Стивен Фрост)
• Реализация более разумного поведения pg_restore с –create –if-exists в случаях, когда
архив содержит нераспознанные команды DROP (Том Лейн)
2383Замечания к выпуску
Это не устраняет никакую наблюдаемую ошибку, но может улучшить поведение в будущем,
при использовании pg_restore с архивом, созданным предыдущей версией pg_dump.
• Исправление ограничения нагрузки pg_basebackup при низкой скорости ввода/вывода (Анто-
нин Хоуска)
Если скорость диска на время оказывалась ниже заданного ограничения, в вычислении про-
исходило переполнение, и в результате ограничение отключалось до конца операции.
• Обеспечение корректной работы pg_basebackup с подкаталогами pg_stat_tmp и pg_replslot,
являющимися символическими ссылками (Магнус Хагандер, Микаэль Пакье)
• Предотвращение возможного сбоя pg_basebackup на резервном сервере при задействовании
файлов WAL (Амит Капила, Роберт Хаас)
• Усовершенствование initdb, чтобы в postgresql.conf вставлялись корректные для текущей
платформы значения по умолчанию параметров xxx_flush_after (Фабьен Коэльо, Том Лейн)
Это позволило описать значения по умолчанию в документации более понятно, чем раньше.
• Исправление возможного дефекта при обработке развёрнутых массивов в ограничениях-про-
верках доменов и в конструкциях CASE (Том Лейн)
Существовала вероятность, что функция PL/pgSQL, вызванная в этих контекстах, изменит или
даже удалит значение массива, которое должно сохраняться для дополнительных операций.
• Исправление рекурсивного вызова функций PL/pgSQL в таких контекстах, как проверки огра-
ничений домена, выполняемые при присвоении значения переменной PL/pgSQL (Том Лейн)
• Обеспечение правильного учёта объектов исключений Python, создаваемых нами для PL/
Python, счётчиками использования (Рафа де ла Торре, Том Лейн)
Это предотвращает ошибки, возникавшие при использовании объектов после цикла уборки
мусора в Python.
• Исправление в PL/Tcl поддержки триггеров для таблиц, в которых имеется столбец .tupno
(Том Лейн)
Это соответствует (ранее недокументированному) поведению команд PL/Tcl spi_exec и
spi_execp, в том, что особый столбец .tupno добавляется, только если отсутствует настоящий
с таким именем.
• В файлах ~/.pgpass должны допускаться завершения строк в стиле DOS, даже на Unix-плат-
формах (Вик Фиринг)
Это изменение упрощает использование одних и тех же файлов паролей на машинах с Unix и
Windows.
• Устранение выхода на один байт за границу буфера, когда ecpg передаётся имя файла, кото-
рое заканчивается точкой (Такаюки Цунакава)
• Исправление некорректных сообщений об ошибках при дублировании данных в psql
\crosstabview (Том Лейн)
psql иногда цитировал некорректное содержимое строки/столбца, выдавая сообщение о мно-
жественных значениях в одной ячейке перекрёстной таблицы.
• Исправление в psql дополнения табуляцией для команды ALTER DEFAULT PRIVILEGES (Жиль
Даролд, Стивен Фрост)
• Исправление в psql дополнения табуляцией для ALTER TABLE t ALTER c DROP … (Кётаро Хо-
ригути)
• В psql пустое или содержащее только пробелы значение переменной окружения PAGER долж-
но означать «без постраничника» (Том Лейн)
2384Замечания к выпуску
Ранее с таким значением вывод, предназначенный для постраничника, просто исчезал.
• Улучшение в contrib/dblink передачи сообщений о низкоуровневых ошибках libpq, напри-
мер, о нехватке памяти (Джо Конвей)
• Реализация contrib/dblink должна игнорировать невоспринимаемые ей параметры серве-
ра, когда в качестве источника параметров подключения используется сторонний сервер
contrib/postgres_fdw (Кори Хинкер)
Ранее, если объект стороннего сервера имел параметры, которые не относились к параметрам
подключения libpq, происходила ошибка.
• Исправление проблем с переносимостью в функциях contrib/pageinspect, связанных с ин-
дексами GIN (Питер Эйзентраут, Том Лейн)
• Устранение возможной потери событий чтения сокета при ожидании в Windows (Амит Капи-
ла)
Эта ошибка была безвредной при обычном использовании, но, как оказалось, она приводила к
повисаниям при попытке воспользоваться расширением pldebugger.
• В Windows изменённые переменные окружения должны передаваться и отладочным DLL
(Кристина Ульрих)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2016j
(Том Лейн)
Это решило ряд проблем; в частности, проблему при установке данных о часовых поясах в ка-
талог, в котором не поддерживаются жёсткие ссылки.
• Обновление данных часовых поясов до версии tzdata 2016j, включающее изменения правил
перехода на летнее время на Северном Кипре (добавление нового пояса Asia/Famagusta), в
России (добавление нового пояса Europe/Saratov), в Тонга и в Антарктике/Кейси, плюс коррек-
тировку исторических данных для Италии, Казахстана, Мальты и Палестины. Переход к пред-
почитаемому числовому обозначению пояса для Тонга.
E.20. Выпуск 9.6.1
Дата выпуска:
2016-10-27
В этот выпуск вошли различные исправления, внесённые после версии 9.6.1. За информацией о
нововведениях версии 9.6 обратитесь к Разделу E.21.
E.20.1. Миграция на версию 9.6.1
Если используется версия 9.6.X, выгрузка/восстановление базы не требуется.
Однако если в вашей инсталляции проявились ошибки, описанные в двух первых записях следу-
ющего списка изменений, после обновления вам может потребоваться предпринять дополнитель-
ные действия для исправления испорченных карт свободного места и/или видимости.
E.20.2. Изменения
• Корректировка записи в WAL отметки об очистке карт свободного пространства и видимости
(Паван Деоласи, Хейкки Линнакангас)
Ранее могло получаться так, что эти файлы не восстанавливались корректно при восстановле-
нии после сбоя или оказывались неправильными на резервном сервере. Обращение к недей-
ствительному содержимому карты свободного пространства могло повлечь попытки использо-
вать страницы, которые были стёрты из самого отношения, что обычно приводило к ошибкам
типа «не удалось прочитать блок XXX: прочитано только 0 из 8192 байт». Также были возмож-
ны нарушения контрольных сумм в карте видимости, при включённом механизме контроль-
ных сумм.
2385Замечания к выпуску
Процедуры для определения наличия проблемы и её исправления рассматриваются в https://
wiki.postgresql.org/wiki/Free_Space_Map_Problems.
• Предупреждение возможного повреждения данных в процессе преобразования программой
pg_upgrade карты видимости отношения в формат 9.6 (Том Лейн)
На машинах с порядком байт от старшего, байты новой карты видимости записывались в
неправильном порядке, в результате чего карта оказывалась абсолютно некорректной. В
Windows старая карта считывалась в текстовом режиме, что приводило к некорректным ре-
зультатам, если в карте рядом оказывались байты, представляющие последовательность сим-
волов возврат каретки/перевод строки. Последняя ошибка практически всегда должна была
приводить к сбою pg_upgrade из-за того, что длина файла с картой оказывалась неверной.
Если вы используете компьютер с порядок байт от старшего (таковы многие архитектуры не
Intel) и применяли pg_upgrade для обновления баз с версии до 9.6, вы должны принять, что
все карты видимости некорректны и должны быть перестроены. Для этого достаточно аннули-
ровать карты видимости всех отношений с помощью функции pg_truncate_visibility_map()
расширения contrib/pg_visibility. Более подробную информацию вы можете найти в
https://wiki.postgresql.org/wiki/Visibility_Map_Problems.
• Предотвращение ошибок сериализации при операции добавлении данных, конфликтующей с
собой же, в INSERT … ON CONFLICT (Томас Мунро, Питер Геохеган)
• Ликвидация риска использования после освобождения при выполнении агрегатных функций с
DISTINCT (Питер Геохеган)
Это могло приводить к отказам или некорректным результатам запросов.
• Исправление обработки полиморфных агрегатных функций, используемых в качестве оконных
(Том Лейн)
Функции перехода агрегата сообщалось, что её первый аргумент и результат имеют выходной
тип агрегата, а не тип состояния. Это приводило к ошибкам или сбоям в функциях перехода,
связанных с полиморфными агрегатами.
• Исправление COPY со списком имён столбцов из таблицы, в которой включена защита на уров-
не строк (Адам Брайтвелл)
• Исправление EXPLAIN, чтобы она выдавала корректный XML, когда параметр track_io_timing
включён (Маркус Винанд)
Ранее вывод в формате XML содержал синтаксически некорректные теги, как например &lt;I/O-
Read-Time&gt;. Сейчас выдаётся такой тег: <I-O-Read-Time>.
• Исправление обновления статистики при TRUNCATE в подготовленной транзакции (Стас Кель-
вич)
• Исправление ошибок при объединении наследуемых ограничений CHECK в процессе создания
или изменения структуры таблицы (Том Лейн, Амит Ланготе)
Теперь одинаковые ограничения CHECK могут добавляться в родительскую и дочернюю таб-
лицу в любом порядке. С другой стороны, слияние проверенного ограничения из родитель-
ской таблицы с непроверенным (NOT VALID) ограничением в дочерней не должно допускаться.
Подобным образом, не должно допускаться слияние дочернего ненаследуемого (NO INHERIT)
ограничения с наследуемым.
• Вывод разумного значения в pg_settings.unit для параметров min_wal_size и max_wal_size
(Том Лейн)
• Исправление замены элементов массива в jsonb_set() (Том Лейн)
Если целью замены был существующий элемент массива JSON, он удалялся, а не заменялся
новым.
2386Замечания к выпуску
• Предотвращение очень маловероятного повреждения данных в результате проверки видимо-
сти кортежа без удержания блокировки буфера (Томас Мунро, Питер Геохеган, Том Лейн)
• Сохранение времени фиксирования транзакций после перезагрузки сервера (Жульен Рухо,
Крейг Рингер)
При включённом параметре track_commit_timestamp старые метки времени фиксации стано-
вились недоступными после полной перезагрузки сервера.
• Исправление логического декодирования WAL в случаях, когда вывод WAL из подтранзакции
оказывался слишком большим и вымещался на диск (Андрес Фройнд)
• Ликвидация проблемы с недействительным указателем в механизме логического декодирова-
ния WAL (Стас Кельвич)
• Округление размера запроса разделяемой памяти до числа, кратного размеру огромной стра-
ницы, когда огромные страницы используются в Linux (Том Лейн)
Это позволяет избежать возможных сбоев в munmap() в системах с нетипичными размерами
огромных страниц. За исключением случаев краха, эти сбои проявлялись только в сообщениях
в журнале.
• Не пытаться разделять контекст SSL между несколькими подключениями в libpq (Хейкки
Линнакангас)
Такое разделение приводило к разнообразным ошибкам, особенно при попытке использова-
ния различных параметров SSL для разных соединений.
• Предотвращение утечек памяти в особых случаях в libpq (Том Лейн)
Поступило сообщение об утечке в процессе PQreset(), но были возможны проявления и в свя-
занных случаях.
• В pg_upgrade проверка загружаемости библиотек должна производиться по порядку имён
(Том Лейн)
Это обходное решение проблемы зависимостей между расширениями, образуемых связями
модулей трансформации языков с базовыми модулями самих языков и типов данных.
• Исправление pg_upgrade для корректной работы с расширениями, содержащими методы до-
ступа индексов (Том Лейн)
Чтобы это было возможно, для сервера была добавлена поддержка команды ALTER EXTENSION
ADD/DROP ACCESS METHOD. Эта функциональность должна была добавляться в изначальной до-
работке, реализующей динамическое создание методов доступа, но этого не произошло по
упущению.
• Улучшение вывода ошибок в pg_upgrade при копировании/создании ссылок/перезаписи (Том
Лейн, Альваро Эррера)
• Исправление pg_dump для поддержки серверов версий до 7.4 (Амит Ланготе, Том Лейн)
• Недопущение одновременного указания аргументов --source-server и --source-target для
pg_rewind (Михаэль Банк)
• Программа pg_rewind должна отключать synchronous_commit в своём сеансе на исходном сер-
вере (Михаэль Банк, Микаэль Пакье)
При этом pg_rewind сможет работать, даже когда на исходном сервере настроена синхронная
репликация, но она по какой-то причине не функционирует.
• В pg_xlogdump нужно повторять попытку открыть новый сегмент WAL, когда используется па-
раметр --follow (Магнус Хагандер)
Это позволяет справиться с возможной задержкой при создании сервером следующего сег-
мента.
2387Замечания к выпуску
• Исправление в contrib/pg_visibility, чтобы выдавался корректный TID испорченного кор-
тежа (ранее TID мог выдаваться некорректно вследствие изменения, впоследствии отменённо-
го) (Том Лейн)
• Исправление зависимостей в makefile, чтобы параллельная сборка PL/Python сама по себе вы-
полнялась надёжно (Павел Райскуп)
• Обновление данных часовых поясов до версии tzdata 2016h, включающее изменение правил
перехода на летнее время в Палестине и Турции, а также исторические изменения для Тур-
ции и некоторых регионов России. Переход к числовым аббревиатурам для некоторых часовых
поясов в Антарктике, бывшем Советском Союзе и на Шри-Ланке.
Ранее в базе данных часовых поясов IANA предоставлялись текстовые аббревиатуры для
всех часовых поясов и иногда при этом указывались аббревиатуры, которые практически не
употреблялись местным населением. Сейчас происходит процесс ухода от этой практики в
пользу использования числовых смещений UTC в тех часовых поясах, где нет никаких свиде-
тельств реального использования английской аббревиатуры. Как минимум на данном этапе,
PostgreSQL продолжит принимать подобные удалённые аббревиатуры при вводе дат/времени.
Но они не будут видны при просмотре представления pg_timezone_names и не будут выводить-
ся с датами/временем.
Начиная с этого выпуска, аббревиатура AMT более не считается занятой часовым поясом Ар-
мении. Поэтому мы изменили значение этой аббревиатуры по умолчанию, чтобы она обозна-
чала Амазонское время (Amazon Time), так что теперь она означает UTC-4, а не UTC+4.
E.21. Выпуск 9.6
Дата выпуска:
2016-09-29
E.21.1. Обзор
В число ключевых усовершенствований PostgreSQL 9.6 входят:
• Параллельное выполнение последовательного сканирования, соединений и агрегатных вычис-
лений
• Предупреждение излишнего сканирования страниц при операциях очистки с заморозкой
• При синхронной репликации стало возможным использовать несколько резервных серверов
для увеличения надёжности
• Полнотекстовый поиск теперь позволяет находить фразы (несколько соседних слов)
• postgres_fdw теперь может выполнять на удалённой стороне соединение, сортировку, UPDATE
и DELETE
• Существенное увеличение производительности, особенно в части масштабируемости на мно-
гопроцессорных серверах
Предыдущие пункты более подробно описаны в следующих разделах.
E.21.2. Миграция на версию 9.6
Тем, кто хочет мигрировать данные из любой предыдущей версии, необходимо выполнить выгруз-
ку/загрузку данных с помощью pg_dumpall или воспользоваться pg_upgrade.
В версии 9.6 реализован ряд изменений, которые могут повлиять на совместимость с предыдущими
выпусками. Рассмотрите следующие несовместимые аспекты:
• Добавление в pg_stat_activity информации о том, чего ждёт процесс (Амит Капила, Ильдус
Курбангалиев)
Исторически процесс показывался как ожидающий, только если он ожидал тяжёлой блоки-
ровки. Теперь в pg_stat_activity также показываются ожидания лёгких блокировок и за-
2388Замечания к выпуску
креплений буферов. Также теперь виден тип ожидаемой блокировки. В результате этих изме-
нений столбец waiting был заменён столбцами wait_event_type и wait_event.
• В функции to_char() знак минус не должен считаться частью поля с заданной шириной для
компонентов времени (Брюс Момджян)
Например, to_char('-4 years'::interval, 'YY') теперь возвращает -04, а не -4.
• Более разумное поведение функции extract() с бесконечными значениями в аргументах (Ви-
талий Буровой)
Ранее функция extract() просто возвращала ноль для аргумента «бесконечность», вне зави-
симости от выбранного поля. Теперь она будет возвращать infinity или -infinity соответ-
ственно, когда это поле является монотонно возрастающим (например, year, epoch), и NULL
в противном случае (например, day, hour). Также теперь выдаётся ожидаемая ошибка при
некорректном указании поля.
• Ликвидация «особенности» PL/pgSQL, подавляющей строку КОНТЕКСТ в сообщениях, выдавае-
мых командами RAISE (Павел Стехуле)
Этот древний трюк для обратной совместимости по общему мнению пережил то время, когда
он был полезен.
• Исправление стандартного анализатора текстового поиска, чтобы он принимал начальные
цифры во фрагментах текста типа email и host (Артур Закиров)
В большинстве случаев это не должно отразиться на разборе текста, но если вы часто имее-
те дело с такими адресами, может иметь смысл перестроить зависимые столбцы и индексы
tsvector, чтобы адреса этих видов корректно находились при поиске.
• Расширение стандартного файла unaccent.rules в модуле contrib/unaccent для обработки
всех существующих в Unicode диакритик и корректного разворачивания лигатур (Томас Мун-
ро, Леонард Бенедетти)
Предыдущая версия не считала нужным преобразовывать некоторые редкие буквы с диакри-
тическими знаками. Кроме того, лигатуры теперь разворачиваются в отдельные буквы. В ин-
сталляциях, где используется этот файл правил, может иметь смысл перестроить столбцы
tsvector и зависимые индексы.
• Ликвидация давно считавшихся устаревшими указаний CREATEUSER/NOCREATEUSER команды
CREATE ROLE и родственных ей (Том Лейн)
Указание CREATEUSER на самом деле означало SUPERUSER из давних соображений относительно
обратной совместимости. Это постоянно вводило в заблуждение людей, которые полагали (и
имели на это право), что оно означало CREATEROLE. Это указание считается устаревшим уже
десять лет, так что пора решить эту проблему, убрав его.
• Считать имена ролей, начинающиеся с pg_, зарезервированными (Стивен Фрост)
Теперь пользователям будет запрещено создавать роли с такими именами. Это предотвращает
конфликты со встроенными ролями, создаваемыми программой initdb.
• Смена имени столбца в представлении information_schema.routines с
result_cast_character_set_name на result_cast_char_set_name (Клеман Прево)
Стандарт SQL:2011 устанавливает более длинное имя, но это, скорее всего, ошибка, так как у
соседних столбцов имена более краткие, как и в других представлениях information_schema.
• Параметр psql -c теперь не подразумевает поведение параметра --no-psqlrc (Павел Стехуле,
Каталин Якоб)
Для получения старого поведения нужно явно написать --no-psqlrc (или сокращение -X).
Модифицированные таким образом скрипты будут продолжать работать и со старыми версия-
ми psql.
2389Замечания к выпуску
• Усовершенствование функции параметра pg_restore -t, чтобы он отбирал все типы отноше-
ний, а не только простые таблицы (Крейг Рингер)
• Изменение формата отображения NextXID в pg_controldata и связанных местах (Джо Конвей,
Брюс Момджян)
Отображение значений эпоха-и-ID-транзакции в формате число:число. Предыдущий формат
число/число был похож на формат LSN, что могло вводить в заблуждение.
• Функции расширений, для которых это уместно, помечены как безопасные для распараллели-
вания (Андреас Карлссон)
Во многие стандартные расширения внесены изменения, чтобы их функции могли выполнять-
ся параллельными исполнителями запросов. Эти изменения не вступят в силу в базах данных,
обновлённых с предыдущих версий (с помощью pg_upgrade), пока вы не примените для каждо-
го такого расширения команду ALTER EXTENSION UPDATE (в каждой базе данных кластера).
E.21.3. Изменения
Ниже вы найдёте подробный список изменений, произошедших между предыдущим основным вы-
пуском и выпуском PostgreSQL 9.6.
E.21.3.1. Сервер
E.21.3.1.1. Параллельное выполнение запросов
• Параллельные запросы (Роберт Хаас, Амит Капила, Дэвид Роули и многие другие)
С версией 9.6 в PostgreSQL появляется начальная поддержка параллельного выполнения
больших запросов. Параллельному выполнению подлежат строго запросы только на чтение, в
которых производится последовательное сканирование целевой таблицы. В параллельном ре-
жиме могут выполняться и соединения по хешу с вложенными циклами, а также агрегирова-
ние (с поддерживаемыми агрегатными функциями). Ещё многое предстоит сделать, но и этот
набор возможностей уже весьма полезен.
Параллельное выполнение запросов по умолчанию отключено (пока). Чтобы выключить
его, установите для нового конфигурационного параметра max_parallel_workers_per_gather
значение, большее нуля. Для дополнительной настройки распараллеливания запросов
также введены новые параметры force_parallel_mode, parallel_setup_cost, parallel_tuple_cost и
min_parallel_relation_size.
• Инфраструктура для обозначения параллельно-безопасности функций (Роберт Хаас, Амит Ка-
пила)
E.21.3.1.2. Индексы
• Индексы GIN строятся более эффективно при значениях maintenance_work_mem, превышаю-
щих 1 ГБ (Роберт Абрахам, Фёдор Сигаев)
• Включение страниц, удаляемых из очереди обработки индекса GIN, сразу в карту свободного
пространства (Джефф Джейнс, Фёдор Сигаев)
Это предотвращает замусоривание базы, если таблица очищается нечасто.
• Добавление функции gin_clean_pending_list(), позволяющей вручную вызвать очистку оче-
реди обработки индекса GIN (Джефф Джейнс)
Ранее такая очистка производилась только в результате очистки или анализа родительской
таблицы.
• Оптимизация обработки «мёртвых» кортежей в индексах GiST (Анастасия Лубенникова)
Кортежи в индексе теперь помечаются как «мёртвые», если при сканировании индекса обна-
руживается, что соответствующий кортеж в куче — «мёртвый». Впоследствии, при добавле-
2390Замечания к выпуску
нии новых кортежей, кортежи, помеченные как «мёртвые», могут быть замещены, если потре-
буется место на этой странице.
• Добавлен класс операторов SP-GiST для типа box (Александр Лебедев)
E.21.3.1.3. Сортировка
• Увеличение производительности сортировки за счёт использования quicksort вместо выбора с
замещением при выполнении этапов внешней сортировки (Питер Геохеган)
Новый подход позволяет эффективнее использовать кеш процессора при типичных размерах
кеша и объёмах данных. Где необходимо, новое поведение можно скорректировать, воспользо-
вавшись новым конфигурационным параметром replacement_sort_tuples.
• Ускорение сортировки текста, когда одна и та же строка встречается многократно (Питер
Геохеган)
• Ускорение сортировки типов uuid, bytea и char(n) за счёт использования «сокращённых»
ключей (Питер Геохеган)
Поддержка сокращённых ключей была также добавлена в дополнительные классы операторов
text_pattern_ops, varchar_pattern_ops и bpchar_pattern_ops. Сокращённые ключи теперь
могут задействоваться и при вычислении сортирующих агрегатных функций.
• Ускорение команды CREATE INDEX CONCURRENTLY за счёт обработки идентификаторов TID как
64-битных целых в процессе сортировки (Питер Геохеган)
E.21.3.1.4. Блокировки
• Уменьшение конкуренции за ProcArrayLock (Амит Капила, Роберт Хаас)
• Улучшение производительности за счёт переноса блокировок содержимого буфера в дескрип-
торы буферов (Андрес Фройнд, Саймон Риггс)
• Замена циклических блокировок заголовков в общем буфере атомарными операциями для
улучшения масштабируемости (Александр Коротков, Андрес Фройнд)
• Использование атомарных операций вместо циклических блокировок для защиты очереди
ожидания LWLock (Андрес Фройнд)
• Разбиение на части списка свободных элементов для разделяемых по хешу таблиц, для умень-
шения конкуренции на многопроцессорных серверах (Александр Алексеев)
• Сокращение взаимоблокировок на резервных серверах при воспроизведении операций очист-
ки индекса-B-дерева (Саймон Риггс)
Это изменение исключает существенные задержки при репликации, которые иногда имели
место при воспроизведении таких операций.
E.21.3.1.5. Статистика оптимизатора
• Улучшение оценок ANALYZE для столбцов с большим количеством NULL (Томаш Вондра, Алек-
сандр Шульгин)
Ранее процедура ANALYZE была склонна недооценивать число различных и отличных от NULL
значений в столбце со множеством NULL, и также неточно вычисляла наиболее распростра-
нённые значения.
• Улучшение оценки планировщиком количества различных значений в результате запроса (То-
маш Вондра)
• Использование связей по внешним ключам для оценки избирательности предикатов соедине-
ния (Томаш Вондра, Дэвид Роули)
Если в таблице t имеется ограничение внешнего ключа, например (a,b) REFERENCES r
(x,y), то условие WHERE вида t.a = r.x AND t.b = r.y не может выбрать больше одной стро-
ки из r для строки t. Ранее планировщик считал объединённые AND условия независимыми и
2391Замечания к выпуску
поэтому часто неправильно оценивал избирательность запроса. Теперь он сравнивает условия
WHERE с применимыми ограничениями внешнего ключа и получает более точные оценки.
E.21.3.1.6. VACUUM
• Предупреждение повторной очистки страниц, содержащих только замороженные кортежи
(Масахико Савада, Роберт Хаас, Андрес Фройнд)
Ранее очистка для предотвращения зацикливания должна была просматривать все страницы
таблицы, даже страницы, с которыми ничего не нужно делать. Теперь страницы, содержащие
только замороженные кортежи, обозначаются в карте видимости таблицы, и могут быть про-
пущены при очистке, даже когда она производится в целях предотвращения зацикливания
транзакций. Это должно значительно снизить стоимость обслуживания больших таблиц, со-
держащих в основном постоянные данные.
Если необходимо, при очистке можно принудительно включить обработку полностью заморо-
женных страниц, передав нововведённый параметр DISABLE_PAGE_SKIPPING. Это никогда не
нужно делать в обычных условиях, но при повреждении карты видимости это может быть по-
лезно.
• Предупреждение бесполезных попыток усечения кучи в процессе VACUUM (Джефф Джейнс,
Том Лейн)
Это изменение предотвращает исключительную блокировку таблицы в некоторых случаях, ко-
гда усечение таблицы невозможно. Прежде всего это полезно тем, что позволяет лишний раз
не отменять запросы на резервных серверах.
E.21.3.1.7. Общая производительность
• Возможность аннулирования старых снимков MVCC после настраиваемого промежутка вре-
мени (Кевин Гриттнер)
Обычно удалённые кортежи не могут быть ликвидированы физически при очистке, пока не
будет отработана последняя транзакция, в которой они могут быть видны. Транзакция, оста-
ющаяся открытой в течение долгого времени, таким образом может стать причиной значи-
тельного замусоривания таблицы, препятствуя освобождению места. Это средство позволяет
задать с помощью нового конфигурационного параметра old_snapshot_threshold ограничение
времени, в течение которого снимок MVCC будет гарантированно актуальным. По истечении
этого времени мёртвые кортежи могут быть удалены. Транзакция, использующая просрочен-
ный снимок, получит ошибку, если она попытается прочитать страницу, которая могла бы со-
держать такие данные.
• Игнорирование в GROUP BY столбцов, функционально зависящих от других (Дэвид Роули)
Если в предложение GROUP BY включаются все столбцы неотложенного первичного ключа, а
также другие столбцы той же таблицы, последние столбцы являются избыточными и могут
быть исключены из группировки. Во многих распространённых случаях это упрощает вычис-
ления.
• Возможность использования сканирования только индекса с частичным индексом, когда
предложение WHERE индекса обращается к не индексированным столбцам (Томаш Вондра, Кё-
таро Хоригути)
Например, индекс, определённый командой CREATE INDEX tidx_partial ON t(b) WHERE a &gt;
0, теперь может использоваться для сканирования только по индексу в запросе, в котором за-
даётся условие WHERE a &gt; 0 и никак больше не задействуется a. Ранее это использование не
допускалось, на основании того, что a не входит в число столбцов индекса.
• Выполнение записи в контрольных точках упорядоченным образом (Фабьен Коэльо, Андрес
Фройнд)
Ранее, в контрольных точках грязные страницы записывались в том порядке, в каком они рас-
полагались в общих буферах, то есть практически в случайном. Это влекло снижение произ-
2392Замечания к выпуску
водительности, особенно на вращающихся носителях. В результате данного изменения запись
в контрольных точках будет производиться по порядку файлов и номеров блоков, и будет сба-
лансирована по табличным пространствам.
• Там, где возможно, вызывать функцию отложенной записи в ядре после некоторого количе-
ства операций записи, во избежание накопления «грязных» данных в дисковых буферах ядра
(Фабьен Коэльо, Андрес Фройнд)
PostgreSQL записывает данные в дисковый кеш ядра, откуда они будут сброшены в физиче-
ское хранилище в нужное время. Многие операционные системы не очень эффективно управ-
ляют этим, позволяя накапливаться в памяти большим объёмам данным, которые затем при-
ходится сбрасывать на диск одномоментно, что приводит к большим задержкам при очеред-
ных операциях ввода/вывода до завершения сброса. Это изменение внесено, чтобы снять эту
проблему, явно запрашивая сброс данных через определённый настраиваемый интервал.
В Linux для этой цели применяется функция sync_file_range(), и так как она практически
безвредна, этот механизм задействуется в Linux по умолчанию. Возможность сброса буфера
доступна и на других платформах, где имеется функция msync() или posix_fadvise(), но эти
функции дают некоторые нежелательные побочные эффекты, поэтому на всех платформах
кроме Linux данный механизм по умолчанию отключён.
Этим поведением управляют новые конфигурационные параметры backend_flush_after,
bgwriter_flush_after, checkpoint_flush_after и wal_writer_flush_after.
• Увеличение производительности агрегатных функций в результате разделения вычислений
между несколькими агрегатами, если они имеют одинаковые аргументы и функции перехода
(Дэвид Роули)
Например, в запросе SELECT AVG(x), VARIANCE(x) FROM tab для строки может быть достаточ-
но одной операции для вычисления обоих агрегатов.
• Ускорение проверок видимости для недавно созданных кортежей путём проверки снимка те-
кущей транзакции, вместо pg_clog, для определения, должна ли исходная транзакция счи-
таться зафиксированной (Джефф Джейнс, Том Лейн)
• Допущение установки вспомогательных битов кортежей на более раннем этапе (Андрес
Фройнд)
• Увеличение производительности подготовленных транзакций с коротким временем жизни
(Стас Кельвич, Саймон Риггс, Паван Деоласи)
Информация о двухфазной фиксации теперь записывается только в WAL во время PREPARE
TRANSACTION и считывается назад из WAL во время COMMIT PREPARED, если это имеет место
вскоре. Отдельный файл состояния создаётся, только если ожидающая транзакция не фикси-
руется и не прерывается к моменту следующей контрольной точки.
• Увеличение скорости уничтожения контекста памяти (Ян Вик)
• Увеличение производительности владельцев ресурсов с большим количеством отслеживаемых
объектов (Александр Алексеев)
• Увеличение скорости функций вывода типов timestamp, time и date (Дэвид Роули, Андрес
Фройнд)
• Недопущение некоторых излишних отмен запросов на серверах горячего резерва при воспро-
изведении действий, требующих блокировок AccessExclusive (Джефф Джейнс)
• Расширение отношений на несколько блоков сразу при конкуренции за блокировку расшире-
ния отношения (Дилип Кумар)
Это улучшает масштабируемость и снижает уровень конфликтов.
• Увеличение числа буферов clog для лучшей масштабируемости (Амит Капила, Андрес
Фройнд)
2393Замечания к выпуску
• Ускорение вычисления выражений в PL/pgSQL за счёт постоянного хранения в памяти запи-
сей ParamListInfo для простых переменных (Том Лейн)
• Недопущение уменьшения значения SO_SNDBUF ниже значения по умолчанию в последних
версиях Windows (Чен Хуацзюнь)
• Отключение механизма update_process_title по умолчанию в Windows (Такаюки Цунакава)
В Windows издержки изменения заголовка процесса гораздо выше, чем на многих других
платформах, и само это изменение менее полезно, так как большинство пользователей
Windows не имеют утилит для наблюдения за заголовками процессов.
E.21.3.1.8. Наблюдение
• Добавление системного представления pg_stat_progress_vacuum для наблюдения за процес-
сом выполнения операций VACUUM (Амит Ланготе, Роберт Хаас, Винаяк Покале, Рахила Сьед)
• Добавление функций pg_control_system(), pg_control_checkpoint(), pg_control_recovery()
и pg_control_init(), выдающих поля pg_control в SQL (Джо Конвей, Микаэль Пакье)
• Добавление системного представления pg_config (Джо Конвей)
В этом представлении выводится та же информация, что выдаётся утилитой командной стро-
ки pg_config, а именно разнообразные конфигурационные параметры времени компиляции
PostgreSQL.
• Добавление столбца confirmed_flush_lsn в системное представление pg_replication_slots
(Марко Тииккая)
• Добавление системного представления pg_stat_wal_receiver с информацией о состоянии
процесса приёмника WAL на сервере горячего резерва (Микаэль Пакье)
• Добавление функции pg_blocking_pids() для надёжного определения, какие сеансы блокиру-
ют какие (Том Лейн)
Эта функция возвращает массив идентификаторов процессов всех сеансов, которые блокиру-
ют сеанс с заданным идентификатором. Ранее пользователи получали такую информацию,
образуя замкнутое соединение с представлением pg_locks. Однако сделать это сколь-нибудь
корректно слишком сложно, а с внедрением параллельных запросов старый подход стал пол-
ностью непрактичным, так как блокировки могут удерживаться или запрашиваться дочерни-
ми рабочими процессами, а не главным обслуживающим процессом сеанса.
• Добавление функции pg_current_xlog_flush_location() для вывода текущей позиции сбро-
шенной записи в журнале транзакции (Томаш Вондра)
• Добавление функции pg_notification_queue_usage(), показывающей, насколько заполнена
очередь NOTIFY (Брендан Юрд)
• Ограничение подробностей при выводе статистики использования контекстов памяти (Том
Лейн)
Информация об использовании памяти, выводимая в протокол главного сервера при нехватке
памяти, теперь включает итоговую статистику при большом числе контекстов памяти, вместо
одного объёмного отчёта. Также в неё теперь входит итоговая строка «Всего».
E.21.3.1.9. Аутентификация
• Добавление метода аутентификации BSD, позволяющего использовать для проверки подлин-
ности клиентов PostgreSQL системную службу аутентификации BSD (Мариса Эмерсон)
Аутентификация BSD в настоящее время поддерживается только в OpenBSD.
• Когда используется аутентификация PAM, через поле PAM_RHOST модулям PAM может выда-
ваться IP-адрес или имя компьютера клиента (Гжегож Сампольски)
• Добавление вывода в протокол сервера сообщений о дополнительных типах ошибок при про-
верке пароля (Том Лейн)
2394Замечания к выпуску
Теперь в случае любых ошибок, которые обычно могут возникать, в протокол должны выда-
ваться сообщения уровня ПОДРОБНО.
• Поддержка паролей RADIUS длиной до 128 символов (Марко Тииккая)
• Добавление новых параметров аутентификации SSPI compat_realm и upn_username, позволяю-
щих выбрать, как при проверке подлинности SSPI будут использоваться имена области и поль-
зователя (NetBIOS или Kerberos) (Кристиан Ульрих)
E.21.3.1.10. Настройка сервера
• Возможность автоматического завершения сеансов, которые находятся в состоянии простоя в
транзакции слишком долго (Вик Фиринг)
Данное поведение настраивается новым конфигурационным параметром
idle_in_transaction_session_timeout. Это помогает бороться с забытыми транзакциями, которые
могут удерживать блокировки или мешать производить очистку в течение длительного време-
ни.
• Увеличение максимально допустимого значения checkpoint_timeout до 24 часов (Саймон
Риггс)
• Возможность устанавливать effective_io_concurrency для табличного пространства; это по-
лезно в случаях, когда различные табличные пространства имеют разные характеристики
ввода/вывода (Жульен Рухо)
• Добавление в log_line_prefix спецкода %n для вывода текущего времени в формате Unix, с мил-
лисекундами (Томаш Вондра, Джефф Дэвис)
• Добавление конфигурационных параметров syslog_sequence_numbers и syslog_split_messages
для дополнительной манипуляции форматом сообщений при выводе их в syslog (Питер Эйзен-
траут)
• Объединение значений archive и hot_standby конфигурационного параметра wal_level в од-
ном новом значении replica (Питер Эйзентраут)
Различать эти варианты больше не имеет смысла, и их слияние является шагом вперёд к за-
планированному упрощению организации репликации. Старые варианты по-прежнему прини-
маются, но внутри преобразуются к replica.
• Добавление в configure параметра --with-systemd, позволяющего вызывать sd_notify() при
запуске и остановке сервера (Питер Эйзентраут)
Это позволяет использовать единицы служб systemd типа notify, что значительно упрощает
управление PostgreSQL в окружении systemd.
• Теперь к файлу SSL-ключа сервера может быть разрешён доступ группы на чтение, если он
принадлежит пользователю root (Кристоф Берг)
Ранее мы настаивали на том, чтобы файл ключа принадлежал пользователю, запускающему
сервер PostgreSQL, но это оказалось неудобным в некоторых системах (например, в Debian),
в которых организовано централизованное управление сертификатами. Поэтому стоит допу-
стить случай, когда файл принадлежит root, а группа имеет доступ на чтение. И в этом слу-
чае администратор отвечает за то, чтобы в эту группу не входили недоверенные пользовате-
ли.
E.21.3.1.11. Надёжность
• Принудительное завершение обслуживающих процессов в случае отключения главного про-
цесса (Раджив Растоги, Роберт Хаас)
При нормальных обстоятельствах главный процесс всегда должен жить дольше своих дочер-
них процессов. Если же он по какой-то причине умирает, процессы, обслуживающие клиен-
тов, принудительно завершаются с ошибкой. Ранее работающие процессы продолжали выпол-
няться до отключения клиента; но это было небезопасно и неэффективно. Это также не дава-
2395Замечания к выпуску
ло запустить новый управляющий процесс до завершения последнего из старых обслуживаю-
щих процессов. Теперь обслуживающие процессы будут проверять, жив ли главный процесс,
ожидая ввода/вывода от клиента, так что они завершатся не мгновенно, но это должно про-
изойти не позже завершения текущего запроса.
• Проверка конфликтов сериализуемости перед тем, как будет выдана ошибка нарушения огра-
ничений (Томас Мунро)
В транзакциях сериализуемого уровня изоляции желательно, чтобы ошибка, вызванная па-
раллельными транзакциями, заявлялась как ошибка сериализации, что скажет приложению,
что попытка повторить то же действие может быть успешной. К сожалению, это не будет на-
дёжно работать при дублировании ключа при параллельном его добавлении. В результате это-
го изменения такая ошибка будет выдаваться как ошибка сериализации, если приложение яв-
но проверяет присутствие конфликтующего ключа (и не находит его) до этого в транзакции.
• Сообщения аннулирования должны записываться в WAL, даже если они выдаются транзакци-
ей, которой не назначен XID (Андрес Фройнд)
Это решает проблемы в особых случаях, когда транзакции на резервных серверах не замечали
некоторые изменения, например, создание индексов.
• Предупреждение одновременной отработки несколькими процессами очереди изменений в
индексе GIN (Фёдор Сигаев, Джефф Джейнс)
Это допускалось намеренно, но вызывало условия гонки, при которых процедура очистки про-
пускала записи в индексе, которые нужно было удалить.
E.21.3.2. Репликация и восстановление
• Возможность при синхронной репликации задействовать одновременно несколько синхрон-
ных резервных серверов (раньше поддерживался только один) (Масахико Савада, Бина Эмер-
сон, Микаэль Пакье, Фудзии Масао, Кётаро Хоригути)
Число резервных серверов, которые должны подтвердить фиксацию, прежде чем
она будет считаться завершённой, теперь устанавливается в значении параметра
synchronous_standby_names.
• Добавление нового значения remote_apply для конфигурационного параметра
synchronous_commit (Томас Мунро)
В этом режиме главный сервер ждёт, пока транзакция не будет применена на резервном, а не
просто сохранена на диске. Это значит, что можно рассчитывать, что транзакция, запущен-
ная на резервном сервере, будет видеть все изменения, подтверждённые на главном.
• Усовершенствование протокола репликации и добавление параметра в функцию
pg_create_physical_replication_slot() для немедленного резервирования WAL при созда-
нии слота репликации (Гуржит Сингх, Микаэль Пакье)
Это позволяет при создании слота репликации гарантировать, что будут доступны все файлы
WAL, нужные для базовой копии.
• Добавление ключа --slot для pg_basebackup (Питер Эйзентраут)
Это позволяет pg_basebackup использовать слот репликации, созданный для трансляции WAL.
Выбрав тот же слот для обычной потоковой репликации после создания базовой резервной ко-
пии, можно запустить новый резервный сервер, не прерывая приём потока.
• Доработка функций pg_start_backup() и pg_stop_backup() для поддержки немонопольного
резервного копирования (Магнус Хагандер)
E.21.3.3. Запросы
• Функции, возвращающие наборы кортежей, теперь могут возвращать просто NULL (Эндрю
Гирт, Том Лейн)
2396Замечания к выпуску
В контексте SELECT FROM function(...) функция, возвращающая набор составных значений,
не могла вернуть обычное значение NULL в составе набора. Теперь это допускается и такой ре-
зультат воспринимается как строка с полями NULL. Это позволяет избежать ошибок в особых
случаях, например, при разворачивании массива составных значений.
• Полная поддержка указаний индексов массивов и выбора полей в списке целевых столбцов
команды INSERT с несколькими строками VALUES (Том Лейн)
Ранее в таких ситуациях возникала ошибка, если один и тот же целевой столбец упоминался
более одного раза, например так: INSERT INTO tab (x[1], x[2]) VALUES (...).
• Когда уместно, вычисление выходных выражений SELECT откладывается и производится после
сортировки ORDER BY (Константин Книжник)
В результате этого изменения изменчивые или дорогостоящие функции в выходном спис-
ке выполняются в порядке, установленном предложением ORDER BY, и не будут вычисляться
лишний раз, когда присутствует предложение LIMIT. Ранее эта оптимизация имела место, ко-
гда сортировка выполнялась при сканировании индекса или перед соединением слиянием, но
не когда она производилась на верхнем уровне запроса.
• Расширение счётчиков, хранящих число обработанных кортежей, до 64 бит (Андреас Шерба-
ум)
В результате этого изменения в метках команд, например SELECT, теперь будут корректно вы-
даваться количества кортежей, превышающие 4 миллиарда. Это также распространяется на
команду GET DIAGNOSTICS ... ROW_COUNT в PL/pgSQL.
• Уход от преобразования некоторых кодировок через кодировку MULE_INTERNAL (Том Лейн)
Ранее преобразования кириллических и центральноевропейских однобайтовых кодировок за-
частую выполнялись путём перевода в связанную схему MULE_INTERNAL, и только затем в целе-
вую кодировку. Помимо того, что это неэффективно, это означает, что при обнаружении непе-
реводимого символа будет выдано некорректное сообщение об ошибке преобразования в/из
кодировки MULE_INTERNAL, а не кодировки, видимой пользователю.
• Допускать удалённое соединение сторонних таблиц, только если к ним обращается одна и та
же роль (Шигеру Ханада, Ашутош Бапат, Эцуро Фудзита)
Ранее инфраструктура вынесения соединений наружу доверяла заботу о безопасности цели-
ком обёрткам сторонних данных, но при этом в обёртке слишком легко могли непреднамерен-
но образовываться неочевидные уязвимости. Поэтому решено было в коде ядра определять,
какая роль обращается к каждой таблице, и пытаться выносить соединение наружу, только
если это одна роль для всех задействованных отношений.
E.21.3.4. Служебные команды
• Поддержка в COPY копирования вывода запроса INSERT/UPDATE/DELETE ... RETURNING (Марко Ти-
иккая)
Ранее для этого приходилось создавать промежуточные CTE (общие табличные выражения).
• Введение команды ALTER объект DEPENDS ON EXTENSION (Абхиджит Менон-Сен)
Эта команда позволяет пометить объект базы данных как зависимый от расширения, чтобы он
автоматически ликвидировался при удалении расширения (без явного указания CASCADE). Но
при этом такой объект не будет частью расширения и поэтому pg_dump будет выгружать его
отдельно.
• Команда ALTER объект SET SCHEMA теперь не будет делать ничего, если объект уже относится
к заданной схеме, вместо того, чтобы выдавать ошибку, что имело место раньше для большин-
ства типов объектов (Марти Раудсепп)
2397Замечания к выпуску
• Добавление в ALTER OPERATOR параметров, позволяющих изменять функции оценки избира-
тельности, связанные с существующим оператором (Юрий Журавлёв)
• Добавление указания IF NOT EXISTS в команду ALTER TABLE ADD COLUMN (Фабрицио де Ройес
Мелло)
• Снижение уровня блокировок, запрашиваемых командой ALTER TABLE при установке фактора
заполнения и параметров отношения, связанных с автоочисткой (Фабрицио де Ройес Мелло,
Саймон Риггс)
• Введение команды CREATE ACCESS METHOD, позволяющей расширениям создавать методы до-
ступа индексов (Александр Коротков, Петр Желинек)
• Добавление указания CASCADE для команды CREATE EXTENSION, позволяющего автоматически
устанавливать расширения, от которых зависит создаваемое (Петр Желинек)
• Команда CREATE TABLE ... LIKE должна включать столбец OID, если он есть в какой-либо из
исходных таблиц (Брюс Момджян)
• Если ограничение CHECK объявлено как NOT VALID (непроверенное) в команде создания табли-
цы, оно должно автоматически помечаться как проверенное (Амит Ланготе, Амул Сул)
Это безопасно, так как в таблице ещё нет строк, и соответствует давно принятому поведению
ограничений FOREIGN KEY.
• Исправлена команда DROP OPERATOR; она должна очищать ссылки на удаляемый оператор
pg_operator.oprcom и pg_operator.oprnegate (Рома Соколов)
Ранее эти ссылки оставлялись как есть, что было чревато проблемами в довольно маловероят-
ных случаях повторного использования OID удалённого оператора другим оператором.
• Один и тот же подплан не должен выдаваться дважды в выводе EXPLAIN (Том Лейн)
В некоторых случаях, обычно с узлами SubPlan в условиях индексов, команда EXPLAIN выводи-
ла данные одного и того же подплана дважды.
• Запрет создания индексов по системным столбцам, за исключением OID (Дэвид Роули)
Такие индексы никогда не считались поддерживаемыми и провоцировали некорректное пове-
дение, так как система могла менять значения системных столбцов, не обновляя индексы. Од-
нако ранее отсутствовали проверки, которые бы мешали их создавать.
E.21.3.5. Управление разрешениями
• Использование системы прав для управления доступом к важным функциям (Стивен Фрост)
Ранее многие требующие ограниченного доступа функции содержали жёстко зашитые про-
верки, которые выдавали ошибки, если эти функции пытался выполнять не суперпользова-
тель. Это вынуждало применять роли суперпользователей для выполнения и некоторых за-
урядных задач. Теперь эти проверки ушли, вместо этого initdb отзывает у роли public право на
выполнение (EXECUTE) этих функций. Это позволяет на местах дать право использовать их до-
веренным ролям, которым не нужны все полномочия суперпользователей.
• Создание нескольких встроенных ролей, используя которые можно давать доступ к операци-
ям, ранее доступным только суперпользователям (Стивен Фрост)
В настоящее время есть только одна такая роль, pg_signal_backend, но в дальнейшем ожида-
ется добавление других ролей.
E.21.3.6. Типы данных
• Усовершенствование полнотекстового поиска; поддержка поиска фраз, то есть лексем, встре-
чающихся рядом в определённом порядке, либо с заданным расстоянием между ними (Фёдор
Сигаев, Олег Бартунов, Дмитрий Иванов)
2398Замечания к выпуску
Запрос поиска фразы может быть записан в значении tsquery с использованием новых опе-
раторов &lt;-&gt; и <N>. Первая запись означает, что лексемы до и после неё должны находиться
рядом и в заданном порядке. Вторая запись означает, что они могут быть разделены ровно N
лексемами.
• Возможность записать указание среза массива без одной или двух границ, например,
array_col[3:] (Юрий Журавлёв)
Опущенные границы воспринимаются как значения верхнего или нижнего предела соответ-
ствующей позиции в массиве. Это позволяет упростить запись срезов во многих распростра-
нённых ситуациях.
• Более аккуратное обращение с датами и временем за пределами допустимого диапазона (Ви-
талий Буровой)
Это изменение предотвращает неожиданные ошибки выхода за пределы диапазона для значе-
ний дата/время с часовым поясом, очень близких к предельным значениям реализации. Ранее
«одно и то же» значение могло быть принято или нет, в зависимости от значения параметра
timezone (часового пояса), и как следствие, ранее выгруженные данные могли не загружаться
из-за значений, который до этого считались приемлемыми. Теперь границы проверяются по
UTC, а не по местному часовому поясу, так что эта проверка не зависит от значения timezone.
Также PostgreSQL теперь более аккуратно выявляет переполнение при вычислениях новых
значений даты или даты/времени, таких как date + integer.
• Обеспечена согласованная обработка значений infinity (бесконечность) и NaN (не число) в
компонентах геометрических типов данных при вводе и выводе (Том Лейн)
Такие значения теперь всегда будут выводиться как они выводились бы в обычном столбце
float8, и таким же образом будут вводиться. Предыдущее поведение зависело от платформы.
• Добавление в словарь ispell поддержки дополнительных языков и современного формата
файлов Hunspell (Артур Закиров)
• Реализация условий с просмотром назад в регулярных выражениях (Том Лейн)
Условие с просмотром назад похоже на условие с просмотром вперёд тем, что оно не вбира-
ет текст; оно проверяет наличие (или отсутствие) соответствия, заканчивающегося в текущей
позиции в строке, а не начинающегося с текущей позиции. Это поддерживают и многие дру-
гие исполнители регулярных выражений.
• Если в регулярных выражениях предположительно трёхсимвольное восьмеричное значение
\nnn превосходит 377 (255 в десятичном виде), должно считываться только двухсимвольное
восьмеричное значение (Том Лейн)
Это поведение соответствует тому, что наблюдается в текущих версиях Tcl.
• Добавление операторов для идентификаторов транзакций xid &lt;&gt; xid и xid &lt;&gt; int4, для согла-
сованности с соответствующими операторами равенства (Микаэль Пакье)
E.21.3.7. Функции
• Добавление функции jsonb_insert() для вставки нового элемента в массив jsonb или ранее
не существовавшего ключа в объект jsonb (Дмитрий Долгов)
• Увеличение точности функций ln(), log(), exp() и pow() для типа numeric (Дин Рашид)
• Добавление функции scale(numeric), выдающей масштаб значения numeric (Марко Тииккая)
• Добавление тригонометрических функций, работающих с градусами (Дин Рашид)
Например, sind() воспринимает свой аргумент в градусах, тогда как sin() — в радианах. Эти
функции до некоторой степени выдают точный результат для аргументов, для которых его
можно ожидать, например, sind(30) = 0.5.
2399Замечания к выпуску
• Обработка аргументов infinity и NaN в тригонометрических функциях по стандарту POSIX
(Дин Рашид)
Стандарт POSIX говорит, что эти функции должны возвращать NaN для аргумента NaN и выда-
вать ошибку для любых значений вне допустимого диапазона (включая infinity). Ранее они
вели себя по-разному на разных платформах.
• Функция to_timestamp(float8) теперь преобразует infinity (бесконечность) в числе с плава-
ющей точкой в infinity в дате (Виталий Буровой)
Ранее она просто выдавала ошибку для аргумента бесконечность.
• Добавление новых функций для значений tsvector (Стас Кельвич)
Это функции ts_delete(), ts_filter(), unnest(), tsvector_to_array(), array_to_tsvector()
и вариация setweight(), устанавливающая вес только для заданных лексем.
• Функции ts_stat() и tsvector_update_trigger() теперь принимают значения, имеющие не
только конкретный ожидаемый тип аргумента, но и тип, двоично совместимый с ним; напри-
мер, они могут принимать citext там, где ожидается text (Фёдор Сигаев)
• Добавление функций num_nulls() и num_nonnulls() с переменным числом аргументов, воз-
вращающих число переданных им значений NULL и значений, отличных от NULL (Марко Ти-
иккая)
Например, их можно использовать в ограничении CHECK(num_nonnulls(a,b,c) = 1), которое
требует, чтобы ровно одно из значений a,b,c было отлично от NULL. Эти функции также могут
применяться для подсчёта элементов NULL и элементов, отличных от NULL, в массиве.
• Добавление функции parse_ident() для разбиения полного (и возможно заключённого в ка-
вычки) идентификатора SQL на компоненты (Павел Стехуле)
• Функция to_number() воспринимает код формата V как признак деления числа на 10 в степе-
ни, заданной цифрами после V (Брюс Момджян)
Таким образом поведение этой функции оказывается обратным к to_char().
• Функции to_reg*() теперь принимают тип text, а не cstring (Пётр Коробейников)
Это избавляет от необходимости записывать явное приведение в большинстве случаев, когда
аргумент не является простой строковой константой.
• Добавление функции pg_size_bytes() для преобразования понятных человеку объёмов в чис-
ла (Павел Стехуле, Виталий Буровой, Дин Рашид)
Эта функция преобразует строки, в частности, те, что выдаёт pg_size_pretty(), в количество
байтов. Использовать её можно, например, так: SELECT oid::regclass FROM pg_class WHERE
pg_total_relation_size(oid) &gt; pg_size_bytes('10 GB').
• Формат вывода отрицательных чисел в pg_size_pretty() не должен отличаться от положи-
тельных (Адриан фон ден Дриш)
Ранее отрицательные числа никогда не сокращались и всегда выводились в байтах.
• Добавление необязательного аргумента missing_ok в функцию current_setting() (Дэвид
Кристенсен)
Это позволяет избежать ошибки при передаче неизвестного имени параметра; вместо ошибки
будет выдан NULL.
• Модификация ряда функций просмотра каталога, чтобы они возвращали NULL при недопусти-
мых входных данных (Микаэль Пакье)
Функция pg_get_viewdef() теперь возвращает NULL, получая неправильный OID представле-
ния; также и другие функции будут возвращать NULL при некорректных параметрах. Ранее в
2400Замечания к выпуску
таких случаях обычно возникали ошибки типа «cache lookup failed» (ошибка поиска в кеше), с
которыми не должны сталкиваться пользователи.
• Избавление функции pg_replication_origin_xact_reset() от аргументов (Фудзии Масао)
В документации говорится, что у неё нет аргументов, и коду функции на C никакие аргументы
не нужны, но в записи в pg_proc по ошибке указаны два аргумента.
E.21.3.8. Языки программирования на стороне сервера
• Выявление некорректных операторов CONTINUE и EXIT в PL/pgSQL при компиляции функции, а
не во время выполнения (Джим Нэсби)
• Расширение функций, выдающих ошибки и сообщения в PL/Python, чтобы они могли переда-
вать помимо основного сообщения и дополнительные поля (Павел Стехуле)
• Исправление механизма вызова функций PL/Python, позволяющее производить рекурсив-
ные вызовы этих функций через SPI, и корректировка поведения в ситуации, когда несколько
функций на PL/Python, возвращающих множества, вызываются в одном запросе (Алексей Гри-
щенко, Том Лейн)
• Ликвидация утечек памяти в пределах длительности сеанса в PL/Python (Хейкки Линнакангас,
Харибабу Комми, Том Лейн)
• Модернизация PL/Tcl, переход от передачи простых строк к «объектному» API Tcl (Джим Нэс-
би, Карл Лехенбауэр)
Это может значительно увеличить производительность в некоторых случаях. Заметьте, что
для PL/Tcl теперь требуется версия Tcl 8.4 или новее.
• В PL/Tcl при возникновении ошибок базы данных теперь возвращается дополнительная инфор-
мация в глобальной переменной Tcl errorCode (Джим Нэсби, Том Лейн)
Это реализовано в соответствии с принятым Tcl соглашением о выдаче дополнительных сведе-
ний об ошибке.
• Исправление логики преобразования кодировки в PL/Tcl; строки в кодировке базы данных
должны преобразовываться в UTF-8 (кодировку, ожидаемую в Tcl) и обратно (Том Лейн)
Ранее строки передавались без преобразования, что приводило к проблемам с символами вне
ASCII, когда кодировка базы была не UTF-8.
E.21.3.9. Клиентские интерфейсы
• Добавление нелокализуемой версии поля серьёзности в сообщения об ошибках и уведомления
(Том Лейн)
Благодаря этому изменению клиентский код может определить уровень серьёзности ошибки
или замечания, не имея дела с локализованными вариантами строки важности.
• Введение в libpq средства подавления поля КОНТЕКСТ в сообщениях об ошибках, либо для всех,
либо только для информационных сообщений (Павел Стехуле)
По умолчанию PQerrorMessage() теперь выводит КОНТЕКСТ только для ошибок. Для корректи-
ровки её поведения предназначена новая функция PQsetErrorContextVisibility().
• Добавление в libpq возможности переформировать сообщение об ошибке с другим уровнем
важности (Алексей Шульгин)
Данную возможность реализует новая функция PQresultVerboseErrorMessage(). Это поддер-
живается новой командой psql \errverbose и может быть также полезно для других клиентов.
• Усовершенствование функции PQhost() в libpq, чтобы она возвращала полезную информацию
при подключении к сокету Unix по умолчанию (Том Лейн)
2401Замечания к выпуску
Ранее она возвращала NULL в отсутствие явного указания адреса узла; теперь она возвращает
путь каталога сокетов по умолчанию.
• Исправление лексического анализатора ecpg, чтобы он корректно обрабатывал разрывы
строк в комментариях, начинающихся в строках с директивами препроцессора (Михаэль Мес-
кес)
E.21.3.10. Клиентские приложения
• Добавление флага --strict-names в pg_dump и pg_restore (Павел Стехуле)
С этим флагом программа выдаст ошибку, не найдя объектов, заданных параметрами -t или -
n, а не просто не будет ничего делать.
• В pg_dump реализована выгрузка локально изменённых назначений прав на системные объек-
ты (Стивен Фрост)
Хотя суперпользователь всегда мог изменить назначения прав для встроенных или создан-
ных расширениями объектов, после выгрузки/загрузки базы эти изменения терялись. Теперь
pg_dump распознаёт такие назначения и выгружает их. (Однако это работает только при вы-
грузке данных с сервера 9.6 или новее.)
• Теперь pg_dump может выгружать объекты, не принадлежащие расширениям, но находящие-
ся в принадлежащих им схемах (Мартин Маркиз)
Ранее такие объекты игнорировались, так как ошибочно считались принадлежащими расши-
рению, которому принадлежала их схема.
• В выводе pg_dump добавлено имя таблицы в метки тех объектов, которые являются уникаль-
ными только в рамках таблицы (как, например, триггеры) (Питер Эйзентраут)
• Поддержка нескольких параметров командной строки -c и -f (Павел Стехуле, Каталин Якоб)
Эти операции выполняются в том порядке, в каком передаются параметры, а затем psql завер-
шается.
• Добавление команды \crosstabview, выводящей результаты запроса в виде перекрёстной таб-
лицы (Даниэль Верите)
В этом виде значения из одного столбца результата запроса располагаются в клетках табли-
цы, заголовки строк и столбцов которой поступают из других столбцов результата.
• Добавление команды \errverbose, выводящей последнюю ошибку сервера с максимальной де-
тализацией (Александр Шульгин)
Этим удобно пользоваться при возникновении неожиданной ошибки — больше не нужно кор-
ректировать переменную VERBOSITY и повторно воспроизводить проблему, чтобы увидеть поля
ошибки, которые не показываются по умолчанию.
• Добавление команд \ev и \sv для редактирования и просмотра определений представлений
(Пётр Коробейников)
Эти команды соответствуют существующим командам \ef и \sf для функций.
• Добавление команды \gexec, выполняющей запрос и передающей полученный результат на
выполнение как тело нового запроса (Кори Хинкер)
• Команда \pset C строка должна устанавливать заголовок таблицы, как это делает \C строка
(Брюс Момджян)
• В режиме автоматического расширения (\pset expanded auto) не нужно применять широкий
формат для запросов результата с всего одним столбцом (Андреас Карлссон, Роберт Хаас)
• Улучшение заголовков, выводимых командой \watch (Микаэль Пакье, Том Лейн)
2402Замечания к выпуску
Добавление названия, если оно было задано командой \pset title, и сокращение предуста-
новленной части заголовка до время (каждые N с). При этом формат времени теперь опреде-
ляется локалью из окружения psql.
• Усовершенствование логики дополнения табуляцией, чтобы в рассмотрение принимался весь
введённый запрос, а не только текущая строка (Том Лейн)
Ранее разбиение команды на несколько строк ломало все правила дополнения табуляцией, ко-
торым нужно было видеть слова в предыдущих строках.
• Многочисленные улучшения механизма завершения табуляцией (Питер Эйзентраут, Вик Фи-
ринг, Кевин Гриттнер, Кётаро Хоригути, Джефф Джейнс, Андреас Карлссон, Фудзии Масао,
Томас Мунро, Масахико Савада, Павел Стехуле)
• Добавление в формат приглашения PROMPT спецкода %p для отображения ID текущего обслу-
живающего процесса (Жульен Рухо)
• Введение средства подавления поля КОНТЕКСТ в сообщения об ошибках, либо для всех, либо
только для информационных сообщений (Павел Стехуле)
Теперь по умолчанию КОНТЕКСТ выводится только для ошибок. И это можно изменить с помо-
щью специальной переменной SHOW_CONTEXT.
• Добавление в вывод \df+ прав доступа к функции и характеристик распараллеливания (Мика-
эль Пакье)
• Команды SQL в pgbench теперь завершаются точкой с запятой, а не переводом строки (Кётаро
Хоригути, Том Лейн)
Благодаря этому изменению, команды SQL в скриптах могут располагаться на нескольких
строках. Существующие нестандартные скрипты придётся подредактировать и добавить точку
с запятой в конце каждой строки, если это не было сделано ранее. (Это не помешает исполь-
зовать тот же скрипт со старыми версиями pgbench.)
• Поддержка арифметики с плавающей точкой, а также некоторых встроенных функций, в вы-
ражениях команд с обратной косой чертой (Фабьен Коэльо)
• Замена \setrandom встроенными функциями (Фабьен Коэльо)
Новые встроенные функции random(), random_exponential() и random_gaussian() делают
то же, что и \setrandom, но проще в использовании, так как их можно задействовать в бо-
лее сложных выражениях. Так как в результате этого добавления команда \setrandom стала
ненужной, она была ликвидирована.
• Возможность многократно запускать и встроенные, а не только нестандартные скрипты (Фаб-
ьен Коэльо)
Для этого введён ключ -b, работающий подобно ключу -f для нестандартных скриптов.
• Возможность изменения вероятностей выбора (весов) скриптов (Фабьен Коэльо)
Когда указывается несколько скриптов, какой из них будет выполняться, для каждой транзак-
ции pgbench выбирается случайным образом. Ранее выбор каждого было равновероятен, но
теперь для разных скриптов можно задать разные вероятности выбора.
• Сбор статистики по каждому скрипту при запуске нескольких скриптов (Фабьен Коэльо)
Это добавляет промежуточный уровень детализации к существующим двум — глобальной ста-
тистике и статистике в разрезе команд.
• Добавление параметра --progress-timestamp для вывода текущего времени эпохи Unix вме-
сто времени с момента запуска теста (Фабьен Коэльо)
• Возможность устанавливать число клиентских соединений (-c), не кратное количеству пото-
ков (-j) (Фабьен Коэльо)
2403Замечания к выпуску
• Когда задаётся параметр -T, завершать работу именно по истечении заданного времени (Фаб-
ьен Коэльо)
Ранее, если выбиралась низкая частота транзакций, программа pgbench могла ждать значи-
тельно дольше заданного времени.
E.21.3.11. Серверные приложения
• Улучшение вывода ошибок в initdb на стадии после начальной инициализации (Том Лейн)
Ранее при возникновении ошибок в качестве «ошибочного запроса» выдавался весь входной
файл; теперь выдаётся только текущий запрос. Чтобы получить желаемое поведение, теперь
запросы во входных файлах initdb нужно разделять пустыми строками.
• Ускорение initdb благодаря использованию только одного серверного сеанса для всех опера-
ций после инициализации (Том Лейн)
• Усовершенствование программы pg_rewind, чтобы она могла работать при изменении целевой
линии времени (Александр Коротков)
Это позволяет, например, перемотать повышенный резервный сервер к какому-то предыдуще-
му состоянию на линии времени прежнего главного сервера.
E.21.3.12. Исходный код
• Удаление устаревших функций heap_formtuple/heap_modifytuple/heap_deformtuple (Питер
Геохеган)
• Добавление макросов, призванных сделать вызовы AllocSetContextCreate() проще и безопас-
нее (Том Лейн)
Теперь указание индивидуальных параметров размера для контекста памяти считается
устаревшим в пользу использования одного из новых макросов ALLOCSET_DEFAULT_SIZES,
ALLOCSET_SMALL_SIZES или ALLOCSET_START_SMALL_SIZES. Однако существующий код будет ра-
ботать по-прежнему.
• Безусловное использование функций static inline в заголовочных файлах (Андрес Фройнд)
Это может привести к предупреждениям или генерации лишнего кода с очень старыми ком-
пиляторами, но упрощение записи стоит того.
• Усовершенствование инфраструктуры тестирования TAP (Микаэль Пакье, Крейг Рингер, Аль-
варо Эррера, Стивен Фрост)
А именно, теперь эта инфраструктура позволяет тестировать сценарии восстановления.
• Когда используется trace_lwlocks, идентифицировать отдельные блокировки по имени (Ро-
берт Хаас)
• Улучшение инфраструктуры psql, обеспечивающей дополнение кода табуляцией (Томас Мун-
ро, Микаэль Пакье)
Правила дополнения табуляцией стали компактнее и писать их стало легче.
• Закрепление системного каталога pg_shseclabel в кеше, чтобы он был доступен при проверке
подлинности в момент подключения (Адам Брайтвелл)
Код ядра не использует этот каталог для аутентификации, но к нему могут обращаться расши-
рения.
• Реструктуризация API методов доступа индексов с целью в большей степени скрыть его на
уровне C (Александр Коротков, Эндрю Гирт)
В результате этого изменения API индексных методов становится больше похожим на API,
принятый для обёрток сторонних данных и генераторов выборки из таблицы. Это упрощает
код C и должно сделать более приемлемой реализацию методов доступа индексов в устанав-
2404Замечания к выпуску
ливаемых расширениях. Данное изменение позволило удалить из системного каталога pg_am
многие столбцы. Чтобы SQL-запросы могли анализировать свойства МД индексов, которые
раньше были доступны в pg_am, были добавлены новые функции проверки свойств.
• Добавление системного каталога pg_init_privs для записи изначальных прав, назначаемых
для объектов, которые создаёт initdb и расширения (Стивен Фрост)
Благодаря этой инфраструктуре pg_dump может выгружать изменённые в данной инсталля-
ции назначения прав на системные объекты. Ранее такие назначения терялись после выгруз-
ки/загрузки, но теперь они сохраняются.
• Изменение способа запрашивания дополнительных лёгких блокировок расширениями (Амит
Капила, Роберт Хаас)
Функция RequestAddinLWLocks() была удалена, а ей на смену пришла
RequestNamedLWLockTranche(). С новым подходом будет проще идентифицировать лёгкие бло-
кировки и сложнее допустить ошибку.
• Усовершенствование тестировщика изоляции, чтобы в состоянии ожидания могли находиться
сразу несколько сеансов; это позволяет тестировать сценарии взаимоблокировок (Роберт Ха-
ас)
• Введение расширяемых типов узлов (КайГай Кохэй)
В результате этого изменения обёртки сторонних данных или провайдеры нестандартного
сканирования могут сохранить данные в дереве плана в более удобном формате, чем было воз-
можно ранее.
• Планировщик должен рассматривать дальнейшие шаги после сканирования/объединения, ге-
нерируя и сравнивая структуры Path; это позволяет упростить большой объём несистематиче-
ской логики (Том Лейн)
Сегодня это изменение практически никак не проявляется для конечных пользователей, но в
будущем оно позволит реализовать множество усовершенствований планировщика, которые
не вписывались в старую структуру кода.
• Поддержка частичного агрегирования (Дэвид Роули, Саймон Риггс)
Это изменение позволяет разделить вычисление агрегатной функции на части, например,
чтобы параллельные рабочие процессы могли вычислять её совместно. В будущем это может
позволить производить агрегатное вычисление по локальным и удалённым данным частично
на удалённой стороне.
• Внедрение универсального механизма для отслеживания процесса выполнения команд (Вина-
як Покале, Рахила Сьед, Амит Ланготе, Роберт Хаас)
• Выделение из psql лексического анализатора flex, чтобы его можно было использовать в дру-
гих клиентских программах (Том Лейн, Кётаро Хоригути)
Это избавляет от необходимости дублировать код для программ, которым нужно достаточно
хорошо понимать команды SQL, чтобы распознавать границы команд. Полноценно реализо-
вать это оказывается гораздо сложнее, чем хотелось бы, и на данный момент только psql из
всех поддерживаемых клиентских программ делает это на самом деле правильно.
Для размещения этого и другого кода, который будут совместно использовать наши клиент-
ские программы, был создан новый подкаталог src/fe_utils/. Раньше для такого совмест-
ного использования приходилось создавать символические ссылки или копировать исходные
файлы во время сборки, что было некрасиво и требовало двойной компиляции.
• Внедрение нового API WaitEventSet для эффективного ожидания набора событий, которые
обычно не меняются от одного цикла ожидания к другому (Андрес Фройнд, Амит Капила)
• Добавление унифицированного интерфейса для добавления записей в WAL (Александр Корот-
ков, Петр Желинек, Маркус Нуллмейер)
2405Замечания к выпуску
Благодаря этому изменению, расширения могут записывать в WAL изменения страниц со
стандартной структурой. При этом проблема воспроизведения WAL без доступа к этому рас-
ширению решается универсальным кодом воспроизведения. Это позволяет расширениям ре-
ализовывать, например, свои методы доступа индексов и рассчитывать на то, что WAL будет
поддерживать их.
• Поддержка произвольных сообщений WAL при логическом декодировании (Петр Желинек,
Андрес Фройнд)
Этот механизм позволяет расширениям вставлять в поток WAL произвольные данные, кото-
рые могут быть прочитаны модулями логического декодирования, но не связаны с физиче-
ским восстановлением данных.
• Реализация возможности для классов операторов SP-GiST сохранять произвольное «переходя-
щее значение» при проходе по индексу (Александр Лебедев, Фёдор Сигаев)
Это может быть нечто вроде «восстановленного значения», но могут быть и произвольные
данные, не обязательно того же типа, что индексируемый столбец.
• Введение уровня сообщений LOG_SERVER_ONLY для ereport() (Дэвид Стил)
Этот уровень обрабатывается как LOG, за исключением того, что такое сообщение никогда не
передаётся клиенту. Он предназначен для организации аудита и подобных приложений.
• Реализация в Makefile цели для сборки всех генерируемых заголовочных файлов (Микаэль
Пакье, Том Лейн)
Теперь, чтобы убедиться, что все генерируемые серверные заголовочные файлы актуальны,
можно выполнить сборку цели submake-generated-headers. Это полезно в подкаталогах, кото-
рые могут собираться «отдельно».
• Поддержка OpenSSL 1.1.0 (Андреас Карлссон, Хейкки Линнакангас)
E.21.3.13. Дополнительные модули
• Добавление параметра конфигурации auto_explain.sample_rate, устанавливающего для
contrib/auto_explain процент запросов, подлежащих анализу (Крейг Рингер, Жульен Рухо)
Это позволяет снизить издержки при большой нагрузке и при этом всё же получать полезную
общую информацию.
• Добавление модуля contrib/bloom, реализующего метод доступа индекса на основе фильтра
Блума (Фёдор Сигаев, Александр Коротков)
Это в первую очередь пилотная реализация метода доступа вне ядра, но этот модуль может
иметь и практическую пользу для запросов, производящих поиск по множеству столбцов.
• В модуле contrib/cube введены операторы расстояния для кубов и поддержка поиска в стиле
kNN в индексах GiST по столбцам типа cube (Стас Кельвич)
• Согласование представления о числах в функциях hstore_to_jsonb_loose() и
hstore_to_json_loose() расширения contrib/hstore (Том Лейн)
Ранее функция hstore_to_jsonb_loose() преобразовывала похожие на числа строки в числа
JSON, а не в строки, даже когда они в точности не соответствовали правилам записи чисел в
JSON. Это не согласовывалось с поведением hstore_to_json_loose(), так что проверки были
усилены для соблюдения синтаксиса JSON.
• Добавление функций оценки избирательности для операторов модуля contrib/intarray с це-
лью улучшения планов запросов, использующих эти операторы (Юрий Журавлёв, Александр
Коротков)
• Доработка функции heap_page_items() в модуле contrib/pageinspect, чтобы она вы-
водила неструктурированные данные в каждом кортеже, а также добавление функций
2406Замечания к выпуску
tuple_data_split() и heap_page_item_attrs() для исследования отдельных полей кортежей
(Николай Шаплов)
• Добавление необязательного параметра, задающего число итераций S2K, в функцию contrib/
pgcrypto в модуле pgp_sym_encrypt() (Джефф Джейнс)
• Добавление возможности оценивать «схожесть слов» в contrib/pg_trgm (Александр Коротков,
Артур Закиров)
Добавленные функции и операторы оценивают схожесть между одной строкой и наиболее по-
хожим отдельным словом в другой строке.
• Добавление параметра конфигурации pg_trgm.similarity_threshold, устанавливающего по-
рог схожести для contrib/pg_trgm (Артур Закиров)
Этот порог настраивался и раньше, но до этого им управляли специальные функции
set_limit() и show_limit(). Теперь они считаются устаревшими.
• Усовершенствование класса операторов GIN в contrib/pg_trgm для ускорения запросов с при-
менением индекса, в которых ищутся и редкие, и частые ключи (Джефф Джейнс)
• Увеличение производительности поиска по схожести в индексах GIN (модуль contrib/
pg_trgm) (Кристоф Форнароли)
• Добавление модуля contrib/pg_visibility, позволяющего изучать карты видимости таблиц
(Роберт Хаас)
• Добавление в contrib/sslinfo функции ssl_extension_info() для вывода информации о рас-
ширениях SSL, представленных в сертификате X509, который используется для текущего со-
единения (Дмитрий Воронин)
E.21.3.13.1. postgres_fdw
• Возможность передавать предоставляемые расширением операторы и функции на удалённый
сервер, если это расширение указано в белом списке в параметрах стороннего сервера (Пол
Рамси)
Пользователи могут использовать это, когда точно известно, что в удалённой базе установле-
на совместимая версия заданного расширения. Это позволяет более эффективно выполнять
запросы с операторами, поддерживаемыми расширениями.
• Возможность выполнения сортировки на удалённом сервере (Ашутош Бапат)
• Возможность выполнения соединений на удалённом сервере (Шигеру Ханада, Ашутош Бапат)
• Если возможно, выполнять UPDATE или DELETE полностью на удалённом сервере (Эцуро Фудзи-
та)
Ранее для удалённой модификации данных требовалось передавать команду SELECT FOR
UPDATE, а затем изменять или удалять отобранные строки по одной. Хотя это по-прежнему
необходимо, если эта операция требует локальных действий, теперь она может выполняться и
удалённо, если все элементы запроса можно безопасно передать на удалённый сервер.
• Возможность задавать число извлекаемых строк в параметрах сервера или таблицы (Кори
Хинкер)
Ранее postgres_fdw всегда читала результаты удалённых запросов по 100 строк; теперь это
количество стало настраиваемым.
• Для всех локальных пользователей, сопоставленных с одним удалённым пользователем, долж-
но использоваться одно соединение со сторонним сервером (Ашутош Бапат)
• Передача требования отмены запроса на удалённый сервер (Микаэль Пакье, Эцуро Фудзита)
Ранее требование на отмену локального запроса не влекло за собой досрочную отмену уда-
лённого запроса, уже переданного на выполнение.
2407Замечания к выпуску
E.22. Выпуск 9.5.15
Дата выпуска:
2018-11-08
В этот выпуск вошли различные исправления, внесённые после версии 9.5.14. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.22.1. Миграция на версию 9.5.15
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.13, см. Раздел E.27.
E.22.2. Изменения
• Устранение сбоев, которые могли возникать в особых случаях в семействе функций has_объ-
ект_privilege() (Том Лейн)
Эти функции должны возвращать NULL, а не выдавать ошибку при получении неверного
OID. Некоторые из этих функций делали это и прежде, но не все. Кроме того, в функции
has_column_privilege() на некоторых платформах могли иметь место и другие сбои.
• Недопущение замедления порядка O(N^2) в функциях match/split с регулярными выражения-
ми при обработке длинных строк (Эндрю Гирт)
• Исправление дефекта в обработке стандартных многосимвольных операторов, следующих
непосредственно за комментарием или символами + и - (Эндрю Гирт)
Следствием данного упущения могли быть ошибки при разборе или неправильное определе-
ние приоритета операторов.
• Недопущение замедления порядка O(N^3) при обработке лексическим анализатором длин-
ных строк из символов + или - (Эндрю Гирт)
• Исправление некорректного выполнения подчинённых планов при сканировании внешнего
запроса в обратном направлении (Эндрю Гирт)
• Исправление ошибочного поведения UPDATE/DELETE ... WHERE CURRENT OF ... после переме-
щения курсора (Том Лейн)
Курсор, сканирующий несколько отношений (в частности, дерево наследования), мог работать
неправильно, возвращаясь к предыдущему отношению.
• Исправление в функции EvalPlanQual обработки узлов InitPlan, которые выполняются по
условию (Эндрю Гирт, Том Лейн)
Вследствие ошибки реализации могли возникать сложновоспроизводимые сбои или выдавать-
ся неправильные результаты при одновременных запросах на изменение, содержащих изоли-
рованные вложенные SELECT в конструкции CASE.
• Исправление проверок классов символов для корректной поддержки в Windows символов
Unicode выше U+FFFF (Том Лейн, Кэндзи Уно)
Эта ошибка проявлялась в операциях полнотекстового поиска, а также в работе модулей
contrib/ltree и contrib/pg_trgm.
• Смена владельца последовательности, принадлежащей сторонней таблице, при выполнении
ALTER OWNER для этой таблицы (Питер Эйзентраут)
Операция смены владельца должна распространяться и на такие последовательности, но
раньше сторонние таблицы она не затрагивала.
• Обеспечение обработки сервером уже полученных прерываний NOTIFY и SIGTERM до начала
ожидания данных от клиента (Джефф Джейнс, Том Лейн)
2408Замечания к выпуску
• Устранение ошибки, приводившей к выделению лишней памяти для строки результатов
array_out() (Кэйити Хиробэ)
• Ликвидация утечки памяти при сканировании индекса SP-GiST (Том Лейн)
Сколько-нибудь значительное проявление этой утечки наблюдалось, только когда для ограни-
чения-исключения, использующего SP-GiST, в индекс поступало много записей.
• Закрытие файла сопоставлений в ApplyLogicalMappingFile() после завершения его использо-
вания (Томаш Вондра)
Ранее дескриптор файла терялся, что могло в итоге приводить к сбоям при логическом деко-
дировании.
• Устранение ошибки логического декодирования в случаях, когда сопоставленная таблица ка-
талога постоянно перезаписывается, например, в результате действия VACUUM FULL (Андрес
Фройнд)
• Предотвращение запуска сервера со значением wal_level, недостаточно большим для под-
держки существующего слота репликации (Андрес Фройнд)
• Предотвращение сбоя в случаях, когда служебная команда создаёт бесконечную рекурсию
(Том Лейн)
• Устранение в процессе инициализации горячего резерва проблемы дублирующихся XID, ко-
торые образуются при выполнении двухфазных транзакций на ведущем сервере (Микаэль Па-
кье, Константин Книжник)
• Исправление поведения событийных триггеров при обработке вложенных команд ALTER TABLE
(Микаэль Пакье, Альваро Эррера)
• Передача параллельным исполнителям времени начала оператора и транзакции от родитель-
ского процесса (Константин Книжник)
Тем самым исправлено поведение таких функций, как transaction_timestamp(), выполняю-
щихся в параллельном исполнителе.
• Исправление логики переработки файла WAL для правильного выполнения этой операции на
ведомых серверах (Микаэль Пакье)
В зависимости от значения параметра archive_mode ведомый сервер мог не удалить некото-
рые файлы WAL, подлежащие удалению.
• Исправление обработки времени фиксации транзакций в процессе восстановления (Масахико
Савада, Микаэль Пакье)
Если отслеживание времени фиксации не было включено постоянно, в процессе восстановле-
ния мог произойти сбой при попытке получить время фиксации транзакции, для которой оно
не было записано.
• Использование случайной затравки для random() в initdb, а также в сервере, запускаемом в
режиме начальной загрузки и в монопольном режиме (Ной Миш)
Практическая польза этого изменения состоит прежде всего в разрешении проблемы, когда
программа initdb не могла использовать общую память POSIX, считая её недоступной, из-за
конфликтов имён, вызванных использованием одинаковой затравки.
• Возможность прерывания операции выделения памяти в DSM (Крис Трэверс)
• Исправление поведения при динамическом включении параметра full_page_writes (Кётаро
Хоригути)
• Предупреждение возможного переполнения буфера при воспроизведении операции распаков-
ки страницы GIN из WAL (Александр Коротков, Шивасубраманьян Рамасубраманьян)
• Выполнение операции fsync, ранее упущенной, для каталога слотов репликации (Константин
Книжник, Микаэль Пакье)
2409Замечания к выпуску
• Устранение неожиданных тайм-аутов при использовании wal_sender_timeout на медленном
сервере (Ной Миш)
• Исправление вычисления подходящей точки согласованности WAL в процессах горячего ре-
зерва (Александр Кукушкин, Микаэль Пакье)
Выбор правильной точки позволяет предотвратить некорректное поведение сразу после того,
как ведомый сервер достигает согласованного состояния базы при воспроизведении WAL.
• Корректная остановка фоновых рабочих процессов при получении главным процессом запро-
са на быстрое отключение до завершения запуска базы (Александр Кукушкин)
• Отказ от вызова обработчиков atexit при обработке SIGQUIT (Хейкки Линнакангас)
• Исключение сопоставлений пользователей для сторонних серверов из состава расширений
(Том Лейн)
При выполнении CREATE USER MAPPING в скрипте расширения для создаваемого сопоставле-
ния добавлялась зависимость, чего не должно быть. Сопоставления пользователей, как и ро-
ли, не могут быть членами расширений.
• Исправление поведения syslogger в случае ошибок при попытке открыть файлы CSV (Том
Лейн)
• Исправление кода psql, а также примеров в документации, чтобы функция PQconsumeInput()
вызывалась перед PQnotifies() (Том Лейн)
Тем самым решена проблема, когда psql не выдавал полученное сообщение NOTIFY до следую-
щей команды.
• Устранение возможной несогласованности при сортировке различных имён объектов в
pg_dump (Джейкоб Чемпион)
• Исправление pg_restore, чтобы при выдаче команд DISABLE/ENABLE TRIGGER имя таблицы до-
полнялось схемой (Том Лейн)
Это предотвращает сбои, возможные при новой политике выполнения восстановления с огра-
ниченным путём поиска.
• В pg_upgrade исправлена обработка событийных триггеров в расширениях (Харибабу Комми)
Ранее pg_upgrade не сохранял связь событийных триггеров с расширениями.
• Исправление проверки состояния кластера в pg_upgrade, чтобы она корректно выполнялась
на ведомом сервере (Брюс Момджян)
• Ограничение числа размерностей в значениях cube во всех функциях contrib/cube (Андрей
Бородин)
Ранее в некоторых функциях, связанных с кубами, можно было создать такие значения, кото-
рые затем не принимала функция cube_in(), что вызывало ошибки при восстановлении вы-
груженных данных.
• Исправление функции unaccent() в расширении contrib/unaccent, чтобы она использовала
словарь текстового поиска unaccent, находящийся в той же схеме, где и сама функция (Том
Лейн)
Ранее она пыталась найти словарь по пути поиска, но могла не обнаружить его, если путь по-
иска был ограничен.
• Устранение проблем при сборке в macOS 10.14 (Mojave) (Том Лейн)
Усовершенствование скрипта configure, чтобы в CPPFLAGS добавлялся ключ -isysroot; без
этого PL/Perl и PL/Tcl нельзя сконфигурировать или собрать в macOS 10.14. Значение sysroot
2410Замечания к выпуску
можно переопределить во время конфигурирования или сборки, установив переменную
PG_SYSROOT в аргументах configure или make.
Теперь рекомендуется, чтобы для связанных с Perl расширений во флагах компилятора указы-
валось $(perl_includespec), а не -I$(perl_archlibexp)/CORE. Второй вариант по-прежнему
будет работать на большинстве платформ, но не в последних macOS.
Также теперь не требуется указывать вручную ключ --with-tclconfig, чтобы собрать PL/Tcl в
последних версиях macOS.
• Исправление скриптов сборки с MSVC и регрессионного тестирования для работы с последни-
ми версиями Perl (Эндрю Дунстан)
Это изменение вызвано тем, что Perl теперь по умолчанию не включает текущий каталог в
свой путь поиска.
• Реализована возможность запускать регрессионные тесты в Windows с учётной записью адми-
нистратора (Эндрю Дунстан)
Чтобы это было безопасно, pg_regress теперь лишает себя расширенных прав при запуске.
• Поддержка сборки в Windows с Visual Studio 2015 и Visual Studio 2017 (Микаэль Пакье, Хари-
бабу Комми)
• Снятие запрета на возврат из функций сравнения btree значений INT_MIN (Том Лейн)
До настоящего времени мы не позволяли типозависимым функциям сравнения возвращать
INT_MIN, благодаря чему вызывающий код мог сменить порядок сортировки, просто изменив
знак результата сравнения. Однако это могло вызывать проблемы с функциями сравнения,
возвращающими непосредственно результат memcmp(), strcmp() и подобных функций, так как
POSIX не накладывает на него никаких ограничений. Как минимум некоторые последние вер-
сии memcmp() могут возвращать INT_MIN, что приводило к нарушению порядка сортировки. В
связи с этим мы убрали это ограничение. Там же, где требуется поменять порядок сортировки
на противоположный, теперь нужно использовать макрос INVERT_COMPARE_RESULT().
• Устранение риска рекурсии при обработке сообщений об аннулировании общего кеша (Том
Лейн)
Эта ошибка могла привести, например, к сбою при обращении к системному каталогу или ин-
дексу, который был только что обработан командой VACUUM FULL.
В результате этого изменения функция LockAcquire теперь может возвращать новый код ре-
зультата, что теоретически может вызвать проблемы при использовании этой функции, хо-
тя для этого схема её использования должна быть весьма необычной. Также был изменён API
функции LockAcquireExtended.
• Сохранение и восстановление глобальных переменных SPI в SPI_connect() и SPI_finish()
(Чепмен Флэк, Том Лейн)
Это предотвращает накладки, возможные при вызове из одной функции, использующей SPI,
другой такой функции.
• Добавление определения ALLOCSET_DEFAULT_SIZES и связанных с ним макросов в ветви старых
версий (Том Лейн)
Эти макросы появились в версии 9.6, но поступали запросы добавить их и в старые версии,
чтобы ими можно было пользоваться в расширениях, обходясь без лишних условий.
• Предотвращение использования потенциально невыравненных буферов страниц (Том Лейн)
Добавлены новые типы-объединения PGAlignedBlock и PGAlignedXLogBlock, которые должны
использоваться вместо простых массивов char, чтобы компилятор гарантированно выравни-
вал адрес начала буфера. В результате устраняется риск аварийного сбоя на платформах, чув-
2411Замечания к выпуску
ствительных к выравниванию, и может увеличиться быстродействие даже на тех платформах,
где выравнивание не требуется.
• Приведение в src/port/snprintf.c значения результата snprintf() в соответствие со стан-
дартом C99 (Том Лейн)
На платформах, где этот код используется (в основном в Windows), его несовременное поведе-
ние (не соответствующие C99) могло препятствовать выявлению переполнения буфера, если
вызывающий код рассчитывал на семантику C99.
• Требование обязательного использования -msse2 при сборке компилятором clang для i386
(Андрес Фройнд)
Тем самым решается проблема отсутствия проверок переполнения при операциях с плаваю-
щей точкой.
• Исправление в configure проверки, определяющей, результат какого типа возвращает
strerror_r() (Том Лейн)
Предыдущая реализация давала неправильный ответ при сборке с использованием компиля-
тора icc в Linux (возможно, и в других случаях), в результате чего libpq не выдавала полезные
сообщения при возникновении системных ошибок.
• Обновление данных часовых поясов до версии tzdata 2018g, включающее изменений правил
перехода на летнее время в России (Волгограде), Чили, Марокко и на Фиджи, а также коррек-
тировку исторических данных для Китая, Гавайев, Японии, Макао и Северной Кореи.
E.23. Выпуск 9.5.14
Дата выпуска:
2018-08-09
В этот выпуск вошли различные исправления, внесённые после версии 9.5.13. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.23.1. Миграция на версию 9.5.14
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.13, см. Раздел E.27.
E.23.2. Изменения
• Осуществление полного сброса состояния libpq между попытками соединения (Том Лейн)
Непривилегированный пользователь dblink или postgres_fdw мог обойти проверки, пред-
назначенные для предотвращения использования учётных данных на стороне сервера, на-
пример, файла ~/.pgpass, принадлежащего пользователю ОС, от имени которого работа-
ет сервер. В частности, уязвимость затрагивает серверы, принимающие локальные подклю-
чения с методом peer. Возможны были и другие атаки, например, SQL-инъекции в сеансе
postgres_fdw. Для атаки на postgres_fdw через эту уязвимость пользователь должен был
иметь возможность создавать объект стороннего сервера с нужными параметрами подключе-
ния, но атаку на dblink мог произвести любой пользователь, имеющий к нему доступ. Вообще
любой пользователь, имеющий возможность менять параметры подключения для приложения
на базе libpq, мог производить непредусмотренные действия, но другие эффективные сцена-
рии эксплуатации этого сложно придумать. Мы благодарим Андрея Красичкова за сообщение
о данном дефекте. (CVE-2018-10915)
• Исправление поведения INSERT ... ON CONFLICT UPDATE с более сложным представлением,
чем просто SELECT * FROM ... (Дин Рашид, Амит Ланготе)
Ошибочное развёртывание изменяемого представления могло приводить к сбоям или ошиб-
кам «attribute ... has the wrong type» (атрибут ... имеет неверный тип), если список SELECT
2412Замечания к выпуску
представления не соответствовал в точности списку столбцов нижележащей таблицы. Более
того, развив атаку через эту уязвимость, злоумышленник мог изменять столбцы, не имея для
них права UPDATE, но имея права INSERT и UPDATE для некоторых других столбцов в таблице.
Любой пользователь также мог эксплуатировать её для раскрытия содержимого памяти сер-
вера. (CVE-2018-10925)
• Обеспечение своевременного изменения полей relfrozenxid и relminmxid в «зафиксирован-
ных» системных каталогах (Андрес Фройнд)
Из-за чрезмерно оптимистичного кеширования эти изменения могли оказаться невидимыми
для других сеансов, что приводило к случайным ошибкам и/или разрушению данных. Для об-
щих каталогов, таких как pg_authid, проблема была ещё острее, так как устаревшие кеширо-
ванные данные могли попадать в новые сеансы и оставаться в существующих.
• Исправление поведения в ситуации, когда недавно повышенный сервер аварийно завершает-
ся до окончания обработки первой контрольной точки после восстановления (Микаэль Пакье,
Кётаро Хоригути, Паван Деоласи, Альваро Эррера)
В такой ситуации сервер не считал, что при последующем воспроизведении WAL было достиг-
нуто согласованное состояние базы данных, и это препятствовало его перезапуску.
• Исключение выдачи фантомной записи WAL при переработке полностью нулевой страницы
индекса btree (Амит Капила)
Эта ошибка проявлялась в сбоях проверочных утверждений и могла приводить к неоправдан-
ным отменам запросов на серверах горячего резерва.
• При воспроизведении WAL добавлена защита от некорректной длины записи, превышающей 1
ГБ (Микаэль Пакье)
Подобные данные должны считаться некорректными. Ранее код пытался выделить такой объ-
ём и получал критическую ошибку, что делало восстановление невозможным.
• При завершении восстановления запись в файл истории линии времени должна откладывать-
ся, насколько это возможно (Хейкки Линнакангас)
Это позволяет избежать ситуаций с несогласованностью состояния линии времени на диске,
возникавших при сбое в процессе очистки после восстановления (например, при проблеме с
файлом двухфазного состояния).
• Увеличение скорости воспроизведения WAL для транзакций, удаляющих множество отноше-
ний (Фудзии Масао)
В результате этого изменения уменьшается число сканирований общих буферов, поэтому эф-
фект от данного изменения тем больше, чем больше значение shared_buffers.
• Увеличение скорости освобождения блокировки при воспроизведении WAL ведомым сервером
(Томас Мунро)
• Обеспечение согласованной передачи состояния логической трансляции передатчиками WAL
(Саймон Риггс, Савада Масахико)
Ранее код не мог правильно определить, удалось ли нагнать вышестоящий сервер.
• Устранение дефектов в процедуре обработки снимков при логическом декодировании, приво-
дивших к ошибкам декодирования в редких случаях (Арсений Шер, Альваро Эррера)
• Обеспечение корректного сброса кешированного списка индексов таблицы после сбоя при со-
здании индекса (Питер Геохеган)
Ранее в этом списке могли оставаться OID нерабочих индексов, что могло приводить к про-
блемам в том же сеансе.
• Исправление некорректной обработки пустых несжатых страниц списка идентификаторов в
индексах GIN (Шивасубраманьян Рамасубраманьян, Александр Коротков)
2413Замечания к выпуску
Это могло привести к сбою проверочного утверждения после выполнения pg_upgrade для ин-
дексов GIN версии до 9.4 (в 9.4 и последующих версиях такие страницы не создаются).
• Обеспечение реакции на сигналы в процессе VACUUM в цикле удаления страниц B-дерева (Ан-
дрес Фройнд)
С испорченными индексами btree цикл мог оказаться бесконечным, и прервать его можно бы-
ло только аварийно отключив сервер.
• Исправление некорректной оптимизации классов эквивалентности со столбцами составного
типа (Том Лейн)
Вследствие данной ошибки сервер не понимал, что индекс по составному столбцу может обес-
печить порядок сортировки, необходимый для соединения слиянием с данным столбцом.
• Исправление синтаксиса конструкции SQL-стандарта FETCH FIRST, чтобы она принимала ($n),
как того требует стандарт (Эндрю Гирт)
• Корректное добавление схемы к именам ряда объектов в выводе getObjectDescription (Кёта-
ро Хоригути, Том Лейн)
Имена правил сортировки, преобразований и объектов текстового поиска не дополнялись схе-
мой, тогда как должны были.
• Расширение счётчика строк в команде COPY FROM с 32 до 64 бит (Дэвид Роули)
Тем самым были решены две проблемы с входными данными, содержащими более 4G строк:
COPY FROM WITH HEADER терял одну строку на каждые 4G строк (не только первую), а в сообще-
ниях об ошибках выводилось неверное количество строк.
• Добавление в библиотеку ecpg pgtypes функции освобождения строк для исключения про-
блем с управлением памятью в разных модулях (Такаюки Цунакава)
В Windows могут происходить сбои, если вызов free для некоторого блока памяти произво-
дится не из той DLL, которая выделила память (с помощью malloc). Библиотека pgtypes ино-
гда возвращает строки, которые должен освободить вызывающий код, и сделать это корректно
оказывается невозможно. Добавленная функция PGTYPESchar_free() является просто обёрт-
кой free, позволяющей приложениям произвести освобождение по правилам.
• Исправление поддержки в ecpg переменных long long в Windows, а также на других платфор-
мах, где strtoll/strtoull объявлены нестандартно или не объявлены вовсе (Хыонг Дангминь,
Том Лейн)
• Исправление ошибки с определением типа SQL-оператора в PL/pgSQL, когда изменение пра-
вила приводило к изменению семантики оператора в рамках сеанса (Том Лейн)
Эта ошибка приводила к сбоям проверочных утверждений или, в редких случаях, к тому, что
указание INTO STRICT не работало должным образом.
• Исправление запроса пароля в клиентских программах, чтобы отображение корректно отклю-
чалось в Windows, когда stdin — не терминал (Мэтью Стикни)
• Продолжение исправления некорректного заключения в кавычки значений для переменных
GUC со списками при формировании дампа (Том Лейн)
Предыдущее исправление для заключения в кавычки значения search_path и других пере-
менных со списками в выводе pg_dump, как оказалось, привело к ошибкам со списками с пу-
стыми элементами и риску потери части длинных файловых путей.
• В pg_dump устранено упущение, когда свойства REPLICA IDENTITY для индексов ограничений
не выгружались (Том Лейн)
Уникальные индексы, созданные вручную, помечались корректно, а индексы, созданные огра-
ничениями UNIQUE или PRIMARY KEY — нет.
2414Замечания к выпуску
• В pg_upgrade теперь правильно проверяется, что старый сервер был выключен штатно (Брюс
Момджян)
Ранее проверка могла сработать некорректно при выключении сервера в незамедлительном
режиме.
• Исправление в contrib/hstore_plperl просмотра скалярных ссылок Perl и предотвращение
сбоя в случае, если не удаётся найти хеш-ссылку там, где она ожидается (Том Лейн)
• Устранение сбоя в функции модуля contrib/ltree при получении на вход пустого массива
(Пьер Дюкроке)
• Исправление обработки ошибок в ряде мест, где мог выдаваться некорректный код ошибки
(Микаэль Пакье, Том Лейн, Магнус Хагандер)
• Переоформление скриптов Makefile для обеспечения компоновки программ с собранными в
том же дереве библиотеками (например, libpq.so), а не с теми, что могут уже находиться в
системных каталогах библиотек (Том Лейн)
Это позволяет избежать проблем при сборке на платформах, где представлены старые версии
библиотек PostgreSQL.
• Обновление данных часовых поясов до версии tzdata 2018e, включающее изменение правил
перехода на летнее время в Северной Корее, а также корректировку исторических данных
для Чехословакии.
В это обновление вошло переопределение «летнего времени», которое действует в Ирландии,
а также действовало в прошлом в Намибии и в Чехословакии. В этих юрисдикциях стандарт-
ное время действует летом, а время для экономии света — зимой, поэтому при переходе на
это время сдвиг производится на час назад, а не на час вперёд. Это не влияет ни на фактиче-
ское смещение от UTC, ни на используемое сокращение часового пояса; эта особенность про-
является лишь в том, что в таких случаях столбец is_dst в представлении pg_timezone_names
будет содержать true для зимнего периода, и false для летнего.
E.24. Выпуск 9.5.13
Дата выпуска:
2018-05-10
В этот выпуск вошли различные исправления, внесённые после версии 9.5.12. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.24.1. Миграция на версию 9.5.13
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вас касаются ошибки с пометкой функций, описанные в первой записи в списке из-
менений, потребуются дополнительные действия для исправления каталогов баз данных.
Если вы обновляете сервер с более ранней версии, чем 9.5.12, см. также Раздел E.25.
E.24.2. Изменения
• Исправление некорректных пометок изменчивости для нескольких встроенных функций (То-
мас Мунро, Том Лейн)
Функции query_to_xml, cursor_to_xml, cursor_to_xmlschema, query_to_xmlschema и
query_to_xml_and_xmlschema должны были считаться изменчивыми, так как они выполняют
пользовательские запросы, в которых могут быть изменчивые операции. Однако они не бы-
ли помечены должным образом, что было чревато неправильной оптимизацией запросов. Это
было исправлено для новых инсталляций в результате корректировки исходных данных ката-
лога, но в существующих инсталляциях ошибочные пометки сохранятся. При практическом
2415Замечания к выпуску
использовании этих функций риск кажется небольшим, но в случае необходимости их мож-
но исправить, вручную изменив записи этих функций в pg_proc. Например: ALTER FUNCTION
pg_catalog.query_to_xml(text, boolean, boolean, text) VOLATILE. (Заметьте, что это нуж-
но будет проделать в каждой базе данных инсталляции.) Также вы можете обновить базу до
версии с корректными исходными данными, воспользовавшись pg_upgrade.
• Предотвращение повторного использования для TOAST идентификаторов OID, соответствую-
щих уже неактуальным, но ещё не очищенным записям TOAST (Паван Деоласи)
После зацикливания счётчика OID имеется возможность использования для значения TOAST
идентификатора OID, соответствующего ранее удалённой записи в той же таблице TOAST.
Если запись не была очищена к тому времени, это приводило к ошибкам «unexpected chunk
number 0 (expected 1) for toast value nnnnn» (неожиданный номер порции 0 (ожидался 1) для
значения TOAST nnnnn), которые сохранялись до удаления неактуальной записи командой
VACUUM. В качестве решения выбор таких OID при создании новых записей TOAST теперь ис-
ключается.
• Изменение алгоритма ANALYZE в части модификации pg_class.reltuples (Дэвид Гулд)
Ранее плотность кортежей могла обновляться только для страниц, прошедших обработку
ANALYZE, для остальных плотность считалась прежней. В большой таблице, где ANALYZE выби-
рает лишь небольшой процент страниц, это означает, что возможно лишь незначительное из-
менение общей оценки плотности кортежей, и поэтому reltuples будет меняться практиче-
ски пропорционально изменениям физического размера таблицы (relpages) вне зависимо-
сти от того, что фактически происходит в таблице. В результате может наблюдаться настоль-
ко большое увеличение reltuples по сравнению с реальностью, что автоматическая очистка
практически отключается. Для исправления этой ошибки принимается, что выборка ANALYZE
является статистически несмещённой (какой она и должна быть), и наблюдаемая в ней плот-
ность просто экстраполируется на всю таблицу.
• Предупреждение взаимоблокировок в параллельных командах CREATE INDEX CONCURRENTLY,
выполняемых на уровнях изоляции SERIALIZABLE и REPEATABLE READ (Том Лейн)
• Устранение возможности замедленного выполнения REFRESH MATERIALIZED VIEW
CONCURRENTLY (Томас Мунро)
• Устранение ошибки в UPDATE/DELETE ... WHERE CURRENT OF в случае, когда задействованный
курсор использует план сканирования только индекса (Юго Нагата, Том Лейн)
• Исправление некорректного планирования, когда предложения соединения передавались в
параметризованные пути (Эндрю Гирт, Том Лейн)
Эта ошибка могла привести к неправильной классификации условия как «фильтра соедине-
ния» для внешнего соединения, тогда как оно должно быть простым «фильтром», и в итоге
мог получиться некорректный результат соединения.
• Устранение возможности некорректного построения плана сканирования только индекса в
случаях, когда один столбец таблицы фигурирует в нескольких индексах, но не во всех этих
индексах используются классы операторов, которые могут выдать значение столбца (Кётаро
Хоригути)
• Исправление некорректной оптимизации ограничений CHECK с гарантированными NULL-под-
выражениями в условиях верхнего уровня AND/OR (Том Лейн, Дин Рашид)
В результате, например, ограничение-исключение могло исключить из запроса дочернюю
таблицу, которая не должна быть исключена.
• Устранение сбоя исполнителя в результате двойного освобождения памяти с некоторыми ва-
риантами использования GROUPING SETS (Питер Геохеган)
• Предотвращение сбоя в случае, когда триггер события перезаписи таблицы добавляется од-
новременно с выполнением команды, которая может вызвать такой триггер (Альваро Эррера,
Эндрю Гирт, Том Лейн)
2416Замечания к выпуску
• Предотвращение ошибки при прерывании запроса или прекращении сеанса в момент фикси-
рования подготовленной транзакции (Стас Кельвич)
• Ликвидация утечки памяти на время выполнения запроса в последовательно выполняемых со-
единениях по хешу (Том Лейн)
• Исправление излишне строгой проверки в heap_prepare_freeze_tuple (Альваро Эррера)
Это могло приводить к необоснованной ошибке «cannot freeze committed xmax» (не удаётся за-
морозить зафиксированный xmax) в базах данных, обновлённых с помощью pg_upgrade с вер-
сии 9.2 или старее.
• Устранение потери указателя в случаях, когда написанный на С триггер, выполняемый до из-
менения строки, возвращает старый кортеж («old») (Рушаб Латиа)
• Понижение уровня блокировки при планировании работы автоочистки (Джефф Джейнс)
Предыдущее поведение создавало значительные препятствия для параллельного выполнения
рабочих процессов в базах, содержащих множество таблиц.
• Обеспечение копирования имени клиентского компьютера при копировании данных
pg_stat_activity в локальную память (Эдмунд Хорнер)
Ранее предположительно локальный экземпляр содержал указатель на разделяемую память,
вследствие чего содержимое поля с именем клиентского компьютера могло неожиданно из-
мениться при отключении какого-либо сеанса.
• Исправление некорректной обработки нескольких составных аффиксов в словарях ispell (Ар-
тур Закиров)
• Исправление поиска (то есть сканирования индекса с операторами неравенства), зависимого
от правила сортировки, в индексах SP-GiST, построенных по текстовым столбцам (Том Лейн)
Такой поиск мог возвращать неправильный набор строк для большинства правил сортировки,
отличных от C.
• Корректировка вычисления количества кортежей в индексе при изначальном построении ин-
декса SP-GiST (Томаш Вондра)
Ранее количество кортежей в индексе считалось равным количеству кортежей в нижележа-
щей таблице, что неверно в случае частичного индекса.
• Корректировка вычисления количества кортежей в индексе при очистке индекса GiST (Ан-
дрей Бородин)
Ранее оно считалось равным примерному количеству кортежей в куче, что провоцировало
неточность и определённо было ошибочным в случае частичного индекса.
• Исправление поведения в особом случае, когда ведомый реплицирующий сервер «застревал»
на записи продолжения WAL (Кётаро Хоригути)
• При логическом декодировании приняты меры во избежание двойной обработки данных WAL
при перезапуске передатчика WAL (Крейг Рингер)
• Поддержка использования scalarltsel и scalargtsel с расширенными типами данных (То-
маш Вондра)
• Уменьшение потребления памяти libpq в случаях, когда сервер выдаёт ошибку после получе-
ния большого объёма результата запроса (Том Лейн)
Полученный ранее результат должен быть отброшен до, а не после обработки ошибки. На
некоторых платформах, в частности в Linux это может влиять на то, сколько памяти будет за-
нимать приложение.
• Устранение сбоев в ecpg, вызванных двойным освобождением памяти (Патрик Крекер, Джи-
ван Ладхе)
2417Замечания к выпуску
• Исправление обработки переменных long long int в ecpg, собранном с использованием
MSVC (Михаэль Мескес, Эндрю Гирт)
• Доработка некорректного заключения в кавычки значений для переменных GUC со списками
при формировании дампа (Микаэль Пакье, Том Лейн)
Переменные local_preload_libraries, session_preload_libraries,
shared_preload_libraries и temp_tablespaces не заключались в кавычки корректно в выводе
pg_dump. Это могло приводить к проблемам, если эти переменным присваивались значения в
конструкциях CREATE FUNCTION ... SET или ALTER DATABASE/ROLE ... SET.
• Предотвращение отказа pg_recvlogical при подключении к серверам PostgreSQL до 10 версии
(Микаэль Пакье)
В результате предыдущего исправления программа pg_recvlogical, не проверяя версию серве-
ра, выдавала команду, которая должна предназначаться только серверам версии 10 и новее.
• Исправление поведения pg_rewind, чтобы на целевом сервере удалялись файлы, которые мог-
ли быть удалены в процессе выполнения на исходном сервере (Такаюки Цунакава)
В противном случае на целевом сервере могла нарушаться согласованность данных, особенно
если это был файл сегмента WAL.
• Исправление в pg_rewind обработки таблиц в дополнительных табличных пространствах (Та-
каюки Цунакава)
• Исправление обработки целочисленного переполнения в циклах FOR на языке PL/pgSQL (Том
Лейн)
Исправление обработки целочисленного переполнения в циклах FOR на языке PL/pgSQL (Том
Лейн)
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.7 (Питер Эйзен-
траут)
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.7 (Питер Эйзен-
траут)
• Поддержка сборки с Microsoft Visual Studio 2015 (Микаэль Пакье)
Различные исправления, необходимые для совместимости с VS2015, были перенесены в ветвь
9.5 ранее, но это исправление было пропущено.
• Переименование функций b64_encode и b64_decode во избежание конфликта со встроенными
функциями Solaris 11.4 (Райнер Орт)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией 2018e (Том
Лейн)
В этой версии усовершенствован компилятор данных часовых поясов zic для работы с отрица-
тельными смещениями при переходе на летнее время. Хотя проект PostgreSQL в настоящее
время не поставляет такие данные часовых поясов, zic может применяться с данными, полу-
ченными непосредственно от IANA, поэтому кажется разумным обновить zic сейчас.
• Обновление данных часовых поясов до версии tzdata 2018d, включающее изменения правил
перехода на летнее время в Палестине и Антарктиде (станция Кейси), плюс корректировку
исторических данных для Португалии и её колоний, а также Уругвая и островов Эндербери,
Ямайка, Теркс и Кайкос.
E.25. Выпуск 9.5.12
Дата выпуска:
2018-03-01
В этот выпуск вошли различные исправления, внесённые после версии 9.5.11. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
2418Замечания к выпуску
E.25.1. Миграция на версию 9.5.12
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если в вашей СУБД не все пользователи взаимно доверяют друг другу либо если вы под-
держиваете приложение или расширение, предназначенное для использования в произвольных
ситуациях, настоятельно рекомендуется прочитать об изменениях в первой записи ниже и пред-
принять соответствующие действия для защиты вашей инсталляции или кода.
Также изменения, описанные во втором пункте списка ниже, могут приводить к сбоям функций,
используемых в индексных выражениях или материализованных представлениях, во время авто-
матического анализа или при восстановлении выгруженных данных. Поэтому после обновления
проверьте журнал сервера на предмет подобных проблем и исправьте затронутые функции.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.10, см. Раздел E.27.
E.25.2. Изменения
• Добавление в документацию информации о настройке серверов и приложений для защиты от
атак с внедрением троянского кода через путь поиска (Ной Миш)
Когда используется значение search_path, включающее схемы, доступные для записи зло-
намеренному пользователю, он может перехватывать управление над выполнением запросов
и затем запускать произвольный SQL-код с правами атакуемого пользователя. Хотя есть воз-
можность составлять запросы, защищённые от подобного перехвата, это требует кропотли-
вой работы, и при этом очень легко что-то упустить. Поэтому мы рекомендуем использовать
конфигурации, в которых пути поиска не могут включать недоверенные схемы. Соответству-
ющая информация добавлена в Подраздел 5.8.6 (для пользователей и администраторов баз
данных), Раздел 34.1 (для разработчиков приложений), Подраздел 38.16.1 (для разработчиков
расширений) и CREATE FUNCTION (для разработчиков функций с характеристикой SECURITY
DEFINER). (CVE-2018-1058)
• Предотвращение использования небезопасных значений search_path в pg_dump и других кли-
ентских программах (Ной Миш, Том Лейн)
pg_dump, pg_upgrade, vacuumdb и другие приложения, предоставляемые PostgreSQL, были
уязвимы для перехвата выполнения, описанного в предыдущем пункте; так как эти прило-
жения обычно запускаются суперпользователями, они представляли собой привлекательные
средства для атаки. Чтобы защитить их вне зависимости от того, защищена ли вся инсталля-
ция в целом, они были изменены так, чтобы для них параметр search_path содержал только
pg_catalog. Теперь это так же касается и рабочих процессов автоочистки.
В случаях, когда этими программами неявно вызываются определённые пользователем функ-
ции — например, это могут быть пользовательские функции в выражениях индексов — бо-
лее строгое значение search_path может приводить к ошибкам, которые потребуется испра-
вить так, чтобы эти функции никак не зависели от пути поиска, с которым они выполняются.
Это всегда рекомендовалось делать, но сейчас это необходимо для корректного поведения.
(CVE-2018-1058)
• Исправление некорректного поведения перепроверок одновременных изменений со ссылками
CTE, фигурирующими во внутренних планах (Том Лейн)
Если ссылка на CTE (содержимое предложения WITH) использовалась в InitPlan или SubPlan, и
запросу требовалось провести перепроверку из-за попытки изменения или блокировки одно-
временно изменяемой строки, могли быть получены неверные результаты.
• Устранение сбоев планировщика при перекрывающихся предложениях соединения слиянием
во внешнем соединении (Том Лейн)
Эти дефекты приводили в особых случаях к ошибкам планировщика «left and right pathkeys
do not match in mergejoin» (нарушено соответствие левых и правых ключей пути в соединении
2419Замечания к выпуску
слиянием) или «outer pathkeys do not match mergeclauses» (внешние ключи пути не соответ-
ствуют предложениям слияния).
• Исправление ошибки в pg_upgrade, когда не удавалось сохранить relfrozenxid для материа-
лизованных представлений (Том Лейн, Андрес Фройнд)
Данное упущение могло приводить к разрушению данных в материализованных пред-
ставлениях после обновления. Это могло проявляться в ошибках «could not access status
of transaction» (не удалось получить состояние транзакции) или «found xmin from before
relfrozenxid» (найден xmin перед relfrozenxid). Эта проблема была более вероятна в редко об-
новляемых материализованных представлениях или в представлениях, обновляемых только
командой REFRESH MATERIALIZED VIEW CONCURRENTLY.
Если такое разрушение имело место, его можно исправить, обновив материализованное пред-
ставление (без указания CONCURRENTLY).
• Исправление некорректной обработки имён функций PL/Python в стеках ошибки CONTEXT (Том
Лейн)
Ошибка, произошедшая во вложенном вызове функции PL/Python (то есть функции, вызван-
ной через SPI-запрос из другой функции PL/Python), могла привести к тому, что в трассировке
стека вместо ожидаемого результата имя внутренней функции фигурировало дважды. Также
ошибка во вложенном блоке PL/Python DO могла привести к обращению по нулевому указате-
лю на некоторых платформах.
• Максимальное значение log_min_duration для contrib/auto_explain доведено до INT_MAX,
что составляет около 24 суток вместо 35 минут (Том Лейн)
E.26. Выпуск 9.5.11
Дата выпуска:
2018-02-08
В этот выпуск вошли различные исправления, внесённые после версии 9.5.10. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.26.1. Миграция на версию 9.5.11
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.10, см. Раздел E.27.
E.26.2. Изменения
• Временные файлы, создаваемые программой pg_upgrade, должны быть недоступны для чте-
ния всеми пользователями (Том Лейн, Ной Миш)
Программа pg_upgrade обычно ограничивает доступ к своим временным файлам, чтобы их
мог читать и записывать только запускающий её пользователь. Но временные файлы, содер-
жащие вывод pg_dumpall -g могли быть доступны для чтения группе или всем пользовате-
лям, а возможно и для записи, если это допускало значение umask этого пользователя. При
типичном использовании в многопользовательских системах umask и/или разрешения в рабо-
чем каталоге достаточно жёсткие и эта проблема неактуальна; но pg_upgrade может исполь-
зоваться и в сценариях, где это упущение могло привести, например, к утечке паролей баз
данных. (CVE-2018-1053)
• Исправление очистки кортежей, которые были изменены при установленной блокировке раз-
деляемого ключа (Андрес Фройнд, Альваро Эррера)
В некоторых случаях операция VACUUM не удаляла такие кортежи, даже когда они теряли акту-
альность, что приводило к различным сценариям повреждения данных.
• Исправление неправильной блокировки буфера при некоторых чтениях LSN (Якоб Чемпион,
Асим Правин, Ашвин Агравал)
2420Замечания к выпуску
Эти ошибки могли приводит к некорректному поведению при многопоточной нагрузке. По-
тенциальные последствия не были характеризованы полностью.
• Исправление некорректных результатов запросов в случаях, когда происходило упрощение
подзапросов, результаты которых использовались в GROUPING SETS (Хейкки Линнакангас)
• Исключение неоправданной ошибки в запросе с деревом наследования, который выполнял-
ся одновременно с тем, как некоторая дочерняя таблица удалялась из этого дерева командой
ALTER TABLE NO INHERIT (Том Лейн)
• Устранение разнообразных ошибок взаимоблокировки при выполнении в нескольких сеансах
команды CREATE INDEX CONCURRENTLY (Джефф Джейнс)
• Устранение ошибок в ситуациях, когда дерево наследования содержит дочерние сторонние
таблицы (Эцуро Фудзита)
Комбинация обычных и сторонних таблиц в дереве наследования провоцировала построение
некорректных планов в запросах UPDATE и DELETE. Это приводило к видимым ошибкам в неко-
торых случаях, особенно когда в дочерней сторонней таблице присутствовали триггеры уров-
ня строк.
• Исправление дефекта со связанным подзапросом SELECT внутри VALUES в подзапросе LATERAL
(Том Лейн)
• Устранение ошибки планировщика «could not devise a query plan for the given query» (не уда-
лось выработать план для данного запроса) в некоторых случаях, включая вложенные UNION
ALL в подзапросе LATERAL (Том Лейн)
• Исправление логического декодирования, чтобы файлы на диске корректно очищались от
данных сбойных транзакций (Атсуши Торикоши)
Процедура логического декодирования может выносить записи WAL на диск, если транзакции
генерируют много записей WAL. Обычно эти файлы очищаются после фиксирования транзак-
ции или поступления записи о её прерывании; но в отсутствие таких записей код очистки ра-
ботал неправильно.
• Исправление тайм-аута в процессе walsender и реакции на прерывания при обработке боль-
шой транзакции (Петр Желинек)
• Добавление в has_sequence_privilege() поддержки проверок WITH GRANT OPTION, как это сде-
лано в других функциях проверки прав (Джо Конвей)
• В базах данных с кодировкой UTF8 любые XML-объявления, выбирающие другую кодировку,
должны игнорироваться (Павел Стехуле, Ной Миш)
Мы всегда храним документы XML в кодировке базы данных, так что позволяя libxml обраба-
тывать объявления с другой кодировкой, мы получим ошибочные результаты. Если кодировка
базы — не UTF8, мы в любом случае не обещали поддерживать XML-данные с не ASCII-коди-
ровкой, так что предыдущее поведение сохранено для совместимости ошибок. Это изменение
затрагивает только xpath() и связанные функции; другой код и ранее работал так.
• Обеспечение прямой совместимости с будущими изменениями младших версий протокола
(Роберт Хаас, Бадрул Чоудхури)
Ранее серверы PostgreSQL просто отклоняли запросы на использование версий протокола но-
вее 3.0, так что никакого функционального отличия старших номеров от младших не было. Те-
перь клиенты могут запрашивать версии 3.x и получать в ответ не отказ, а сообщение, говоря-
щее, что сервер поддерживает только версию 3.0. В данный момент от этого ничего не меня-
ется, но перенос этого изменения в предыдущие версии должен ускорить внедрение неболь-
ших усовершенствований протокола в будущем.
• Исправление реакции на сбой при запуске параллельного рабочего процесса (Амит Капила,
Роберт Хаас)
2421Замечания к выпуску
Ранее параллельный запрос мог зависнуть на неопределённое время, если не удавалось запу-
стить рабочий процесс, вследствие ошибки в fork() или других редких проблем.
• Устранение небезопасного предположения о выравнивании при работе с типом __int128 (Том
Лейн)
Обычно компиляторы полагают, что переменные __int128 выравниваются по 16-байтовым
границам, но наша инфраструктура выделения памяти не готова гарантировать это, а увели-
чение MAXALIGN кажется неподходящим по множеству причин. В качестве решения код был
изменён так, чтобы тип __int128 можно было использовать только когда мы можем сказать
компилятору, что предполагается не такое крупное выравнивание. Единственный замечен-
ный симптом этой проблемы — сбои в некоторых параллельных запросах с агрегированием.
• Предотвращение сбоев с переполнением стека при планировании операций со множествами с
крайне большой вложенностью (UNION/INTERSECT/EXCEPT) (Том Лейн)
• Ликвидация обращений по нулевому указателю для некоторых типов адресов LDAP, задавае-
мых в файле pg_hba.conf (Томас Мунро)
• Исправление демонстрационных функций INSTR() в документации по PL/pgSQL (Юго Нагата,
Том Лейн)
В документации утверждалось, что эти функции совместимы с Oracle®, но это было не совсем
так. В частности, по-разному интерпретировалось отрицательное значение третьего парамет-
ра: Oracle воспринимает это значение как последнюю позицию, с которой может начинаться
целевая подстрока, а наши функции считали, что это последняя позиция, где строка может
заканчиваться. Также Oracle выдаёт ошибку в случае нулевого или отрицательного четвёрто-
го параметра, тогда как наши функции возвращали ноль.
Код этого примера был изменён для большего соответствия поведению Oracle. Пользовате-
лям, которые скопировали этот код в свои приложения, возможно, имеет смысл обновить свои
копии.
• Исправление поведения pg_dump, чтобы ACL (разрешения), комментарии и метки безопасно-
сти можно было надёжно идентифицировать в архивных выходных форматах (Том Лейн)
Компонент «метка» записи ACL в архиве обычно представлял собой просто имя целевого объ-
екта. В его начало теперь добавляется тип объекта, чтобы записи ACL соответствовали согла-
шениям, уже принятым для записей комментариев и меток безопасности. Кроме того, обо-
значения комментариев и меток безопасности, заданных для собственно базы данных, теперь
должны начинаться с DATABASE, чтобы они соответствовали тому же соглашению. Это преду-
преждает ложные срабатывания в коде, который пытается найти записи больших объектов по
строкам, начинающимся со слов LARGE OBJECT. Прежнее поведение могло приводить к непра-
вильной классификации записей как данные и нежелательным результатам при восстановле-
нии выгруженной только схемы или только данных.
Заметьте, что следствием этого стало изменение видимого пользователями вывода pg_restore
--list.
• Переименование функции copy_file_range в pg_rewind во избежание конфликта с новым си-
стемным вызовом Linux с таким же именем (Андрес Фройнд)
Это изменение предотвращает ошибки при сборке с новыми версиями glibc.
• В ecpg добавлено выявление массивов индикаторов с неправильной длиной и сообщение об
ошибке (Дэвид Рейдер)
• Предотвращение срабатывания проверки истинности внутри libc в расширении contrib/
hstore из-за использования memcpy() с равными указателями источника и получателя (Томаш
Вондра)
• Добавление современных примеров настройки автозапуска Postgres в macOS (Том Лейн)
2422Замечания к выпуску
Скрипты в contrib/start-scripts/osx используют инфраструктуру, которая устарела десять
лет назад, и абсолютно неработоспособны во всех версиях macOS, выпущенных в последние
два года. Добавлен новый подкаталог contrib/start-scripts/macos со скриптами, использую-
щими новую инфраструктуру launchd.
• Исправление некорректного выбора зависящих от конфигурации библиотек OpenSSL в
Windows (Эндрю Дунстан)
• Поддержка компоновки с версиями libperl, собранными компилятором MinGW (Ной Миш)
Это позволяет собирать PL/Perl с некоторыми распространёнными дистрибутивами Perl для
Windows.
• Исправление в сборке MSVC проверки, требуется ли 32-битной libperl определение -
D_USE_32BIT_TIME_T (Ной Миш)
Имеющиеся дистрибутивы Perl ожидают разного, и при этом нет никакой возможности на-
дёжно проверить это, поэтому пришлось добавить проверку фактического поведения исполь-
зуемой библиотеки во время компиляции.
• В Windows обработчик аварийного завершения должен устанавливаться на более раннем эта-
пе запуска главного процесса (Такаюки Цунакава)
Это поможет получить дамп памяти при ошибках в те моменты в начале запуска, в которые
раньше дамп не записывался.
• В Windows устранены сбои, связанные с преобразованием кодировок при выводе сообщений
на самых ранних стадиях запуска процесса postmaster (Такаюки Цунакава)
• Использование нашего ранее написанного кода циклических блокировок для Motorola 68K во
OpenBSD, а также в NetBSD (Давид Карлье)
• Добавление поддержки циклических блокировок для Motorola 88K (Давид Карлье)
• Обновление данных часовых поясов до версии tzdata 2018c, включающее изменения правил
перехода на летнее время в Бразилии, в Сан-Томе и Принсипи, а также корректировки ис-
торических данных для Боливии, Японии и Южного Судана. Был удалён часовой пояс US/
Pacific-New (это был просто псевдоним для пояса America/Los_Angeles).
E.27. Выпуск 9.5.10
Дата выпуска:
2017-11-09
В этот выпуск вошли различные исправления, внесённые после версии 9.5.9. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.27.1. Миграция на версию 9.5.10
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы используете индексы BRIN, прочитайте четвёртую запись в списке изменений.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.8, см. Раздел E.29.
E.27.2. Изменения
• Обеспечение проверки разрешений на уровне таблиц и политик RLS при выполнении
INSERT ... ON CONFLICT DO UPDATE во всех случаях (Дин Рашид)
Путь изменения данных в команде INSERT ... ON CONFLICT DO UPDATE требовал наличия раз-
решения SELECT для всех столбцов в решающем индексе, но в случае указания решающего
ограничения по имени должная проверка отсутствовала. Кроме того, для таблиц с включён-
2423Замечания к выпуску
ной защитой на уровне строк не проверялось, соответствуют ли изменённые строки полити-
кам SELECT (вне зависимости от способа задания решающего индекса). (CVE-2017-15099)
• Устранение сбоя при несовпадении типа записи в json{b}_populate_recordset() (Микаэль
Пакье, Том Лейн)
Эти функции использовали тип результата, заданный в предложении FROM ... AS, не прове-
ряя, соответствует ли он фактическому типу поступившего кортежа. В случае несоответствия
обычно происходил сбой, хотя также вероятным было раскрытие содержимого памяти серве-
ра. (CVE-2017-15098)
• Исправление скриптов запуска сервера — переключение на $PGUSER до открытия файла
$PGLOG (Ной Миш)
Ранее файл журнала postmaster открывался ещё под именем root. Таким образом, владелец
базы данных мог произвести атаку на другого пользователя системы, сделав $PGLOG символи-
ческой ссылкой на некоторый другой файл, который в результате можно было испортить до-
бавленными в него сообщениями журнала.
По умолчанию эти скрипты никуда не устанавливаются. Если вы использовали их, замените
свои экземпляры новыми копиями либо внесите те же коррективы в свои вручную изменён-
ные скрипты. Если владельцем существующего файла $PGLOG является root, его нужно уда-
лить или переименовать прежде чем перезапускать сервер с помощью исправленного скрип-
та. (CVE-2017-12172)
• Исправление вычисления сводных данных индекса BRIN для корректной работы при одновре-
менном расширении таблицы (Альваро Эррера)
Ранее в условиях гонки некоторые строки таблицы могли пропадать из индекса. Для устране-
ния последствий предыдущих проявлений этой проблемы может потребоваться перестроить
существующие индексы BRIN.
• Предупреждение возможных сбоев при параллельных изменениях индекса BRIN (Том Лейн)
В определённых условиях гонки могли возникать ошибки «invalid index offnum» (неверный но-
мер смещения в индексе) или «inconsistent range map» (несогласованность в карте диапазо-
нов).
• Устранение сбоя при вызове логического декодирования из функции, использующей SPI, в
частности, из любой функции на одном из языков PL (Том Лейн)
• Исправление в функциях json_build_array(), json_build_object() и их аналогах для jsonb
обработки явно заданных аргументов VARIADIC (Микаэль Пакье)
• Корректное недопущение попыток приведения бесконечных значений с плавающей точкой к
типу numeric (Том Лейн, КайГай Кохэй)
Ранее поведение зависело от платформы.
• Устранение сбоев в особых случаях при добавлении столбцов в конец представления (Том
Лейн)
• Фиксирование правильных зависимостей когда представление или правило содержит узлы вы-
ражения FieldSelect или FieldStore (Том Лейн)
В отсутствие этих зависимостей команда DROP со столбцом или типом данных может выпол-
ниться, когда не должна, что вызовет ошибки при последующем использовании представле-
ния или правила. Данное исправление не защищает существующие представления/правила, а
повлияет только на создаваемые в будущем.
• Правильное определение хешируемости диапазонных типов данных (Том Лейн)
Планировщик ошибочно полагал, что любой диапазонный тип может хешироваться для ис-
пользования в соединениях или агрегировании по хешу, но на самом деле он должен прове-
2424Замечания к выпуску
рять, поддерживает ли хеширование подтип диапазона. Это не касается встроенных диапазон-
ных типов, так как все они всё равно хешируемые.
• Игнорирование узлов выражений RelabelType при определении уникальности содержимого
отношения (Дэвид Роули)
Это позволяет применить оптимизацию, когда результирующий столбец имеет тип varchar.
• Устранение маловероятной потери сообщений NOTIFY вследствие зацикливания идентифика-
торов транзакций (Марко Тииккая, Том Лейн)
Если в сеансе не выполнялись никакие запросы, то есть он просто ждал уведомлений и за это
время прошло более 2 миллиардов транзакций, он начинал пропускать уведомления от парал-
лельно фиксируемых транзакций.
• Предупреждение сбоя SIGBUS в Linux, когда в памяти DSM запрашивается область объёма,
превышающего свободный объём в tmpfs (Томас Мунро)
• Предотвращение маловероятного сбоя при рекурсивном срабатывании триггеров (Том Лейн)
• Реализована возможность использовать режим FREEZE команды COPY на уровне изоляции
транзакций REPEATABLE READ или выше (Ной Миш)
Этот сценарий использования был непреднамеренно потерян вследствие предыдущего ис-
правления ошибки.
• Корректное восстановление значения umask при ошибке создания файла в COPY или
lo_export() (Питер Эйзентраут)
• Улучшение сообщения об ошибке в случае дублирующихся имён столбцов в ANALYZE (Натан
Боссарт)
• Исправление разбора последней строки в файле pg_hba.conf, завершающемся не символом
перевода строки (Том Лейн)
• Исправление в pg_basebackup сравнения путей табличных пространств посредством приведе-
ния путей к канонической форме (Микаэль Пакье)
Это особенно полезно в Windows.
• Исправление libpq, чтобы для её работы не требовалось существование домашнего каталога
пользователя (Том Лейн)
В версии 10 невозможность найти домашний каталог при попытке прочитать ~/.pgpass счита-
лась критической ошибкой, но эта ситуация должна обрабатываться так же, как и отсутствие
данного файла. И в версии 10, и в ветвях предыдущих выпусков была допущена та же ошибка
при чтении ~/.pg_service.conf, хотя это было менее очевидно, так как данный файл исполь-
зовался только при указании имени службы.
• Исправление в libpq защиты от целочисленного переполнения в счётчике строк в PGresult
(Микаэль Пакье)
• Исправление в ecpg обработки объявлений курсора вне текущей области с переменными типа
указатель или массив (Михаэль Мескес)
• В ecpglib исправлена обработка обратной косой черты в строковых константах в зависимости
от значения standard_conforming_strings (Такаюки Цунакава)
• Игнорирование в ecpglib дробной части при вводе целочисленных значений в режиме совме-
стимости с Informix (Гао Цзэнци, Михаэль Мескес)
• Добавление отсутствующего предварительного требования temp-install для целей типа check в
Make (Ной Миш)
Некоторые невыполняемые по умолчанию тестовые процедуры, подобные make check, не про-
веряли актуальность временной инсталляции.
2425Замечания к выпуску
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2017c
(Том Лейн)
Тем самым исправлены различные дефекты; единственное, что могут заметить пользователи
— правила перевода на летнее время для часового пояса с именем в стиле POSIX в отсутствие
файла posixrules в каталоге данных часового пояса теперь соответствуют текущему закону
США, а не действовавшему десять лет назад.
• Обновление данных часовых поясов до версии tzdata 2017c, включающее изменения правил
перехода на летнее время на Фиджи, в Намибии, Серверном Кипре, Судане, Тонга и на ост-
ровах Теркс и Кайкос, плюс корректировку исторических данных для Аляски, Апии, Бирмы,
Калькутты, Детройта, Ирландии, Намибии и Паго-Паго.
E.28. Выпуск 9.5.9
Дата выпуска:
2017-08-31
В этот выпуск вошло несколько исправлений, внесённых после версии 9.5.8. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.28.1. Миграция на версию 9.5.9
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.8, см. Раздел E.29.
E.28.2. Изменения
• Отображение сторонних таблиц в представлении information_schema.table_privileges (Пи-
тер Эйзентраут)
Раньше сторонние таблицы отображались в остальных связанных представлениях
information_schema, но отсутствовали в этом.
Так как определение этого представления устанавливается программой initdb, для решения
проблемы будет недостаточно обычного обновления. Если вы хотите исправить существую-
щую инсталляцию, вы можете от имени суперпользователя выполнить в psql:
SET search_path TO information_schema;
CREATE OR REPLACE VIEW table_privileges AS
SELECT CAST(u_grantor.rolname AS sql_identifier) AS grantor,
CAST(grantee.rolname AS sql_identifier) AS grantee,
CAST(current_database() AS sql_identifier) AS table_catalog,
CAST(nc.nspname AS sql_identifier) AS table_schema,
CAST(c.relname AS sql_identifier) AS table_name,
CAST(c.prtype AS character_data) AS privilege_type,
CAST(
CASE WHEN
-- object owner always has grant options
pg_has_role(grantee.oid, c.relowner, 'USAGE')
OR c.grantable
THEN 'YES' ELSE 'NO' END AS yes_or_no) AS is_grantable,
CAST(CASE WHEN c.prtype = 'SELECT' THEN 'YES' ELSE 'NO' END AS yes_or_no)
AS with_hierarchy
FROM (
SELECT oid, relname, relnamespace, relkind, relowner,
(aclexplode(coalesce(relacl, acldefault('r', relowner)))).* FROM pg_class
) AS c (oid, relname, relnamespace, relkind, relowner, grantor, grantee,
prtype, grantable),
pg_namespace nc,
2426Замечания к выпуску
pg_authid u_grantor,
(
SELECT oid, rolname FROM pg_authid
UNION ALL
SELECT 0::oid, 'PUBLIC'
) AS grantee (oid, rolname)
WHERE c.relnamespace = nc.oid
AND c.relkind IN ('r', 'v', 'f')
AND c.grantee = grantee.oid
AND c.grantor = u_grantor.oid
AND c.prtype IN ('INSERT', 'SELECT', 'UPDATE', 'DELETE', 'TRUNCATE',
'REFERENCES', 'TRIGGER')
AND (pg_has_role(u_grantor.oid, 'USAGE')
OR pg_has_role(grantee.oid, 'USAGE')
OR grantee.rolname = 'PUBLIC');
Это потребуется повторить для каждой базы данных, требующей исправления (включая
template0).
• Исправление обработки аварийного выхода (например, при получении SIGTERM) при попытке
выполнить ROLLBACK для прерванной транзакции (Том Лейн)
В таких ситуациях мог происходить сбой проверочного утверждения. В выпускаемых сборках
выход всё равно производился, но в журнал выводилось неуместное сообщение «cannot drop
active portal» (удалить активный портал нельзя).
• Удаление проверочного утверждения, которое могло нарушаться при аварийном выходе (Том
Лейн)
• Правильное обнаружение столбцов, имеющих тип диапазона или домена, который определён
поверх искомого составного или доменного типа (Том Лейн)
Определённые команды ALTER, меняющие определение составного или доменного типа, долж-
ны проверять, нет ли в базе данных значений этого типа, и прерываться, если они есть, так
как для изменения или обновления таких значений нет необходимой инфраструктуры. Ранее
эти проверки могли пропустить значения, обёрнутые в типы диапазонов или вложенные доме-
ны, что могло нарушить целостность в базе данных.
• Устранение сбоя в pg_restore при работе в параллельном режиме и использовании фай-
ла-списка объектов, подлежащих восстановлению (Фабрицио де Ройес Мелло)
• Исправление лексического анализатора ecpg, чтобы он принимал предложения RETURNING без
связанных переменных C (Михаэль Мескес)
Благодаря этому программы ecpg могут содержать SQL-конструкции, использующие
RETURNING внутри (например, внутри CTE), не определяя значения, которые будут возвращены
клиенту.
• Улучшение выбора флагов компилятора для PL/Perl в Windows (Том Лейн)
В результате этого исправления предотвращаются сбои PL/Perl, возможные из-за некор-
ректных предположений о ширине значений time_t. Побочным эффектом, который мо-
гут заметить разработчики расширений, стала ликвидация глобального определения
_USE_32BIT_TIME_T в сборках PostgreSQL для Windows. Это не должно приводить к проблемам,
так как тип time_t не используется ни в каких определениях API PostgreSQL.
• Исправление поведения make check при использовании альтернативной (не GNU) программы
make (Томас Мунро)
E.29. Выпуск 9.5.8
Дата выпуска:
2017-08-10
2427Замечания к выпуску
В этот выпуск вошли различные исправления, внесённые после версии 9.5.7. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.29.1. Миграция на версию 9.5.8
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы используете сторонние серверы данных, на которых для проверки подлинности
применяются пароли, прочитайте ниже первую запись в списке изменений.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.7, см. Раздел E.30.
E.29.2. Изменения
• Дальнейшее ограничение видимости pg_user_mappings.umoptions для защиты паролей, сохра-
нённых в свойствах сопоставлений пользователей (Ной Миш)
Исправление дефекта CVE-2017-7486 оказалось некорректным: в результате пользова-
тель мог видеть свойства своего собственного сопоставления, даже когда он не имел пра-
ва USAGE для соответствующего стороннего сервера. В таких свойствах мог содержаться па-
роль, который должен задавать владелец сервера, а не сам пользователь. Так как представ-
ление information_schema.user_mapping_options не показывает свойства в таких случаях, и
pg_user_mappings не должно. (CVE-2017-7547)
Само по себе это исправление корректирует поведение только в новых базах данных, созда-
ваемых initdb. Если вы хотите применить это исправление к существующей базе данных, вам
нужно будет проделать следующие действия:</N></I-O-Read-Time></li>
  <li>Добавьте allow_system_table_mods = true в postgresql.conf и перезапустите сервер. (В
версиях, поддерживающих ALTER SYSTEM, вы можете воспользоваться этой командой для
изменения конфигурации, но перезапустить сервер потребуется всё равно.)</li>
  <li>В каждой базе данных кластера выполните от имени суперпользователя следующие ко-
манды:
SET search_path = pg_catalog;
CREATE OR REPLACE VIEW pg_user_mappings AS
SELECT
U.oid
AS umid,
S.oid
AS srvid,
S.srvname
AS srvname,
U.umuser
AS umuser,
CASE WHEN U.umuser = 0 THEN
‘public’
ELSE
A.rolname
END AS usename,
CASE WHEN (U.umuser &lt;&gt; 0 AND A.rolname = current_user
AND (pg_has_role(S.srvowner, ‘USAGE’)
OR has_server_privilege(S.oid, ‘USAGE’)))
OR (U.umuser = 0 AND pg_has_role(S.srvowner, ‘USAGE’))
OR (SELECT rolsuper FROM pg_authid WHERE rolname =
current_user)
THEN U.umoptions
ELSE NULL END AS umoptions
FROM pg_user_mapping U
LEFT JOIN pg_authid A ON (A.oid = U.umuser) JOIN
pg_foreign_server S ON (U.umserver = S.oid);
3.
Не забудьте внести коррективы в базах данных template0 и template1, в противном случае
уязвимость сохранится в базах, которые будут создаваться впоследствии. Чтобы поправить
2428Замечания к выпуску
template0, вам потребуется временно разрешить подключения к ней. В PostgreSQL 9.5 и
новее вы можете выполнить
ALTER DATABASE template0 WITH ALLOW_CONNECTIONS true;
, а внеся поправку в template0, восстановить прежнее состояние командой
ALTER DATABASE template0 WITH ALLOW_CONNECTIONS false;
В более ранних версиях вместо этого используйте пару команд
UPDATE pg_database SET datallowconn = true WHERE datname = ‘template0’;
UPDATE pg_database SET datallowconn = false WHERE datname = ‘template0’;
4.
В заключение удалите параметр конфигурации allow_system_table_mods и ещё раз пере-
запустите postmaster.
• Запрет пустых паролей для всех методов аутентификации по паролю (Хейкки Линнакангас)
Библиотека libpq игнорирует пустое указание пароля и не передаёт его на сервер. Поэтому,
если пароль пользователя пустой, psql и другие клиенты на базе libpq не позволяют подклю-
читься с таким паролем. Как следствие, администратор может решить, что установка пустого
пароля равнозначна запрету входа по паролю. Однако с изменённым клиентом или клиентом
не на базе libpq подключение оказывается возможным, в зависимости от настроенного метода
аутентификации. В частности, самый распространённый метод, md5, принимает пустые паро-
ли. В результате этого изменения сервер не будет принимать пустые пароли во всех случаях.
(CVE-2017-7546)
• Добавление в lo_put() проверки права UPDATE для целевых больших объектов (Том Лейн, Ми-
каэль Пакье)
Функция lo_put(), несомненно, должна требовать наличия тех же прав, что и lowrite(), но
такая проверка отсутствовала, что позволяло пользователю менять данные в большом объек-
те. (CVE-2017-7548)
• Исправление в документации описания процесса обновления резервных серверов с использо-
ванием pg_upgrade (Брюс Момджян)
Ранее в документации говорилось, что нужно запустить/остановить ведущий сервер после за-
пуска pg_upgrade, но до синхронизации резервных серверов. Однако эта последовательность
небезопасна.
• Исправление одновременной блокировки цепочки изменённых кортежей (Альваро Эррера)
Когда цепочка изменённых кортежей блокируется одновременно несколькими сеансами в
неконфликтующем режиме с использованием старого снимка, и все операции завершаются
успешно, существовала возможность, что некоторые из них, несмотря на это, нарушатся (и
заключат, что актуальной версии кортежа нет) из-за условий гонки. В частности, вследствие
этого проверка внешнего ключа могла не увидеть кортеж, который определённо существует,
но изменяется параллельной операцией.
• Устранение риска повреждения данных при замораживании кортежа, в котором XMAX равен
идентификатору мультитранзакции с ровно одним ещё востребованным членом (Фёдор Сига-
ев)
• Предупреждение целочисленного переполнения и краха при сортировке в памяти более чем
одного миллиарда кортежей (Сергей Копосов)
• В Windows необходимо повторять попытки создания процесса в случае ошибки при резервиро-
вании диапазона адресов разделяемой памяти в новом процессе (Том Лейн, Амит Капила)
Это должно устранить периодические сбои при запуске дочерних процессов, возможно, вы-
званные вмешательством антивирусных программ.
• Устранение маловероятной возможности повреждения разделяемой хеш-таблицы предикат-
ных блокировок в сборках для Windows (Томас Мунро, Том Лейн)
2429Замечания к выпуску
• Предотвращение вывода в журнал сообщения о штатном закрытии SSL-соединения (поведе-
ние должно быть таким же, как и при сбросе соединения) (Микаэль Пакье)
• Запрещение передачи сеансовых билетов SSL клиентам (Том Лейн)
Это исправление устраняет сбои при переподключении клиентов с реализациями SSL, в кото-
рых эти билеты используются.
• Исправление кода, устанавливающего tcp_keepalives_idle в Solaris (Том Лейн)
• Исправление дефекта в сборщике статистики, приводящего к потере запросных сообщений,
выдаваемых сразу после перезапуска главного процесса (Том Лейн)
Запросы статистики, выдаваемые в течение полсекунды после предыдущего отключения глав-
ного процесса, по сути терялись.
• Размер приёмного буфера в сборщике статистики должен быть не меньше 100 Кбайт (Том
Лейн)
Это снижает риск потери данных статистики на старых платформах, где размер приёмного бу-
фера по умолчанию меньше.
• Устранение возможности создания некорректного сегмента WAL при повышении резервного
сервера сразу после того, как он обрабатывает запись XLOG_SWITCH (Андрес Фройнд)
• Процесс walsender должен завершаться своевременно, когда клиент инициирует выключение
(Том Лейн)
• Исправление обработки сигналов SIGHUP и SIGUSR1 в процессах walsender (Петр Желинек,
Андрес Фройнд)
• Предотвращение панического состояния, которое могут вызвать процессы walsender во время
контрольной точки при выключении (Андрес Фройнд, Микаэль Пакье)
• Устранение неоправданной паузы при перезапуске процессов walreceiver, возникающей
вследствие условий гонки в главном процессе (Том Лейн)
• Устранение утечки маленьких подтранзакций, оказывающихся на диске при логическом деко-
дировании (Андрес Фройнд)
В результате образовывались временные файлы, занимающие лишнее место на диске.
• Оптимизация операций, необходимых для получения снимков при создании слотов логическо-
го декодирования (Андрес Фройнд, Петр Желинек)
Предыдущий алгоритм оказывался очень неэффективным на сервере со множеством откры-
тых транзакций.
• Устранение условий гонки, при которых создание слотов логического декодирования могло
откладываться на неопределённое время (Андрес Фройнд, Петр Желинек)
• Уменьшение издержек при обработке событий сброса системного кеша (Том Лейн)
Это особенно полезно для логического декодирования, когда сброс кеша происходит часто.
• Исправление поведения в ситуациях, когда INSERT или UPDATE присваивает более одного эле-
мента столбцу с типом домена на базе массива (Том Лейн)
• Разрешение использования оконных функций во вложенных SELECT в аргументах агрегатной
функции (Том Лейн)
• Предупреждение конфликта имён с автоматически генерируемыми типами массивов при вы-
полнении ALTER … RENAME (Вик Фиринг)
Ранее автоматически сгенерированный тип массива во избежание конфликта переименовы-
вался при выполнении CREATE; данное исправление распространяет это поведение и на опера-
ции переименования.
2430Замечания к выпуску
• Устранение потери указателя в ALTER TABLE когда для ограничения, принадлежащего табли-
це, добавлен комментарий (Дэвид Роули)
При повторном применении комментария к воссозданному ограничению мог произойти сбой
со странным сообщением или даже с аварийным завершением.
• Добавление для команды ALTER USER … SET всех вариантов синтаксиса, что принимает
ALTER ROLE … SET (Питер Эйзентраут)
• Обновление информации о зависимости при смене типа аргумента или возврата для функции
ввода/вывода с opaque на целевой тип (Хейкки Линнакангас)
CREATE TYPE изменяет функции ввода/вывода, объявленные в давно устаревшем стиле, но ин-
формация о зависимости от этого типа не записывалась, в результате чего после команд DROP
TYPE могли оставаться дефектные определения функций.
• Сокращение использования памяти при обработке командой ANALYZE столбцов tsvector
(Хейкки Линнакангас)
• Устранение ненужной потери точности и небрежного округления при умножении и делении
значений money на целые числа или числа с плавающей точкой (Том Лейн)
• Уточнение проверок пробельных символов в функциях, разбирающих идентификаторы, напри-
мер regprocedurein() (Том Лейн)
В зависимости от используемой локали эти функции могли неправильно воспринимать фраг-
менты многобайтных символов как пробелы.
• Использование уместных символов #define из Perl при сборке PL/Perl (Ашутош Шарма, Том
Лейн)
Это предупреждает проблемы переносимости, обычно проявляющиеся в виде ошибок «про-
верки совместимости» в момент загрузки библиотеки при использовании последних версий
Perl.
• Обеспечение в libpq корректного сброса состояния аутентификации GSS/SASL и SSPI после
неудачной попытки подключения (Микаэль Пакье)
Ранее этот сброс не выполнялся и при переходе с SSL-соединения на не SSL ошибка GSS/SASL
при попытке SSL-подключения мешала затем установить обычное подключение, без SSL. С
SSPI этого не происходило, но имела место утечка памяти.
• В psql устранён сбой, возникающий, когда команда COPY FROM STDIN завершалась вводом сиг-
нала EOF с клавиатуры, а затем следовала ещё одна попытка выполнить COPY FROM STDIN (То-
мас Мунро)
Это некорректное поведение наблюдалось в системах, основанных на BSD, (включая macOS),
но не в других.
• Исправление программ pg_dump и pg_restore, чтобы команды REFRESH MATERIALIZED VIEW вы-
давались в конце (Том Лейн)
Это предотвращает ошибки при выгрузке/восстановлении данных, когда материализованное
представление ссылается на таблицы, принадлежащие другому пользователю.
• Улучшение вывода в pg_dump/pg_restore сообщений об ошибках, возникающих в zlib (Влади-
мир Кунщиков, Альваро Эррера)
• Исправление поведения pg_dump с ключом –clean, чтобы событийные триггеры удалялись
должным образом (Том Лейн)
Теперь также правильно назначаются владельцы событийных триггеров; ранее после запуска
скрипта восстановления такие триггеры оказывались принадлежащими суперпользователю.
• Исправление дефекта в pg_dump, когда для пустого класса операторов выдавался некоррект-
ный SQL (Даниэль Густафссон)
2431Замечания к выпуску
• Исправление вывода pg_dump в stdout на платформе Windows (Кунтал Гхош)
Сжатые данные выгрузки в текстовом виде при выводе в stdout оказывались испорченными
из-за того, что дескриптор файла не переводился в двоичный режим.
• Исправление вывода pg_get_ruledef() для правила ON SELECT, связанного с представлением,
в котором переименовывались столбцы (Том Лейн)
В некоторых особых случаях pg_dump использует pg_get_ruledef() для выгрузки представле-
ний, так что эта ошибка могла приводить к сбоям при выгрузке/загрузке.
• Исправление выгрузки внешних соединений с пустыми ограничениями, получающихся, на-
пример, в результате NATURAL LEFT JOIN без общих столбцов (Том Лейн)
• Исправление выгрузки выражений с функциями в предложении FROM в случаях, когда эти вы-
ражения не преобразуются в нечто, напоминающее вызов функции (Том Лейн)
• Исправление вывода pg_basebackup в stdout на платформе Windows (Харибабу Комми)
Архивируемые данные при выводе в stdout оказывались испорченными из-за того, что де-
скриптор файла не переводился в двоичный режим.
• Исправление pg_rewind для корректной работы с файлами больше 2 ГБ (Кунтал Гхош, Мика-
эль Пакье)
Обычно такие файлы в каталогах данных PostgreSQL не образуются, но в некоторых случаях
они могут появиться.
• Исправление pg_upgrade, чтобы в конечной записи в WAL не оказалось wal_level = minimum
(Брюс Момджян)
Это могло препятствовать переподключению обновлённых резервных серверов.
• Исправление в pg_xlogdump вычисления длины записи WAL (Андрес Фройнд)
• В postgres_fdw соединения к удалённым серверам должны устанавливаться заново после ко-
манд ALTER SERVER и ALTER USER MAPPING (Кётаро Хоригути)
Благодаря этому изменения параметров, затрагивающие свойства соединения, вступят в силу
своевременно.
• В postgres_fdw реализована отмена команд управления удалёнными транзакциями (Роберт
Хаас, Рафия Сабих)
Это изменение позволяет быстрее прервать ожидание неотвечающего удалённого сервера в
большем количестве случаев, чем раньше.
• Увеличение MAX_SYSCACHE_CALLBACKS для выделения дополнительного места расширениям
(Том Лейн)
• При сборке разделяемых библиотек с gcc всегда должен передаваться ключ -fPIC, а не -fpic
(Том Лейн)
Это позволяет поддерживать библиотеки расширений большего размера на тех платформах,
где эти ключи не равнозначны.
• Экранирование фигурных скобок в наших сборочных скриптах для Microsoft MSVC во избежа-
ние предупреждений или ошибок с новыми версиями Perl (Эндрю Дунстан)
• Для сборок MSVC реализована обработка ситуации, когда библиотека OpenSSL находится не в
подкаталоге VC (Эндрю Дунстан)
• Для сборок MSVC добавлен нужный путь для заголовочных файлов libxml2 (Эндрю Дунстан)
Это устраняет прежнюю необходимость перемещения файлов в стандартной инсталляции
libxml2 в Windows.
• Сборки MSVC должны распознавать библиотеку Tcl с именем tcl86.lib (Ной Миш)
2432Замечания к выпуску
• В сборках MSVC должны учитываться флаги в параметре PROVE_FLAGS, заданном в командной
строке vcregress.pl (Эндрю Дунстан)
E.30. Выпуск 9.5.7
Дата выпуска:
2017-05-11
В этот выпуск вошли различные исправления, внесённые после версии 9.5.6. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.30.1. Миграция на версию 9.5.7
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы используете сторонние серверы данных, на которых для проверки подлинности
применяются пароли, прочитайте ниже первую запись в списке изменений.
А если вы используете сторонние средства репликации, основанные на «логическом декодирова-
нии», обратите внимание на четвёртую запись в списке изменений.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.6, см. Раздел E.31.
E.30.2. Изменения
• Ограничение видимости pg_user_mappings.umoptions для защиты паролей, сохранённых в
свойствах сопоставлений пользователей (Микаэль Пакье, Фейке Стинберген)
Предыдущая реализация позволяла владельцу объекта стороннего сервера или любому, кто
получил право USAGE, видеть свойства всех сопоставлений, связанных с этим сервером. В том
числе это могли быть и пароли других пользователей. Теперь определение данного представ-
ления изменено для соответствия поведению information_schema.user_mapping_options, так
что эти свойства может прочитать только собственно пользователь сопоставления либо, если
это сопоставление роли PUBLIC, владелец сервера, либо суперпользователь. (CVE-2017-7486)
Само по себе это исправление корректирует поведение только в новых базах данных, созда-
ваемых initdb. Если вы хотите применить это исправление к существующей базе данных, сле-
дуйте исправленной процедуре в списке изменений, относящейся к CVE-2017-7547, в Разде-
ле E.29.
• Предотвращение утечки статистической информации через негерметичные операторы (Питер
Эйзентраут)
Некоторые функции оценки избирательности в планировщике применяют пользовательские
операторы к значениям, получаемым из pg_statistic, например, к наиболее частым значе-
ниям и элементам гистограммы. Это происходит до проверки прав доступа к таблице, так что
злонамеренный пользователь может воспользоваться этим и получить подобные значения из
столбцов таблицы, чтение которых ему запрещено. Для устранения этой уязвимости следует
переходить к общим оценкам, если функция, реализующая оператор, не считается герметич-
ной и вызывающий её пользователь не имеет права на чтение столбца, статистика по которо-
му требуется планировщику. На практике в большинстве случаев одно из этих условий выпол-
няется. (CVE-2017-7484)
• Восстановление восприятия библиотекой libpq переменной окружения PGREQUIRESSL (Даниэль
Густафссон)
Поддержка этой переменной окружения была непреднамеренно ликвидирована в PostgreSQL
9.3, но в документации она осталась. Это создало угрозу безопасности, так как пользовате-
ли могли рассчитывать на то, что она будет требовать SSL-шифрования подключений, но на
самом деле этого не происходило. Теперь эта переменная воспринимается как и раньше, но
имеет меньший приоритет, чем PGSSLMODE, во избежание нарушения конфигураций, работаю-
щих корректно с версиями после 9.3. (CVE-2017-7485)
2433Замечания к выпуску
• Исправление потенциально некорректного начального снимка при логическом декодирова-
нии (Петр Желинек, Андрес Фройнд)
Изначальный снимок, создаваемый для слота репликации с логическим декодированием, мог
быть некорректным. В результате сторонние средства, использующие логическое декодирова-
ние, могли получать неполные/несогласованные начальные данные. Вероятность такого сбоя
увеличивалась, если при создании слота исходный сервер был загружен либо уже существо-
вал другой логический слот.
Если вы используете средство репликации, основанное на логическом декодировании, и копи-
ровали непустой набор данных в начале репликации, имеет смысл пересоздать реплику после
установления этого обновления либо сверить содержимое базы с исходным сервером.
• Исправление потенциального повреждения «слоёв инициализации» нежурналируемых индек-
сов (Роберт Хаас, Микаэль Пакье)
Это повреждение могло приводить к переходу нежурналируемого индекса в ошибочное состо-
яние после сбоя и перезапуска сервера. Устранить возникшую проблему можно было, только
удалив и перестроив индекс.
• Исправление ошибочного восстановления записей pg_subtrans при воспроизведении резерв-
ным сервером подготовленных, но не зафиксированных двухфазных транзакций (Том Лейн)
В большинстве случаев это не имело никаких болезненных последствий, но в особых ситуаци-
ях могло приводить к зацикливанию ссылок в pg_subtrans, что, в свою очередь, провоцирова-
ло бесконечные циклы в запросах, обращающимся к строкам, изменённым двухфазной тран-
закцией.
• Предотвращение возможного сбоя в walsender при ошибке инициализации буфера строки
(Стас Кельвич, Фудзии Масао)
• Предупреждение возможного сбоя при повторном сканировании индекса GiST с использова-
нием только индекса и поиском ближайших соседей (Том Лейн)
• Исправление поведения postmaster при обработке сбоя fork() для фонового рабочего процес-
са (Том Лейн)
Ранее postmaster модифицировал элементы своего состояния так, как будто процесс был запу-
щен успешно, что впоследствии приводило к замешательству.
• Устранение сбоев или неверных ответов в случаях, когда тип данных столбца в GROUPING SETS
является хешируемым, но не сортируемым (Паван Деоласи)
• Исключение применения оптимизации «физического целевого списка» к нестандартным ска-
нированиям (Дмитрий Иванов, Том Лейн)
Эта оптимизация предполагала, что получить все столбцы кортежа можно недорого, что дей-
ствительно верно для обычных кортежей Postgres, но с нестандартными провайдерами скани-
рования это может быть не так.
• Использование правильного подвыражения при применении политики защиты на уровне
строк FOR ALL (Стивен Фрост)
В некоторых случаях применялось ограничение WITH CHECK, хотя более уместным было бы
ограничение USING.
• Обеспечение видимости результатов непосредственно предшествующих DDL при разборе за-
просов в скриптах расширений (Жульен Рухо, Том Лейн)
Из-за того, что кеш между командами в скрипте расширения не сбрасывался, запрос к дан-
ным мог не наблюдать эффектов непосредственно предшествующего ему изменения каталога,
например результатов ALTER TABLE … RENAME.
• Ликвидация проверки прав доступа к табличному пространству при перестроении существую-
щего индекса командой ALTER TABLE … ALTER COLUMN TYPE (Ной Миш)
2434Замечания к выпуску
Это команда выдавала ошибку, если вызывающий пользователь не имел права CREATE для таб-
личного пространства, содержащего индекс. Такое поведение малополезно, так что стоит ис-
ключить эту проверку и разрешить перестраивать индекс там, где он находился.
• Предотвращение рекурсивного обращения команды ALTER TABLE … VALIDATE CONSTRAINT к
дочерним таблицам когда ограничение помечено как NO INHERIT (Амит Ланготе)
Это предупреждает нежелательные сбои типа «constraint does not exist» (ограничение не су-
ществует) в случаях, когда в дочерних таблицах нет соответствующего ограничения.
• Устранение потери указателя в COPY … TO когда для исходной таблицы активна защита на
уровне строк (Том Лейн)
Обычно это не имело болезненных последствий, но иногда всё же приводило к неожиданным
ошибкам и сбоям.
• Предупреждение обращения к уже закрытому элементу relcache в CLUSTER и VACUUM FULL (Том
Лейн)
При особом стечении обстоятельств это могло приводить к тому, что индексы в целевом отно-
шении перестраивались с неправильным режимом сохранения.
• Исправление ошибки команды VACUUM, когда она неправильно учитывала страницы, которые
не могла прочитать из-за конфликтующих закреплений страниц (Эндрю Гирт)
Это провоцировало недооценивание количества кортежей в таблице. В худшем случае с чрез-
вычайно востребованной таблицей команда VACUUM могла ошибочно сообщить, что таблица во-
все не содержит кортежей, что приводило к очень плохим решениям при планировании.
• Обеспечение возможности прерывания циклов массовой передачи кортежей в соединении по
хешу при попытке отмены запроса (Том Лейн, Томас Мунро)
• Исправление проблем с переполнением целочисленных значений при сравнении типов
interval (Кётаро Хоригути, Том Лейн)
Операторы сравнения для типа interval могли выдавать неверные ответы для интервалов,
превышающих 296000 лет. Индексы по столбцам с такими большими значениями следует пе-
рестроить, так как они могут быть испорчены.
• Исправление функции cursor_to_xml(), чтобы она выдавала правильный результат с
tableforest = false (Томас Мунро, Питер Эйзентраут)
Ранее она не добавляла внешний элемент &lt;table&gt;.
• Устранение проблем с округлением в функциях float8_timestamptz() и make_interval()
(Том Лейн)
Эти функции отбрасывали дробную часть, а не округляли числа при преобразовании значения
с плавающей точкой к целому числу микросекунд; это могло приводить к неожиданным сдви-
гам результатов на единицу.
• Исправление функции pg_get_object_address() для членов семейств операторов (Альваро
Эррера)
• Улучшение производительности представления pg_timezone_names (Том Лейн, Дэвид Роули)
• Уменьшение издержек при управлении памятью для контекстов, содержащих множество
больших блоков (Том Лейн)
• Исправление неаккуратной обработки редких ошибок в lseek() и close() (Том Лейн)
В типичных ситуациях эти системные вызовы отрабатывают без ошибок, но в случае ошибки
код fd.c мог повести себя некорректно.
• Исправление некорректной проверки факта работы postmaster в виде службы Windows (Мика-
эль Пакье)
2435Замечания к выпуску
Вследствие ошибки для вывода сообщений мог выбираться системный журнал событий (там
где его на самом деле не было), так что запись сообщений фактически не производилась.
• Исправление в ecpg поддержки COMMIT PREPARED и ROLLBACK PREPARED (Масахико Савада)
• Исправление ошибки двойного освобождения при обработке строковых констант, заключён-
ных в доллары, в ecpg (Михаэль Мескес)
• В pg_dump исправлена пометка схемы и владельца для комментариев и меток безопасности
некоторых типов объектов БД (Джузеппе Брокколо, Том Лейн)
В простых случаях это не проявлялось никак, но например, при восстановлении с выбором
схемы, могли потеряться комментарии, которые в ней должны быть, из-за того, что они не бы-
ли помечены как принадлежащие схеме своего объекта.
• Предотвращение вывода командой pg_restore -l некорректного файла со списком объектов,
когда имена объектов SQL содержат символы перевода строки (Том Лейн)
Символы перевода строки заменяются пробелами, что достаточно для того, чтобы этот список
корректно обработала команда pg_restore -L.
• Исправление поведения pg_upgrade для корректного переноса комментариев и меток без-
опасности, связанных с «большими объектами» (BLOB) (Стивен Фрост)
Ранее такие объекты корректно переносились в новую базу данных, но связанные с ними ком-
ментарии и метки безопасности терялись.
• Улучшение обработки ошибок в функции pg_file_write() из contrib/adminpack (Ной Миш)
В частности, она не реагировала на ошибки в вызове fclose().
• Предупреждение утечки предыдущего безымянного соединения при установлении нового
безымянного соединения в contrib/dblink (Джо Конвей)
• Исправление извлечения триграмм из регулярных выражений в contrib/pg_trgm (Том Лейн)
В некоторых случаях это могло приводить к формированию испорченной структуры данных,
для которой отсутствуют какие-либо соответствия. Вследствие этого при сканировании по ин-
дексам GIN и GiST с использованием триграмм для регулярного выражения могли не нахо-
диться никакие результаты.
• В contrib/postgres_fdw реализована передача требования отмены запроса удалённому серве-
ру (Микаэль Пакье, Эцуро Фудзита)
Ранее требование на отмену локального запроса не влекло за собой досрочную отмену уда-
лённого запроса, уже переданного на выполнение. Это доработка ранее была реализована в
9.6 и теперь перенесена в 9.5.
• Поддержка Tcl 8.6 в сборках с MSVC (Альваро Эррера)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2017b
(Том Лейн)
Это устраняет ошибку с некоторыми вариантами перехода на летнее время в январе 2038.
• Обновление данных часовых поясов до версии tzdata 2017b, включающее изменение правил
перехода на летнее время в Чили, Монголии и на Гаити, а также исторические изменения для
Эквадора, Казахстана, Либерии и Испании. Переход к числовым аббревиатурам для ряда ча-
совых поясов в Южной Америке, в Тихом и Индийском океанах, а также в некоторых азиат-
ских и ближневосточных странах.
Ранее в базе данных часовых поясов IANA предоставлялись текстовые аббревиатуры для
всех часовых поясов и иногда при этом указывались аббревиатуры, которые практически не
употреблялись местным населением. Сейчас происходит процесс ухода от этой практики в
пользу использования числовых смещений UTC в тех часовых поясах, где нет никаких свиде-
2436Замечания к выпуску
тельств реального использования английской аббревиатуры. Как минимум на данном этапе,
PostgreSQL продолжит принимать подобные удалённые аббревиатуры при вводе дат/времени.
Но они не будут видны при просмотре представления pg_timezone_names и не будут выводить-
ся с датами/временем.
• Использование корректных правил перехода на летнее время для названий часовых поясов в
стиле POSIX при сборке с MSVC (Дэвид Роули)
Сборочные скрипты для MSVC не устанавливали корректно файл posixrules в дерево катало-
гов timezone. Это приводило к тому, что код timezone переходил к использованию встроенных
представлений о том, какой вариант перехода на летнее время применим для названия поя-
са в стиле POSIX. По историческим причинам это соответствует правилам, которые действо-
вали в США до 2007 г. (то есть переход на летнее время происходил в первое воскресенье ап-
реля, а на зимнее — в последнее воскресенье октября). С этим исправлением для часового по-
яса с названием в стиле POSIX будут использоваться текущие и исторические даты перехода
для пояса US/Eastern. Если для вас это нежелательно, удалите файл posixrules или замени-
те его файлом другого часового пояса (см. Подраздел 8.5.3). Учтите, что вследствие кеширо-
вания вам потребуется перезапустить сервер, чтобы подобные изменения вступили в силу.
E.31. Выпуск 9.5.6
Дата выпуска:
2017-02-09
В этот выпуск вошли различные исправления, внесённые после версии 9.5.5. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.31.1. Миграция на версию 9.5.6
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если в вашей инсталляции проявилась ошибка, описанная в первой записи следующего
списка изменений, после обновления вам может потребоваться предпринять дополнительные дей-
ствия для исправления испорченных индексов.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.5, см. Раздел E.32.
E.31.2. Изменения
• Исправление поведения в особых условиях, которое приводило к повреждению индексов, со-
здаваемых командой CREATE INDEX CONCURRENTLY (Паван Деоласи, Том Лейн)
Если команда CREATE INDEX CONCURRENTLY применялась для построения индекса, зависящего
от столбца, ранее не индексированного, то у строк, изменяемых транзакциями, выполняемы-
ми одновременно с командой CREATE INDEX, могли оказываться некорректные записи в индек-
се. В случае подозрений, что вас это коснулось, самое надёжное решение — перестроить та-
кие индексы после установки этого обновления.
• Предотвращение утери специального снимка, используемого при сканированиях каталога,
при преждевременной очистке данных (Tom Lane)
Рабочие процессы не учитывали этот снимок, сообщая о своём самом старом xmin, что остав-
ляло возможность для удаления по-прежнему нужных данных параллельными операциями
очистки. Это приводило к появлению плавающих ошибок с сообщениями «ошибка поиска в
кеше для отношения 1255».
• Исправление некорректной записи в WAL, формируемой для индексов BRIN (Кунтал Гхош)
Запись WAL, выдаваемая для страницы BRIN «revmap» при перемещении кортежа индекса в
другую страницу, была некорректной. При воспроизведении журнала соответствующая часть
индекса становилась непригодной, и её требовалось вычислять заново.
• Безусловное фиксирование в WAL создания «слоя инициализации» для нежурналируемых таб-
лиц (Микаэль Пакье)
2437Замечания к выпуску
Ранее это действие пропускалось при wal_level = minimal, но на самом деле это необходимо
даже в этом случае, чтобы нежурналируемая таблица корректно создавалась пустой после
сбоя.
• Сокращение взаимоблокировок на резервных серверах при воспроизведении операций очист-
ки индекса-B-дерева (Саймон Риггс)
Это изменение исключает существенные задержки при репликации, которые иногда имели
место при воспроизведении таких операций.
• Если процесс сборщика статистики потерян, перезапускать его и в режиме горячего резерва
(Такаюки Цунакава)
• Обеспечение корректной работы механизма уведомлений горячего резерва, когда он включа-
ется при запуске резервного сервера (Антс Аасма, Крейг Рингер)
• Проверка прерываний в момент ожидания конфликтующего запроса сервером горячего ре-
зерва (Саймон Риггс)
• Предупреждение постоянного перезапуска процесса запуска автоочистки в особых случаях
(Амит Хандекар)
Это исправление решает проблему, возникавшую, когда автоочистка номинально отключена
и есть несколько таблиц, требующих «заморозки», но эти таблицы уже обработаны рабочими
процессами автоочистки.
• Исправление проверки на возможность удаления объекта, принадлежащего расширению (Том
Лейн)
Скрипты обновления расширений должны иметь возможность удалять объекты расширений,
но это запрещалось для последовательностей со столбцами serial, а также, возможно, в других
случаях.
• Команда ALTER TABLE должна сохранять назначения табличных пространств индексам при пе-
рестраивании индексов (Том Лейн, Микаэль Пакье)
Ранее с нестандартными значениями default_tablespace были возможны разрушения индек-
сов.
• Исправление некорректного изменения свойств триггерной функции при изменении свой-
ства «откладываемости» ограничения внешнего ключа с помощью команды ALTER TABLE …
ALTER CONSTRAINT (Том Лейн)
Это приводило к странным сбоям при последующем обращении к внешнему ключу, так как
триггеры срабатывали не в положенное время.
• Недопущение удаления ограничения внешнего ключа при наличии событий, ожидающих об-
работки триггерами, для целевого отношения (Том Лейн)
Это предотвращает ошибки «не удалось найти триггер NNN» и «в отношении NNN нет тригге-
ров».
• Исправление поведения ALTER TABLE … SET DATA TYPE … USING в случаях, когда порядок
столбцов в дочерней таблице отличается от родительской (Альваро Эррера)
Вследствие того, что столбцы в выражении USING не перенумеровывались, возникала ошибка,
обычно такая: «атрибут N имеет неправильный тип».
• Исправление обращения к столбцу OID в случаях, когда таблица с таким столбцом связывает-
ся с родительской, тоже с OID, посредством ALTER TABLE … INHERIT (Амит Ланготе)
В таких случаях столбец OID должен обрабатываться как обычный пользовательский столбец,
но этого не происходило, что приводило к странному поведению при последующих изменени-
ях наследования.
2438Замечания к выпуску
• Исправление поведения CREATE OR REPLACE VIEW — запрос представления должен изменяться
до применения новых параметров представления (Дин Рашид)
Ранее в команде происходил сбой, если новые параметры оказывались несогласованными со
старым определением представления.
• Получение правильного идентификатора объекта в ALTER TEXT SEARCH CONFIGURATION (Артур
Закиров)
Ранее расширениям, таким как модули логического декодирования, выдавался неправильный
OID каталога.
• Предупреждение сбоев механизма учёта времени транзакций при запросе особых XID
(FrozenTransactionId и BootstrapTransactionId) (Крейг Рингер)
• Проверка конфликтов сериализуемости перед тем, как будет выдана ошибка нарушения огра-
ничений (Томас Мунро)
В транзакциях сериализуемого уровня изоляции желательно, чтобы ошибка, вызванная па-
раллельными транзакциями, заявлялась как ошибка сериализации, что скажет приложению,
что попытка повторить то же действие может быть успешной. К сожалению, это не будет на-
дёжно работать при дублировании ключа при параллельном его добавлении. В результате это-
го изменения такая ошибка будет выдаваться как ошибка сериализации, если приложение яв-
но проверяет присутствие конфликтующего ключа (и не находит его) до этого в транзакции.
• Исправление некорректного использования reloptions представлений как reloptions обычных
таблиц (Том Лейн)
Симптомами ошибки были неуместные сообщения «ON CONFLICT не поддерживается
для таблицы …, служащей таблицей каталога» когда целевым отношением INSERT … ON
CONFLICT было представление с каскадной проверкой.
• Исправление некорректного сообщения «допустимое число элементов в целевом списке огра-
ничено N» при использовании ON CONFLICT с широкими таблицами (Том Лейн)
• Предотвращение разворачивания foo.* в набор столбцов в исходном выражении UPDATE (Том
Лейн)
Это приводило к ошибкам с сообщением «несоответствие целевого количества в UPDATE —
внутренняя ошибка». Теперь эта запись воспринимается как обозначение переменной «вся-
строка», как и в других контекстах.
• Обеспечение точного определения модификаторов типа столбцов в конструкциях VALUES с
несколькими строками (Том Лейн)
Это устраняет проблемы, возникавшие, когда первое значение в столбце имеет воспринима-
емый модификатор типа (например, длину значения varchar), но последующие значения не
разделяют его ограничение.
• При нахождении незаконченной суррогатной пары Unicode в конце строки символов Unicode
должна выдаваться ошибка (Том Лейн)
Обычно за начальным суррогатным символом Unicode должно следовать продолжение, но
это не проверялось когда такой начальный символ оказывался последним в строке символов
Unicode (U&amp;’…’) или в Unicode-идентификаторе (U&amp;”…”).
• Определённо отрицательному поисковому запросу, например, !foo, должны удовлетворять пу-
стые значения tsvector (Том Дунстан)
Такие соответствия находились при поиске по индексу GIN, но не при последовательном ска-
нировании или поиске по индексу GiST.
• Предотвращение сбоя в ситуации, когда ts_rewrite() заменяет поддерево не верхнего уровня
пустым запросом (Артур Закиров)
2439Замечания к выпуску
• Устранение проблем с производительностью в ts_rewrite() (Том Лейн)
• Исправление обработки в ts_rewrite() вложенных операторов NOT (Том Лейн)
• Увеличение скорости пользовательских агрегатов, использующих в качестве перехода функ-
цию array_append() (Том Лейн)
• Исправление array_fill() для корректной обработки пустых массивов (Том Лейн)
• Предупреждение возможных сбоев в функциях array_position() и array_positions() при об-
работке массивов записей (Джун-сок Янг)
• Устранение выхода на один байт за границу буфера в функции quote_literal_cstr() (Хейкки
Линнакангас)
Этот выход имел место только если входная строка содержала исключительно апострофы и/
или обратные косые черты.
• Предотвращение одновременного выполнения вызовов pg_start_backup() и
pg_stop_backup() (Микаэль Пакье)
Это предупреждает сбой проверки истинности и, вероятно, худшие последствия, в случае, ес-
ли кто-то попытается запустить эти функции параллельно.
• Отключение трансформации, которая пыталась оптимизировать бесполезные преобразования
AT TIME ZONE (Том Лейн)
Вследствие этого выдавались неверные результаты, когда упрощённое выражение использова-
лось в условии индекса.
• Сохранение приведений interval-в-interval, которые на самом деле несут смысловую на-
грузку (Том Лейн)
В некоторых случаях приведения, которые должны были обнулять младшие поля значений
interval, ошибочно считались бессмысленными и просто убирались. В результате, например,
при приведении значения типа INTERVAL MONTH к INTERVAL YEAR поле месяцев не обнулялось.
• Исправление ошибок при передаче значений параметров GUC параллельным исполнителям
(Микаэль Пакье, Том Лейн)
• Аннулирование кешированных планов при изменениях в параметрах сторонних таблиц (Амит
Ланготе, Эцуро Фудзита, Ашутош Бапат)
• Исправление pg_dump для корректной выгрузки пользовательских приведений и преобразова-
ний, использующих встроенные функции (Стивен Фрост)
• Реализация более разумного поведения pg_restore с –create –if-exists в случаях, когда
архив содержит нераспознанные команды DROP (Том Лейн)
Это не устраняет никакую наблюдаемую ошибку, но может улучшить поведение в будущем,
при использовании pg_restore с архивом, созданным предыдущей версией pg_dump.
• Исправление ограничения нагрузки pg_basebackup при низкой скорости ввода/вывода (Анто-
нин Хоуска)
Если скорость диска на время оказывалась ниже заданного ограничения, в вычислении про-
исходило переполнение, и в результате ограничение отключалось до конца операции.
• Обеспечение корректной работы pg_basebackup с подкаталогами pg_stat_tmp и pg_replslot,
являющимися символическими ссылками (Магнус Хагандер, Микаэль Пакье)
• Предотвращение возможного сбоя pg_basebackup на резервном сервере при задействовании
файлов WAL (Амит Капила, Роберт Хаас)
• Исправление возможного дефекта при обработке развёрнутых массивов в ограничениях-про-
верках доменов и в конструкциях CASE (Том Лейн)
2440Замечания к выпуску
Существовала вероятность, что функция PL/pgSQL, вызванная в этих контекстах, изменит или
даже удалит значение массива, которое должно сохраняться для дополнительных операций.
• Исправление рекурсивного вызова функций PL/pgSQL в таких контекстах, как проверки огра-
ничений домена, выполняемые при присвоении значения переменной PL/pgSQL (Том Лейн)
• Обеспечение правильного учёта объектов исключений Python, создаваемых нами для PL/
Python, счётчиками использования (Рафа де ла Торре, Том Лейн)
Это предотвращает ошибки, возникавшие при использовании объектов после цикла уборки
мусора в Python.
• Исправление в PL/Tcl поддержки триггеров для таблиц, в которых имеется столбец .tupno
(Том Лейн)
Это соответствует (ранее недокументированному) поведению команд PL/Tcl spi_exec и
spi_execp, в том, что особый столбец .tupno добавляется, только если отсутствует настоящий
с таким именем.
• В файлах ~/.pgpass должны допускаться завершения строк в стиле DOS, даже на Unix-плат-
формах (Вик Фиринг)
Это изменение упрощает использование одних и тех же файлов паролей на машинах с Unix и
Windows.
• Устранение выхода на один байт за границу буфера, когда ecpg передаётся имя файла, кото-
рое заканчивается точкой (Такаюки Цунакава)
• Исправление в psql дополнения табуляцией для команды ALTER DEFAULT PRIVILEGES (Жиль
Даролд, Стивен Фрост)
• В psql пустое или содержащее только пробелы значение переменной окружения PAGER долж-
но означать «без постраничника» (Том Лейн)
Ранее с таким значением вывод, предназначенный для постраничника, просто исчезал.
• Улучшение в contrib/dblink передачи сообщений о низкоуровневых ошибках libpq, напри-
мер, о нехватке памяти (Джо Конвей)
• Реализация contrib/dblink должна игнорировать невоспринимаемые ей параметры серве-
ра, когда в качестве источника параметров подключения используется сторонний сервер
contrib/postgres_fdw (Кори Хинкер)
Ранее, если объект стороннего сервера имел параметры, которые не относились к параметрам
подключения libpq, происходила ошибка.
• Исправление проблем с переносимостью в функциях contrib/pageinspect, связанных с ин-
дексами GIN (Питер Эйзентраут, Том Лейн)
• В Windows изменённые переменные окружения должны передаваться и отладочным DLL
(Кристина Ульрих)
• Синхронизация нашей копии библиотеки timezone с выпущенной IANA версией tzcode2016j
(Том Лейн)
Это решило ряд проблем; в частности, проблему при установке данных о часовых поясах в ка-
талог, в котором не поддерживаются жёсткие ссылки.
• Обновление данных часовых поясов до версии tzdata 2016j, включающее изменения правил
перехода на летнее время на Северном Кипре (добавление нового пояса Asia/Famagusta), в
России (добавление нового пояса Europe/Saratov), в Тонга и в Антарктике/Кейси, плюс коррек-
тировку исторических данных для Италии, Казахстана, Мальты и Палестины. Переход к пред-
почитаемому числовому обозначению пояса для Тонга.
2441Замечания к выпуску
E.32. Выпуск 9.5.5
Дата выпуска:
2016-10-27
В этот выпуск вошли различные исправления, внесённые после версии 9.5.4. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.32.1. Миграция на версию 9.5.5
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если в вашей инсталляции проявилась ошибка, описанная в первой записи следующего
списка изменений, после обновления вам может потребоваться предпринять дополнительные дей-
ствия для исправления испорченных карт свободного места.
Также, если вы обновляете сервер с более ранней версии, чем 9.5.2, см. Раздел E.35.
E.32.2. Изменения
• Корректировка записи в WAL отметки об очистке карт свободного пространства и видимости
(Паван Деоласи, Хейкки Линнакангас)
Ранее могло получаться так, что эти файлы не восстанавливались корректно при восстановле-
нии после сбоя или оказывались неправильными на резервном сервере. Обращение к недей-
ствительному содержимому карты свободного пространства могло повлечь попытки использо-
вать страницы, которые были стёрты из самого отношения, что обычно приводило к ошибкам
типа «не удалось прочитать блок XXX: прочитано только 0 из 8192 байт». Также были возмож-
ны нарушения контрольных сумм в карте видимости, при включённом механизме контроль-
ных сумм.
Процедуры для определения наличия проблемы и её исправления рассматриваются в https://
wiki.postgresql.org/wiki/Free_Space_Map_Problems.
• Исправление некорректного создания в WAL записей, относящихся к индексам GIN, на маши-
нах с порядком байт от старшего (Том Лейн)
Типичным симптомом данной проблемы были ошибки «unexpected GIN leaf action» (неожидан-
ное действие на уровне листьев GIN) при воспроизведении WAL.
• Исправление команды SELECT FOR UPDATE/SHARE, чтобы кортежи, изменённые впоследствии
прерванной транзакцией, блокировались корректно (Альваро Эррера)
Начиная с версии 9.5, команда SELECT иногда могла вообще не выдавать такие кортежи. Под-
тверждений того, что это могло иметь место в предыдущих версиях, не было, но теоретически
при одновременных изменениях это возможно.
• Исправление перепроверок EvalPlanQual в ситуациях со сканированием CTE (Том Лейн)
Перепроверка всегда воспринимала такие CTE, как не возвращающие строки, в результате че-
го обычно не удавалось изменить строки, которые были изменены недавно.
• Исправлено удаление спекулятивно добавленных кортежей TOAST при выходе из INSERT …
ON CONFLICT (Оскари Сааренмаа)
В условиях гонки, когда две транзакции пытаются вставить конфликтующие кортежи, в проиг-
равшей транзакции происходила ошибка «попытка удаления невидимого кортежа», если при
добавлении вставлялись поля TOAST.
• Предотвращение ошибок сериализации при операции добавлении данных, конфликтующей с
собой же, в INSERT … ON CONFLICT (Томас Мунро, Питер Геохеган)
• Исправление некорректного повторения предыдущих результатов агрегирования по хешу в
подзапросе (Эндрю Гирт)
2442Замечания к выпуску
Проверка возможности повторного использования ранее вычисленной хеш-таблицы со значе-
ниями состояния агрегата не учитывала то, что в выражении агрегируемого аргумента мог-
ла фигурировать ссылка на внешний запрос. В этом случае изменение в значении этой ссылки
должно было приводить к пересчёту хеш-таблицы, но этого не происходило.
• Ликвидирована утечка памяти на протяжении запроса в массовой команде UPDATE для табли-
цы с индексом PRIMARY KEY или REPLICA IDENTITY (Том Лейн)
• Исправление COPY со списком имён столбцов из таблицы, в которой включена защита на уров-
не строк (Адам Брайтвелл)
• Исправление EXPLAIN, чтобы она выдавала корректный XML, когда параметр track_io_timing
включён (Маркус Винанд)
Ранее вывод в формате XML содержал синтаксически некорректные теги, как например &lt;I/O-
Read-Time&gt;. Сейчас выдаётся такой тег: <I-O-Read-Time>.
• Подавление вывода нулей для неизмеренного времени в EXPLAIN (Максим Милютин)
При определённом сочетании параметров команда EXPLAIN выдавала нулевые значения для
того времени, которое на самом деле даже не замеряется при этих параметрах. Мы придер-
живаемся политики не выдавать такие поля в выводе EXPLAIN, так что нужно обеспечить со-
гласованность во всех случаях.
• Исправление обновления статистики при TRUNCATE в подготовленной транзакции (Стас Кель-
вич)
• Исправление длительности таймаута, установленного для ожидания командой VACUUM исклю-
чительной блокировки, чтобы она могла опустошить таблицу (Саймон Риггс)
Длительность таймаута должна была составлять 50 миллисекунд, но на самом деле это было
лишь 50 микросекунд, в результате чего команда VACUUM оставляла попытку опустошить таб-
лицу гораздо раньше, чем планировалось. Теперь устанавливается запланированное значе-
ние.
• Исправление ошибок при объединении наследуемых ограничений CHECK в процессе создания
или изменения структуры таблицы (Том Лейн, Амит Ланготе)
Теперь одинаковые ограничения CHECK могут добавляться в родительскую и дочернюю таб-
лицу в любом порядке. С другой стороны, слияние проверенного ограничения из родитель-
ской таблицы с непроверенным (NOT VALID) ограничением в дочерней не должно допускаться.
Подобным образом, не должно допускаться слияние дочернего ненаследуемого (NO INHERIT)
ограничения с наследуемым.
• Вывод разумного значения в pg_settings.unit для параметров min_wal_size и max_wal_size
(Том Лейн)
• Ликвидация искусственных ограничений на значения, принимаемые функциями
numeric_in() и numeric_recv() (Том Лейн)
Мы принимаем числовые значения, не превышающие предела хранения (больше 1e100000),
поэтому кажется довольно неразумным, что numeric_in() не принимала в научной записи
экспоненты больше 1000. Также нет смысла не принимать в numeric_recv() более 1000 цифр
во вводимом значении.
• Предотвращение очень маловероятного повреждения данных в результате проверки видимо-
сти кортежа без удержания блокировки буфера (Томас Мунро, Питер Геохеган, Том Лейн)
• Сохранение времени фиксирования транзакций после перезагрузки сервера (Жульен Рухо,
Крейг Рингер)
При включённом параметре track_commit_timestamp старые метки времени фиксации стано-
вились недоступными после полной перезагрузки сервера.
2443Замечания к выпуску
• Исправление логического декодирования WAL в случаях, когда вывод WAL из подтранзакции
оказывался слишком большим и вымещался на диск (Андрес Фройнд)
• Исправление возможной ошибки сортировки при прекращении использования сокращённых
ключей (Питер Геохеган)
В худшем случае это могло приводить к повреждению индекса-B-дерева, что потребует пере-
строить его с помощью команды REINDEX. Но, как нам представляется, такие ситуации очень
редки.
• Ликвидация утечки дескриптора файла, имевшей место при опустошении временного отноше-
ния размером более 1 Гбайта (Андрес Фройнд)
• Запрещение запуска самостоятельного обслуживающего процесса при включённом режиме
standby_mode (Микаэль Пакье)
Такой режим не будет ничем полезен, так как никакой процесс-приёмник WAL не сможет по-
лучать данные WAL; и это может привести к некорректному поведению кода, который не рас-
считан на такую ситуацию.
• Исправление инициализации состояния слота репликации при повторном использовании сло-
та (Микаэль Пакье)
В результате того, что не все поля слота сбрасывались, команда VACUUM могла не удалять
«мёртвые» кортежи.
• Округление размера запроса разделяемой памяти до числа, кратного размеру огромной стра-
ницы, когда огромные страницы используются в Linux (Том Лейн)
Это позволяет избежать возможных сбоев в munmap() в системах с нетипичными размерами
огромных страниц. За исключением случаев краха, эти сбои проявлялись только в сообщениях
в журнале.
• Выбор более случайного значения для идентификатора управляющего сегмента динамиче-
ской разделяемой памяти (Роберт Хаас, Том Лейн)
Ранее каждый раз выбиралось одно и то же значение, потому что оно получалось из random(),
но srandom() к этому моменту ещё не вызывалась. Это относительно безвредно, однако плани-
ровалось другое поведение.
• В Windows нужно повторять попытку создания управляющего сегмента динамической разде-
ляемой памяти после ошибки «нет доступа» (Кётаро Хоригути, Амит Капила)
Иногда Windows выдаёт ошибку ERROR_ACCESS_DENIED вместо ERROR_ALREADY_EXISTS, когда та-
кой сегмент уже существует. Получая такую ошибку, главный процесс не мог запуститься,
считая, что столкнулся с неисправимой ошибкой.
• Исправление в PL/pgSQL поведения с параметрами и локальными переменными типов
int2vector и oidvector (Том Лейн)
• Не пытаться разделять контекст SSL между несколькими подключениями в libpq (Хейкки
Линнакангас)
Такое разделение приводило к разнообразным ошибкам, особенно при попытке использова-
ния различных параметров SSL для разных соединений.
• Предотвращение утечек памяти в особых случаях в libpq (Том Лейн)
Поступило сообщение об утечке в процессе PQreset(), но были возможны проявления и в свя-
занных случаях.
• Согласование поведения параметров --help и --version программы ecpg со всеми остальны-
ми нашими программами (Харибабу Комми)
• Исправление расчёта средней задержки в pgbench (Фабьен Коэльо)
2444Замечания к выпуску
Этот расчёт был неверным при наличии в скрипте команд \sleep или когда длительность те-
ста ограничивалась числом транзакций, а не общим временем.
• В pg_upgrade проверка загружаемости библиотек должна производиться по порядку имён
(Том Лейн)
Это обходное решение проблемы зависимостей между расширениями, образуемых связями
модулей трансформации языков с базовыми модулями самих языков и типов данных.
• Программа pg_dump никогда не должна выгружать функции-конструкторы диапазонов (Том
Лейн)
В результате такой выгрузки программа pg_upgrade не могла справиться с расширениями,
включающими диапазонные типы, пытаясь дважды создать их функции-конструкторы.
• При запуске pg_dump с ключом -C должно подавляться предложение TABLESPACE команды
CREATE DATABASE, если указан ключ --no-tablespaces (Том Лейн)
• Исправление работы pg_receivexlog с ключом --synchronous без слотов (Габриэль Бартолини)
• Недопущение одновременного указания аргументов --source-server и --source-target для
pg_rewind (Михаэль Банк)
• Программа pg_rewind должна отключать synchronous_commit в своём сеансе на исходном сер-
вере (Михаэль Банк, Микаэль Пакье)
При этом pg_rewind сможет работать, даже когда на исходном сервере настроена синхронная
репликация, но она по какой-то причине не функционирует.
• В pg_xlogdump нужно повторять попытку открыть новый сегмент WAL, когда используется па-
раметр --follow (Магнус Хагандер)
Это позволяет справиться с возможной задержкой при создании сервером следующего сег-
мента.
• Исправление программы pg_xlogdump, чтобы она корректно работала с файлом WAL, начина-
ющимся с записи продолжения, располагающейся на нескольких страницах (Паван Деоласи)
• Исправление contrib/pg_buffercache для работы со значением shared_buffers, превышаю-
щим 256 Гбайт (КайГай Кохэй)
• Исправление скрипта contrib/intarray/bench/bench.pl, чтобы он выводил результаты ко-
манды EXPLAIN, которую он выполняет при запуске с ключом -e (Даниэль Густафссон)
• Поддержка OpenSSL 1.1.0 (Хейкки Линнакангас)
• Внедрение инфраструктуры тестирования TAP, чтобы её можно было применять для тестиро-
вания расширений (Крейг Рингер)
Когда PostgreSQL конфигурируется с параметром --enable-tap-tests, теперь команда «make
install» будет устанавливать файлы поддержки Perl для тестирования TAP туда, где PGXS смо-
жет найти их. Благодаря этому внешние расширения смогут использовать $(prove_check) без
дополнительных проверок.
• В сборках MSVC программа pg_recvlogical включена в клиентский набор (МауМау)
• Корректировка сопоставления часовых поясов в Windows, чтобы сервер корректно распозна-
вал имена часовых поясов, появившиеся в последних версиях Windows (Микаэль Пакье)
• Предупреждение ошибок при использовании устаревших аббревиатур динамических часовых
поясов (Том Лейн)
Если аббревиатуре динамического часового пояса не соответствует запись в данных часово-
го пояса, считать её равнозначной имени часового пояса. Это предупреждает неожиданные
ошибки, когда IANA удаляет аббревиатуры из своей базы данных часовых поясов, что произо-
шло в выпуске tzdata 2016f и, вполне вероятно, повторится в будущем. Вследствие этого не
2445Замечания к выпуску
только не распознавались отдельные аббревиатуры; при любом расхождении происходил сбой
в представлении pg_timezone_abbrevs.
• Обновление данных часовых поясов до версии tzdata 2016h, включающее изменение правил
перехода на летнее время в Палестине и Турции, а также исторические изменения для Тур-
ции и некоторых регионов России. Переход к числовым аббревиатурам для некоторых часовых
поясов в Антарктике, бывшем Советском Союзе и на Шри-Ланке.
Ранее в базе данных часовых поясов IANA предоставлялись текстовые аббревиатуры для
всех часовых поясов и иногда при этом указывались аббревиатуры, которые практически не
употреблялись местным населением. Сейчас происходит процесс ухода от этой практики в
пользу использования числовых смещений UTC в тех часовых поясах, где нет никаких свиде-
тельств реального использования английской аббревиатуры. Как минимум на данном этапе,
PostgreSQL продолжит принимать подобные удалённые аббревиатуры при вводе дат/времени.
Но они не будут видны при просмотре представления pg_timezone_names и не будут выводить-
ся с датами/временем.
Начиная с этого выпуска, аббревиатура AMT более не считается занятой часовым поясом Ар-
мении. Поэтому мы изменили значение этой аббревиатуры по умолчанию, чтобы она обозна-
чала Амазонское время (Amazon Time), так что теперь она означает UTC-4, а не UTC+4.
E.33. Выпуск 9.5.4
Дата выпуска:
2016-08-11
В этот выпуск вошли различные исправления, внесённые после версии 9.5.3. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.33.1. Миграция на версию 9.5.4
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.2, см. Раздел E.35.
E.33.2. Изменения
• Исправление некорректного вычисления вложенных выражений CASE-WHEN (Хейкки Линнакан-
гас, Микаэль Пакье, Том Лейн)
Выражение CASE, фигурирующее в подвыражении проверки другого выражения CASE, мог-
ло некорректно оценивать, отличается ли его собственное проверяемое значение от NULL.
Кроме того, встраивание SQL-функции, реализующей оператор равенства, который использу-
ется выражением CASE, может привести к передаче неправильного проверяемого значения
функциям, вызываемым в выражении CASE в теле функции SQL. Если же проверяемые значе-
ния оказываются разных типов, возможен сбой; более того, это может эксплуатироваться для
несанкционированного чтения областей памяти сервера. (CVE-2016-5423)
• Корректировка в клиентских программах обработки специальных символов в именах ролей и
баз данных (Ной Миш, Натан Боссарт, Микаэль Пакье)
Программа vacuumdb и другие клиентские утилиты во многих местах могли некорректно вос-
принимать имена ролей и баз данных, включающие кавычки или обратную косую черту. Те-
перь проверки ужесточены во избежание рисков. Также, когда этим программам вместо име-
ни базы передаётся строка подключения, она обрабатывается должным образом.
Приведение в соответствие с документацией правил обработки пар двойных кавычек в коман-
дах psql \connect и \password.
Введение нового параметра -reuse-previous для команды psql \connect, позволяющего явно
указывать, должны ли повторно использоваться параметры предыдущего подключения. (Без
данного параметра это, как и раньше, зависит от того, похоже ли имя базы данных на стро-
2446Замечания к выпуску
ку подключения.) Это позволяет безопасно оперировать с именами баз данных, содержащими
специальные символы, в скриптах pg_dumpall.
pg_dumpall теперь не будет принимать имена ролей или баз данных, содержащие символы пе-
ревода строки или возврата каретки, так как безопасно экранировать эти символы в Windows
не представляется практичным. В будущем мы можем запретить такие имена и на стороне
сервера, но пока это не сделано.
Эти коррективы считаются исправлениями уязвимостей, так как, сконструировав имена объ-
ектов специальным образом (используя спецсимволы), можно было сформировать произволь-
ные команды, которые выполнятся с правами суперпользователя, когда суперпользователь бу-
дет выполнять pg_dumpall или другие операции обслуживания базы. (CVE-2016-5424)
• Исправление некорректного в особых случаях поведения проверок IS NULL/IS NOT NULL, при-
меняемых к вложенным составным значениям (Эндрю Гирт, Том Лейн)
В стандарте SQL говорится, что проверка IS NULL должна возвращать TRUE для строки со все-
ми значениями NULL (то есть ROW(NULL,NULL) IS NULL выдаёт TRUE), но это не должно дей-
ствовать рекурсивно (то есть, ROW(NULL, ROW(NULL,NULL)) IS NULL выдаёт FALSE). В основном
исполнителе это реализовано правильно, но при некоторых оптимизациях планировщика эта
проверка рассматривалась как рекурсивная (и TRUE выдавалось в обоих случаях), кроме того,
обёртка contrib/postgres_fdw тоже могла выдавать удалённые запросы с подобным некор-
ректным поведением.
• Исправление ошибки «unrecognized node type» (нераспознанный тип узла) при INSERT ... ON
CONFLICT в рекурсивном CTE (элементе WITH) (Питер Геохеган)
• Исправление в INSERT ... ON CONFLICT сопоставления предикатов или выражений индексов,
которые были упрощены планировщиком на стадии предобработки выражений (Том Лейн)
• Правильная обработка нарушений ограничений-исключений, которые применяются к целе-
вой таблице команды INSERT ... ON CONFLICT, но не являются решающими индексами (Том
Лейн)
В таких случаях должна выдаваться обычная ошибка нарушения ограничения, но вместо это-
го код попадал в бесконечный цикл.
• Исправление INSERT ... ON CONFLICT, чтобы при наличии в целевой таблице уникального ин-
декса по OID не происходила ошибка (Том Лейн)
• Недопущение для типов данных inet и cidr входных адресов IPv6 со слишком большим коли-
чеством разделённых двоеточиями полей (Том Лейн)
• Предотвращение сбоя в close_ps() (операторе point ## lseg) для входных координат NaN
(Том Лейн)
В таких случаях должен просто возвращаться NULL.
• Предотвращение сбоя в функции pg_get_expr(), когда ей передаются несогласованные значе-
ния (Микаэль Пакье, Томас Мунро)
• Исправление в нескольких местах выхода на один байт за границу буфера в to_number() (Пи-
тер Эйзентраут)
В некоторых случаях функция to_number() могла читать из входной строки на один символ
больше, чем нужно. Это создавало небольшой риск сбоя в случае расположения входной стро-
ки у края блока памяти.
• Планировщик не должен запускаться для запроса, заданного в операторе CREATE
MATERIALIZED VIEW или CREATE TABLE AS с указанием WITH NO DATA (Микаэль Пакье, Том
Лейн)
Это предотвращает некоторые лишние условия ошибки, например, когда стабильная функция,
вызываемая материализованным представлением, зависит от ещё не существующей таблицы.
2447Замечания к выпуску
• Ликвидация небезопасного промежуточного состояния при выполнении heap_update() по
сложному пути (Масахико Савада, Андрес Фройнд)
Ранее в особых случаях целевой кортеж блокировался (путём изменения его XMAX), но это
действие не отражалось в журнале, что могло угрожать целостности данных, если страница
вымещалась на диск, а затем, до завершения изменения кортежа, происходил сбой базы.
• Исправление обновления вспомогательных битов при воспроизведении из WAL операций бло-
кирования строк (Андрес Фройнд)
Единственным известным последствием этой проблемы было то, что блокировки строк, удер-
живаемые подготовленной, но не зафиксированной транзакцией, могли теряться после сбоя и
перезапуска сервера.
• Предотвращение неоправданных ошибок «could not serialize access» (не удалось сериализо-
вать доступ) при получении блокировок строк FOR KEY SHARE в сериализуемом режиме (Альва-
ро Эррера)
• «Развёрнутые» данные, возвращаемые узлом плана, должны быть доступны только для чтения
(Том Лейн)
Это предотвращает сбои в некоторых случаях, когда результат нижнего узла плана неодно-
кратно задействуется в верхних узлах. Если говорить о ядре PostgreSQL, риску подвержены
только значения массивов, возвращаемые функциями PL/pgSQL; но расширения могут исполь-
зовать развёрнутые данные и для других целей.
• Предупреждение сбоя в postgres -C, когда указанная переменная имеет пустое строковое
значение (Микаэль Пакье)
• Предотвращение незапланированного ожидания приёмника в процессах, передающих WAL
(Кётаро Хоригути)
• Исправление возможной потери больших подтранзакций при логическом декодировании
(Петру-Флорин Миханча)
• Исправление сбоя логического декодирования, когда подтранзакция не содержит фактиче-
ских изменений (Марко Тииккая, Эндрю Гирт)
• Предоставление обслуживающим процессам актуальной статистики по общим каталогам (Том
Лейн)
Ранее сборщик статистики не мог обновлять файл статистики для общих каталогов по запросу
от обычного обслуживающего процесса. Эта проблема была частично скрыта, так как процесс
запуска автоочистки регулярно выдавал запросы, в результате которых такие обновления про-
изводились: однако она проявлялась при отключении автоочистки.
• Исключение ненужной записи в файлы статистики, когда несколько обслуживающих процес-
сов запрашивают обновление один за другим (Том Лейн, Томаш Вондра)
• Исключение потребления лишнего ID транзакции во время VACUUM (Александр Коротков)
В некоторых случаях в процессе VACUUM текущей транзакции без необходимости присваивался
XID. В обычных условиях это некритично, но если очистка выполняется для предотвращения
зацикливания идентификаторов транзакций, потребление дополнительных идентификаторов
может привести к очень плохим последствиям.
• Предотвращение риска сбоя при очистке идентификаторов мультитранзакций в инсталляции,
обновлённой (с помощью pg_upgrade) с версии старее 9.3 (Эндрю Гирт, Альваро Эррера)
Обычно этот дефект проявлялся в ошибках типа «MultiXactId NNN has not been created yet --
apparent wraparound» (MultiXactId %u ещё не был создан: видимо, произошло зацикливание).
• Когда в запускаемой вручную команде ANALYZE задаётся список столбцов, не нужно сбрасы-
вать счётчик changes_since_analyze целевой таблицы (Том Лейн)
2448Замечания к выпуску
Если мы анализируем только избранные столбцы, мы не должны предотвращать запуск проце-
дуры автоанализа для других столбцов.
• Исправление ошибки в ANALYZE с завышением показателя n_distinct для столбца, содержа-
щего уникальные или почти уникальные значениями и вместе с тем множество NULL (Том
Лейн)
Значения NULL могли учитываться как будто они сами являются уникальными, что приводи-
ло к серьёзным просчётам планировщика с запросами некоторых типов.
• Недопущение запуска при автоочистке нескольких рабочих процессов для одного общего ка-
талога (Альваро Эррера)
Обычно это не представляет большой проблемы, так как очистка выполняется быстро; но ес-
ли каталог очень сильно замусорен, это может привести к тому, что все рабочие процессы,
кроме одного, будут бессмысленно ждать, вместо того, чтобы делать что-то полезное с други-
ми таблицами.
• Исправление ошибки при обработке пометки/восстановления позиции в B-дереве (Кевин
Гриттнер)
Вследствие этой ошибки могли выдаваться некорректные результаты соединения или ошибоч-
ные утверждения при соединении слиянием, в котором внутренним узлом оказывалось скани-
рование индекса-B-дерева.
• Предупреждение двойного освобождения блокировки буфера при отказе от попытки удаления
страницы индекса-B-дерева (Том Лейн)
В результате этой ошибки процедура VACUUM не могла завершиться в некоторых случаях при
наличии проблем с индексами-B-деревьями.
• Исправление ошибки при построении больших (больше shared_buffers) хеш-индексов (Том
Лейн)
В коде, работающем с большими индексами, обнаружилась ошибка, приводящая к добавле-
нию в индекс некорректных хеш-значений, так что последующий поиск по индексу всегда был
безуспешным, кроме случаев, когда кортежи вставлялись в индекс уже после его создания.
• Предотвращение бесконечного цикла при построении индексов GiST для геометрических
столбцов с составными значениями, содержащими NaN (Том Лейн)
• Предупреждение сбоя при сканировании с поиском ближайших соседей (упорядоченно-
го (ORDER BY) по расстоянию) по индексу contrib/btree_gist, построенному по столбцу
interval (Питер Геохеган)
• Исправление ошибки «PANIC: failed to add BRIN tuple» (ПАНИКА: не удалось добавить кортеж
BRIN), возникавшей при попытке изменить элемент индекса BRIN (Альваро Эррера)
• Предупреждение возможных сбоев при остановке фонового рабочего процесса (Дмитрий Ива-
нов)
• Исправление поведения в PL/pgSQL предложения INTO внутри команд IMPORT FOREIGN SCHEMA
(Том Лейн)
• Исправление кода contrib/btree_gin, чтобы он корректно выдавал наименьшее возможное
значение bigint (Питер Эйзентраут)
• Наделение libpq способностью корректно декодировать версию сервера по схеме нумерации,
которая вскоре будет принята (Питер Эйзентраут)
Для выпусков после 9.6 планируется перейти на нумерацию версий по схеме с двумя, а не
тремя компонентами. Поэтому нужно, чтобы PQserverVersion() возвращала правильное зна-
чение с такой нумерацией.
2449Замечания к выпуску
• Исправление в ecpg кода обработки элементов массива unsigned long long (Михаэль Мескес)
• В pg_dump с одновременно заданными ключами -c и -C не должна выдаваться команда CREATE
SCHEMA public (Дэвид Джонсон, Том Лейн)
• Улучшение обработки SIGTERM/control-C в параллельном режиме pg_dump и pg_restore (Том
Лейн)
Обеспечение своевременного завершения рабочих процессов и передачи команд отмены за-
просов в подключённые рабочие процессы, в случае, если они выполняют какие-либо длитель-
ные операции, например CREATE INDEX.
• Корректировка выдачи ошибок в параллельном режиме pg_dump и pg_restore (Том Лейн)
Ранее ошибки, выдаваемые рабочими процессами pg_dump или pg_restore, могли никогда не
достигать консоли пользователя, так как они проходили через главный процесс, и были воз-
можны различные сценарии взаимоблокировки, когда главный процесс не мог передавать со-
общения. Теперь вместо этого всё будет просто выводиться в stderr. В некоторых случаях при
этом возможны повторы сообщений (например, когда все рабочие процессы сообщают об от-
ключении главного), но это представляется лучшим вариантом, чем терять сообщения.
• Обеспечение корректного отключения параллельных процессов pg_dump и pg_restore в
Windows в случае ошибки (Кётаро Хоригути)
Ранее процесс выдавал ошибку, но затем просто оставался в памяти, пока пользователь не
останавливал его вручную.
• Параллельный pg_dump должен завершаться штатно при попытке подключения к резервному
серверу (Магнус Хагандер)
Такое использование не поддерживается (если только не применяется --no-synchronized-
snapshots), но эта ошибка не обрабатывалась должным образом.
• Улучшение поведения pg_dump при сборке без поддержки zlib (Кётаро Хоригути)
С такой сборкой не работала корректно параллельная выгрузка, а в других случаях выдава-
лись довольно бессмысленные предупреждения.
• Добавление для pg_basebackup параметра -Z 0, позволяющего отключить сжатие (Фудзии Ма-
сао)
• Корректировка в makefile правила для безопасной сборки разделяемых библиотек AIX в па-
раллельном режиме (Ной Миш)
• Исправление тестов TAP и скриптов MSVC для работы с каталогом сборки, путь к которому со-
держит пробелы (Микаэль Пакье, Кётаро Хоригути)
• Более предсказуемое поведение в выборе ошибки «statement timeout» (тайм-аут оператора)
или «lock timeout» (тайм-аут блокировки) (Том Лейн)
В сильно загруженных системах регрессионные тесты иногда выдавали ошибку «lock timeout»
(тайм-аут блокировки), хотя прежде этого должен был случиться тайм-аут оператора.
• Адаптация регрессионных тестов к датской и валлийской локалям (Джефф Джейнс, Том
Лейн)
Изменены некоторые тестовые данные, с которыми в этих локалях действовали необычные
правила сортировки.
• Приведение нашей копии кодов часовых поясов в соответствие с выпущенной IANA версией
tzcode 2016c (Том Лейн)
Это необходимо для принятия ожидаемых в будущем изменений в файлах данных часовых по-
ясов. Также это решает некоторые редкие проблемы при работе с необычными часовыми поя-
сами.
2450Замечания к выпуску
• Обновление данных часовых поясов до версии tzdata 2016f, включающее новые правила пере-
хода на летнее время в Кемерове и Новосибирске, а также корректировку исторических дан-
ных для Азербайджана, Белоруссии и Марокко.
E.34. Выпуск 9.5.3
Дата выпуска:
2016-05-12
В этот выпуск вошли различные исправления, внесённые после версии 9.5.2. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.34.1. Миграция на версию 9.5.3
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако если вы обновляете сервер с более ранней версии, чем 9.5.2, см. Раздел E.35.
E.34.2. Изменения
• Очередь ошибок OpenSSL должна очищаться перед вызовом функций OpenSSL (не следует по-
лагать, что она уже очищена); мы также должны обязательно очищать её после вызова (Пи-
тер Геохеган, Дэйв Витек, Питер Эйзентраут)
Это изменение предотвращает проблемы, возникающие, когда несколько подключений ис-
пользуют OpenSSL в одном процессе и не весь участвующий в этом код очищает очередь оши-
бок по одним правилам. В частности, возникали ошибки, когда клиентское приложение ис-
пользовало SSL-подключения через libpq одновременно с SSL-подключениями, устанавливае-
мыми обёртками PHP, Python или Ruby для OpenSSL. Подобные проблемы могли иметь место и
на сервере, если модуль расширения устанавливал исходящее SSL-подключение.
• Исправление ошибки планировщика «не удалось построить N-стороннее соединение» с пол-
ным соединением, заключённым в правой части левого соединения (Том Лейн)
• Исправление некорректной обработки проверок класса эквивалентности в планах с много-
уровневыми вложенными циклами (Том Лейн)
С классом эквивалентности переменных с тремя или более элементами, например X.X = Y.Y
= Z.Z, планировщик мог опустить некоторые проверки, необходимые, чтобы удостовериться,
что все переменные действительно равны, в результате чего выдавались строки соединения,
не удовлетворяющие предложениям WHERE. По ряду причин некорректные планы редко выби-
рались на практике, поэтому эта ошибка оставалась необнаруженной долгое время.
• Исправление ошибок анализатора запроса в особых случаях при включённом параметре
operator_precedence_warning (Том Лейн)
Например, запрос SELECT (ARRAY[])::text[] давал ошибку, хотя без скобок он работал.
• Ликвидирована утечка памяти на протяжении запроса при сканировании индекса GIN (Жу-
льен Рухо)
• Ликвидирована утечка памяти на протяжении запроса и угроза повреждения индекса при до-
бавлении в индекс GIN (Том Лейн)
Эта утечка памяти обычно ни на что не влияла в простых запросах, но могла быть очень суще-
ственной при построении большого индекса GIN с большим значением maintenance_work_mem.
• Исправление возможного некорректного поведения кодов формата TH, th и Y,YYY в
to_timestamp() (Том Лейн)
С этими кодами был возможен выход за конец строки, в результате чего последующие коды
формата читали мусор.
• Исправление вывода правил и представлений, в которых аргумент массив в конструкции зна-
чение оператор ANY (массив) представляет собой вложенный SELECT (Том Лейн)
2451Замечания к выпуску
• Запрет на использование символов новой строки в значениях параметров ALTER SYSTEM (Том
Лейн)
При разборе файла конфигурации строки, содержащие символы новой строки, не принимают-
ся, поэтому мы не должны допускать их в значениях, вставляемых командой ALTER SYSTEM.
• Исправление поведения ALTER TABLE ... REPLICA IDENTITY USING INDEX в случае, когда вы-
бирается индекс по OID (Дэвид Роули)
• Исключение возможного некорректного поведения в случае неудачи при удалении символи-
ческой ссылки табличного пространства (Том Лейн)
• Исправление сбоя при логическом декодировании на платформах, чувствительных к выравни-
ванию (Том Лейн, Андрес Фройнд)
Этот сбой происходил, когда транзакция была достаточно большой, чтобы оказаться на диске,
и в ней происходило изменение первичного ключа.
• Исключение повторных обращений за ответом к приёмнику журнала при завершении процес-
са walsender (Ник Клитон)
• Использование в pg_regress тайм-аута запуска из переменной окружения PGCTLTIMEOUT, если
она задана (Том Лейн)
Это поведение согласуется с тем, что было недавно введено в pg_ctl; возможность задать
тайм-аут облегчает автоматизированное тестирование на медленных машинах.
• Исправление ошибки в pg_upgrade, из-за которой не восстанавливалось членство семейства
операторов, содержащего всего один класс операторов, в расширении (Том Лейн)
В таких случаях семейство операторов восстанавливалось в новую базу, но переставало быть
частью расширения. Это не приводило немедленно к негативным эффектам, но с выводом, вы-
даваемым впоследствии утилитой pg_dump, при восстановлении возникали ошибки (безвред-
ные).
• Исправление ошибки в pg_upgrade, приводившей к сбою, когда правила TOAST в новом кла-
стере отличались от старых (Том Лейн)
В pg_upgrade был специальный код для обработки ситуации, когда новая версия PostgreSQL
считала, что у таблицы должна быть дополнительная таблица TOAST, а старая версия считала
по-другому. Этот код был нерабочим, поэтому его следует удалить и ничего не делать в таких
случаях; похоже, что нет никаких причин полагать, что мы не сможем обойтись без таблицы
TOAST, если это было возможно по правилам старой версии.
• Исправление атомарных операций в коде для PPC, генерируемом компилятором IBM XLC
(Ной Миш)
• Уменьшение числа семафоров SysV, задействуемых сборкой, полученной с ключом --disable-
spinlocks (Том Лейн)
• Переименование внутренней функции strtoi() в strtoint() во избежание конфликта с биб-
лиотечной функцией NetBSD (Томас Мунро)
• Исправление кодов ошибок, получаемых из системных вызовов bind() и listen() в Windows
(Том Лейн)
• Уменьшение детализации вывода компилятора при сборке с Microsoft Visual Studio (Кристиан
Ульрих)
• Поддержка сборки с Visual Studio 2015 (Микаэль Пакье, Петр Желинек)
Учтите, что сборки, произведённые с VS2015, не будут работать в версиях Windows, более ран-
них чем Windows Vista.
• Исправление putenv() для корректной работы с Visual Studio 2013 (Микаэль Пакье)
2452Замечания к выпуску
• Исключение потенциально небезопасного использования функции FormatMessage() в
Windows (Кристиан Ульрих)
Использование флага FORMAT_MESSAGE_IGNORE_INSERTS, где это уместно. Сообщений о кон-
кретных связанных с этим ошибками не было, но проявить осторожность представляется хо-
рошей идеей.
• Обновление данных часовых поясов до версии tzdata 2016d, включающее изменения правил
перехода на летнее время в России и Венесуэле. Появились новые названия часовых поясов
Europe/Kirov и Asia/Tomsk, отражающие тот факт, что в этих регионах история изменения ча-
совых поясов отличается от соседних.
E.35. Выпуск 9.5.2
Дата выпуска:
2016-03-31
В этот выпуск вошли различные исправления, внесённые после версии 9.5.1. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.35.1. Миграция на версию 9.5.2
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
Однако вследствие изменения, идущего первым в следующем списке, для некоторых индексов мо-
жет потребоваться выполнить REINDEX.
E.35.2. Изменения
• Отключены сокращённые ключи при сортировке строк в локалях, отличных от C (Роберт Хаас)
В PostgreSQL 9.5 появилась логика ускорения сравнения строковых типов данных с примене-
нием стандартной функции библиотеки C strxfrm() вместо strcoll(). Сейчас обнаружилось,
что в большинстве версий glibc (реализации библиотеки С для Linux) функция strxfrm() реа-
лизована с ошибками, то есть для некоторых локалей с ней получаются результаты сравнения
строк, отличающиеся от strcoll(). Пока эта проблема не будет изучена глубже, такая опти-
мизация для всех локалей, отличных от C, отключается. (Локаль C от этого не зависит, так как
она не использует ни strcoll(), ни strxfrm().)
К сожалению, данная проблема затрагивает не только сортировку, но и упорядочивание запи-
сей в B-деревьях, а значит, индексы-B-деревья по столбцам типов text, varchar или char мо-
гут оказаться испорченными, если они сортировались с проблемной локалью и были построе-
ны или модифицированы версией PostgreSQL 9.5.0 или 9.5.1. Индексы, которые могли постра-
дать вследствие этой проблемы, следует перестроить (выполнив REINDEX) .
В данный момент невозможно определить исчерпывающий список проблемных локалей. Из-
вестно, что с локалью C всё в порядке, и с локалями английского языка, например, en_US, то-
же не замечено никаких проблем, но с некоторыми другими популярными локалями, напри-
мер de_DE, поведение некорректно в большинстве версий glibc.
• Корректное сохранение статуса защиты на уровне строк в кешируемых планах (Стивен Фрост)
В сеансе, выполняющем запросы с разными ролями, из кеша планов может быть некорректно
взят план, построенный для другой роли, что может привести к применению ошибочного на-
бора политик, когда активна защита на уровне строк (RLS). (CVE-2016-2193)
• В некоторые новые функции contrib/pageinspect добавлены проверки суперпользователя
(Андреас Зельтенрейх)
Большинство функций в расширении pageinspect, исследующие значения bytea, не допуска-
ют вызова обычными пользователями, но в brin_page_type() и brin_metapage_info() такие
ограничения отсутствуют. Однако, передав им изощрённо сформированные значения bytea,
2453Замечания к выпуску
можно вызвать крах сервера или прочитать несколько байт памяти сервера. Поэтому были до-
бавлены недостающие проверки во избежание подобных злоупотреблений. (CVE-2016-3065)
• Исправлено некорректное сравнение ROW() с применением индексов (Саймон Риггс)
Ошибки в небольшой оптимизации, введённой в 9.5, приводили к некорректным результатам,
если при сравнении ROW() имело место частичное соответствие индексу, но не точное (напри-
мер, когда порядок столбцов другой или в индексе есть столбцы с сортировкой и ASC, и DESC).
Пока лучшее решение не найдено, эта оптимизация отключена.
• Исправлена некорректная обработка NULL в сравнениях ROW() с применением индексов (Том
Лейн)
Поиск по индексу со сравнением строк вида ROW(a, b) &gt; ROW('x', 'y') останавливался, до-
ходя до элемента NULL в столбце b, игнорируя тот факт, что с последующими значениями a
могут быть связаны значения b, отличные от NULL.
• Предотвращение маловероятных сценариев потери данных в случае переименования фай-
лов без соответствующих вызовов fsync() до и после (Микаэль Пакье, Томаш Вондра, Андрес
Фройнд)
• Исправлено некорректное поведение при перепроверке только что изменённой строки в за-
просе, выполняющем SELECT FOR UPDATE/SHARE и обращающемся к отношениям, которые не
нужно блокировать (Том Лейн)
Строки из незаблокированных отношений некорректно воспринимались во время перепровер-
ки как полностью содержащие NULL, что могло привести к неправильному выводу о том, что
изменённая строка больше не удовлетворяет условию WHERE, или к выдаче NULL в результате.
• Исправлена ошибка в json_to_record(), возникавшая, когда поле входного объекта содержа-
ло вложенный объект с полем, имя которого совпадало с именем одного из запрошенных вы-
ходных столбцов (Том Лейн)
• Исправлен бессмысленный результат функции jsonb_object() в форме с двумя аргументами
при вызове с пустыми массивами (Микаэль Пакье, Эндрю Дунстан)
• Исправлено некорректное поведение в jsonb_set() при преобразовании элемента массива пу-
тей в целое значение для использования в качестве индекса массива (Микаэль Пакье)
• Исправлено некорректное форматирование отрицательных смещений часовых поясов в функ-
ции to_char() с применением кода формата OF (Томас Мунро, Том Лейн)
• Исправлена некорректное протоколирование событий ожидания, имеющих место в
INSERT ... ON CONFLICT (Питер Геохеган)
В выводимых сообщениях иногда отмечалось, что ожидание было вызвано ограничением-ис-
ключением, хотя такое ограничение было не при чём.
• Параметр recovery_min_apply_delay игнорируется, пока восстановление не достигло согласо-
ванного состояния (Микаэль Пакье)
Ранее, резервные серверы откладывали применение записей WAL, учитывая
recovery_min_apply_delay, даже при воспроизведении начальной порции WAL, необходимой
для приведения базы данных в рабочее состояние. Так как резервный сервер бесполезен, пока
он не достиг согласованного состояния базы данных, это кажется напрасным.
• Корректная обработка ситуаций, когда pg_subtrans на грани зацикливания XID при запуске
сервера (Джефф Джейнс)
• Исправление разнообразных ошибок в логическом декодировании (Андрес Фройнд)
Проблемы возникали с кортежами больше одной страницы с вариантом идентификации ре-
плики FULL, при выполнении команд UPDATE, изменяющих первичный ключ в транзакции, до-
статочно большой для выгрузки на диск, а также с некорректными ошибками «subxact logged
2454Замечания к выпуску
without previous toplevel record» (транзакция внесена в журнал без предыдущей записи верх-
него уровня) и с некорректным выводом времени фиксирования транзакций.
• Исправлена ошибка планировщика, возникавшая с вложенными представлениями с барьера-
ми безопасности, когда внешнее представление содержит предложение WHERE с коррелирую-
щим подзапросом (Дин Рашид)
• Ликвидирована утечка памяти при поиске по индексу GIN (Том Лейн)
• Предотвращён крах в исключительной ситуации при попытке повторно освободить строки, вы-
водимые localeconv() (Том Лейн)
• Исправлен разбор файлов аффиксов для словарей ispell (Том Лейн)
Код разбора мог работать неправильно, если файл аффиксов содержит символы, которые мо-
гут менять размер в байтах при преобразовании регистра, как например, символ I в турецких
локалях UTF8.
• Исключено использование sscanf() при разборе файлов словарей ispell (Артур Закиров)
Это устраняет проблему переносимости на платформы на базе FreeBSD (включая macOS).
• Исправление кода атомарных операций, генерируемого на PPC компилятором IBM xlc (Ной
Миш)
Эта ошибка приводила к редким сбоям при параллельных операциях на этой платформе.
• Предотвращение сбоя на старых версиях Windows (до 7SP1/2008R2SP1) с процессором с под-
держкой AVX2 и с Postgres, собранным компилятором Visual Studio 2013 (Кристиан Ульрих)
Это обходное решение проблемы в библиотеки выполнения Visual Studio 2013, которая, как
заявили в Microsoft, не будет исправляться в этой версии.
• В psql исправлена логика завершения команд табуляцией с учётом особенностей многобайт-
ных символов (Кётаро Хоригути, Роберт Хаас)
• В psql исправлено завершение табуляцией команды SECURITY LABEL (Том Лейн)
При нажатии TAB после ввода SECURITY LABEL мог произойти сбой или выдавались посторон-
ние ключевые слова.
• Команда pg_ctl теперь принимает тайм-аут ожидания из переменной среды PGCTLTIMEOUT, ес-
ли этот тайм-аут не задан в командной строке (Ной Миш)
Это упрощает тестирование более медленных узлов на ферме сборки, позволяя индивиду-
ально задавать время, превышающее обычное, для запуска и завершения главного процесса
(postmaster).
• Исправление ошибочной проверки состояния службы Windows в pg_ctl (Мануэль Матар)
В предыдущих корректирующих выпусках были попытки исправить pg_ctl, чтобы он правиль-
но определял, нужно ли отправлять сообщения в журнал событий Window, но в итоге провер-
ка оказалась противоположной.
• Исправлено поведение pgbench, чтобы сочетание параметров -C и -M prepared обрабатыва-
лось корректно (Том Лейн)
• В pg_upgrade теперь пропускается создание скрипта удаления, когда новый каталог данных
находится внутри старого (Брюс Момджян)
Выполнение этого скрипта «вслепую» в таких случаях приводило к потере нового каталога
данных.
• В PL/Perl пустые массивы Postgres стали корректно переводиться в пустые массивы Perl
(Алекс Хансакер)
• Код PL/Python адаптирован для работы с именами функций, не подходящими для идентифика-
торов Python (Джим Нэсби)
2455Замечания к выпуску
• Исправление ряда ошибок в статистике, возвращаемой функцией pgstatindex() из contrib/
pgstattuple (Том Лейн)
• Ликвидация зависимости от psed в сборках с MSVC, так как ядро Perl больше не предоставля-
ет её (Микаэль Пакье, Эндрю Дунстан)
• Обновление данных часовых поясов до версии tzdata 2016c, включающее изменения правил
перехода на летнее время в Азербайджане, Чили, на Гаити, в Палестине и России (в Алтай-
ском крае, Астраханской, Кировской и Ульяновской областях, а также на Сахалине), плюс
корректировку исторических данных для Литвы, Молдавии и России (для Калининграда, Са-
мары и Волгограда).
E.36. Выпуск 9.5.1
Дата выпуска:
2016-02-11
В этот выпуск вошли различные исправления, внесённые после версии 9.5.0. За информацией о
нововведениях версии 9.5 обратитесь к Разделу E.37.
E.36.1. Миграция на версию 9.5.1
Если используется версия 9.5.X, выгрузка/восстановление базы не требуется.
E.36.2. Изменения
• Исправлены проблемы с бесконечными циклами и переполнениями буфера в регулярных вы-
ражениях (Том Лейн)
С очень большими диапазонами символов в некоторых случаях можно было добиться беско-
нечного цикла, а в других — переполнения памяти. (CVE-2016-0773)
• Исправлено упущение, из-за которого в редких случаях при соединениях по хешу пропуска-
лось соединение некоторых кортежей внутреннего отношения (Томаш Вондра, Том Лейн)
• Предотвращено проталкивание предложений HAVING в подзапросы, когда применяются набо-
ры группирования (Эндрю Гирт)
• Исправление пересборки арбитра ON CONFLICT в предложении WHERE (Питер Геохеган)
• Спецкоды %h и %r в log_line_prefix стали работать в сообщениях, выдаваемых в режиме
log_connections (Том Лейн)
Ранее %h/%r начинали работать только после того, как новый сеанс выдавал сообщение
«connection received» (соединение получено); теперь они работают и для этого сообщения.
• Ликвидация утечки маркера в процессе аутентификации SSPI (Кристиан Ульрих)
• Исправлена команда \det в psql, чтобы она воспринимала шаблон, передаваемый ей в аргу-
менте, так же, как другие команды \d с шаблонами, которые могут дополняться схемами (Рис
Харт)
• Программа pg_ctl в Windows должна выбирать, куда направлять вывод, проверяя состояние
службы, а не то, что устройство стандартного вывода является терминалом (Микаэль Пакье)
• Исправление разнообразных ошибок в исключительных случаях при обработке объектов-чле-
нов расширений в pg_dump (Том Лейн)
• Исправлено некорректное заключение в кавычки имён ограничений доменов в pg_dump (Эл-
вис Пранскевичус)
• Теперь pg_dump помечает триггеры представления, чтобы они обрабатывались после правил,
во избежание ошибок при параллельном pg_restore (Том Лейн)
• Внедрение в pgbench защиты от переполнения в исключительных случаях при вычислении за-
данных в скрипте операторов деления или взятия остатка (Фабьен Коэльо, Микаэль Пакье)
2456Замечания к выпуску
• Подавление бесполезного предупреждения при подключении pg_receivexlog к серверу версии
до 9.4 (Марко Ненчарини)
• Решение проблем с выгрузкой/перезагрузкой данных при одновременном использовании
plpython2 и plpython3 (Том Лейн)
В принципе можно использовать обе версии PL/Python в одной базе данных, но не в одном се-
ансе (так как две версии libpython нельзя безопасно использовать одновременно). Однако и
pg_restore, и pg_upgrade в своей работе нарушают это ограничение одного сеанса. В качестве
обходного решения изменено время проверки версий.
• Исправление регрессионных тестов PL/Python для совместимости с Python 3.5 (Питер Эйзен-
траут)
• Недопущение установки определённых параметров PL/Java непривилегированными пользова-
телями (Ной Миш)
Это изменение ликвидирует угрозу, связанную с уязвимостью в PL/Java (CVE-2016-0766), ис-
правленной в PL/Java (эти параметры теперь доступны только суперпользователю). Чтобы лик-
видировать угрозу безопасности для тех серверов PostgreSQL, которые обновляются чаще,
чем PL/Java, это изменение внесено также в код ядра сервера.
• Исправление заголовочных файлов, поставляемых с ecpg: в директиву препроцессора не дол-
жен включаться комментарий, продолжающийся в следующей строке (Михаэль Мескес)
Такой комментарий не принимается препроцессором ecpg. Пока не вполне ясно, следует ли
скорректировать сам ecpg.
• Исправление в hstore_to_json_loose() проверки, можно ли преобразовать значение hstore в
число JSON (Том Лейн)
Ранее эту функцию можно было ввести в заблуждение не алфавитно-цифровыми замыкающи-
ми символами, что приводило к формированию синтаксически некорректного JSON.
• В contrib/postgres_fdw исправлены ошибки, вызванные использованием tableoid в коман-
дах, модифицирующих данные (Эцуро Фудзита, Роберт Хаас)
• Исправлено некорректно введённое ограничение NAMEDATALEN 256 байтами (Роберт Хаас, Том
Лейн)
• Улучшение воспроизводимости сборки путём обеспечения фиксированного порядка имён
файлов, передаваемых компоновщику (Кристоф Берг)
Это устраняет возможные двоичные различия создаваемых исполняемых файлов от сборки к
сборке.
• Включение dynloader.h в список устанавливаемых заголовочных файлов при сборке с MSVC
(Брюс Момджян, Микаэль Пакье)
• Обновление данных часовых поясов до версии tzdata 2016a, включающее изменения правил
перехода на летнее время на Каймановых островах, в Метлакалте и Забайкальском крае, плюс
корректировку исторических данных для Пакистана.
E.37. Выпуск 9.5
Дата выпуска:
2016-01-07
E.37.1. Обзор
В число ключевых усовершенствований PostgreSQL 9.5 входят:
• Возможность превращать команды INSERT, вызывающие конфликты ограничений, в команды
UPDATE, либо игнорировать их
• Добавление в GROUP BY аналитической функциональности: GROUPING SETS, CUBE и ROLLUP
2457Замечания к выпуску
• Добавление механизма защиты на уровне строк
• Создание механизмов для отслеживания прогресса репликации, включая средства идентифи-
кации источника отдельных изменений при логической репликации
• Добавление блочно-зональных индексов (BRIN)
• Существенное увеличение скорости сортировки
• Существенное увеличение производительности на многопроцессорных машинах
Предыдущие пункты более подробно описаны в следующих разделах.
E.37.2. Миграция на версию 9.5
Тем, кто хочет мигрировать данные из любой предыдущей версии, необходимо выполнить выгруз-
ку/загрузку данных с помощью pg_dumpall или воспользоваться pg_upgrade.
В версии 9.5 реализован ряд изменений, которые могут повлиять на совместимость с предыдущими
выпусками. Рассмотрите следующие несовместимые аспекты:
• Изменение приоритета операторов в соответствии со стандартом SQL (Том Лейн)
Приоритет операторов &lt;=, &gt;= и &lt;&gt; был понижен до приоритета операторов &lt;, &gt; и =. Приори-
тет проверок IS (например, x IS NULL) был понижен и стал непосредственно ниже приорите-
та этих шести операторов сравнения. Также операторы из нескольких слов, начинающиеся с
NOT, теперь имеют приоритет своего базового оператора (например, NOT BETWEEN теперь имеет
тот же приоритет, что и BETWEEN), тогда как раньше их приоритет был несогласованным; они
воспринимались как NOT по отношению к левому операнду, но при этом как базовый оператор
по отношению к правому. Новый параметр конфигурации operator_precedence_warning даёт
возможность получать предупреждения о запросах, в которых эти изменения приоритета при-
водят к другому результату разбора запроса.
• Смена в pg_ctl выбираемого по умолчанию режима отключения с smart на fast (Брюс Момд-
жян)
Это означает, что теперь по умолчанию сервер будет принудительно прерывать существую-
щие сеансы, а не просто ждать их завершения.
• Использование приведения присваивания для преобразований типов данных в присваиваниях
PL/pgSQL, вместо перевода в текстовый вид и обратно (Том Лейн)
Вследствие этого изменения при преобразовании булевых значений в строковые получаются
значения true и false, а не t и f. Другие преобразования типов могут быть успешны в боль-
шем числе случаев, чем раньше; например, при присвоении числового значения 3.9 цело-
численной переменной, ей будет присвоено 4, а не произойдёт ошибка, как раньше. Если для
некоторых исходного и целевого типов приведение присваивания не определено, PL/pgSQL
вернётся к старому поведению с преобразованием через вывод/ввод.
• Возможность использования экранирования обратной косой чертой символов в параметрах
командной строки сервера (Андрес Фройнд)
Ранее, пробелы в строке параметров всегда служили разделителями параметров, так что не
было никакой возможности включить пробел в значение параметра. Чтобы указать обратную
косую черту в значении параметра, теперь нужно написать \\.
• Изменение значения по умолчанию параметра GSSAPI include_realm на 1, чтобы по умолча-
нию имя области клиента не удалялось из имени принципала GSS или SSPI (Стивен Фрост)
• Замена параметра конфигурации checkpoint_segments параметрами min_wal_size и
max_wal_size (Хейкки Линнакангас)
Если вы ранее настраивали checkpoint_segments, следующая формула даст вам приблизи-
тельно эквивалентное значение:
2458Замечания к выпуску
max_wal_size = (3 * checkpoint_segments) * 16MB
Заметьте, что значение по умолчанию параметра max_wal_size стало гораздо больше, чем
раньше имел параметр checkpoint_segments, так что возможно, что корректировать этот па-
раметр больше не потребуется.
• Регулирование снятия процессов при нехватке памяти в Linux через новые переменные окру-
жения PG_OOM_ADJUST_FILE и PG_OOM_ADJUST_VALUE, вместо параметров времени компиляции
LINUX_OOM_SCORE_ADJ и LINUX_OOM_ADJ (Гуржит Сингх)
• Списание параметра конфигурации сервера ssl_renegotiation_limit, который стал устарев-
шим в предыдущих выпусках (Андрес Фройнд)
Хотя возможность повторного согласования SSL — хорошая вещь в теории, с ней связано до-
статочно ошибок, чтобы считать её скорее отрицательной на практике, и поэтому она будет
исключена в будущих версиях соответствующих стандартов. Учитывая это, мы убрали под-
держку этой возможности из PostgreSQL. Параметр ssl_renegotiation_limit сохранился, но
ему нельзя присвоить ничего, кроме нуля (то есть он всегда отключён). Также он больше не
описывается в документации.
• Удаление параметра конфигурации сервера autocommit, который уже был устаревшим и не
работал (Том Лейн)
• Удаление из каталога pg_authid поля rolcatupdate, так как оно было бесполезным (Адам
Брайтвелл)
• В системном представлении pg_stat_replication в поле sent теперь NULL, а не 0, представ-
ляет недействительное значение (Магнус Хагандер)
• Операторы извлечения элементов массивов json и jsonb теперь могут принимать отрицатель-
ные позиции, которые отсчитываются от конца массивов JSON (Питер Геохеган, Эндрю Дун-
стан)
Ранее эти операторы возвращали NULL для отрицательных позиций.
E.37.3. Изменения
Ниже вы найдёте подробный список изменений, произошедших между предыдущим основным вы-
пуском и выпуском PostgreSQL 9.5.
E.37.3.1. Сервер
E.37.3.1.1. Индексы
• Добавление блочно-зональных индексов (BRIN) (Альваро Эррера)
Индексы BRIN хранят только сводные данные (например, минимальные и максимальные зна-
чения) по зонам блоков в куче. Поэтому они очень компактны и легко обновляются; при этом,
если данные кластеризованы натуральным образом, такие индексы позволяют очень суще-
ственно ускорить операции поиска.
• Реализация возможности выполнять в запросах точную фильтрацию по дистанции для объек-
тов (многоугольников, кругов), индексируемых по описанным прямоугольникам с использова-
нием GiST (Александр Коротков, Хейкки Линнакангас)
Ранее, для использования такого индекса требовалось применять подзапрос, выбирающий
большое количество строк, упорядоченных по дистанции до окружающего прямоугольника, а
затем дополнительно отфильтровывать результат, рассчитывая расстояние точнее.
• Возможность использования индексов GiST в сканировании только по индексу (Анастасия Лу-
бенникова, Хейкки Линнакангас, Андреас Карлссон)
• Добавление параметра конфигурации gin_pending_list_limit, управляющего размером очере-
дей GIN (Фудзии Масао)
2459Замечания к выпуску
Это значение можно также задать на уровне индекса как параметр хранения индекса. Ранее
размер очереди зависел от параметра work_mem, что было неудобно, так как подходящие зна-
чения work_mem обычно оказывались слишком большими для данной цели.
• Выдача при создании хеш-индексов предупреждения о том, что они не защищены от сбоев
(Брюс Момджян)
E.37.3.1.2. Общая производительность
• Ускорение сортировки полей varchar, text и numeric за счёт использования «сокращённых»
ключей (Питер Геохеган, Эндрю Гирт, Роберт Хаас)
• Расширение инфраструктуры, позволяющее производить сортировку, вызывая встроенные,
не вызываемые из SQL функции сравнения, для выполнения команд CREATE INDEX, REINDEX и
CLUSTER (Питер Геохеган)
• Улучшение производительности соединений по хешу (Томаш Вондра, Роберт Хаас)
• Улучшение параллелизма операции замены разделяемого буфера (Роберт Хаас, Амит Капила,
Андрес Фройнд)
• Уменьшение количества блокировок и закреплений страниц при сканировании индексов (Ке-
вин Гриттнер)
Прежде всего это полезно тем, что позволяет реже блокировать процедуру очистки индексов.
• Оптимизация использования памяти при отслеживании закреплений буферов в серверных
процессах (Андрес Фройнд)
• Улучшение масштабируемости блокировок (Андрес Фройнд)
В особенности это снимает проблемы масштабируемости в системах с несколькими раздель-
ными процессорами.
• Оптимизатор теперь может удалить ненужные ссылки на соединяемые слева подзапросы (Дэ-
вид Роули)
• Возможность вынесения ограничений запроса в подзапросы с оконными функциями, где это
уместно (Дэвид Роули)
• Возможность вынесения вызова негерметичной функции за представление с барьером без-
опасности, если функция не получает никакие выходные столбцы представления (Дин Рашид)
• Доработка планировщика, чтобы он использовал статистику, полученную из индекса по вы-
ражению с булевской функцией, когда соответствующий вызов функции присутствует в WHERE
(Том Лейн)
• ANALYZE теперь вычисляет основную статистику (процент значений NULL и среднюю шири-
ну столбцов) даже для столбцов, тип данных которых лишён функции равенства (Олександр
Шульгин)
• Ускорение расчёта CRC (циклического избыточного кода) и переход к CRC-32C (Абхиджит
Менон-Сен, Хейкки Линнакангас)
• Улучшение производительности сканирования индексов по битовой карте (Фёдор Сигаев, Том
Лейн)
• Ускорение команды CREATE INDEX за счёт исключения лишнего копирования в памяти (Роберт
Хаас)
• Увеличение числа разделов отображений буферов (Амит Капила, Андрес Фройнд, Роберт Ха-
ас)
Это увеличивает производительность при многопоточной нагрузке.
E.37.3.1.3. Наблюдение
• Добавление параметра хранения log_autovacuum_min_duration для управления протоколиро-
ванием автоочистки на уровне таблиц (Микаэль Пакье)
2460Замечания к выпуску
• Добавление нового параметра конфигурации cluster_name (Томас Мунро)
Эта строка, обычно задаваемая в postgresql.conf, позволяет клиентам идентифицировать
кластер. Это имя также выводится в заголовке всех серверных процессов, что упрощает выде-
ление всех процессов, принадлежащих одному кластеру.
• Недопущение изменения log_disconnections простыми пользователями при установлении со-
единения (Фудзии Масао)
E.37.3.1.4. SSL
• Проверка «Альтернативных имён субъекта» (Subject Alternative Names) (при наличии) в SSL-
сертификатах серверов (Алексей Клюкин)
Когда такое поле присутствует, оно проверяется вместо поля «Общее имя» (Common Name) в
сертификате.
• Добавление системного представления pg_stat_ssl, выдающего информацию о SSL-подклю-
чениях (Магнус Хагандер)
• Добавление в libpq функций, возвращающих информацию об SSL независящим от реализации
способом (Хейкки Линнакангас)
Хотя PQgetssl() по-прежнему можно применять для обращений к функциям OpenSSL, те-
перь это считается устаревшим вариантом, так как будущие версии libpq могут поддерживать
и другие реализации SSL. По возможности используйте новые функции PQsslAttribute(),
PQsslAttributeNames() и PQsslInUse(), чтобы получать информацию об SSL независящим от
реализации SSL способом.
• В libpq должны сохраняться установленные многопоточные обработчики вызовов OpenSSL
(Ян Урбански)
Ранее они перезаписывались.
E.37.3.1.5. Параметры сервера
• Замена параметра конфигурации checkpoint_segments параметрами min_wal_size и
max_wal_size (Хейкки Линнакангас)
Это изменение позволяет разместить большое количество файлов WAL, но при этом не со-
хранять их, когда они будут уже не нужны. Как следствие, значение max_wal_size по умол-
чанию увеличено до 1GB, что намного больше старой величины по умолчанию, устанавливае-
мой параметром checkpoint_segments. Также заметьте, что резервные серверы теперь произ-
водят точки перезапуска, стараясь ограничить использование пространства WAL значением
max_wal_size; ранее они не учитывали параметр checkpoint_segments.
• Регулирование снятия процессов при нехватке памяти в Linux через новые переменные окру-
жения PG_OOM_ADJUST_FILE и PG_OOM_ADJUST_VALUE (Гуржит Сингх)
Предыдущая инфраструктура управления механизмом OOM зависела от параметров времени
компиляции LINUX_OOM_SCORE_ADJ и LINUX_OOM_ADJ, которые теперь не поддерживаются. Но-
вое поведение распространяется на все сборки.
• Осуществление записи времени фиксации транзакции, когда включён параметр
track_commit_timestamp (Альваро Эррера, Петр Желинек)
Прочитать записанное время можно, воспользовавшись функциями
pg_xact_commit_timestamp() и pg_last_committed_xact().
• Возможность устанавливать local_preload_libraries в команде ALTER ROLE SET (Питер Эйзен-
траут, Кётаро Хоригути)
• Рабочие процессы автоочистки теперь реагируют на изменения параметров конфигурации в
процессе работы (Микаэль Пакье)
2461Замечания к выпуску
• Параметр конфигурации debug_assertions стал доступен только для чтения (Андрес Фройнд)
Это значит, что утверждения теперь нельзя выключить, если они были включены на этапе
компиляции, что позволяет дополнительно оптимизировать код. При этом изменении также
был удалён ключ postgres -A.
• Возможность установления параметра effective_io_concurrency в системах, где он не играет
роли (Питер Эйзентраут)
• Добавление системного представления pg_file_settings, показывающего содержимое фай-
лов конфигурации сервера (Савада Масахико)
• Добавление поля pending_restart в системное представление pg_settings, показывающего,
что изменение было внесено, но не вступит в силу до перезапуска базы данных (Питер Эйзен-
траут)
• Возможность сбросить значения ALTER SYSTEM командой ALTER SYSTEM RESET (Вик Фиринг)
Эта команда удаляет заданный параметр из postgresql.auto.conf.
E.37.3.2. Репликация и восстановление
• Создание механизмов для отслеживания прогресса репликации, включая средства идентифи-
кации источника отдельных изменений при логической репликации (Андрес Фройнд)
Эти механизмы полезны при создании решений репликации.
• Переработка операции усечения мультитранзакций, чтобы она корректно фиксировалась в
журнале (Андрес Фройнд)
В результате этот механизм становится проще и надёжнее.
• Добавление в recovery.conf параметра recovery_target_action, управляющего действиями
после восстановления (Петр Желинек)
Этот параметр пришёл на замену pause_at_recovery_target.
• Добавление для archive_mode нового значения always, позволяющего архивировать получае-
мые файлы WAL (Фудзии Масао)
• Добавление параметра конфигурации wal_retrieve_retry_interval для управления повторными
попытками чтения WAL после сбоя (Алексей Васильев, Микаэль Пакье)
Это особенно полезно для тёплого резерва.
• Возможность сжатия образов полных страниц в WAL (Рахила Сьед, Микаэль Пакье)
Это позволяет сократить объём WAL, за счёт дополнительной нагрузки на процессор при за-
писи и воспроизведении WAL. Эта возможность управляется новым параметром конфигура-
ции wal_compression (по умолчанию он отключён).
• Архивация файлов WAL с расширением .partial при повышении резервного сервера (Хейкки
Линнакангас)
• Добавление параметра конфигурации log_replication_commands для протоколирования команд
репликации (Фудзии Масао)
По умолчанию команды репликации, в частности IDENTIFY_SYSTEM, не записываются в прото-
кол, даже когда log_statement имеет значение all.
• Добавление в pg_replication_slots отображения процессов, занимающих слоты репликации
(Крейг Рингер)
Эта информация выводится в новом столбце active_pid.
• Возможность использовать в задаваемом в recovery.conf параметре primary_conninfo иден-
тификаторы соединений в формате URI, например, postgres:// (Александр Шульгин)
2462Замечания к выпуску
E.37.3.3. Запросы
• Возможность превращать команды INSERT, вызывающие конфликты ограничений, в команды
UPDATE, либо игнорировать их (Питер Геохеган, Хейкки Линнакангас, Андрес Фройнд)
Для этого введён синтаксис INSERT ... ON CONFLICT DO NOTHING/UPDATE. Таким образом в
Postgres реализована популярная команда UPSERT.
• Добавление в GROUP BY аналитической функциональности: GROUPING SETS, CUBE и ROLLUP (Энд-
рю Гирт, Атри Шарма)
• Возможность присвоения результатов одного вложенного SELECT нескольким целевым столб-
цам в UPDATE (Том Лейн)
Для этого применяется синтаксис UPDATE tab SET (col1, col2, ...) = (SELECT ...).
• Добавление в SELECT указания SKIP LOCKED для пропуска заблокированных строк (Томас Мун-
ро)
При этом не выдаётся ошибка, как в случае с NOWAIT.
• Добавление в SELECT указания TABLESAMPLE, что позволяет получать подмножество строк таб-
лицы (Петр Желинек)
Благодаря этому теперь поддерживаются описанные в стандарте SQL методы извлечения вы-
борки. Кроме того, представлены средства для создания пользовательских методов извлече-
ния выборки.
• Предложение возможных исправлений при опечатках в именах столбцов (Питер Геохеган, Ро-
берт Хаас)
E.37.3.4. Служебные команды
• Добавление более подробной информации о порядке сортировки в вывод EXPLAIN (Мариус
Тиммер, Лукас Крефт, Арне Шеффер)
Эта информация включает свойства COLLATE, DESC, USING и NULLS FIRST/LAST.
• Добавление в вывод VACUUM количества страниц, пропущенных из-за закреплений (Джим Нэс-
би)
• Команда TRUNCATE теперь корректно обновляет счётчики кортежей в pg_stat (Александр
Шульгин)
• Добавление в REINDEX возможности переиндексировать всю схему с новым указанием SCHEMA
(Савада Масахико)
• Добавление в REINDEX указания VERBOSE (Савада Масахико)
• Исключение из вывода REINDEX DATABASE и SCHEMA имён столбцов в случае отсутствия указа-
ния VERBOSE (Саймон Риггс)
• Удаление устаревшего указания FORCE команды REINDEX (Фудзии Масао)
E.37.3.5. Манипуляции с объектами
• Добавление механизма защиты на уровне строк (Крейг Рингер, КайГай Кохэй, Адам Брайт-
велл, Дин Рашид, Стивен Фрост)
Этот механизм позволяет на уровне строк определять, какие строки пользователи смогут
добавлять, изменять и даже видеть в таблице. Для управления им введены новые команды
CREATE/ALTER/DROP POLICY и ALTER TABLE ... ENABLE/DISABLE ROW SECURITY.
• Возможность изменения режима журналирования таблицы в WAL с применением команды
ALTER TABLE ... SET LOGGED / UNLOGGED (Фабрицио де Ройес Мелло)
2463Замечания к выпуску
• Добавление предложения IF NOT EXISTS в CREATE TABLE AS, CREATE INDEX, CREATE SEQUENCE и
CREATE MATERIALIZED VIEW (Фабрицио де Ройес Мелло)
• Добавление поддержки IF EXISTS в ALTER TABLE ... RENAME CONSTRAINT (Брюс Момджян)
• Возможность передать некоторым командам DDL вместо имени конкретного пользователя
идентификаторы CURRENT_USER и SESSION_USER, обозначающие текущего пользователя и поль-
зователя сеанса (Кётаро Хоригути, Альваро Эррера)
Это поддерживают команды ALTER USER, ALTER GROUP, ALTER ROLE, GRANT и ALTER объект
OWNER TO.
• Поддержка комментариев в ограничениях домена (Альваро Эррера)
• Снижение уровней блокировки для некоторых команд, управляющих триггерами и сторонни-
ми ключами (Саймон Риггс, Андреас Карлссон)
• Разрешение использовать LOCK TABLE ... ROW EXCLUSIVE MODE тем, кто имеет право INSERT в
целевой таблице (Стивен Фрост)
Ранее для этой команды требовалось право UPDATE, DELETE или TRUNCATE.
• Применение ограничений CHECK для таблицы и домена в алфавитном порядке имён (Том
Лейн)
Ранее порядок был недетерминированным.
• Добавление в CREATE/ALTER DATABASE возможности управлять свойствами datistemplate и
datallowconn (Вик Фиринг)
Это позволяет задавать/изменять эти параметры, не модифицируя вручную системный ката-
лог pg_database.
E.37.3.5.1. Сторонние таблицы
• Добавление поддержки IMPORT FOREIGN SCHEMA (Ронан Данклау, Микаэль Пакье, Том
Лейн)
Эта команда позволяет автоматически создать локальные сторонние таблицы с той же струк-
турой, что имеют таблицы на удалённом сервере.
• Возможность определения ограничений CHECK для сторонних таблиц (Шигеру Ханада, Эцуро
Фудзита)
Такие ограничения считаются контролируемыми на удалённом сервере, а не локально. Одна-
ко для оптимизации запросов предполагается, что они удовлетворяются, как например при
исключении по ограничению.
• Возможность включать сторонние таблицы в иерархии наследования (Шигеру Ханада, Эцуро
Фудзита)
Чтобы это работало естественным образом, в сторонних таблицах теперь допускаются ограни-
чения-проверки, помечаемые как недействительные, и могут задаваться характеристики хра-
нения и OID, хотя по сути это никак не влияет на стороннюю таблицу.
• Обёртки сторонних данных и методы нестандартного сканирования обрели возможность вы-
носить соединения наружу (КайГай Кохэй)
E.37.3.5.2. Событийные триггеры
• Для устанавливаемого событийного триггера ddl_command_end собираются сведения об актив-
ности DDL, которые могут быть ему полезны (Альваро Эррера)
Эти сведения можно получить через возвращающую множество функцию
pg_event_trigger_ddl_commands() или через структуры данных C, если результат этой функ-
ции недостаточно детализирован.
2464Замечания к выпуску
• Возможность реагирования в событийных триггерах на перезапись таблицы, вызываемую опе-
рацией ALTER TABLE (Димитри Фонтейн)
• Добавление поддержки событийных триггеров для команд COMMENT, SECURITY LABEL и
GRANT/REVOKE уровня базы данных (Альваро Эррера)
• Добавление столбцов в вывод pg_event_trigger_dropped_objects (Альваро Эррера)
Это позволяет упростить обработку операций удаления.
E.37.3.6. Типы данных
• Возможность записать в тип xml пустое или состоящее только из пробельных символов значе-
ние (Питер Эйзентраут)
Это требуется стандартом SQL/XML.
• Возможность ввода в macaddr значений в формате xxxx-xxxx-xxxx (Хервин Вестстрате)
• Запрещение несоответствующего стандарту SQL синтаксиса interval с указанием одновре-
менно полей и точности (Брюс Момджян)
Пр стандарту такие значения этого типа должны записываться, например, как INTERVAL
MINUTE TO SECOND(2). В PostgreSQL ранее допускалась запись INTERVAL(2) MINUTE TO SECOND,
но теперь принимается только стандартный способ.
• Добавление оценки избирательности для операторов inet/cidr и улучшение оценки для функ-
ций текстового поиска (Эмре Хасегели, Том Лейн)
• Добавление типов данных regrole и regnamespace для упрощения ввода и улучшенного выво-
да OID ролей и пространств имён (Кётаро Хоригути)
E.37.3.6.1. JSON
• Добавление для типа jsonb функций jsonb_set() и jsonb_pretty() (Дмитрий Долгов, Эндрю
Дунстан, Петр Желинек)
• Добавление функций, формирующих jsonb: to_jsonb(), jsonb_object(),
jsonb_build_object(), jsonb_build_array(), jsonb_agg() и jsonb_object_agg() (Эндрю Дун-
стан)
Аналогичные функции уже имелись для типа json.
• Снижение требований для преобразований в/из json и jsonb (Том Лейн)
• Возможность вычитать из документов jsonb значения типов integer, text и массивы text
(Дмитрий Долгов, Эндрю Дунстан)
• Добавление для типа jsonb оператора || (Дмитрий Долгов, Эндрю Дунстан)
• Добавление функций json_strip_nulls() и jsonb_strip_nulls() для удаления значений null
из документов JSON (Эндрю Дунстан)
E.37.3.7. Функции
• Добавление generate_series() для значений numeric (Плато Малугин)
• Возможность передавать массив на вход array_agg() и ARRAY() (Али Акбар, Том Лейн)
• Добавление функций array_position() и array_positions(), возвращающих позиции значе-
ний в массиве (Павел Стехуле)
• Добавление оператора дистанции от точки до многоугольника (point-polygon) &lt;-&gt; (Александр
Коротков)
• Возможность использовать в качестве спецсимволов в SIMILAR TO и SUBSTRING многобайтовых
символов (Джефф Девис)
2465Замечания к выпуску
Ранее в качестве спецсимвола можно было выбрать только однобайтовый символ.
• Добавление вариации width_bucket(), поддерживающей любой упорядочиваемый тип данных
и группы неодинаковой ширины (Петр Желинек)
• Добавление необязательного аргумента missing_ok в pg_read_file() и связанные функции
(Микаэль Пакье, Хейкки Линнакангас)
• Введение конструкции =&gt;, позволяющей задать значения именованных параметров в вызовах
функций (Павел Стехуле)
Ранее присвоение значения записывалось только с конструкцией :=. Это потребовало запре-
тить создание пользовательского оператора =&gt;. При создании пользовательских операторов =&gt;
до этого выдавались предупреждения (начиная с PostgreSQL 9.0).
• Добавление POSIX-совместимого округления для платформ, где используются функции округ-
ления, предоставляемые PostgreSQL (Педро Химено Фортеа)
E.37.3.7.1. Системные информационные функции и представления
• Добавление функции pg_get_object_address(), возвращающей набор OID, однозначно иден-
тифицирующих объект, и функции pg_identify_object_as_address(), возвращающей инфор-
мацию об объекте по этим OID (Альваро Эррера)
• Ослабление ограничений безопасности при просмотре запросов в pg_stat_activity и вызове
функций pg_cancel_backend() и pg_terminate_backend() (Стивен Фрост)
Ранее эти операции могли выполнять только роли, которым непосредственно принадлежит
целевой сеанс; теперь достаточно быть членом такой роли.
• Добавление функции pg_stat_get_snapshot_timestamp(), выдающей время снимка статисти-
ки (Мэтт Келли)
Это время показывает, когда в последний раз файл снимка записывался в файловую систему.
• Добавление функции mxid_age(), вычисляющей возраст мультитранзакций (Брюс Момджян)
E.37.3.7.2. Агрегатные функции
• Добавление агрегатных функций min()/max() для типов данных inet/cidr (Харибабу Комми)
• Использование 128-битных целых, где они поддерживаются, для накопления значений в неко-
торых агрегатных функциях (Андреас Карлссон)
E.37.3.8. Языки программирования на стороне сервера
• Улучшение поддержки составных типов в PL/Python (Эд Бен, Ронан Данклау)
Это позволяет возвращать из функций на PL/Python массивы составных типов.
• Уменьшение неточности при преобразовании значений с плавающей точкой в PL/Python (Мар-
ко Крин)
• Возможность определения функций преобразования между типами данных SQL и типами дан-
ных процедурных языков (Питер Эйзентраут)
Это изменение привносит команды CREATE/DROP TRANSFORM. Также с ним добавлены дополни-
тельные трансформации типов hstore и ltree из/в типы языков PL/Perl и PL/Python.
E.37.3.8.1. Серверный язык PL/pgSQL
• Улучшение производительности массивов PL/pgSQL (Том Лейн)
• Добавление оператора ASSERT в PL/pgSQL (Павел Стехуле)
• Допущение использования в качестве идентификаторов большего количества ключевых слов
PL/pgSQL (Том Лейн)
2466Замечания к выпуску
E.37.3.9. Клиентские приложения
• Перемещение pg_archivecleanup, pg_test_fsync, pg_test_timing и pg_xlogdump из contrib в src/
bin (Питер Эйзентраут)
В результате эти программы должны по умолчанию устанавливаться в большем числе инстал-
ляций.
• Добавление программы pg_rewind, позволяющей восстановить синхронизированное состояние
главного сервера после отработки отказа (Хейкки Линнакангас)
• Возможность управления слотами физической репликации с помощью pg_receivexlog (Мика-
эль Пакье)
Для этого введены новые параметры --create-slot и --drop-slot.
• В pg_receivewal появилась возможность синхронно сбрасывать WAL на диск с нововведённым
параметром --synchronous (Фуруя Осаму, Фудзии Масао)
Без него файлы WAL сохраняются на диске только при закрытии.
• В vacuumdb появилась возможность очистки в параллельном режиме с нововведённым пара-
метром --jobs (Дилип Кумар)
• Программа vacuumdb теперь не запрашивает один и тот же пароль многократно, когда уста-
навливает несколько подключений (Харибабу Комми, Микаэль Пакье)
• Добавление ключа --verbose для reindexdb (Савада Масахико)
• Использование в pg_basebackup файла отображений табличных пространств при выборе фор-
мата tar, что позволяет поддерживать символические ссылки и пути длиннее 100 символов в
MS Windows (Амит Капила)
• Добавление в pg_xlogdump ключа --stats для получения сводной статистики (Абхиджит Ме-
нон-Сен)
• Возможность получить вывод psql в формате AsciiDoc (Шимон Гуз)
• Добавление режима errors в переменной ECHO, в котором psql выводит только команды с
ошибками (Павел Стехуле)
Этот режим также можно включить, передав psql ключ -b.
• Разделение в psql параметров, управляющих стилем линий в Юникоде, на параметры для ко-
лонок, заголовка и границ (Павел Стехуле)
Поддерживаются одинарные и двойные линии; вариант по умолчанию — single (одинарные).
• Поддержка нового параметра %l в переменных окружения PROMPT в psql, позволяющего уви-
деть текущий номер строки в многострочном операторе (Савада Масахико)
• Добавление в \pset параметра pager_min_lines, управляющего вызовом постраничника (Энд-
рю Дунстан)
• Улучшение подсчёта строк в psql, по результатам которого принимается решения о вызове
постраничника (Эндрю Дунстан)
• Теперь psql не запускается, если не может записать в файл, заданный ключом --output или
--log-file (Том Лейн, Даниэль Верите)
Ранее psql по сути игнорировал этот ключ в таких случаях.
• Добавление в psql дополнения табуляцией, когда устанавливается переменная search_path
(Джефф Джейнс)
В настоящее время дополнение табуляцией возможно только для первой схемы.
2467Замечания к выпуску
• Улучшение в psql дополнения табуляцией для триггеров и правил (Андреас Карлссон)</I-O-Read-Time></li>
  <li>Команды с обратной косой чертой
• Добавление для команды psql \? разделов справки variables и options (Павел Стехуле)
Команда \? variables показывает справку по специальным переменным psql, а \? options —
по параметрам командной строки. Команда \? commands выводит метакоманды, которые выво-
дились раньше, и это остаётся вариантом по умолчанию. Эти разделы справки также можно
получить, передав в командной строке аргумент –help=раздел.
• В команде psql \db+ добавлен вывод размера табличного пространства (Фабрицио де Ройес
Мелло)
• В psql \dT+ добавлено отображение владельцев типов данных (Магнус Хагандер)
• В psql \watch добавлен вывод информации \timing (Фудзии Масао)
Отключение вывода запросов \watch при запуске с ключом –echo-hidden, так как обычно
они не нужны.
• Команды psql \sf и \ef должны учитывать переменную ECHO_HIDDEN (Эндрю Дунстан)
• Улучшение в psql дополнения табуляцией для \set, \unset и имён :variable (Павел Стехуле)
• Возможность дополнения табуляцией имён ролей в командах psql \c (Иэн Барвик)
• Возможность использовать в pg_dump снимок данных, полученный в другом сеансе, с пара-
метром –snapshot (Саймон Риггс, Микаэль Пакье)
Этот снимок должен быть экспортирован функцией pg_export_snapshot() или при создании
слота логической репликации. Это может применяться для совместного использования согла-
сованного снимка несколькими процессами pg_dump.
• Поддержка в архивном формате tar таблиц размером больше 8 ГБ (Том Лейн)
Стандарт POSIX формата tar не позволяет включать в архив элементы размером больше 8
ГБ, но большинство современных реализаций tar поддерживают расширение, допускающие
это. Поэтому нужно использовать расширенный формат, когда это необходимо, а не выдавать
ошибку.
• Включение в pg_dump вывода версий сервера и pg_dump во всех режимах (Цзин Ван)
До этого информация о версии выводилась только в режиме –verbose.
• Исключение давно забытого параметра -i/–ignore-version из pg_dump, pg_dumpall и
pg_restore (Фудзии Масао)
• Поддержка нескольких параметров pg_ctl -o, так что их значения соединяются вместе (Брюс
Момджян)
• Возможность определения для pg_ctl источника событий, записываемых в журнал событий
MS Windows (МауМау)
Это влияет только на события pg_ctl, а не сервера — для него источник событий задаётся от-
дельно, в postgresql.conf.
• Если в качестве принимающего адреса сервера задаётся всёохватывающее значение (0.0.0.0
в IPv4 или :: в IPv6), нужно подключаться через адрес локального замыкания, а не использо-
вать заданный адрес буквально (Кондо Юта)
Это исправление в первую очередь затрагивает Windows, так как на других платформах pg_ctl
предпочитает использовать Unix-сокет.
• Перемещение pg_upgrade из contrib в src/bin (Питер Эйзентраут)
2468Замечания к выпуску
В связи с этим изменением, функциональность, ранее предоставляемая модулем
pg_upgrade_support, была включена в ядро сервера.
• Поддержка нескольких параметров pg_upgrade -o/-O, так что их значения соединяются вме-
сте (Брюс Момджян)
• Улучшение сравнений правил сортировки для баз данных в pg_upgrade (Хейкки Линнакангас)
• Ликвидация поддержки обновления с версии 8.3 (Брюс Момджян)
• Перемещение pgbench из contrib в src/bin (Питер Эйзентраут)
• Исправлено вычисление TPS «за исключением установленных соединений» (Тацуо Исии, Фаб-
ьен Коэльо)
Накладные расходы на установление соединения подсчитывались неправильно, когда число
потоков pgbench было меньше числа клиентских подключений. Хотя это определённо ошибка,
мы не будем переносить её исправление в версии до 9.5, так как при этом значения TPS ока-
жутся несравнимыми с предыдущими результатами.
• Подсчёт транзакций, выполнявшихся дольше заданного времени (Фабьен Коэльо)
Этим подсчётом управляет нововведённый параметр –latency-limit.
• Возможность получить в pgbench случайное распределение Гаусса или экспоненциальное
распределение \setrandom (Мицумаса Кондо, Фабьен Коэльо)
• Реализация в команде pgbench \set обработки арифметических выражений с несколькими
операторами и включение % (деления по модулю) в список поддерживаемых операторов (Ро-
берт Хаас, Фабьен Коэльо)
E.37.3.10. Исходный код
• Упрощение формата записи WAL (Хейкки Линнакангас)
Благодаря этому изменению, внешним средствам будет легче отслеживать, какие блоки изме-
няются.
• Улучшение представления записей фиксации и прерывания транзакций в WAL (Андрес
Фройнд)
• Добавление API атомарных операций с памятью (Андрес Фройнд)
• Возможность реализации нестандартных методов сканирования и путей (КайГай Кохэй, Том
Лейн)
Это даёт расширениям дополнительные рычаги управления оптимизатором и исполнителем.
• Возможность устанавливать блокировки после фильтрации в обёртках сторонних данных (Эцу-
ро Фудзита)
• Сторонние таблицы теперь могут участвовать в запросах INSERT … ON CONFLICT DO NOTHING
(Питер Геохеган, Хейкки Линнакангас, Андрес Фройнд)
Обёртки сторонних данных не нужно модифицировать, чтобы это поддерживалось. Однако ко-
манда INSERT … ON CONFLICT DO UPDATE со сторонними таблицами не поддерживается.
• Улучшение интерфейса hash_create(), позволяющее выбирать хеш-функции с простым двоич-
ным ключом (Фёдор Сигаев, Том Лейн)
• Улучшение инфраструктуры параллельного выполнения (Роберт Хаас, Амит Капила, Ной
Миш, Рушаб Латиа, Дживан Чок)
• Ликвидация портов для Alpha (CPU) и Tru64 (ОС) (Андрес Фройнд)
• Ликвидация реализации циклических блокировок (spinlock) на основе перестановки байт для
ARMv5 и предыдущих процессоров (Роберт Хаас)
2469Замечания к выпуску
Особенность слабого упорядочивания доступа к памяти в ARM v5 делает такую реализацию
блокировки ненадёжной. Однако использование циклических блокировок всё же возможно с
новыми версиями gcc, поддерживающими атомарные операции.
• Выдача ошибки при попытке записать в файлы tar чрезмерно длинный (больше 100 символов)
путь (Питер Эйзентраут)
Tar не поддерживает такие длинные пути.
• Смена индексируемого класса операторов для столбцов pg_seclabel.provider и
pg_shseclabel.provider на text_pattern_ops (Том Лейн)
Это позволяет избежать возможных проблем с этими индексами, когда в разных базах данных
кластера используются разные правила сортировки.
• Изменение примитивов spinlock, чтобы они действовали как барьеры для оптимизаций компи-
лятора (Роберт Хаас)
E.37.3.10.1. MS Windows
• Получение системного времени с большей точностью в Windows 8, Windows Server 2012 и бо-
лее новых системах Windows (Крейг Рингер)
• Установка разделяемых библиотек в bin в MS Windows (Питер Эйзентраут, Микаэль Пакье)
• Установка src/test/modules вместе с contrib в сборках с MSVC (Микаэль Пакье)
• В сборке с MSVC теперь может учитываться задаваемый для configure параметр –with-
extra-version (Микаэль Пакье)
• Передача PGFILEDESC в сборки contrib с MSVC (Микаэль Пакье)
• Добавление значков во все собираемые с MSVC двоичные файлы и информации о версии во
все двоичные файлы, собираемые для MS Windows (Ной Миш)
При сборке с MinGW такие значки уже добавлялись ранее.
• Добавление поддержки необязательных аргументов во внутреннюю реализацию
getopt_long() (Микаэль Пакье, Андрес Фройнд)
Это используется при сборке с MSVC.
E.37.3.11. Дополнительные модули
• Добавление статистики для получения минимального, максимального, среднего времени и
стандартного отклонения в pg_stat_statements (Мицумаса Кондо, Эндрю Дунстан)
• Добавление в pgcrypto функции pgp_armor_headers() для извлечения заголовков PGP Armor
(Марко Тииккая, Хейкки Линнакангас)
• Возможность задавать пустые строки замены в unaccent (Мохаммед Альхашаш)
Это полезно для языков, в которых диакритические знаки представляются как отдельные сим-
волы.
• Возможность задавать многосимвольные исходные строки в unaccent (Том Лейн)
Это может быть полезно для языков, в которых диакритические знаки представляются как от-
дельные символы. Это также позволяет создавать более сложные словари удаления диакрити-
ки.
• Добавление в contrib модулей tsm_system_rows и tsm_system_time, реализующих дополни-
тельные методы извлечения выборки (Петр Желинек)
• Добавление функций исследования индекса GIN в pageinspect (Хейкки Линнакангас, Питер
Геохеган, Микаэль Пакье)
2470Замечания к выпуску
• Добавление информации о закреплении буфера в вывод pg_buffercache (Андрес Фройнд)
• Возможность получать от pgstattuple приблизительных ответов с меньшими издержками, ис-
пользуя pgstattuple_approx() (Абхиджит Менон-Сен)
• Перемещение dummy_seclabel, test_shm_mq, test_parser и worker_spi из contrib в src/test/
modules (Альваро Эррера)
Этим модули предназначаются только для тестирования сервера, поэтому их нет смысла соби-
рать или устанавливать в составе пакета PostgreSQL.
2471</li>
</ol>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="http://localhost:4000/tags/#PostgreSQL" title="Pages tagged PostgreSQL" class="tag"><span class="term">PostgreSQL</span></a><a href="http://localhost:4000/tags/#PostgreSQL_Book_11" title="Pages tagged PostgreSQL_Book_11" class="tag"><span class="term">PostgreSQL_Book_11</span></a></span>
        <span>Updated on <span class="entry-date date updated"><time datetime="2018-12-03 T15:14:43-04:00">December 03, 2018</time></span></span>
        <span class="author vcard"><span class="fn">Sergey Khatsiola</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/PostgreSQL-V11_Doc-075/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=http://localhost:4000/PostgreSQL-V11_Doc-075/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=http://localhost:4000/PostgreSQL-V11_Doc-075/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="http://localhost:4000/PostgreSQL-V11_Doc-074/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="http://localhost:4000/PostgreSQL-V11_Doc-077/" title="Приложение G. Дополнительно поставляемые программы">Приложение G. Дополнительно поставляемые программы</a></h3>
      <p> <a href="http://localhost:4000/PostgreSQL-V11_Doc-077/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/PostgreSQL-V11_Doc-076/" title="Приложение F. Дополнительно поставляемые модули">Приложение F. Дополнительно поставляемые модули</a></h4>
        <span>Published on December 01, 2018</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="http://localhost:4000/PostgreSQL-V11_Doc-074/" title="Приложение D. Соответствие стандарту SQL">Приложение D. Соответствие стандарту SQL</a></h4>
        <span>Published on December 01, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2018 Sergey Khatsiola. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>



	        

</body>
</html>
