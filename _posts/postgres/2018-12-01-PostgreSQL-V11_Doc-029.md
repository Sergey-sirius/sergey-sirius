---
layout: post
title: Глава 29. Мониторинг использования диска
description: ""
tags: [PostgreSQL, PostgreSQL_Book_11]
image:
  feature: abstract-11.jpg
  #credit: dargadgetz
  #creditlink: http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/
share: true
modified: 2018-12-03 T15:14:43-04:00
---

Глава 29. Мониторинг использования диска

В данной главе обсуждается как отслеживать использование дискового пространства в СУБД
PostgreSQL.
29.1. Определение использования диска
Для каждой таблицы создаётся первичный дисковый файл кучи (heap), в котором хранится боль-
шая часть данных. Если в таблице есть столбцы с потенциально большими значениями, то также
может быть и ассоциированный с этой таблицей файл TOAST, который используется для хранения
слишком больших значений, не умещающихся в главной таблице (см. Раздел  68.2). На каждую
таблицу TOAST, если она существует, будет существовать один индекс. Также там могут быть и
индексы, ассоциированные с базовой таблицей. Каждая таблица и индекс хранятся в отдельном
дисковом файле — возможно более чем в одном файле, если размер этого файла превышает один
гигабайт. Преобразования имён для этих файлов описываются в Разделе 68.1.
Вы можете осуществлять мониторинг дискового пространства тремя способами: используя SQL-
функции, перечисленные в Таблице 9.84, используя модуль oid2name или просматривая системные
каталоги вручную. Вышеупомянутые SQL функции являются наиболее простыми и рекомендуются
для использования. В продолжении этого раздела рассказывается, как просматривать системные
каталоги.
Используя psql после недавнего применения команд VACUUM или ANALYZE, вы можете выполнить
такой запрос, чтобы увидеть сколько дискового пространства использует какая-либо таблица:
SELECT pg_relation_filepath(oid), relpages FROM pg_class WHERE relname = 'customer';
pg_relation_filepath | relpages
----------------------+----------
base/16384/16806
|
60
(1 row)
Каждая страница обычно равна 8kb. (Помните, что relpages обновляется только командами
VACUUM, ANALYZE, и несколькими командами DDL, такими как CREATE INDEX). Путь к файлу пред-
ставляет интерес, если вы хотите проанализировать непосредственно файл на диске.
Чтобы посмотреть пространство, используемое таблицами TOAST, используйте следующий запрос:
SELECT relname, relpages
FROM pg_class,
(SELECT reltoastrelid
FROM pg_class
WHERE relname = 'customer') AS ss
WHERE oid = ss.reltoastrelid OR
oid = (SELECT indexrelid
FROM pg_index
WHERE indrelid = ss.reltoastrelid)
ORDER BY relname;
relname
| relpages
----------------------+----------
pg_toast_16806
|
0
pg_toast_16806_index |
1
Вы можете легко посмотреть размеры индексов:
SELECT c2.relname, c2.relpages
FROM pg_class c, pg_class c2, pg_index i
WHERE c.relname = 'customer' AND
c.oid = i.indrelid AND
725Мониторинг использования диска
c2.oid = i.indexrelid
ORDER BY c2.relname;
relname
| relpages
----------------------+----------
customer_id_indexdex |
26
Также легко найти самые большие таблицы и индексы, используя эту информацию:
SELECT relname, relpages
FROM pg_class
ORDER BY relpages DESC;
relname
| relpages
----------------------+----------
bigtable
|
3290
customer
|
3144
29.2. Ошибка переполнения диска
Наиболее важной задачей мониторинга диска для администратора баз данных состоит в том, что-
бы иметь уверенность в наличии свободного места на диске. Если диск полон, это не приведёт
к повреждению данных, но может не давать выполняться некоторым полезным действиям. Если
переполнится диск, который содержит файлы WAL, то сервер СУБД может аварийно завершить
свою работу.
Если вы не можете освободить дополнительное пространство на диске, удалив какие-либо другие
файлы, то можно перенести часть файлов базы данных на другие файловые системы, с помощью
создания табличных пространств. Подробности об этом смотрите в Раздел 22.6.
Подсказка
Некоторые файловые системы плохо работают, когда они почти или совсем заполне-
ны, так что не ждите пока диск заполнится полностью, чтобы выполнить необходимые
действия.
Если ваша система поддерживает дисковые квоты для пользователей, вы должны позаботиться о
квоте, выделенной для пользователя, от имени которого запускается сервер СУБД. Если эта квота
будет исчерпана, последствия будут столь же негативными, как если просто закончится свободное
место на диске.
726
