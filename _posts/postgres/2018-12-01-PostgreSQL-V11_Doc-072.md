---
layout: post
title: Приложение B. Поддержка даты и времени
description: ""
tags: [PostgreSQL, PostgreSQL_Book_11]
image:
  feature: abstract-11.jpg
  #credit: dargadgetz
  #creditlink: http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/
share: true
modified: 2018-12-03 T15:14:43-04:00
---

Приложение B. Поддержка даты и времени

PostgreSQL использует внутренний эвристический анализатор для поддержки всех значений даты
и времени. Дата и время вводятся как строки и разделяются на различные поля, при этом пред-
варительно определяется, какого рода информация содержится в конкретном поле. Каждое поле
интерпретируется и получает числовое значение, игнорируется или отклоняется. Анализатор со-
держит внутренние справочные таблицы для текстовых полей, включая месяцы, дни недели и ча-
совые пояса.
Данное приложение включает информацию о содержании справочных таблиц и описывает этапы,
необходимые анализатору для распознавания даты и времени.
B.1. Интерпретация данных даты и времени
Все значения даты и времени расшифровываются при помощи следующей процедуры.
1.
2.
3.
Разделить входную строку на фрагменты и определить каждый фрагмент как строку, время,
часовой пояс или цифру.
a. Если числовой фрагмент содержит двоеточие (:), значит эта строка представляет время.
Включаются все последующие цифры и двоеточия.
b. Если числовой фрагмент содержит тире (-), косую черту (/) или две и более точек (.),
то это строка даты, которая, возможно, включает название месяца. Если фрагмент даты
уже встречался, он интерпретируется как название часового пояса (например, America/
New_York).
c. Если этот фрагмент является лишь числом, он представляет собой отдельное поле или со-
ставную дату ISO 8601 (например, 19990113 для 13 января 1999 года) или время (например,
141516 для 14:15:16).
d. Если фрагмент начинается с плюса (+) или минуса (-), то это или числовой часовой пояс
или специальное поле.
Если фрагмент является текстовой строкой, сопоставить его с возможными строками:
a. Выполнить двоичный поиск в справочной таблице соответствующего фрагмента в виде аб-
бревиатуры часового пояса.
b. Если фрагмент не найден, выполнить подобный просмотр в таблице двоичного поиска,
чтобы определить фрагмент как специальную строку (например, today), день (например,
Thursday), месяц (например, January) или неучитываемое слово (например, at, on).
c. Если фрагмент всё же не найден, выдать ошибку.
Когда фрагмент является числом или числовым полем:
a. Если получено восемь или шесть цифр и никакое другое поле даты ранее не было прочита-
но, интерпретировать их как «составленную дату» (например, 19990118 или 990118). Такая
дата интерпретируется как ГГГГММДД или ГГММДД.
b. Если фрагмент представляет собой трёхзначное число, и год уже был прочитан, интерпре-
тировать как день года.
c. Если это четыре или шесть цифр и год уже был прочитан, интерпретировать как время
(ЧЧММ или ЧЧММСС).
d. Если найдены три или более цифр, а поля даты ещё не были найдены, интерпретировать
как год (это ведёт к установке порядка гг-мм-дд для оставшихся полей даты).
2207Поддержка даты и времени
e.
В противном случае подразумевается, что порядок сортировки полей даты определяется
значением DateStyle: мм-дд-гг, дд-мм-гг или гг-мм-дд. Выдать ошибку, если оказалось, что
поле месяца или дня вышло за пределы диапазона.
4. Если указан год до н. э., отнять год и добавить единицу для внутреннего хранения. (В григори-
анском календаре отсутствует нулевой год, поэтому 1 год до н. э. становится нулевым.)
5. Если год до н. э. не был указан, и если поле года имело два разряда, установить для записи
года четыре разряда. Если поле меньше 70, добавить 2000, в противном случае добавить 1900.
Подсказка
Годы с 1 по 99 н. э. по григорианскому календарю могут вводится при помощи
четырёхзначного числа с начальными нулями (например, 0099 это год 99 н. э.).
B.2. Ключевые слова для обозначения даты и времени
Таблица B.1 показывает фрагменты, которые распознаются как названия месяцев.
Таблица B.1. Названия месяцев
Месяц Аббревиатуры
January Jan
February Feb
March Mar
April Apr
May
June Jun
July Jul
August Aug
September Sep, Sept
October Oct
November Nov
December Dec
Таблица B.2 показывает фрагменты, которые распознаются как названия дней недели.
Таблица B.2. Названия дней недели
День Аббревиатуры
Sunday Sun
Monday Mon
Tuesday Tue, Tues
Wednesday Wed, Weds
Thursday Thu, Thur, Thurs
Friday Fri
Saturday Sat
Таблица B.3 показывает фрагменты, которые выполняют различные функции модификаторов.
2208Поддержка даты и времени
Таблица B.3. Модификаторы поля даты/времени
Идентификатор Описание
AM Время до 12:00
AT игнорируется
JULIAN, JD, J Следующее поле является юлианской датой
ON игнорируется
PM Время 12:00 и более позднее
T Следующее поле указывает на время
B.3. Файлы конфигурации даты/времени
Поскольку аббревиатуры часовых поясов недостаточно стандартизированы, PostgreSQL предлага-
ет средства для определения набора аббревиатур, принимаемых сервером. Параметром выполне-
ния timezone_abbreviations определяется активный набор аббревиатур. Хотя данный параметр мо-
жет быть изменён любым пользователем базы данных, возможные значения для него контролиру-
ются администратором базы данных и являются именами конфигурационных файлов, хранящих-
ся в .../share/timezonesets/ каталога установки. Добавляя или изменяя файлы в этом каталоге,
администратор может определить местную специфику выбора аббревиатур часовых поясов.
Значение timezone_abbreviations может быть установлено в любое имя файла, находящегося
в .../share/timezonesets/, если имя файла состоит только из букв. (Запрет на использование
небуквенных символов в timezone_abbreviations делает невозможным чтение файлов, находя-
щихся вне заданного каталога, а также резервных файлов редактора и прочих внешних файлов.)
Файл аббревиатур часовых поясов может содержать пустые строки и комментарии, начинающиеся
с #. Строки, не имеющие комментариев, должны иметь один из следующих форматов:
аббревиатура_пояса смещение
аббревиатура_пояса смещение D
аббревиатура_пояса имя_часового_пояса
@INCLUDE имя_файла
@OVERRIDE
Поле аббревиатура_пояса лишь задаёт определяемую аббревиатуру. Смещение — это целое число,
задающее эквивалентное смещение от UTC в секундах, положительное — к востоку от Гринвич-
ского меридиана, а отрицательное — к западу. Например, -18000 означало бы пять часов к запа-
ду от Гринвича, или Североамериканское восточное время. D указывает, что название пояса пред-
ставляет местное летнее, а не поясное время.
В качестве альтернативы может быть задано имя_часового_пояса, определённое в базе данных
часовых поясов IANA. В этом случае система обращается к определению пояса, чтобы выяснить,
используется или использовалась ли аббревиатура для этого пояса, и если да, действовать будет
соответствующее значение — то есть, значение, действовавшее в указанный момент времени, или
действовавшее непосредственно перед ним, если текущее на тот момент неизвестно, либо самое
старое значение, если первое определение появилось после этого момента. Это поведение важно
для тех аббревиатур, значение которых менялось в ходе истории. Также допускается определение
аббревиатуры через имя часового пояса, с которым эта аббревиатура не связана; в таком случае
использование аббревиатуры равнозначно написанию просто имени пояса.
Подсказка
Простое целочисленное смещение предпочтительнее использовать, когда определяется
аббревиатура, смещение которой от UTC никогда не менялось, так как обрабатывать
подобные аббревиатуры гораздо легче, чем те, что требуют обращения к определению
часового пояса.
2209Поддержка даты и времени
Использование @INCLUDE позволяет включить другой файл в каталоге .../share/timezonesets/.
Включение может быть вложенным до ограниченной глубины.
Использование @OVERRIDE указывает, что последующие записи в файле могут переопределять
предыдущие (как правило, это записи, полученные из включённых файлов). Без этого указания
конфликтующие определения аббревиатуры одного и того же часового пояса считаются ошибкой.
При установке без внесения изменений, файл Default содержит все неконфликтующие аббревиа-
туры часовых поясов для большей части земного шара. Дополнительные файлы Australia и India
предоставляются для данных регионов. Эти файлы сначала включают файл Default, а затем до-
бавляют и изменяют аббревиатуры по мере необходимости.
В качестве справочной информации стандартная установка также содержит файлы Africa.txt,
America.txt и т. д., содержащие информацию о каждой используемой аббревиатуре часового поя-
са, включённой в базу данных часовых поясов IANA. Определения названий часовых поясов, нахо-
дящиеся в этих файлах, можно копировать и помещать в файл с нестандартной конфигурацией по
мере необходимости. Заметьте, что данные файлы нельзя указывать непосредственно в значении
timezone_abbreviations, так как их имена включают точку.
Примечание
Если при чтении набора аббревиатур часовых поясов возникает ошибка, новое значе-
ние не применяется и сохраняется старый набор. Если ошибка возникает при запуске
базы данных, происходит сбой.
Внимание
Аббревиатуры часового пояса, определённые в файле конфигурации, переопределяют
не относящиеся к часовому поясу значения, встроенные в PostgreSQL. Например, файл
конфигурации Australia определяет SAT (для Южноавстралийского стандартного вре-
мени, South Australian Standard Time). Когда этот файл активен, SAT не будет распозна-
ваться как сокращение слова "суббота".
Внимание
Если вы модифицируете файлы в .../share/timezonesets/, вы можете сами выполнить
резервное копирование, так как обычный дамп базы данных не содержит этот каталог.
B.4. История единиц измерения времени
Стандарт SQL устанавливает, что «В определении „литерала типа дата-время“, „значения типа
дата-время“ ограничены естественными правилами, касающимися дат и времени согласно григо-
рианскому календарю». Следуя стандарту SQL, PostgreSQL подсчитывает даты исключительно в
григорианском календаре, включая годы, когда этот календарь ещё не использовался. Это прави-
ло известно как пролептический григорианский календарь.
Юлианский календарь был введён Юлием Цезарем в 45 г. до н. э. Он широко использовался запад-
ной цивилизацией до 1582 года, когда страны начали переходить на григорианский календарь. В
юлианском календаре тропический год длится приблизительно 365 1/4 дня = 365,25 дня. Каждые
128 лет накапливается примерно 1 день.
Накапливающаяся погрешность побудила папу Григория XIII реформировать календарь в соответ-
ствии с постановлениями Тридентского собора. В григорианском календаре тропический год длит-
2210Поддержка даты и времени
ся приблизительно 365 + 97 / 400 дней = 365,2425 дней. Таком образом, погрешность в один день
тропического года накапливается примерно за 3300 лет.
Приблизительное число 365+97/400 получается из-за того, что из каждых 400 лет 97 високосные.
При этом действуют следующие правила:
Каждый год кратный 4 является високосным.
Однако каждый год кратный 100 не является високосным.
Тем не менее, каждый год кратный 400 всё же является високосным.
Таким образом, 1700, 1800, 1900, 2100 и 2200 не являются високосными годами. Но 1600, 2000 и
2400 — високосные. А в юлианском календаре високосными считаются все годы, кратные 4.
Папская булла, изданная в феврале 1582 года, предписывала сделать октябрь 1582 года на 10 дней
короче, чтобы 15 октября следовало сразу за 4 октября. Это правило соблюдалось в Италии, Поль-
ше, Португалии и Испании. Вскоре к ним присоединились и прочие католические страны, но про-
тестантские страны вводили эти изменения неохотно, а страны греческой православной церкви
не переходили на новый календарь до начала 20 века. В 1752 г. реформа была проведена в Вели-
кобритании и её доминионах (включая территорию сегодняшних Соединённых Штатов Америки).
Таким образом, за 2 сентября 1752 года следовало 14 сентября 1752 года. Поэтому в системах Unix
программа cal выводит следующее:
$ cal 9 1752
September 1752
S M Tu W Th F S
1 2 14 15 16
17 18 19 20 21 22 23
24 25 26 27 28 29 30
Но этот календарь действует только в Великобритании и доминионах. В других местах он является
недействительным. Чтобы избежать сложностей и возможной путаницы при отслеживании кален-
дарей, которыми фактически пользовались в различных местах в разное время, PostgreSQL при-
меняет правила григорианского календаря ко всем датам, даже если это нарушает историческую
достоверность.
Разные календари были составлены в различных частях земного шара, многие из них до григори-
анской системы. Например, появление китайского календаря относится к 14 веку до н. э. Легенда
гласит, что император Хуан-ди изобрёл этот календарь в 2637 г. до н. э. В Китайской Народной
Республике григорианский календарь используется для официальных и коммерческих нужд. Ки-
тайский календарь используется для определения дат традиционных праздников.
Юлианский период является ещё одним типом календаря. Он не имеет отношения к юлианско-
му календарю, несмотря на схожие названия. Данный способ измерения времени был изобретён
французским учёным Жозефом Жюстом Скалигером (1540-1609) и так назван, вероятно, в честь
отца Скалигера, итальянского учёного Юлия Цезаря Скалигера (1484-1558). В юлианском перио-
де, каждый день имеет порядковый номер, начиная с 0 (иногда его называют юлианская дата или
JD 0). Первый день имеет номер 0 и соответствует 1 января 4713 г. до н. э. по юлианскому кален-
дарю или 24 ноября 4714 г. до н. э. по григорианскому календарю. Юлианская дата чаще всего
используется в астрономических расчётах для записи ночных наблюдений, и поэтому день длится
от полудня до полудня UTC, а не с полуночи до полуночи: Первый юлианский день (JD 0) обозна-
чает 24 часа от полудня UTC 24 ноября 4714 г. до н. э. до полудня UTC 25 ноября 4714 г. до н. э.
Хотя PostgreSQL поддерживает юлианскую дату для записи входных и выходных дат (а также, ис-
пользует юлианские даты для некоторых внутренних вычислений в формате дата-время), полдень
не считается началом суток. PostgreSQL рассматривает юлианский день как длящийся от полуно-
чи до полуночи.
2211
