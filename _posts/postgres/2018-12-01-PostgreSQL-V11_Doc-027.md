---
layout: post
title: Глава 27. Конфигурация восстановления
description: ""
tags: [PostgreSQL, PostgreSQL_Book_11]
image:
  feature: abstract-11.jpg
  #credit: dargadgetz
  #creditlink: http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/
share: true
modified: 2018-12-03 T15:14:43-04:00
---

Глава 27. Конфигурация восстановления


Глава описывает параметры, задаваемые в файле recovery.conf. Они применяются лишь во время
восстановления и должны заново устанавливаться перед каждым последующим восстановлением.
После начала процесса они не могут быть изменены.
Параметры в файле recovery.conf указываются в формате name = 'value'. Каждый параметр
должен располагаться на отдельной строке. Для строчного комментария используется хеш (#).
Чтобы включить апостроф в значение параметра, продублируйте его ('').
Пример файла share/recovery.conf.sample, поставляемый в рамках дистрибутива, размещён в
каталоге share/.
27.1. Параметры восстановления из архива
restore_command (string)
Это команда оболочки ОС, которая выполняется для извлечения архивного сегмента файлов
WAL. Этот параметр требуется для восстановления из архива, но необязателен для потоковой
репликации. Любое вхождение %f в строке заменяется именем извлекаемого из архива файла,
а %p заменяется на путь назначения при копировании на сервере. (Путь указывается относи-
тельно текущего рабочего каталога, т. е. относительно каталога хранения данных кластера.)
Любое вхождение %r заменяется на имя файла, в котором содержится последняя действитель-
ная точка восстановления. Это самый ранний файл, который необходимо хранить для возмож-
ности восстановления, и эту информацию можно использовать для усечения архива в целях его
минимизации. %r обычно используется при организации тёплого резерва (см. Раздел 26.2). Для
того чтобы указать символ %, продублируйте его (%%).
Обратите внимание, что команда должна возвращать ноль на выходе лишь в случае успешного
выполнения. У команды будет запрошен список имён файлов, которые отсутствуют в архиве;
в этом случае она должна возвращать ненулевой статус. Примеры:
restore_command = 'cp /mnt/server/archivedir/%f "%p"'
restore_command = 'copy "C:\\server\\archivedir\\%f" "%p"'
# Windows
В случае прерывания команды сигналом (отличным от SIGTERM, который используется для
остановки сервера баз данных) или при возникновении ошибки оболочки (например, если ко-
манда не найдена), процесс восстановления будет остановлен и сервер не запустится.
archive_cleanup_command (string)
Этот необязательный параметр указывает команду оболочки ОС, которая будет вызываться
при каждой точке перезапуска. Назначение команды archive_cleanup_command в том, что-
бы предоставить механизм очистки от старых архивных файлов WAL, которые более не нуж-
ны на резервном сервере. Любое вхождение %r заменяется на имя файла, содержащего по-
следнюю действительную точку восстановления. Это самый ранний файл, который необхо-
димо хранить для возможности восстановления, а более старые файлы, чем %r, могут быть
безболезненно удалены. Эта информация может быть использована для усечения архива с
целью его минимизации при сохранении возможности последующего восстановления из за-
данной точки. Модуль pg_archivecleanup часто используется в качестве значения параметра
archive_cleanup_command в конфигурациях с одним резервным сервером, например:
archive_cleanup_command = 'pg_archivecleanup /mnt/server/archivedir %r'
Стоит обратить внимание, что в конфигурациях с множеством резервных серверов, использую-
щих общий архивный каталог для восстановления, необходимо контролировать удаление фай-
лов WAL, так как для некоторых они ещё могут требоваться. Поэтому archive_cleanup_command
обычно используется при организации тёплого резерва (см. Раздел 26.2). Для того чтобы ука-
зать символ % в команде, он пишется дважды %%.
670Конфигурация восстановления
Если команда вернёт ненулевой статус завершения, то в журнал будет записано предупрежда-
ющее сообщение. В ситуации когда команда прерывается сигналом или в случае ошибки обо-
лочки ОС (например, команда не найдена), будет вызвана фатальная ошибка.
recovery_end_command (string)
Этот необязательный параметр указывает команду оболочки, которая будет выполнена едино-
жды в конце процесса восстановления. Назначение параметра recovery_end_command в предо-
ставлении механизма очистки, следующего за репликацией или восстановлением. Любое вхож-
дение %r заменяется именем файла, содержащим последнюю действительную точку восстанов-
ления, например, как в archive_cleanup_command.
Если команда вернёт ненулевой статус завершения, то в журнал будет записано предупрежда-
ющее сообщение, но при этом запуск сервера будет продолжен. За исключением случаев, когда
команда прервана сигналом или при возникновения ошибки оболочки ОС (например, команда
не найдена). В таких случаях база данных не будет запускаться.
27.2. Параметры управления восстановлением
По умолчанию процесс восстановления производится вплоть до окончания журнала WAL.
Нижеуказанные параметры могут использоваться, чтобы остановить процесс восстановления
в более ранней точке. Использоваться может только один из параметров recovery_target,
recovery_target_lsn, recovery_target_name, recovery_target_time и recovery_target_xid; если
в конфигурационном файле задано несколько параметров, будет использоваться последний.
recovery_target= 'immediate'
Данный параметр указывает, что процесс восстановления должен завершиться, как только бу-
дет достигнуто целостное состояние, т. е. как можно раньше. При восстановлении из опера-
тивной резервной копии, это будет точкой, в которой завершился процесс резервного копиро-
вания.
Технически, это строковый параметр, но значение 'immediate' единственно допустимое в дан-
ный момент.
recovery_target_name (string)
Этот параметр указывает именованную точку восстановления (созданную с помощью
pg_create_restore_point()), до которой будет производиться восстановление.
recovery_target_time (timestamp)
Данный параметр указывает точку времени, вплоть до которой будет производиться восстанов-
ление. Точность этой точки останова также зависит от recovery_target_inclusive.
recovery_target_xid (string)
Параметр указывает идентификатор транзакции, вплоть до которой необходимо произвести
процедуру восстановления. Имейте в виду, что несмотря на то, что при старте идентификаторы
транзакций назначаются последовательно, завершаться они могут в ином порядке. Восстанав-
ливаемые транзакции это те, что были зафиксированы до указанной (и, возможно, включая её).
Точность точки останова также зависит от recovery_target_inclusive.
recovery_target_lsn (pg_lsn)
Данный параметр указывает LSN позиции в журнале предзаписи, до которой долж-
но выполняться восстановление. Точная позиция остановки зависит также от параметра
recovery_target_inclusive. Данный параметр принимает значение системного типа данных
pg_lsn.
Следующие параметры уточняют целевую точку восстановления и оказывают влияние на процесс
при её достижении:
671Конфигурация восстановления
recovery_target_inclusive (boolean)
Указывает на необходимость остановки сразу после (true) либо до (false) достижения
целевой точки. Применяется одновременно с recovery_target_lsn, recovery_target_time или
recovery_target_xid. Этот параметр определяет, нужно ли восстанавливать транзакции, у кото-
рых позиция в WAL (LSN), время фиксации либо идентификатор в точности совпадает с задан-
ным соответствующим значением. Значение по умолчанию — true.
recovery_target_timeline (string)
Указывает линию времени для восстановления. По умолчанию производится восстановление
той же линии времени, которая была текущей в момент создания базовой резервной копии.
Со значением latest восстанавливаться будет последняя линия времени, найденная в архиве,
что полезно для резервного сервера. Иное значение параметра может потребоваться в более
сложной ситуации повторного восстановления, когда необходимо вернуться к состоянию, ко-
торое само было достигнуто после восстановления на момент времени. Это обсуждается в Под-
разделе 25.3.5.
recovery_target_action (enum)
Указывает, какое действие должен предпринять сервер после достижения цели восстановле-
ния. Вариант по умолчанию — pause, что означает приостановку восстановления. Второй ва-
риант, promote, означает, что процесс восстановления завершится и сервер начнёт принимать
подключения. Наконец, с вариантом shutdown сервер остановится, как только цель восстанов-
ления будет достигнута.
Вариант pause позволяет выполнить запросы к базе данных и убедиться в том, что достиг-
нутая цель оказалась желаемой точкой восстановления. Для снятия с паузы нужно вызвать
pg_wal_replay_resume() (см. Таблицу 9.81), что в итоге приведёт к завершению восстановле-
ния. Если же окажется, что мы ещё не достигли желаемой точки восстановления, нужно оста-
новить сервер, установить более позднюю цель и перезапустить сервер для продолжения вос-
становления.
Вариант shutdown полезен для получения готового экземпляра сервера в желаемой точке. При
этом данный экземпляр сможет воспроизводить дополнительные записи WAL (и на самом деле
ему придётся воспроизводить записи WAL после последней контрольной точки при следующем
перезапуске).
Заметьте, что так как recovery.conf не переименовывается, когда в recovery_target_action
выбран вариант shutdown, при последующем запуске будет происходить немедленная останов-
ка, пока вы не измените конфигурацию или не удалите файл recovery.conf вручную.
Этот параметр не действует, если цель восстановления не установлена. Если не включён режим
hot_standby, значение pause действует так же, как и shutdown.
27.3. Параметры резервного сервера
standby_mode (boolean)
Указывает, является ли сервер PostgreSQL резервным или нет. Если параметр установлен в
on, то сервер не прекратит восстановление по окончании последнего архивного файла WAL, а
продолжит попытки извлечения новых сегментов WAL посредством команды restore_command
и/или через подключение к ведущему, как указано в параметре primary_conninfo.
primary_conninfo (string)
Указывает строку подключения ведомого сервера к ведущему. Строка описана в формате со-
гласно Подраздел 34.1.1. Вместо опущенных параметров подключения используются соответ-
ствующие переменные окружения (см. Раздел 34.14). Если же какие-то переменные не уста-
новлены, то используются значения по умолчанию.
672Конфигурация восстановления
Строка может содержать имя (или адрес) основного сервера и порт подключения. Также можно
указать необходимого пользователя на ведущем сервере с требуемыми привилегиями (см. Под-
раздел 26.2.5.1). Если настроена аутентификация по паролю, то его также необходимо указать.
Пароль можно указать как в строке подключения primary_conninfo, так и в файле ~/.pgpass
ведомого сервера (в качестве имени базы данных используйте replication). Не указывайте
имя базы данных среди параметров подключения primary_conninfo.
Этот параметр не действует, если standby_mode имеет значение off.
primary_slot_name (string)
Дополнительно указывает заранее созданный слот при потоковой репликации для контроля
очистки ресурсов подключённого узла (см. Подраздел 26.2.6). Этот параметр не действует, если
не указана строка подключения primary_conninfo.
trigger_file (string)
Указывает триггерный файл, наличие которого завершает работу в режиме резервирования.
Даже если это значение не установлено, существует возможность назначить резервный сервер
основным с помощью команды pg_ctl promote. Этот параметр не действует, если параметр
standby_mode имеет значение off.
recovery_min_apply_delay (integer)
По умолчанию ведомый сервер восстанавливает записи WAL ведущего настолько быстро, на-
сколько это возможно. Иногда полезно иметь возможность задать задержку при копировании
данных, например, для устранения ошибок, связанных с потерей данных. Параметр позволяет
задать эту задержку, указав период времени в миллисекундах (по умолчанию) или иных едини-
цах измерения. Например, если установить значение 5min, ведомый сервер будет воспроизво-
дить фиксацию транзакции не раньше, чем через 5 минут (судя по его системным часам) после
времени фиксации, сообщённого ведущим.
Возможна ситуация, когда задержка репликации между серверами превышает значение этого
параметра. В этом случае дополнительная задержка не добавляется. Заметьте, что задержка
вычисляется как разница между меткой времени, записанной в WAL на ведущем сервере, и
текущим временем на резервном. Запаздывание передачи, связанное с задержками в сети или
каскадной репликацией, может существенно сократить реальное время ожидания. Если время
на главном и резервном сервере не синхронизировано, это может приводить к применению
записей ранее ожидаемого, однако это не очень важно, потому что полезные значения этого
параметра намного превышают типичное расхождение во времени между двумя серверами.
Задержка применяется лишь для записей WAL, представляющих фиксацию транзакций.
Остальные записи проигрываются незамедлительно, так как их эффект не будет заметен до
применения соответствующей записи о фиксации транзакции, благодаря правилам видимости
MVCC.
Задержка добавляется, как только восстанавливаемая база данных достигает согласованного
состояния, и исключается, когда резервный сервер переключается в режим основного. С мо-
мента переключения резервный сервер завершает восстановление незамедлительно.
Данный параметр предназначен для применения в конфигурациях с потоковой репликацией;
однако, если он задан, он будет учитываться в любых случаях. Задержка, устанавливаемая этим
параметром, распространяется и на сообщения hot_standby_feedback, что может привести к
раздуванию базы на главном сервере; сочетание этих параметров требует осторожности.
Предупреждение
Этот параметр влияет на синхронную репликацию, когда synchronous_commit име-
ет значение remote_apply; каждый COMMIT будет ждать подтверждения примене-
ния.
673
