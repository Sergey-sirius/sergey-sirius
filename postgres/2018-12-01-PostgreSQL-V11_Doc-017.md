---
layout: page
title: Глава 17. Установка из исходного кода в Windows
description: ""
tags: [PostgreSQL]
image:
  feature: abstract-11.jpg
  #credit: dargadgetz
  #creditlink: http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/
share: true
modified: 2018-12-03 T15:14:43-04:00
---

Глава 17. Установка из исходного кода в Windows

Для большинства пользователей рекомендуется просто загрузить дистрибутив для Windows с
сайта PostgreSQL. Компиляция из исходного кода описана только для разработчиков сервера
PostgreSQL или его расширений.
Существует несколько различных способов сборки PostgreSQL для Windows. Самый простой спо-
соб сборки с применением инструментов Microsoft — установить Visual Studio Express 2017 для
Windows Desktop и использовать входящий в её состав компилятор. Также возможна сборка с по-
мощью полной версии Microsoft Visual C++ 2005—2017. В некоторых случаях помимо компилятора
требуется установить Windows SDK.
Также возможно собрать PostgreSQL с помощью средств компиляции GNU, используя среду
MinGW, либо с помощью Cygwin для более старых версий Windows.
При компиляции с помощью MinGW или Cygwin сборка производится как обычно, см. Главу 16 и
дополнительные замечания в Подразделе 16.7.5 и Подразделе 16.7.2. Чтобы получить в этих окру-
жениях «родные» 64-битные двоичные файлы, используйте инструменты из MinGW-w64. Данные
инструменты также могут быть использованы для кросс-компиляции для 32- и 64-битной Windows
в других системах, например в Linux и macOS. Cygwin не рекомендуется применять в производ-
ственной среде, его следует использовать только для запуска в старых версиях Windows, где «род-
ная» сборка невозможна, таких как Windows 98. Официальные двоичные файлы собираются с ис-
пользованием Visual Studio.
«Родные» сборки psql не поддерживают редактирование командной строки. Однако сборка в
Cygwin это поддерживает, так что следует выбрать её, когда необходимо интерактивно использо-
вать psql в Windows.
17.1. Сборка с помощью Visual C++ или Microsoft
Windows SDK
PostgreSQL может быть собран с помощью компилятора Visual C++ от Microsoft. Этот компилятор
есть в пакетах Visual Studio, Visual Studio Express или в некоторых версиях Microsoft Windows SDK.
Если у вас ещё не установлена среда Visual Studio, проще всего будет использовать компиляторы
из Visual Studio Express 2017 для Windows Desktop или из Windows SDK 8.1, которые Microsoft
распространяет бесплатно.
С применением инструментария Microsoft Compiler возможна и 32-, и 64-битная сборка. 32-битную
сборку PostgreSQL можно произвести с использованием Visual Studio, версии с Visual Studio 2005
по Visual Studio 2017 (включая редакции Express), а также отдельных выпусков Windows SDK вер-
сии с 6.0 по 8.1. 64-битная сборка PostgreSQL также поддерживается с Microsoft Windows SDK вер-
сии с 6.0a по 8.1 или с Visual Studio 2008 и новее. Компиляция для систем, начиная с Windows XP и
Windows Server 2003, поддерживается при использовании Visual Studio 2005 — Visual Studio 2013.
При сборке с Visual Studio 2015 поддерживаются системы, начиная с Windows Vista и Windows
Server 2008. При сборке с Visual Studio 2017 поддерживаются системы, начиная с Windows 7 SP1
и Windows Server 2008 R2 SP1.
Инструменты для компиляции с помощью Visual C++ или Platform SDK находятся в каталоге src/
tools/msvc. При сборке убедитесь, что в системном пути PATH не подключаются инструменты из
набора MinGW или Cygwin. Также убедитесь, что в пути PATH указаны каталоги всех необходимых
инструментов Visual C++. Если вы используете Visual Studio, запустите Visual Studio Command
Prompt. Если вы хотите собрать 64-битную версию, вы должны выбрать 64-битную версию данной
оболочки, и наоборот. Если вы используете Microsoft Windows SDK, запустите через стартовое ме-
ню, подменю SDK оболочку CMD shell. В последних версиях SDK можно изменить целевую архи-
тектуру процессора, вариант сборки и целевую ОС с помощью команды setenv, например после
setenv /x86 /release /xp будет получена выпускаемая 32-битная сборка для Windows XP. О дру-
473Установка из исход-
ного кода в Windows
гих параметрах setenv можно узнать с ключом /?. Все команды должны запускаться из каталога
src\tools\msvc.
До начала сборки может потребоваться отредактировать файл config.pl и изменить в нём желае-
мые параметры конфигурации или пути к сторонним библиотекам, которые будут использоваться.
Для получения конфигурации сначала считывается и разбирается файл config_default.pl, а за-
тем применяются все изменения из config.pl. Например, чтобы указать, куда установлен Python,
следует добавить в config.pl:
$config->{python} = 'c:\python26';
Вам нужно задать только те параметры, которые отличаются от заданных в config_default.pl.
Если вам необходимо установить какие-либо другие переменные окружения, создайте файл с име-
нем buildenv.pl и поместите в него требуемые команды. Например, чтобы добавить путь к bison,
которого нет в PATH, создайте файл следующего содержания:
$ENV{PATH}=$ENV{PATH} . ';c:\some\where\bison\bin';
Передать дополнительные аргументы командной строки команде сборки Visual Studio (msbuild или
vcbuild) можно так:
$ENV{MSBFLAGS}="/m";
17.1.1. Требования
Для сборки PostgreSQL требуется следующее дополнительное ПО. Укажите каталоги, в которых
находятся соответствующие библиотеки, в файле конфигурации config.pl.
Microsoft Windows SDK
Если с вашим инструментарием для разработки не поставляется поддерживаемая версия
Microsoft Windows SDK, рекомендуется установить последнюю версию SDK (в настоящее время
7.1), которую можно загрузить с https://www.microsoft.com/download/.
Устанавливая SDK, вы всегда должны выбирать для установки пункт Windows Headers and
Libraries (Заголовочные файлы и библиотеки Windows). Если вы установили Windows SDK,
включая Visual C++ Compilers, Visual Studio для сборки вам не нужна. Обратите внимание, что
с версии 8.0a в SDK для Windows не включается полное окружение для сборки в командной
строке.
ActiveState Perl
ActiveState Perl требуется для запуска скриптов, управляющих сборкой. Perl из MinGW или
Cygwin работать не будет. ActiveState Perl также должен находиться по пути в PATH. Готовый
двоичный пакет можно загрузить с https://www.activestate.com. Заметьте, что требуется вер-
сия 5.8.3 или выше, при этом достаточно бесплатного стандартного дистрибутива (Standard
Distribution).
Следующее дополнительное ПО не требуется для базовой сборки, но требуется для сборки полно-
го пакета. Укажите каталоги, в которых находятся соответствующие библиотеки, в файле конфи-
гурации config.pl.
ActiveState TCL
Требуется для компиляции PL/Tcl (Заметьте, что требуется версия 8.4 или выше, при этом до-
статочно бесплатного стандартного дистрибутива (Standard Distribution)).
Bison и Flex
Для компиляции из Git требуются Bison и Flex, хотя они не нужны для компиляции из дистри-
бутивного пакета исходного кода. Bison должен быть версии 1.875 или 2.2, либо новее, а Flex
— версии 2.5.31 или новее.
И Bison, и Flex входят в комплект утилит msys, который можно загрузить с http://www.mingw.org/
wiki/MSYS в качестве компонента набора MinGW.
474Установка из исход-
ного кода в Windows
Вам потребуется добавить каталог, содержащий flex.exe и bison.exe, в путь, задаваемый пе-
ременной PATH, в buildenv.pl, если она его ещё не включает. В случае с MinGW, это будет
подкаталог \msys\1.0\bin в каталоге вашей инсталляции MinGW.
Примечание
Bison, поставляемый в составе GnuWin32, может работать некорректно, когда он
установлен в каталог с именем, содержащим пробелы, например, C:\Program Files
\GnuWin32 (целевой каталог по умолчанию в англоязычной системе). В таком слу-
чае, возможно, стоит установить его в C:\GnuWin32 или задать в переменной окру-
жения PATH короткий путь NTFS к GnuWin32 (например, C:\PROGRA~1\GnuWin32).
Примечание
Старые программы winflex, которые раньше размещались на FTP-сайте PostgreSQL
и упоминались в старой документации, не будут работать в 64-битной Windows,
выдавая ошибку «flex: fatal internal error, exec failed». Используйте Flex из набора
MSYS.
Diff
Diff требуется для запуска
gnuwin32.sourceforge.net.
регрессионных
тестов,
его
можно
загрузить
с
http://
Gettext
Gettext требуется для сборки с поддержкой NLS, его можно загрузить с http://
gnuwin32.sourceforge.net. Заметьте, что для сборки потребуются и исполняемые файлы, и за-
висимости, и файлы для разработки.
MIT Kerberos
Требуется для поддержки проверки подлинности GSSAPI. MIT Kerberos можно загрузить с
http://web.mit.edu/Kerberos/dist/index.html.
libxml2 и libxslt
Требуется для поддержки XML. Двоичный пакет можно загрузить с http://zlatkovic.com/pub/
libxml, а исходный код с http://xmlsoft.org. Учтите, что для libxml2 требуется iconv, который
можно загрузить там же.
OpenSSL
Требуется для поддержки SSL. Двоичные пакеты можно загрузить с https://www.slproweb.com/
products/Win32OpenSSL.html, а исходный код с https://www.openssl.org.
ossp-uuid
Требуется для поддержки UUID-OSSP (только для contrib). Исходный код можно загрузить с
http://www.ossp.org/pkg/lib/uuid/.
Python
Требуется для сборки PL/Python. Двоичные пакеты можно загрузить с https://www.python.org.
zlib
Требуется для поддержки сжатия в pg_dump и pg_restore. Двоичные пакеты можно загрузить
с http://www.zlib.net.
475Установка из исход-
ного кода в Windows
17.1.2. Специальные замечания для 64-битной Windows
PostgreSQL для архитектуры x64 можно собрать только в 64-битной Windows, процессоры Itanium
не поддерживаются.
Совместная сборка 32- и 64-битных версий в одном дереве не поддерживается. Система сборки
автоматически определит, в каком окружении (32- или 64-битном) она запущена, и соберёт соот-
ветствующий вариант PostgreSQL. Поэтому перед сборкой важно запустить требуемую версию ко-
мандного интерпретатора.
Для использования на стороне сервера сторонних библиотек, таких как python или OpenSSL,
эти библиотеки также должны быть 64-битными. 64-битный сервер не поддерживает загруз-
ку 32-битных библиотек. Некоторые библиотеки сторонних разработчиков, предназначенные для
PostgreSQL, могут быть доступны только в 32-битных версиях и в таком случае их нельзя будет
использовать с 64-битной версией PostgreSQL.
17.1.3. Сборка
Чтобы собрать весь PostgreSQL в конфигурации выпуска (по умолчанию), запустите команду:
build
Чтобы собрать весь PostgreSQL в конфигурации отладки, запустите команду:
build DEBUG
Для сборки отдельного проекта, например psql, выполните, соответственно:
build psql
build DEBUG psql
Чтобы сменить конфигурацию по умолчанию на отладочную, поместите в файл buildenv.pl сле-
дующую строку:
$ENV{CONFIG}="Debug";
Также возможна сборка из графической среды Visual Studio. В этом случае вам нужно запустить
в командной строке:
perl mkvcbuild.pl
и затем открыть в Visual Studio полученный pgsql.sln в корневом каталоге дерева исходных кодов.
17.1.4. Очистка и установка
В большинстве случаев за изменением файлов будет следить автоматическая система отслежива-
ния зависимостей в Visual Studio. Но если изменений было слишком много, может понадобиться
очистка установки. Чтобы её выполнить, просто запустите команду clean.bat, которая автомати-
чески очистит все сгенерированные файлы. Вы также можете запустить эту команду с параметром
dist, в этом случае она отработает подобно make distclean и удалит также выходные файлы flex/
bison.
По умолчанию все файлы сохраняются в подкаталогах debug или release. Чтобы установить эти
файлы стандартным образом, а также сгенерировать файлы, требуемые для инициализации и ис-
пользования базы данных, запустите команду:
install c:\destination\directory
Если вы хотите установить только клиентские приложения и интерфейсные библиотеки, выполни-
те команду:
install c:\destination\directory client
17.1.5. Запуск регрессионных тестов
Чтобы запустить регрессионные тесты, важно сначала собрать все необходимые для них компо-
ненты. Также убедитесь, что в системном пути могут быть найдены все DLL, требуемые для загруз-
476Установка из исход-
ного кода в Windows
ки всех подсистем СУБД (например, DLL Perl и Python для процедурных языков). Если их каталоги
в пути поиска отсутствуют, задайте их в файле buildenv.pl. Чтобы запустить тесты, выполните
одну из следующих команд в каталоге src\tools\msvc:
vcregress
vcregress
vcregress
vcregress
vcregress
vcregress
vcregress
vcregress
vcregress
vcregress
check
installcheck
plcheck
contribcheck
modulescheck
ecpgcheck
isolationcheck
bincheck
recoverycheck
upgradecheck
Чтобы выбрать другой планировщик выполнения тестов (по умолчанию выбран параллельный),
укажите его в командной строке, например:
vcregress check serial
За дополнительными сведениями о регрессионных тестах обратитесь к Главе 33.
Для запуска регрессионных тестов клиентских программ с применением команды vcregress
bincheck или тестов восстановления, с применением vcregress recoverycheck, должен быть уста-
новлен дополнительный модуль Perl:
IPC::Run
На момент написания документации модуль IPC::Run не включается ни в инсталляцию Perl
ActiveState, ни в библиотеку ActiveState PPM (Perl Package Manager, Менеджер пакетов Perl).
Чтобы установить его, загрузите архив исходного кода IPC-Run-<version>.tar.gz из CPAN, по
адресу https://metacpan.org/release/IPC-Run, и распакуйте его. Откройте файл buildenv.pl и до-
бавьте в него переменную PERL5LIB, указывающую на подкаталог lib из извлечённого архива.
Например:
$ENV{PERL5LIB}=$ENV{PERL5LIB} . ';c:\IPC-Run-0.94\lib';
17.1.6. Сборка документации
Для сборки документации PostgreSQL в формате HTML требуются дополнительные инструменты
и файлы. Создайте общий каталог для всех этих файлов и сохраните их в названные подкаталоги.
OpenJade 1.3.1-2
Загрузите архив https://sourceforge.net/projects/openjade/files/openjade/1.3.1/openjade-1_3_1-2-
bin.zip/download и распакуйте его в подкаталог openjade-1.3.1.
DocBook DTD 4.2
Загрузите архив с https://www.oasis-open.org/docbook/sgml/4.2/docbook-4.2.zip и распакуйте его
в подкаталог docbook.
Сущности символов ISO
Загрузите архив с https://www.oasis-open.org/cover/ISOEnts.zip и распакуйте его в подкаталог
docbook.
Добавьте в buildenv.pl переменную, задающую местоположение ранее созданного общего ката-
лога, например:
$ENV{DOCROOT}='c:\docbook';
Чтобы собрать документацию, запустите builddoc.bat. Обратите внимание, что при этом сбор-
ка фактически будет запущена дважды; это нужно для построения индексов. Сгенерированные
HTML-файлы окажутся в каталоге doc\src\sgml.
